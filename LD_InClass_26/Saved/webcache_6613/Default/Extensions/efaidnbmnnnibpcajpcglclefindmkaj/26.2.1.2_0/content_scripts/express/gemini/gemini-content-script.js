/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class GeminiContentScript{responseImageTagNames=["SINGLE-IMAGE"];previewedImageTagNames=["mat-dialog-content"];responseContainerTagNames=["response-container"];imageTagName="img";buttonsContainerV2ClassNames=["buttons-container-v2"];spacerClassNames=["spacer"];arrowBackContainerClassNames=["arrow-back-container"];generatedImageExpansionDialogActionButtonsClassNames=["generated-image-expansion-dialog-action-buttons"];cdkOverlayPopoverClassNames=["cdk-overlay-popover cdk-global-overlay-wrapper"];chatViewTouchpointId="gemini-chatview-adobe-express-entry-point";previewEntryPointId="gemini-preview-adobe-express-entry-point";touchpoint="geminiPreview";chatViewTouchpoint="geminiChatView";chatViewTooltips=[];geminiExpressStateKey="geminiExpressState";launchExpress=(e,t,s)=>{chrome.runtime.sendMessage({main_op:"launch-express",imgUrl:e,intent:s,touchpoint:t})};async loadContentScripts(){const e=chrome.runtime.getURL("content_scripts/express/single-click-cta.js"),t=chrome.runtime.getURL("content_scripts/express/express-utils.js"),s=await Promise.all([import(e),import(t)]);this.ExpressCTAClass=s[0].default,this.expressUtils=s[1].default,this.expressCTAForPreviewMode=new this.ExpressCTAClass}floatingButtonClickHandler=(e,t)=>{if(!chrome?.runtime?.id)return void this.removeAllTouchpoints();const s=t.getElementsByTagName(this.imageTagName)[0];if(!s)return void this.expressUtils.sendErrorLog("Error executing express in Gemini chatView","image element not found");const i=s.src;i?(this.setTouchpointClickedForFteState(this.chatViewTouchpoint),this.launchExpress(i,this.chatViewTouchpoint,e)):this.expressUtils.sendErrorLog("Error executing express in Gemini chatView","image URL not found")};createAndAttachChatViewButton=async e=>{const t=this.expressUtils.getClosestElementBasedOnSelectors(e,this.responseContainerTagNames);if(!t)return;if(this.expressUtils.getElementsFromClassNames(t,"cc440d50ba-express-entrypoint-button")[0])return;const s=e.getElementsByTagName(this.imageTagName)[0];if(!s)return;const i=new this.ExpressCTAClass,n=await i.renderMenuButton(e=>{this.floatingButtonClickHandler(e,t)},this.chatViewTouchpoint);if(n.id=this.chatViewTouchpointId,t.getElementsByTagName(this.imageTagName).length>1)return;const o=this.expressUtils.getElementsFromClassNames(t,this.buttonsContainerV2ClassNames)[0];if(!o)return;if("true"===t.getAttribute("express_processing"))return;t.setAttribute("express_processing","true");const r=this.expressUtils.getElementsFromClassNames(o,this.spacerClassNames)[0];let a=0;if(o.children.length>0){for(const e of o.children){if(this.spacerClassNames.some(t=>e.classList.contains(t)))break;a+=e.offsetWidth}0!==s.offsetWidth?(r?.before(n),n.style.position="relative",n.style.left=16+s.offsetWidth-(a+n.offsetWidth)+"px",this.chatViewTooltips.push(i.attachTooltip("bottom")),t.removeAttribute("express_processing"),this.expressUtils.sendAnalyticsEventOncePerDay("DCBrowserExt:Express:Gemini:ChatViewEntryPoint:Shown")):t.removeAttribute("express_processing")}else t.removeAttribute("express_processing")};adjustPositionOfCTAButton=e=>{const t=this.expressUtils.getClosestElementBasedOnSelectors(e,this.responseContainerTagNames);if(!t)return;const s=t.getElementsByClassName(this.chatViewTouchpoint)[0];if(!s)return;const i=this.expressUtils.getElementsFromClassNames(t,this.buttonsContainerV2ClassNames)[0];if(!i)return;const n=e.getElementsByTagName(this.imageTagName)[0];if(!n)return;let o=0;for(const e of i.children){if(e.classList.contains(this.chatViewTouchpoint))break;o+=e.offsetWidth}s.style.position="relative",s.style.left=16+n.offsetWidth-(o+s.offsetWidth)+"px"};adjustPositionOfCTAButton=e=>{const t=this.expressUtils.getClosestElementBasedOnSelectors(e,this.responseContainerTagNames);if(!t)return;const s=t.getElementsByClassName(this.chatViewTouchpoint)[0];if(!s)return;const i=this.expressUtils.getElementsFromClassNames(t,this.buttonsContainerV2ClassNames)[0];if(!i)return;const n=e.getElementsByTagName(this.imageTagName)[0];if(!n)return;let o=0;for(const e of i.children){if(e.classList.contains(this.chatViewTouchpoint))break;o+=e.offsetWidth}s.style.position="relative",s.style.left=16+n.offsetWidth-(o+s.offsetWidth)+"px"};previewEntryPointClickHandler=e=>{if(!chrome?.runtime?.id)return void this.removeAllTouchpoints();const t=this.expressUtils.getElementsFromTagNames(document,this.previewedImageTagNames)[0];if(!t)return void this.expressUtils.sendErrorLog("Error executing express in Gemini preview","preview container not found");const s=t.getElementsByTagName(this.imageTagName)[0];s?(this.setTouchpointClickedForFteState(this.touchpoint),this.launchExpress(s.src,this.touchpoint,e)):this.expressUtils.sendErrorLog("Error executing express in Gemini preview","image element not found")};addThumbnailAndImagePreviewerObserver=()=>{new MutationObserver(()=>{this.messageAreaObserverHandler(),this.imagePreviewerObserverHandler()}).observe(document.body,{childList:!0,subtree:!0})};addPreviewEntryPoint=async e=>{const t=e.parentElement;if(!t)return;const s=this.expressUtils.getElementsFromClassNames(t,this.arrowBackContainerClassNames)[0];if(!s)return;if(document.getElementById(this.previewEntryPointId))return;const i=await this.expressCTAForPreviewMode.renderMenuButton(this.previewEntryPointClickHandler,this.touchpoint);i.id=this.previewEntryPointId;const n=this.expressUtils.getElementsFromClassNames(s,this.generatedImageExpansionDialogActionButtonsClassNames)[0];n?.before(i,s.lastChild),this.tooltip=this.expressCTAForPreviewMode.attachTooltip("bottom"),chrome.runtime.sendMessage({main_op:"reRenderShowOneChild"}),this.expressUtils.sendAnalyticsEventOncePerDay("DCBrowserExt:Express:Gemini:PreviewEntryPoint:Shown");const o=this.expressUtils.getElementsFromClassNames(document,this.cdkOverlayPopoverClassNames)[0];o&&o.setAttribute("popover","auto")};setTouchpointClickedForFteState=async e=>{this.removeContextualFte();let t=await chrome.storage.local.get(this.geminiExpressStateKey);switch(t=t?.geminiExpressState?t.geminiExpressState:{},e){case this.touchpoint:t.previewTouchpointUsed=!0;break;case this.chatViewTouchpoint:t.chatViewTouchpointUsed=!0}chrome.storage.local.set({[this.geminiExpressStateKey]:t})};messageAreaObserverHandler=()=>{if(!this.config.enableGeminiChatViewExpressMenu)return;if(!chrome?.runtime?.id)return void this.removeAllTouchpoints();this.removeTooltipIfFteRendered();const e=this.expressUtils.getElementsFromTagNames(document,this.responseImageTagNames);if(0!==e.length){for(const t of e)this.createAndAttachChatViewButton(t);e.length>2&&this.adjustPositionOfCTAButton(e[e.length-2])}};imagePreviewerObserverHandler=()=>{if(!this.config.enableGeminiPreviewExpressMenu)return;if(!chrome?.runtime?.id)return void this.removeAllTouchpoints();this.removeTooltipIfFteRendered();const e=this.expressUtils.getElementsFromTagNames(document,this.previewedImageTagNames)[0];e&&this.addPreviewEntryPoint(e)};removeAllTouchpoints=()=>{const e=this.expressUtils.getElementsFromClassNames(document,"cc440d50ba-express-entrypoint-button");for(const t of e)t.remove()};cleanupTooltips=()=>{this.tooltip?.tooltip?.remove(),this.tooltip=null;for(const e of this.chatViewTooltips)e?.tooltip?.remove();this.chatViewTooltips=[]};removeTooltipIfFteRendered=()=>{document.getElementById("express-contextual-fte")&&this.cleanupTooltips()};removeContextualFte=()=>{const e=document.getElementById("express-contextual-fte");e&&e.remove()};init=async()=>{const e=await chrome.runtime.sendMessage({main_op:"gemini-express-init"});this.config=e,(this.config.enableGeminiPreviewExpressMenu||this.config.enableGeminiChatViewExpressMenu)&&(this.responseImageTagNames=this.config.selectors?.responseImageTagNames||this.responseImageTagNames,this.previewedImageTagNames=this.config.selectors?.previewedImageTagNames||this.previewedImageTagNames,this.responseContainerTagNames=this.config.selectors?.responseContainerTagNames||this.responseContainerTagNames,this.buttonsContainerV2ClassNames=this.config.selectors?.buttonsContainerV2ClassNames||this.buttonsContainerV2ClassNames,this.spacerClassNames=this.config.selectors?.spacerClassNames||this.spacerClassNames,this.arrowBackContainerClassNames=this.config.selectors?.arrowBackContainerClassNames||this.arrowBackContainerClassNames,this.generatedImageExpansionDialogActionButtonsClassNames=this.config.selectors?.generatedImageExpansionDialogActionButtonsClassNames||this.generatedImageExpansionDialogActionButtonsClassNames,this.cdkOverlayPopoverClassNames=this.config.selectors?.cdkOverlayPopoverClassNames||this.cdkOverlayPopoverClassNames,await this.loadContentScripts(),this.addThumbnailAndImagePreviewerObserver())}}const geminiContentScript=new GeminiContentScript;geminiContentScript.init();