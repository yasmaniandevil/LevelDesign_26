/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
let $iframe,$newiframe,$fteIframe,errorTooltipTimeout=null,widgetState=null;const newIframeTop=150,ERROR_TOOLTIP_DURATION=5e3,ERROR_TOOLTIP_FADE_DURATION=300,THEME_COLORS={light:{background:"#ffffff",contentBg:"#f8f8f8",skeletonBar:"#f8f8f8",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"},dark:{background:"#2c2c2c",contentBg:"#1e1e1e",skeletonBar:"#3a3a3a",boxShadow:"0 2px 8px rgba(0,0,0,0.4)"}},SKELETON_HEIGHT={signedIn:174,signedOut:214},SKELETON_PADDING={signedIn:7,signedOut:15},docUrl=document.location.href;function observeForSPWWidget(e){const t=e||".smallpdf-google-serp-app",o=getSearchEngine(docUrl);if(!o)return;const n={google:"center_col",bing:"b_results"}[o];let i=document.getElementById(n),r=!1;const a=()=>{r||(r=!0,chrome.runtime.sendMessage({main_op:"log-info",log:{message:"SPW widget found"}}).catch(()=>{}))},s=e=>{if(e.querySelector(t))return void a();const o=new MutationObserver(()=>{e.querySelector(t)&&(o.disconnect(),a())});o.observe(e,{childList:!0,subtree:!0}),setTimeout(()=>{o.disconnect()},2e3)};if(!i){const e=new MutationObserver(()=>{i=document.getElementById(n),i&&(e.disconnect(),s(i))});return e.observe(document.body,{childList:!0,subtree:!0}),void setTimeout(()=>e.disconnect(),2e3)}s(i)}function GetChromeMenuDimensions(e,t){const o=t.version>SETTINGS.READER_VER,n=t.version===SETTINGS.READER_VER,i=t.panel_op,r={width:0,height:0};if("searchWidget"===e)switch(i){case"html_menu":case"status":case"test":o?(r.width=259,r.height=450):(r.width=294,r.height=624);break;case"pdf_menu":n?(r.width=294,r.height=350):o?(r.width=259,r.height=400):(r.width=294,r.height=160);break;case"load-frictionless":"v2"===t.variant?(r.width=652,r.height=195):(r.width=294,r.height=521)}else"persistent"===e&&"pdf_menu"===i?(r.width=350,r.height=280):"fte"===e?(r.width=365,r.height=510):"downloadBanner"===e?(r.width="100%",r.height="100px"):"successToast"===e&&(r.width="450px",r.height="50px");return r}function GetEdgeMenuDimensions(e,t){const o=t.version>SETTINGS.READER_VER,n=t.version===SETTINGS.READER_VER,i=t.panel_op,r={width:0,height:0};if("searchWidget"===e)switch(i){case"html_menu":case"status":case"test":o?(r.width=259,r.height=450):(r.width=294,r.height=624);break;case"pdf_menu":n?(r.width=294,r.height=350):o?(r.width=294,r.height=400):(r.width=294,r.height=180);break;case"load-frictionless":"v2"===t.variant?(r.width=652,r.height=195):(r.width=294,r.height=550)}else"persistent"===e&&"pdf_menu"===i?SETTINGS.IS_BETA||!o?(r.width=350,r.height=280):o&&(r.width=200,r.height=50):"fte"===e?(r.width=302,r.height=510):"downloadBanner"===e?(r.width="100%",r.height="100px"):"successToast"===e&&(r.width="450px",r.height="50px");return r}function GetMenuDimensions(e,t){return t.is_edge?GetEdgeMenuDimensions(e,t):GetChromeMenuDimensions(e,t)}function moveNewIframe(e,t){"dc-cv-fte-pdf-dmb"!==t&&($newiframe=$("#__acrobatNewDialog__"),$newiframe.length>0&&$newiframe.css({top:`${e}px`,transition:"top 0.5s ease 0s"}))}function attachZoomPrevention(e){e&&e.length>0&&(e.on("wheel",e=>{e.ctrlKey&&e.preventDefault()}),e.on("keydown",e=>{e.ctrlKey&&-1!==[187,189,107,109].indexOf(e.keyCode)&&e.preventDefault()}))}function createAndInjectIframeV1(e,t,o){let n="block";"hidden"===e.frame_visibility&&(n="none"),$iframe=$("<iframe>"),$iframe.attr("id","__acrobatDialog__").css({border:"0px","z-index":2147483647,position:"fixed",top:"-5px",right:"80px",left:"unset",width:`${o.width}px`,height:`${o.height}px`,display:n,margin:"auto"}).attr("src",`${chrome.runtime.getURL("browser/js/frame.html")}?${t}`).appendTo("html"),attachZoomPrevention($iframe),$newiframe=$("#__acrobatNewDialog__");const{top:i}=$newiframe.offset()||{};if(o.height>i){moveNewIframe(i+(o.height-i),e.fteFeatureFlag)}}function createAndInjectIframeV2(e,t,o){async function n(e){const o=document.querySelector(e);if(!o)return;if(getClickableOverlappingElement(o).length>0)return;if(document.getElementById("__acrobatWidgetContainer__")||document.getElementById("__acrobatSkeleton__")||document.getElementById("__acrobatDialog__"))return;let n=SKELETON_HEIGHT.signedOut,i=SKELETON_PADDING.signedOut;try{const e=await chrome.runtime.sendMessage({main_op:"getSignInStatus"}),t=e?.signInStatus;n=t?SKELETON_HEIGHT.signedIn:SKELETON_HEIGHT.signedOut,i=t?SKELETON_PADDING.signedIn:SKELETON_PADDING.signedOut}catch(e){}const r=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a="true"===document.documentElement.getAttribute("data-dark-mode")||document.body.classList.contains("dark-mode")||"dark"===document.body.getAttribute("data-theme"),s=r||a?"dark":"light",d=THEME_COLORS[s],c=document.createElement("div");c.id="__acrobatWidgetContainer__",c.style.cssText=`position: relative; width: 652px; height: ${n}px; display: block; margin-top: 20px; margin-bottom: 32px;`;const l=document.querySelector(e);l&&l.parentNode&&l.parentNode.insertBefore(c,l);const m=document.createElement("div");m.id="__acrobatSkeleton__",m.setAttribute("data-theme",s),m.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; z-index: 1;";const h=m.attachShadow({mode:"closed"});try{const e=await fetch(chrome.runtime.getURL("browser/js/searchWidgetSkeleton.html")),t=await e.text(),o=document.createElement("template");o.innerHTML=t,h.appendChild(o.content.cloneNode(!0));const n=h.querySelector(".skeleton-wrapper");n&&(n.style.setProperty("--skeleton-bg",d.background),n.style.setProperty("--skeleton-bar-bg",d.skeletonBar),n.style.setProperty("--skeleton-content-bg",d.contentBg),n.style.setProperty("--skeleton-padding",`${i}px`))}catch(e){const t=document.createElement("div");t.style.cssText=`width:100%;height:100%;background:${d.background}`,h.appendChild(t)}c.appendChild(m);const p=document.createElement("iframe");p.id="__acrobatDialog__",p.style.cssText="border: 0px; position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; display: block; transition: opacity 0.3s ease-in-out; z-index: 2;",p.src=`${chrome.runtime.getURL("browser/js/searchWidget.html")}?${t}`,c.appendChild(p),$iframe=$(p),widgetState={skeletonShown:!1,iframeReady:!1,widgetContainer:c,iframe:p,skeleton:m},m.style.display="block",setTimeout(()=>{if(widgetState&&(widgetState.skeletonShown=!0,widgetState.iframeReady)){widgetState.iframe.style.opacity="1";const e=widgetState.skeleton;setTimeout(()=>{e.remove()},350),widgetState=null}},800),attachZoomPrevention($iframe)}const i=e.dom_selector||"#topstuff",r=i.startsWith("#"),a=i.startsWith("."),s=r||a?i.substring(1):null;if($(i).length>0)n(i);else{let t=!1;const o=1e4,d=500;let c=null,l=null,m=null;const h=()=>{c&&(clearTimeout(c),c=null),l&&(clearInterval(l),l=null),m&&m.disconnect()};m=new MutationObserver(e=>{t||e.forEach(e=>{t||("childList"===e.type?e.addedNodes.forEach(e=>{t||1===e.nodeType&&((e=>{if(r)return e.id===s;if(a)return e.classList&&e.classList.contains(s);try{return e.matches&&e.matches(i)}catch(e){return!1}})(e)||e.querySelector&&e.querySelector(i))&&(t=!0,h(),n(i))}):"attributes"===e.type&&(r&&"id"===e.attributeName&&e.target.id===s&&(t=!0,h(),n(i)),a&&"class"===e.attributeName&&e.target.classList&&e.target.classList.contains(s)&&(t=!0,h(),n(i))))})});const p=()=>{if(document.querySelector(i))return t=!0,void n(i);let s;s=r?["id"]:a?["class"]:["id","class"];const p=e.observer_containers||["#center_col","#rcnt","#main","#cnt","#search"];let u=null;p.some(e=>{const t=document.querySelector(e);return!!t&&(u=t,!0)}),u||(u=document.body),m.observe(u,{childList:!0,subtree:!0,attributes:!0,attributeFilter:s}),l=setInterval(()=>{t||document.querySelector(i)&&(t=!0,h(),n(i))},d),c=setTimeout(()=>{t||(h(),console.warn(`MutationObserver timed out waiting for element: ${i}`))},o)};document.body?p():document.addEventListener("DOMContentLoaded",()=>{p()})}$newiframe=$("#__acrobatNewDialog__");const{top:d}=$newiframe.offset()||{};if(o.height>d){moveNewIframe(d+(o.height-d),e.fteFeatureFlag)}}function createAndInjectIframe(e){const t={...e};delete t.base64PDF;const o=`message=${encodeURIComponent(JSON.stringify(t))}`,n=GetMenuDimensions("searchWidget",e);n.width<=0||n.height<=0||("v2"===e.variant?createAndInjectIframeV2(e,o,n):createAndInjectIframeV1(e,o,n))}function injectFrame(e){$iframe=$("#__acrobatDialog__"),0===$iframe.length?createAndInjectIframe(e):"none"===$iframe.css("display")&&"visible"===e.frame_visibility&&$iframe.css({display:"block"})}function injectBannerInFrame(e){const{height:t,width:o}=GetMenuDimensions(e.showToast?"successToast":"downloadBanner",e);if($iframe=$("#__acrobatDialog__"),0===$iframe.length){let n="block";"hidden"===e.frame_visibility&&(n="none"),$iframe=$("<iframe>"),$iframe.attr("id","__acrobatDialog__").css({border:"0px","z-index":2147483647,position:"fixed",bottom:"0px",width:o,height:t,display:n,margin:"auto",background:"transparent","color-scheme":"auto",...e.showToast&&{bottom:"25px",right:"calc(50% - 200px)",left:"unset","border-radius":"4px"}}).attr("src",chrome.runtime.getURL(e.showToast?"browser/js/successToast.html":"browser/js/download-banner.html")).appendTo("html")}else"none"===$iframe.css("display")&&"visible"===e.frame_visibility&&$iframe.css({display:"block"})}function injectPersistFrame(e){if("application/pdf"!==document.contentType||e.url.startsWith("file://"))return;const t=e.base64PDF,o={...e};delete o.base64PDF;const n=`message=${encodeURIComponent(JSON.stringify(o))}`,i=GetMenuDimensions("persistent",e);i.width<=0||i.height<=0||(e.base64PDF=t,$newiframe=$("#__acrobatNewDialog__"),0===$newiframe.length&&("dc-cv-fte-pdf-dmb"===e.fteFeatureFlag&&$("embed")[0]&&($("embed")[0].style.top="48px",$("embed")[0].style.transition="top 1s ease 0s"),$newiframe=$("<iframe>").attr("id","__acrobatNewDialog__").css({border:"0px",position:"fixed",top:"150px",right:"15px",left:"unset",height:`${i.height}px`,width:`${i.width}px`,display:"block",margin:"auto",..."dc-cv-fte-pdf-dmb"===e.fteFeatureFlag&&{position:"absolute",top:"0px",right:"0px",left:"unset",height:"48px",width:"100%"}}).attr("src",`${chrome.runtime.getURL("browser/js/frameUI.html")}?${n}`).appendTo("html"),attachZoomPrevention($newiframe)))}function errorOpeningPDF(e){e.panel_op="status",e.current_status="pdf_failure",e.main_op="open_in_acrobat",chrome.runtime.sendMessage(e)}function downloadAuthenticatedPDF(e){const t=new XMLHttpRequest;t.open("GET",e.url,!0),t.responseType="blob",t.onerror=function(t){errorOpeningPDF(e)},t.onload=function(o){let n;t.status<400&&(e.url===t.responseURL||"application/pdf"===t.response.type)?(n=new FileReader,n.onloadend=function(t){e.base64PDF=t.target.result,e.content_op="status",e.current_status="pdf_downloaded",e.main_op="open_in_acrobat",chrome.runtime.sendMessage(e)},n.readAsDataURL(t.response)):errorOpeningPDF(e)},t.send()}function hideErrorTooltip(){errorTooltipTimeout&&(clearTimeout(errorTooltipTimeout),errorTooltipTimeout=null);const e=document.getElementById("__acrobatErrorTooltip__");e&&(e.style.transition="opacity 300ms ease-out",e.style.opacity="0",setTimeout(()=>{e.remove()},300))}function handler(e,t,o){if(!isInvalidContentScript()){if("show_error_toast"!==e.content_op){(e.content_op||e.panel_op||"external_msg"===e.main_op&&e.data?.dc_hosted_event||!0===e.data?.dc_hosted_event?.clearError||"upload-reset"===e.data?.dc_hosted_event?.event||"files-dropped"===e.data?.dc_hosted_event?.event||"files-selected"===e.data?.dc_hosted_event?.event||"conversion-complete"===e.data?.dc_hosted_event?.event||"upload-complete"===e.data?.dc_hosted_event?.event||"file-upload-start"===e.data?.dc_hosted_event?.event||"assets-verified"===e.data?.dc_hosted_event?.event)&&hideErrorTooltip()}if("complete_conversion"===e.content_op&&hideErrorTooltip(),"load-frictionless"===e.panel_op&&"visible"===e.frame_visibility&&widgetState&&(widgetState.iframeReady=!0,widgetState.widgetContainer.style.display="block",widgetState.skeletonShown)){widgetState.iframe.style.opacity="1";const e=widgetState.skeleton;setTimeout(()=>{e.remove()},350),widgetState=null}if("remove_skeleton_on_timeout"===e.content_op&&widgetState&&(widgetState.skeleton&&widgetState.skeleton.remove(),widgetState.iframe&&(widgetState.iframe.style.opacity="1"),widgetState.widgetContainer&&(widgetState.widgetContainer.style.display="block"),widgetState=null),"show_error_toast"===e.content_op&&e.error_message){const t=document.getElementById("__acrobatDialog__");if(t){const o=document.getElementById("__acrobatErrorTooltip__");o&&o.remove();const n=t.parentElement;n&&(n.style.overflow="visible");const i=t.getBoundingClientRect(),r={top:i.top+window.scrollY,left:i.left+window.scrollX},a=i.width,s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("width","18"),s.setAttribute("height","18"),s.setAttribute("viewBox","0 0 18 18"),s.setAttribute("fill","none"),s.setAttribute("xmlns","http://www.w3.org/2000/svg"),s.style.cssText="flex-shrink: 0; margin-top: 2px; margin-right: 8px;";const d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d","M9 1.5C4.86 1.5 1.5 4.86 1.5 9C1.5 13.14 4.86 16.5 9 16.5C13.14 16.5 16.5 13.14 16.5 9C16.5 4.86 13.14 1.5 9 1.5ZM9.75 12.75H8.25V8.25H9.75V12.75ZM9.75 6.75H8.25V5.25H9.75V6.75Z"),d.setAttribute("fill","white"),s.appendChild(d);const c=document.createElement("span");c.style.cssText="color: #FFFFFF; font-family: adobe-clean, 'Helvetica Neue', 'Myriad Pro', sans-serif; font-size: 13px; font-weight: 400; line-height: 18px; overflow-wrap: anywhere;",c.textContent=e.error_message;const l=88,m=16,h=r.top+l-m,p=document.createElement("div");p.style.cssText="position: absolute; left: -8px; top: 16px; width: 0; height: 0; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-right: 8px solid #D7373F;";const u=document.createElement("div");u.id="__acrobatErrorTooltip__";const f=r.left+a+12;u.style.cssText=`position: absolute; top: ${h}px; left: ${f}px; max-width: 160px; width: max-content; background: #D7373F; border-radius: 4px; padding: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); z-index: 2147483647; display: flex; justify-content: flex-start; align-items: flex-start;`,u.appendChild(s),u.appendChild(c),u.appendChild(p),document.body.appendChild(u),errorTooltipTimeout&&clearTimeout(errorTooltipTimeout),errorTooltipTimeout=setTimeout(()=>{hideErrorTooltip()},5e3)}return}if(!e.authenticatedPDF||!0!==e.authenticatedPDF||"pdf_downloading"!==e.current_status){if("dismiss"===e.content_op)if(delete e.content_op,$iframe=$("#__acrobatDialog__"),!0===e.fteUI){if(delete e.fteUI,$fteIframe)return $fteIframe.remove(),void($fteIframe=null)}else if(!0===e.newUI){if(delete e.newUI,$newiframe)return $newiframe.remove(),"dc-cv-fte-pdf-dmb"===e.fteFeatureFlag&&$("embed")[0]&&($("embed")[0].style.top="0px"),void($newiframe=null)}else if(!0===e.downloadBanner){if(delete e.downloadBanner,$iframe)return $iframe.remove(),void($iframe=null)}else if((null!=e.frictionless_workflow||e.forced_cancel)&&(delete e.frictionless_workflow,$iframe)){errorTooltipTimeout&&(clearTimeout(errorTooltipTimeout),errorTooltipTimeout=null);const e=$("#__acrobatWidgetContainer__");e.length>0&&e.remove();const t=document.getElementById("__acrobatSkeleton__");t&&t.remove();const o=document.getElementById("__acrobatErrorTooltip__");return o&&o.remove(),$iframe.remove(),void($iframe=null)}return e.panel_op&&($fteIframe&&$fteIframe.remove(),"load-frictionless"===e.panel_op&&e.pdf_action?("resize_window"===e.content_op?(delete e.content_op,delete e.window_height):injectFrame(e),e.checkSPW&&observeForSPWWidget()):"load-downloadBanner"===e.panel_op?"update-height"===e?.content_op?$iframe.css({height:e.height}):injectBannerInFrame(e):!0!==e.newUI&&!0!==e.persist||(delete e.newUI,injectPersistFrame(e))),!1}downloadAuthenticatedPDF(e)}}isSupportedBrowserVersion()&&isGoogleQuery(docUrl)&&(async()=>{try{const e=await chrome.runtime.sendMessage({main_op:"frictionless-startup",url:docUrl,startup_time:Date.now()});e?.pdf_action&&("resize_window"===e.content_op?(delete e.content_op,delete e.window_height):injectFrame(e),e.checkSPW&&observeForSPWWidget(e.checkSPWSelector))}catch(e){}})(),void 0!==chrome.runtime&&chrome.runtime.onMessage.addListener(handler),"application/pdf"===document.contentType&&chrome.runtime.sendMessage({main_op:"pdf-contentType-event"});