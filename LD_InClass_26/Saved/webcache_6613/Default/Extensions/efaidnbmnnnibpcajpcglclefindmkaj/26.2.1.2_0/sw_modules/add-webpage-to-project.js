/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e}from"../common/analytics.js";import{dcLocalStorage as t}from"../common/local-storage.js";import{loggingApi as a}from"../common/loggingApi.js";import{sendCoiEnabledEvent as o,checkForImsSidCookie as r}from"../common/util.js";import{NEW_RCM_LABEL_FLAG as n,OFFSCREEN_DOCUMENT_PATH as s}from"../common/constant.js";import{common as c}from"./common.js";import{communicate as i}from"./communicate.js";import d from"./ExplicitBlocklist.js";import{floodgate as m}from"./floodgate.js";import{createPerfTracker as l,PERF_MARKERS as g}from"./perf-tracker.js";import{cleanupUsedOrExpiredRequests as u,registerRequestId as p,getRequestContext as f}from"./request-validator.js";import{util as b}from"./util.js";import{CACHE_PURGE_SCHEME as w}from"./constant.js";let I=!1;const h=new Map,E=["documentcloud.adobe.com","acrobat.adobe.com","stage.acrobat.adobe.com","dev.acrobat.adobe.com"];const T=function(){const e="abcdefghijklmnopqrstuvwxyz0123456789.-",t={};for(let a=0;a<38;a++)t[e[a]]="tubg6lxdq8jc1m9-vw.pfhskar0oi5zn372ye4"[a];return t}();export async function ensureAndExtractWebpageHTML(e){const t=await async function(e){try{const t=await chrome.scripting.executeScript({target:{tabId:e},func:async()=>"function"==typeof window.extractWebpageHTML});return t?.[0]?.result}catch(e){return!1}}(e);t||await chrome.scripting.executeScript({target:{tabId:e},files:["content_scripts/extract-webpage-html.js"]}),chrome.scripting.executeScript({target:{tabId:e},func:async()=>(await getExtractWebpageHTML(),window.extractWebpageHTML?.(document))})}async function _({url:e,domain:t}){if(!e&&!t)return!1;try{if(t||(t=new URL(e).hostname),E.includes(t))return!0;const[a=[],o=[]]=await Promise.all([d.getKWBlockList(),d.getExplicitBlocklist()]);return!![...a,...o].includes(function(e){return e.toLowerCase().split("").map(e=>T[e]||e).join("")}(t))}catch(e){return a.error({message:"Error in checking for blocked domain",error:e?.message}),!1}}function x(){!function(){const e=Date.now();h.forEach((t,a)=>{e-(t?.getStartTime?.()||0)>36e5&&h.delete(a)})}(),u()}async function P(){await t.init();if(!await m.hasFlag("dc-cv-add-webpage-to-project"))return!1;const e="false"!==t.getItem("egaf"),o="true"===t.getItem("DISABLE_GENAI_BY_ADMIN"),r=t.getItem("appLocale")||chrome.i18n.getMessage("@@ui_locale"),n=function(){const e=["en-US","en-GB"],o="true"===t.getItem("adobeInternal"),r="dc-cv-add-webpage-to-project";let n={};try{const t=JSON.parse(m.getFeatureMeta(r)||"{}");o&&(n=JSON.parse(m.getFeatureMeta(`${r}-internal`)||"{}"));const a=[...t.allowedLocales??[],...n.allowedLocales??[]];return a.length>0?a:e}catch(t){return a.error({message:"Failed to get AddWebpageToProject allowed locales:",error:t?.message}),e}}().includes(r)||r.startsWith("en");return!(!e||o||!n)}chrome.runtime.onMessage.addListener((e,t,o)=>{const r=e?.main_op;switch(r){case"kw-perf-mark":!function(e){const t=e?.data?.requestId,a=h.get(t);a&&a.mark(e.data.name,e.data.metadata)}(e);break;case"emit-perf-data":!function(e){const t=e?.data?.requestId,o=h.get(t);if(o){const e=o.getPerfTimings();a.info({message:"AddWebpageToProject_PerfTimings",perfTimings:e}),h.delete(t)}}(e)}return!0});const y="addWebpageToNewPdfSpaceContextMenu",W="addWebpageToExistingPdfSpaceContextMenu",M="separatorForPdfSpaceMenu",j="addWebpageToProject";async function k(e,t){const o=e.map(async e=>{try{await chrome.contextMenus.update(e,{visible:t})}catch(t){a.error({message:`Failed to update menu visibility for: ${e}`,error:t?.message})}});await Promise.all(o)}async function L(){let e=!1;try{const t=await P();if(e=await m.hasFlag(n,w.NO_CALL),t&&!I){if(e){await r()?await k([y,W,M],!0):(await k([y],!0),await k([W,M],!1))}else await k([j],!0);I=!0}else!t&&I&&(e?await k([y,W,M],!1):await k([j],!1),I=!1)}catch(t){a.error({message:"Error toggling AddWebpageToProject context menu",error:t?.message,stack:t?.stack,context:{useNewContextMenuLabel:e,menuCreated:I}})}}function A(e){if(document.getElementById("addWebpageToProjectExtnIframe"))return;const{env:t,tabId:a,locale:o,requestId:r,context:n,imsca:s,newContextMenuEnabled:c}=e,i=(e,t={})=>{const a={main_op:"kw-perf-mark",data:{requestId:r,name:e,metadata:t,timestamp:Date.now()}};chrome.runtime.sendMessage(a)};i("AWPP_Extension_Iframe_Creation_Started");const d=window?.matchMedia?.("(prefers-color-scheme: dark)"),m=d?.matches,l=document.createElement("iframe"),g=chrome.runtime.getURL("resources/addWebpage/index.html"),u=new URL(g);u.searchParams.set("env",t),u.searchParams.set("tabId",a),u.searchParams.set("locale",o),u.searchParams.set("requestId",r),u.searchParams.set("context",n),u.searchParams.set("theme",m?"dark":"light"),u.searchParams.set("imsca",s),u.searchParams.set("newCme",c?.toString()||"false"),l.src=u.toString(),l.id="addWebpageToProjectExtnIframe",l.allowFullscreen=!0,l.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        border: none;\n        z-index: 10000;\n        background: rgba(0, 0, 0, 0.1);\n        color-scheme: light;\n    ";const p=()=>{const e=document.getElementById("addWebpageToProjectExtnIframe");e&&(i("AWPP_Extension_Iframe_Removed"),chrome.runtime.sendMessage({main_op:"emit-perf-data",data:{requestId:r}}),window.removeEventListener("message",b),e.style.display="none",setTimeout(()=>{document.body.removeChild(e)},2e3))};l.onload=()=>{i("AWPP_Extension_Iframe_Loaded")},l.onerror=()=>{i("AWPP_Extension_Iframe_Error"),p()},document.body.appendChild(l),i("AWPP_Extension_Iframe_Added_To_Document");const f=new URL(chrome.runtime.getURL("resources/addWebpage/index.html")).origin,b=e=>{if(e.origin!==f)return;const{main_op:t}=e.data;switch(t){case"closeAllIframes":p();break;case"openCollectionTab":chrome.runtime.sendMessage({main_op:"openCollectionTab",data:e.data},e=>{e.closeDialog&&p()});break;case"inPlaceWebpageIngestion":chrome.runtime.sendMessage({main_op:"inPlaceWebpageIngestion",data:e.data.data});break;case"kw-perf-mark":{const{main_op:t,...a}=e.data;chrome.runtime.sendMessage({main_op:t,data:a});break}}};d?.addEventListener?.("change",e=>{i("AWPP_Extension_Iframe_Theme_Changed",{theme:e.matches?"dark":"light"})}),window.addEventListener("message",b),window.addEventListener("beforeunload",()=>{chrome.runtime.sendMessage({main_op:"emit-perf-data",data:{requestId:r}})})}async function v(s,i,d){x();const u=new URL(i.url);o(i.id,{domain:u.hostname,expressTouchpoint:d});const f=`req_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;p(f,d);const b=l({requestId:f});h.set(f,b),b.mark(g.AWPP_CONTEXT_MENU_CLICKED),e.event(e.e.CONTEXT_MENU_ADD_WEB_PAGE_TO_PROJECT,{CONTEXT:d});const I=c.getEnv(),E=t.getItem("appLocale")||chrome.i18n.getMessage("@@ui_locale"),T=await r(),_=await m.hasFlag(n,w.NO_CALL),P={env:I,locale:E,requestId:f,tabId:i.id,context:d,imsca:T,newContextMenuEnabled:_};try{const e=await Promise.race([chrome.scripting.executeScript({target:{tabId:i.id},func:A,args:[P]}),new Promise((e,t)=>{setTimeout(()=>{t(new Error("AddWebpageToProject Extension iframe script execution timeout"))},1e4)})]);if(!e||0===e.length)throw new Error("Script execution returned no results")}catch(e){let t=e?.message;chrome.runtime.lastError&&(t=chrome.runtime.lastError.message),b.mark(g.AWPP_EXTENSION_IFRAME_SCRIPT_EXECUTION_FAILED,{error:t}),a.error({message:"Error in executing AddWebpageToProject Extension iframe script",error:t,requestId:f})}finally{b.mark(g.AWPP_EXTENSION_IFRAME_SCRIPT_EXECUTION_COMPLETED)}}function C(e){v(0,{id:e.tabId,url:e.url},e.context)}async function q(e){const{tabId:t,toastMessage:o,toastType:r}=e;try{const n=chrome.runtime.getURL("dist/ToastManager.js");a.info({message:"[DEBUG] Starting showToastOnTab",tabId:t,toastManagerUrl:n,toastMessage:o,toastType:r});const s=await chrome.scripting.executeScript({target:{tabId:t},func:async(e,t)=>{try{const a=(await import(e)).default,o=t.toastType;return"success"===o?await a.positive(t):"error"===o?await a.negative(t):await a.info(t),{success:!0}}catch(e){return{success:!1,error:e.message,stack:e.stack}}},args:[n,e]});a.info({message:"[DEBUG] ExecuteScript completed",result:s})}catch(e){a.error({message:"Error showing toast on tab",error:e?.message,stack:e?.stack,tabId:t})}}i.registerHandlers({openCollectionTab:async function(e,t,o){try{const{collectionUrl:r,requestId:n,activeTab:s=!0}=e.data||{},c=new URL(r);chrome.tabs.query({url:`${c.origin}${c.pathname}*`,windowId:t?.tab?.windowId},t=>{let c=!1;t?.length>0?chrome.tabs.update(t[0].id,{active:s,url:r}):(c=!0,chrome.tabs.create({url:r,active:s})),o({success:!0,closeDialog:e.data.closeDialog}),a.info({message:"AddWebpageToProject Open project url "+(c?"in new tab":"in existing tab"),requestId:n})}),await ensureAndExtractWebpageHTML(t?.tab?.id)}catch(t){a.error({message:"Error in opening collection tab",error:t?.message,...e.data})}},inPlaceWebpageIngestion:async function(e){try{const{collectionId:t,collectionName:o,requestId:r,tabId:n}=e.data||{},i=f(r),d=await chrome.tabs.get(n);a.info({message:"In-place webpage ingestion started",requestId:r,context:i,tabId:n,collectionId:t}),await ensureAndExtractWebpageHTML(n);q({tabId:n,toastMessage:b.getTranslation("addWebpageToProjectIngestionStarted"),toastType:"info",timeout:5e3});const m=`${s}?env=${c.getEnv()}`;await b.setupOffscreenDocument(m),a.info({message:"Offscreen document ready, creating ingestion iframe with Port API",requestId:r,context:i});const l=await chrome.runtime.sendMessage({main_op:"startKWIngestion",target:"offscreen",collectionId:t,collectionName:o,tabId:n,requestId:r,pageTitle:d.title,extensionId:chrome.runtime.id,context:i});if(a.info({message:"Received response from offscreen",requestId:r,context:i,ingestionResponse:l}),!l)throw new Error("No response received from offscreen");if(l.success){const e=l.collectionName||o,t=`${c.getWelcomePdfUrlHost()}/link/spaces/${l.collectionId}?context=${i}`;a.info({message:"Webpage ingestion completed successfully",requestId:r,context:i,collectionId:l.collectionId,collectionName:e});const s={tabId:n,toastMessage:b.getTranslation("addWebpageToProjectSuccess",[e]),toastType:"success",timeout:3e4,actionLabel:b.getTranslation("addWebpageToProjectViewAction"),actionData:{main_op:"openCollectionTab",data:{collectionUrl:t,requestId:r,closeDialog:!0}}};return await q(s),{success:!0}}a.error({message:"Webpage ingestion failed - error response",requestId:r,context:i,error:l.error});const g={tabId:n,toastMessage:b.getTranslation("addWebpageToProjectFailed"),toastType:"error",timeout:3e4};return await q(g),{success:!1,error:l.error}}catch(t){const o=e.data?.requestId,r=f(o);a.error({message:"Error in handleInPlaceWebpageIngestion",requestId:o,context:r,error:t?.message,stack:t?.stack,...e.data});const n={tabId:e.data?.tabId,toastMessage:b.getTranslation("addWebpageToProjectFailed"),toastType:"error",timeout:3e4};return await q(n),{success:!1,error:t?.message}}}});export{P as isAddWebpageToProjectEnabled,L as toggleAddWebpageToProjectContextMenu,v as handleAddWebpageToProjectContextMenu,C as handleAddWebpageToProjectAction,_ as checkForBlockedDomain};