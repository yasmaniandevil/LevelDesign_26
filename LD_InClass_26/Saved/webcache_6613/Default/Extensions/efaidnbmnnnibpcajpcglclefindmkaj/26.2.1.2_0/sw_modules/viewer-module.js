/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e}from"../common/analytics.js";import{communicate as t}from"./communicate.js";import{util as n}from"./util.js";import{SETTINGS as a}from"./settings.js";import{dcLocalStorage as r}from"../common/local-storage.js";import{downloadManager as o}from"./download-manager.js";import{privateApi as s}from"./private-api.js";import{viewerModuleUtils as i}from"./viewer-module-utils.js";import{checkAndInitialiseWhatsNewAlarm as c}from"./whats-new-handler.js";import{floodgate as l}from"./floodgate.js";import{openLocalFileFTEPrompts as d}from"./ch-context-menu.js";import{offscreenActions as u}from"./offscreen-actions.js";import{CACHE_PURGE_SCHEME as m}from"./constant.js";import{setExperimentCodeForAnalytics as p,removeExperimentCodeForAnalytics as f}from"../common/experimentUtils.js";import{loggingApi as g}from"../common/loggingApi.js";import{checkForBlockedDomain as b,isAddWebpageToProjectEnabled as h}from"./add-webpage-to-project.js";import{getExpressMenuIds as I,isExpressDomainBlocked as E}from"./express/express-context-menu.js";import{checkForImsSidCookie as _}from"../common/util.js";import{NEW_RCM_LABEL_FLAG as v,ONE_DAY_IN_MS as w}from"../common/constant.js";import{pdfRenderingTabNavigatedAwayListener as P}from"../common/pdf-rendering-tracking.js";let C=null,R=chrome.runtime.getURL("viewer.html"),L={},x={};const F=new Map,A={"dc-sp-enable-fab-auto-positioning":"enableFabAutoPositioning","dc-sp-url-hash-scrolling-feature":"enableURLHashScrollingFeature","dc-sp-enable-fab-drag":"enableFabDrag","dc-cv-genai-webpages-master":"","dc-cv-all-domain-tracking":"allDomainTracking","dc-cv-enable-splunk-logging":"","dc-cv-enable-genai-webpages":"","dc-sp-enable-scrolled-content-ingestion":"enableScrolledContentIngestionInGenAI","dc-sp-enable-gen-ai-unlimited-offer":"enableGenAIUnlimitedOffer","dc-cv-enable-paid-content-detection":"enablePaidContentDetection","dc-sp-enable-fab-for-paid-users":"enableFabForPaidUsers","dc-sp-enable-cs-ssr-for-anon":"enableCSSSRForAnon","dc-sp-enable-html-to-pdf-pill":"enableHtmlToPdfPill"};function S(e){if(void 0!==e.responseHeaders){const t=y(e.responseHeaders,"content-length");if(t)return t.value}}const D=e=>{chrome.management.getSelf().then(async t=>{const n=await Promise.all(Object.entries(A).map(([e,t])=>l.hasFlag(e).then(n=>(t&&r.setItem(t,n),[e,n])))),a=Object.fromEntries(n),o=await l.getReleaseVariant("dc-sp-fab-variant");r.setItem("enableReactFab","dc-sp-enable-react-fab"===o),"dc-sp-enable-react-fab"===o?r.setItem("fabVariant","ReactFAB"):"dc-sp-keep-vanilla-fab"===o&&r.setItem("fabVariant","VanillaFAB");const s="true"===r.getItem("adobeInternal"),d=r.getItem("isAdminUser"),u=r.getItem("isGenAIPaidUser");if(chrome.sidePanel){if(s||a["dc-cv-genai-webpages-master"]&&"admin"!==t.installType&&!d){const t=a["dc-cv-enable-genai-webpages"]||u;!r.getItem("enableGenAIFab")&&t&&r.setItem("enableGenAIFab",`${t}`),t?p("EGW"):f("EGW");const{version:n}=chrome.runtime.getManifest();chrome.sidePanel?.setOptions({enabled:!0,tabId:e.tabId,path:`resources/SidePanel/index.html?tabId=${e.tabId}&version=${n}`}),r.setItem("sidePanelRegistered",!0)}else r.setItem("sidePanelRegistered",!1);const n=a["dc-cv-enable-splunk-logging"];i.enableSplunk(n)}try{c()}catch(e){}});const t=l.getFeatureMeta("dc-cv-genai-webpage-blocklist");if(t){const e=JSON.parse(t);r.setItem("genaiWebpageBlockList",e)}const n=l.getFeatureMeta("dc-cv-genai-webpage-regex-blocklist");if(n)try{const e=JSON.parse(n);Array.isArray(e)&&r.setItem("genaiWebpageRegexBlockList",e)}catch(e){}l.hasFlag("dc-cv-all-domain-tracking").then(e=>{r.setItem("allDomainTracking",e)}),chrome.tabs.get(e.tabId,e=>{chrome.runtime.lastError||T(e)})};function M(e){e&&e!==chrome.windows.WINDOW_ID_NONE&&chrome.tabs.query({active:!0,windowId:e},e=>{e.length>0&&T(e[0])})}export function disableContextMenus(e=[]){e.forEach(async e=>{try{await chrome.contextMenus.update(e,{visible:!1})}catch(e){}})}export function enableContextMenus(e=[]){e.forEach(async e=>{try{await chrome.contextMenus.update(e,{visible:!0})}catch(e){}})}async function T(e){if(e.url){const n=new URL(e.url),r=await l.hasFlag(v,m.NO_CALL);a.IS_READER||0==t.version||1==t.version&&0==t.NMHConnStatus||(chrome.runtime.id===n.host?disableContextMenus(["convertPageContextMenu","appendPageContextMenu"]):enableContextMenus(["convertPageContextMenu","appendPageContextMenu"])),chrome.runtime.id!==n.host?(Promise.all([h(),b({url:e.url}),r?_():Promise.resolve(!1)]).then(([e,t,n])=>{e&&!t?r?n?enableContextMenus(["addWebpageToNewPdfSpaceContextMenu","addWebpageToExistingPdfSpaceContextMenu","separatorForPdfSpaceMenu"]):(enableContextMenus(["addWebpageToNewPdfSpaceContextMenu"]),disableContextMenus(["addWebpageToExistingPdfSpaceContextMenu","separatorForPdfSpaceMenu"])):enableContextMenus(["addWebpageToProject"]):disableContextMenus(r?["addWebpageToNewPdfSpaceContextMenu","addWebpageToExistingPdfSpaceContextMenu","separatorForPdfSpaceMenu"]:["addWebpageToProject"])}),E(e.url).then(e=>{e?disableContextMenus(I()):enableContextMenus(I())})):disableContextMenus(r?["addWebpageToNewPdfSpaceContextMenu","addWebpageToExistingPdfSpaceContextMenu","separatorForPdfSpaceMenu"]:["addWebpageToProject"])}}function O(e){const t=new Date;t.setMinutes(t.getMinutes()+a.VIEWER_RECHECK_CDN_ACCESS_DELAY_MINS),r.setItem("netAccAdT",t.getTime()),r.setItem("netAcc",e)}function W(){try{return"true"===r.getItem("pdfViewer")}catch(e){return!1}}function y(e,t){for(let n=0;n<e.length;++n){let a=e[n];if(a.name.toLowerCase()===t)return a}}function N(t){if(void 0!==t.responseHeaders){const n=y(t.responseHeaders,"content-type"),a=y(t.responseHeaders,"content-disposition"),r=t.url&&new URLSearchParams(t.url)?.has("acrobatPromotionSource");if(n){const o=n.value.toLowerCase().split(";",1)[0].trim();if(a&&/^\s*attachment[;]?/i.test(a.value)&&!r)return!1;if("application/pdf"===o)return!0;if("application/octet-stream"===o){if(a&&/\.pdf(["']|$)/i.test(a.value))return e.event(e.e.VIEWER_PDF_PROCESS_OS_CD),!0;t.url.toLowerCase().indexOf(".pdf")>0&&e.event(e.e.VIEWER_PDF_PROCESS_OS_URL)}}}else if("file"==function(e){let t=e.indexOf("/");return e.substr(0,t-1)}(t.url)&&"PDF"==function(e){if(e)try{let t=new URL(e).pathname;return t.substr(t.lastIndexOf(".")+1).toUpperCase()}catch(e){return""}return""}(t.url))return!0;return!1}const U=async(a,r,s)=>{"loading"===r.status&&r.url&&(n.consoleLog("onTabsUpdated",r.url),chrome.tabs.sendMessage(a,{main_op:"rerunGenAiWebpage"}),P(a,r.url,n.isViewerURL));const c=s.incognito;if("complete"===s.status&&T(s),"loading"===r.status){t.loading({id:a});try{if(!n.isViewerURL(s.url))return;const e=i.extractUrlValue("pdfurl",s.url);if(c)return void V(a,e);if(W())return;const t=e?.startsWith(`blob:chrome-extension://${chrome.runtime.id}`),r=i.isTabURLFromExternalTouchPoint(s.url),o=i.isPDFSourceFromWhatsNew(s.url);if(t||r||o)return;V(a,e)}catch(e){}}else if("complete"===r.status){o.newTab(s.url,a);const t=await chrome.extension.isAllowedFileSchemeAccess();s.url.toLowerCase().startsWith("file://")&&s.url.toLowerCase().endsWith(".pdf")&&!t&&(d(s),e.logEventOnce(e.e.LOCAL_FILE_OPENED,{storageKey:"loggedLocalFileEnabled",timePeriod:w}))}void 0!==r.splitViewId&&chrome.tabs.sendMessage(a,{main_op:"updateSplitView",splitViewId:r.splitViewId})};function V(e,t){e&&t&&chrome.tabs.update(e,{url:t})}function j(e){if("GET"!==e.method||!a.VIEWER_ENABLED||!W())return!1;let t=e.url,n=`reloadurl-${e.tabId}`;const o=r.getItem(n),s=r.getItem("nativeFallbackLogging");if(o&&o===t){try{r.removeItem(n)}catch(e){}return!1}const i=N(e);if(!(e=>{if(!e||null===e||"undefined"===e)return!1;let t=[/^chrome\:\/\//,/^chrome\-extension\:\/\//,/^https:\/\/([a-zA-Z\d-]+\.){0,}officeapps.live.com/,/^https\:\/\/*.*\/(saml|login)/,/^https:\/\/sharedcloud.([a-zA-Z\d-]+)+.(s3|s3-accelerate).amazonaws.com/,/^https\:\/\/*.*.\/(login|auth|okta|saml).*\/S*|\/(login|auth|okta|saml|IWA|owa)\//,/^https\:\/\/www.google.com\/search\?q/,/^https\:\/\/www.citibank.*/,/^https:\/\/[^/]*\.*\/([$-/:-?{-~!"^_`\[\]A-Za-z0-9]*)view-sdk/],n=l.getFeatureMeta("dc-cv-invalid-urls");if(n)try{n=JSON.parse(n);for(let e in n)n[e]=new RegExp(n[e]);t=n}catch(e){g.error({message:"Error in parsing dc-cv-invalid-urls meta",error:e})}return!![/^http\:\/\/[^/]/,/^https\:\/\/[^/]/,/^file?:/].find(t=>t.test(e))&&!t.find(t=>t.test(e))})(t)){if(s&&i)try{const e=new URL(t);g.info({message:"PDF URL not supported",url:e.origin+e.pathname})}catch(e){}return!1}return i}function k(e){try{const t=new URL(e.url),n=new URLSearchParams(t.search);let a=!1;const r=e.initiator;return r&&["https://classroom.google.com","https://mail.google.com","https://drive.google.com"].includes(r)&&n.forEach((e,t)=>{t.startsWith("print")&&"true"===e&&(a=!0)}),a}catch(e){return!1}}async function G(t){try{if(await l.hasFlag("dc-cv-disable-mv3-storage-migration",m.NO_CALL))return;if(r.getItem("retryOnNextPage")){await chrome.scripting.executeScript({target:{tabId:t},files:["content_scripts/injectCopyLSIframe.js"]}),await n.sleep(300),e.event(e.e.LOCAL_STORAGE_MIGRATION_RETRYING);const a=await chrome.runtime.sendMessage({main_op:"copy-ls"});chrome.tabs.sendMessage(t,{content_op:"remove-lsCopy"}).catch(()=>null),"succeed"===a&&(e.event(e.e.LOCAL_STORAGE_MIGRATION_RETRYING_SUCCESS),r.removeItem("retryOnNextPage"),Object.assign(r.storage,await chrome.storage.local.get()))}}catch(e){}}const H=($=chrome.runtime.getURL(""),$?.replace(/\/+$/,""));var $;function B(t){t.initiator!==H&&"main_frame"!==t.type&&function(t){if(void 0!==t.responseHeaders){const n=y(t.responseHeaders,"content-type"),a=y(t.responseHeaders,"content-disposition");if(n){const r=n.value.toLowerCase().split(";",1)[0].trim();if("application/pdf"===r)return e.event(e.e.VIEWER_PDF_DETECT_EMBED_PDF_TYPE_PDF),!0;if("application/octet-stream"===r){if(a&&/\.pdf(["']|$)/i.test(a.value))return e.event(e.e.VIEWER_PDF_DETECT_EMBED_PDF_OCTET_CD),!0;if(new URL(t.url).pathname.toLowerCase().endsWith(".pdf"))return e.event(e.e.VIEWER_PDF_DETECT_EMBED_PDF_OCTET_URL),!0}}}return!1}(t)&&e.event(e.e.VIEWER_PDF_DETECT_EMBED_PDF)}function q(t){s.isMimeHandlerAvailable().then(async o=>{const{tabId:s}=t;if(await G(s),r.getItem("sessionStarted")||(r.setItem("sessionId",n.uuid()),r.setItem("sessionStarted",!0)),!o){let r=n.parseExtensionURL(t.url);if(r){r=R+"?pdfurl="+r+"&tabId="+s+"&aw=true";let n=t.url.indexOf("#");n>0&&(r+=t.url.slice(n)),a.VIEWER_ENABLED&&W()&&e.event(e.e.VIEWER_EXTN_PDF_OPENED,{tabURL:r}),chrome.tabs.update(s,{url:r})}}})}function z(t){try{l.hasFlag("dc-cv-enable-webpage-domain-tracking",m.NO_CALL).then(n=>{if(n&&"main_frame"===t.type){const n=new URL(t.url).hostname;(a=t.tabId,new Promise(e=>{x[a]=e})).then(t=>{e.event(e.e.VIEWER_PDF_WEBPAGE_OPENED,{domain:n,hasPDFLink:t})})}var a})}catch(e){}}function K(a,o){s.isMimeHandlerAvailable().then(async s=>{r.getItem("sessionStarted")||(r.setItem("sessionId",n.uuid()),r.setItem("sessionStarted",!0));const{tabId:c}=a;if(s){const e=k(a),t=a.tabId;t>-1&&(L[t]={isGooglePrint:e})}else{if("main_frame"===a.type){if(await G(c),!function(){const e=new Date,t=r.getItem("netAcc"),n=r.getItem("netAccAdT");return!(n&&n>e.getTime())||t}()||!j(a))return;if(o&&!await chrome.extension.isAllowedFileSchemeAccess())return void e.event(e.e.VIEWER_PDF_LOCAL_FILE_IGNORED);C=a.url,o&&e.event(e.e.VIEWER_PDF_LOCAL_FILE),i.updateVariables(t.version),i.fetchAndUpdateVersionConfig();let{viewerURL:n,acceptRanges:s}=function(e){let t=R,n=!1;if(t+="?pdfurl="+encodeURIComponent(e.url),t+="&tabId="+e.tabId,void 0!==e.responseHeaders){const a=S(e);a&&(t+="&clen="+a);const r=y(e.responseHeaders,"accept-ranges");r&&r.value&&"bytes"===r.value.toLowerCase()&&!k(e)&&(t+="&chunk=true",n=!0);const o=y(e.responseHeaders,"content-disposition");if(o&&o.value&&/\.pdf(["']|$)/i.test(o.value)){const e=/filename[^;=\n\*]?=((['"]).*?\2|[^;\n]*)/.exec(o.value);null!=e&&e.length>1&&(t+="&pdffilename="+e[1].replace(/['"]/g,""))}}return k(e)&&(t+="&googlePrint=true"),{viewerURL:t,acceptRanges:n}}(a);e.event(e.e.VIEWER_EXTN_PDF_OPENED,{tabURL:C});const l=S(a),d=void 0!==l?Number(l):l;k(a)||u.setupWorkerOffscreen({tabId:c,pdfURL:a.url,pdfSize:d,acceptRanges:s});for(let e=0;e<20;e++)try{await chrome.tabs.update(c,{url:n})}catch(e){}}"sub_frame"===a.type&&function(e){return/^https:\/\/[^/]*(acrobat|adobe)\.com\/dc-chrome-extension/.test(e)}(a.url)&&(200!==a.statusCode?403===a.statusCode?(r.setItem("pdfViewer","false"),e.event(e.e.VIEWER_FALLBACK_TO_NATIVE_CDN_FORBIDDEN,{tabURL:a.url}),V(a.tabId,C)):(O(!1),e.event(e.e.VIEWER_FALLBACK_TO_NATIVE_CDN_OFFLINE,{tabURL:a.url}),V(a.tabId,C)):O(!0))}})}function Y(e){try{if(!r.getItem("ignorePrefetchRequests"))return!1;if(F.size>200)return F.clear(),!1;const t=`${e.tabId}_${e.requestId}`,n=F.get(t);if(n){if(n===e.url)return F.delete(t),!0;F.delete(t)}return!1}catch(e){return!1}}function J(e){try{if(!r.getItem("ignorePrefetchRequests"))return;const t=e.requestHeaders||[];if(t.some(e=>{const t=e.name.toLowerCase(),n=e.value.toLowerCase();return("purpose"===t||"sec-purpose"===t)&&n.includes("prefetch")})){const t=`${e.tabId}_${e.requestId}`;F.set(t,e.url)}}catch(e){}}function Z(e){try{if(!r.getItem("ignorePrefetchRequests"))return;const t=[];for(const[n,a]of F.entries())n.startsWith(`${e}_`)&&t.push(n);t.forEach(e=>F.delete(e))}catch(e){}}t.registerHandlers({"check-is-google-print":function(e,t,n){return L&&L[e.tabId]?n({isGooglePrint:L[e.tabId].isGooglePrint}):n({isGooglePrint:!1})},"resolve-has-pdf-promise":({hasPDFLink:e,tabId:t})=>function(e,t){const n=x[t];n&&(n(e),delete x[t])}(e,t)});export{K as processRequest,q as honorRequest,D as onTabActivated,U as onTabsUpdated,B as detectEmbeddedPDF,z as logWebpageDomain,Y as handlePrefetchValidation,J as detectAndStorePrefetch,Z as cleanupPrefetchForTab,M as onWindowFocusChanged};