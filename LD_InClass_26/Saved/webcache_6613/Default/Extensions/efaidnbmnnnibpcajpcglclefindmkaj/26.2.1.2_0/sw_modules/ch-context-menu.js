/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{communicate as e}from"./communicate.js";import{util as t}from"./util.js";import{analytics as o,events as n}from"../common/analytics.js";import{SETTINGS as a}from"./settings.js";import{dcLocalStorage as i,dcSessionStorage as s}from"../common/local-storage.js";import{floodgate as r}from"./floodgate.js";import{privateApi as l}from"./private-api.js";import{common as c}from"./common.js";import{userSubscription as m}from"./user-subscription.js";import{userDetailsAcrobat as d}from"./acrobatUserDetails.js";import{performSyncToAsyncStorageMigration as g,performAsyncStorageCleanup as I}from"./storage-migration.js";import{downloadBannerExcludeList as u,LOCAL_FTE_WINDOW as h,ONE_DAY_IN_MS as p,POPUP_CONTEXT as f}from"../common/constant.js";import{CACHE_PURGE_SCHEME as w,EXPRESS as L}from"./constant.js";import{versionChecks as E}from"./handleVersionChecks.js";import{fetchCombinationOfLocalFilePromptCooldownConfig as _,fetchLocalFileAccessAndSummaryCoachmarkCooldownConfig as C}from"../common/util.js";import{loggingApi as A}from"../common/loggingApi.js";import{offscreenActions as S}from"./offscreen-actions.js";import{viewerModuleUtils as O}from"./viewer-module-utils.js";import{indexedDBScript as F}from"../common/indexDB.js";import{llmUtil as N}from"./llm-util.js";import{floodgateMigration as T}from"./floodgateMigration.js";import{removeExperimentCodeForAnalytics as v,setExperimentCodeForAnalytics as D}from"../common/experimentUtils.js";import b from"./dynamic-tab-context-manager.js";import{clearEventsFromLocalStorage as P}from"./analytics-event-cleanup.js";import{createContextMenu as y,contextMenuOnClickHandler as R}from"./context-menu-manager.js";let M,U,B,W,k=new Promise(function(e){W=e});const V={},G=()=>(M||(M=(async()=>{let e;try{const t=`https://chromewebstore.google.com/detail/*/${chrome.runtime.id}*`,o=`https://microsoftedge.microsoft.com/addons/detail/*/${chrome.runtime.id}*`,n=new Promise(t=>{e=setTimeout(()=>t(null),1500)}),a=chrome.tabs.query({url:[t,o]}).catch(()=>null),i=await Promise.race([a,n]);return Array.isArray(i)&&(B=void 0,U=void 0,i.some(e=>{const t=new URLSearchParams(new URL(e.url).search);return!!t.has("mv")&&(B=e,U={},Array.from(t.entries()).forEach(([e,t])=>{null==U[e]&&(U[e]=t)}),!0)})),U||null}catch(e){return null}finally{e&&clearTimeout(e)}})()),M),x="Error in Local File Prompt";async function j(){!async function(){const[e,t]=await Promise.all([chrome.tabs.query({url:"https://mail.google.com/*"}),chrome.tabs.query({url:"https://drive.google.com/*"})]);e?.length>0&&o.event("DCBrowserExt:ExtensionUpdate:Gmail:Open"),t?.length>0&&o.event("DCBrowserExt:ExtensionUpdate:GDrive:Open")}();for(const e of chrome.runtime.getManifest().content_scripts){const t=await chrome.tabs.query({url:e.matches});for(const o of t)(o.url.includes("mail.google.com")||o.url.includes("drive.google.com"))&&(e.css&&chrome.scripting.insertCSS({files:e.css,target:{tabId:o.id}}),chrome.scripting.executeScript({files:e.js,target:{tabId:o.id,allFrames:e.all_frames}}))}}async function H(e,t){try{const o=e?.reason===chrome.runtime.OnInstalledReason.INSTALL,n=await r.hasFlag(`dc-cv-${t}-implicit-default-viewership`)||await r.hasFlag(`dc-cv-${t}-implicit-default-viewership-control`);if(o&&n){D({gmail:"GIDN",gdrive:"GDIN"}[t])}}catch(e){}}async function $(e){try{chrome.sidePanel?.setOptions({enabled:!1}),i.getItem("anonUserUUID")||c.createAnonUserUUID(),e&&(e.reason===chrome.runtime.OnInstalledReason.UPDATE&&e.previousVersion!==chrome.runtime.getManifest().version?(t.verCmp(e.previousVersion,"15.1.3.30")<0&&await async function(){let e;try{if(await r.hasFlag("dc-cv-disable-mv3-storage-migration",w.NO_CALL))return;const o=await chrome.tabs.query({});await Promise.allSettled(o.map(({id:e})=>chrome.scripting.executeScript({target:{tabId:e},files:["content_scripts/injectCopyLSIframe.js"]}))),await t.sleep(300),e=await chrome.runtime.sendMessage({main_op:"copy-ls"}),o.map(({id:e})=>chrome.tabs.sendMessage(e,{content_op:"remove-lsCopy"}).catch(()=>null))}catch(e){}finally{"succeed"!==e?(i.setItem("retryOnNextPage",!0),o.event(o.e.LOCAL_STORAGE_MIGRATION_FAILED)):o.event(o.e.LOCAL_STORAGE_MIGRATION_SUCCESS)}}(),i.getItem("installVersion")||i.setItem("installVersion",e.previousVersion),i.setItem("installType",e.reason),i.getItem("thirdPartyCookieChecked")&&i.removeItem("thirdPartyCookieChecked"),i.getItem("tpcBlockAnalyticsEnable")&&i.removeItem("tpcBlockAnalyticsEnable"),i.getItem("startupNewEventLastLogged")&&i.removeItem("startupNewEventLastLogged"),i.getItem("offlineSupportDisable")&&i.removeItem("offlineSupportDisable")):e.reason===chrome.runtime.OnInstalledReason.INSTALL&&(G(),i.setItem("installVersion",chrome.runtime.getManifest().version),i.setItem("installType",e.reason))),k.then(({env:n,msg:s})=>{const r=i.getItem("installSource");if(i.setItem("installSource",n.installType),H(e,"gmail"),H(e,"gdrive"),t.checkOS().then(()=>{c.registerUninstallUrl()}),F.clearExpiredBlobBuffers()?.catch(e=>{A.error({message:"Failed to clear old file buffer entries on startup",error:e})}),F.clearFileHashOldEntries()?.catch(e=>{A.error({message:"Failed to clear old blob cache entries on startup",error:e})}),"true"===s.repromptDone&&o.event(o.e.EXTENSION_REPROMPT_TRACKING,{REASON:e.reason,TYPE:n.installType}),e.reason===chrome.runtime.OnInstalledReason.UPDATE&&e.previousVersion!==chrome.runtime.getManifest().version)j(),T.init(),o.event(o.e.EXTENSION_UPDATE,{installReason:e.reason,previousVersion:e.previousVersion||"none"}),K(n,!0,r);else if(e.reason===chrome.runtime.OnInstalledReason.INSTALL||e.previousVersion===chrome.runtime.getManifest().version){switch(j(),o.event(o.e.EXTENSION_INSTALLED,{installReason:e.reason,previousVersion:e.previousVersion||"none"}),o.logEventOnce(o.e.EXTENSION_INSTALLED_NEW,{storageKey:"installAnalyticsLogged",installReason:e.reason,previousVersion:e.previousVersion||"none"}),n.installType){case"admin":o.event(o.e.EXTENSION_INSTALLED_ADMIN);break;case"development":o.event(o.e.EXTENSION_INSTALLED_DEVELOPMENT);break;case"other":o.event(o.e.EXTENSION_INSTALLED_OTHER);break;case"normal":l.isInstalledViaUpsell().then(e=>{if(e)o.event(o.e.EXTENSION_INSTALLED_UPSELL);else{o.event(o.e.EXTENSION_INSTALLED_DIRECT);G().then(e=>{const t=e?.mv||"store_direct";o.event(o.e.EXTENSION_INSTALLED_SOURCE,{SOURCE:t})})}});break;case"sideload":{o.event(o.e.EXTENSION_INSTALLED_SIDE_LOADED);const e=`${s.installMonth||"None"}-${s.installYear||"None"}`;o.event(o.e.EXTENSION_INSTALLED_SIDE_LOADED_MONTH_YEAR,{sideloadInstallDate:e}),a.IS_READER&&o.event(o.e.EXTENSION_INSTALLED_SIDE_LOADED_SOURCE,{SOURCE:s.source});break}default:o.event(o.e.EXTENSION_INSTALLED_DEFAULT)}K(n)}})}catch(e){}}function Y(){try{if(navigator.onLine){const e=i.getItem("pdfViewer"),t=i.getItem("killSwitch"),n=i.getItem("cdnUrl");"false"===e&&"on"===t&&async function(e){const t=new AbortController,o=t.signal;let n=!1;setTimeout(()=>{n||t.abort()},5e3);const a=await fetch(e,{signal:o});if(n=!0,200===a.status)return await a.text();return new Error(a.statusText)}(n).then(e=>{-1===e.toString().indexOf("<meta name='killSwitch' content='off'/>")&&-1===e.toString().indexOf('<meta name="killSwitch" content="off"/>')||(i.setItem("pdfViewer",!0),l.setViewerState("enabled"),i.setItem("killSwitch","off"),o.event(o.e.VIEWER_KILL_SWITCH_OFF_SUCCESS))}).catch(e=>{o.event(o.e.VIEWER_KILL_SWITCH_OFF_FAILED)})}}catch(e){o.event(o.e.VIEWER_KILL_SWITCH_OFF_FAILED)}}async function X(e,t){chrome.tabs.sendMessage(t.id,{type:"removeActionableCoachmark"}),i.setItem("touchpoint",e.touchpoint),o.event(`${o.e.OPEN_SIDE_PANEL_RECIEIVED}:${e.touchpoint||"Unspecified"}`);try{await(chrome.sidePanel?.open({tabId:t.id})),A.info({message:"Opening sidepanel success",touchpoint:e.touchpoint})}catch(t){A.error({message:"Opening sidepanel failed",error:t.toString(),touchpoint:e.touchpoint})}}function K(e,n=!1,a=!1){"false"!==i.getItem("fte")&&(n&&i.getItem("pdfViewer")||(i.getItem("installTimestamp")||i.setItem("installTimestamp",Date.now()),setTimeout(()=>{chrome.storage.managed.get("OpenHelpx",async s=>{let r=!s||"false"!==s.OpenHelpx;try{const e=await G();"suppress"===e?.fte&&(r=!1,o.event(o.e.VIEWER_FTE_SUPPRESSED_VIA_STORE_PARAM,{MV:e?.mv||"unknown"}),B?.id&&B?.url&&chrome.tabs.remove(B.id).catch(()=>null))}catch(e){}o.event(r?o.e.VIEWER_FTE_OPEN_HELPX_ENABLED:o.e.VIEWER_FTE_OPEN_HELPX_DISABLED),n&&o.event(o.e.USE_ACROBAT_DEF_OWNERSHIP_ON_UPDATE),function(){try{i.getItem("pdfViewer")||(i.setItem("viewer-enabled-source","ownership-install"),i.setItem("pdfViewer","true"),l.setViewerState("enabled"),t.isEdge()?(m.initiateUserPolling(),o.event(o.e.USE_ACROBAT_IN_EDGE_AUTO_ENABLED)):o.event(o.e.USE_ACROBAT_IN_CHROME_AUTO_ENABLED))}catch(e){o.event(o.e.LOCAL_STORAGE_DISABLED)}}(),i.setItem("fte","false"),a&&(r=!1);const d=t.isEdge()&&("admin"===e.installType||"sideload"===e.installType);r&&!d&&async function(){let e=chrome.i18n.getMessage("@@ui_locale");["ca","da","en_GB","es","fi","hr","it","ko","nl","pt_BR","ru","sl","tr","zh_CN","cs","de","en_US","eu","fr","hu","ja","nb","pl","ro","sk","sv","uk","zh_TW"].includes(e)||(e="en_US");const o=t.isEdge()?"Edge":"Chrome";return`${c.getWelcomePdfUrlHost()}/dc-chrome-extension/mv/${e}/Acrobat-for-${o}.pdf`}().then(e=>t.createTab(e,e=>{const t=(new Date).getTime();V={...e,timestamp:t},chrome.tabs.onUpdated.addListener(function t(n,a){e.id==n&&"complete"===a.status&&(o.event(o.e.WELCOME_PDF_LOADED),chrome.tabs.onUpdated.removeListener(t))})}))})},2e3)))}function q(){const e="true"===i.getItem("pdfViewer")?"enabled":"disabled";l.setViewerState(e)}function z(e){const t=e.UsageMeasurement,o=t&&"false"===t.newValue?"false":"true";i.setItem("ANALYTICS_OPT_IN_ADMIN",o)}function J(){const e=i.getItem("pdfViewer");let t="neverTaken";return"true"===e?t="enabled":"false"===e&&(t="disabled"),t}async function Z(e){const t=i.getItem("localFileConfig");t?e&&!t?.localFilePermission&&function(e,t){Q(t?.promptCount>0?o.e.LOCAL_FILE_PROMPT_ACCESS_ALREADY_GRANTED:o.e.LOCAL_FILE_PROMPT_NO_SHOW_ACCESS_GRANTED);t.localFilePermission=e,i.setItem("localFileConfig",t)}(e,t):async function(e){const t=await Ee(),o={promptCount:0,localFilePermission:e,eligibleDate:new Date(Date.now()).toISOString()};i.setItem("localFileConfig",o),function(e){if("localFileFte"===e)return;let t;switch(e){case"localFileAccessAndSummaryCoachmark":t="LSC";break;case"combinationOfLocalFilePrompt":t="CLP";break;case"localFilePrompt":case"localFileBlockingPrompt":case"localFileFteControl":return;default:A.error({message:x+`setLocalFilePromptExperimentAnalyticsCode: Invalid localFileCohort ${e}`})}D(t)}(t)}(e)}function Q(e){if(!e)return;const t=new Date,n=`${t.getUTCFullYear()}${(t.getUTCMonth()+1).toString().padStart(2,"0")}`;chrome.storage.local.get([e],t=>{const a=t[e]?.lastSentYearMonth;(!a||n>a)&&(o.event(e),chrome.storage.local.set({[e]:{lastSentYearMonth:n}}))})}function ee(){const e=i.getItem("settingsWindow");e&&(chrome.tabs.remove(e?.id),i.removeItem("settingsWindow"));const t=chrome.runtime.getURL("browser/js/options.html");chrome.tabs.query({url:t+"*"},e=>{e?.length>0&&chrome.tabs.update(e[0].id,{active:!0})})}async function te(){try{const e=await chrome.extension.isAllowedFileSchemeAccess();await Z(e),(async()=>{await r.hasFlag("dc-cv-show-animation-on-settings",w.NO_CALL)&&D("LFS")})(),(async()=>{await r.hasFlag("dc-cv-combination-of-local-file-prompt",w.NO_CALL)?(D("CLP"),["LSC","LSC1","LSC2","LSC3"].forEach(v)):["CLP","CLP1","CLP2"].forEach(v)})(),(async()=>{await r.hasFlag("dc-cv-local-file-access-and-summary-coachmark",w.NO_CALL)?(D("LSC"),["CLP","CLP1","CLP2"].forEach(v)):["LSC","LSC1","LSC2","LSC3"].forEach(v)})();const{tabId:t,url:a}=i.getItem("localFileFteData");i.removeItem("localFileFteData");const s=i.getWithTTL("LocalFileAccessTouchpointsFromViewer");i.removeItem("LocalFileAccessTouchpointsFromViewer");const l=i.getWithTTL("LFATFromOptionsPage");i.removeItem("LFATFromOptionsPage");const c=i.getWithTTL("downloadBanner");i.removeItem("downloadBanner");const m=i.getWithTTL("LocalFileAccessBannerChallengerTouchpointsFromViewer");i.removeItem("LocalFileAccessBannerChallengerTouchpointsFromViewer");const d=i.getWithTTL("LocalFileAccessBannerControlTouchpointsFromViewer");if(i.removeItem("LocalFileAccessBannerControlTouchpointsFromViewer"),e){try{const{url:e}=t?await chrome.tabs.get(t):{};(t&&e&&e===a||s||c||l)&&(s?function(e,t){o.event(n.LOCAL_FILE_ACCESS_TOUCHPOINT_PERMISSION_GRANTED),e?o.event(n.LOCAL_FILE_ACCESS_BANNER_CHALLENGER_TOUCHPOINT_PERMISSION_GRANTED):t&&o.event(n.LOCAL_FILE_ACCESS_BANNER_CONTROL_TOUCHPOINT_PERMISSION_GRANTED)}(m,d):c?await async function(){o.event(n.DOWNLOAD_BANNER_PERMISSION_GRANTED);const e=i.getItem("lastOpenTabId");await chrome.scripting.executeScript({target:{tabId:e},files:["content_scripts/injectBannerIframe.js"]}),chrome.tabs.sendMessage(e,{panel_op:"load-downloadBanner",showToast:!0}),o.event(n.DOWNLOAD_BANNER_TOAST_SHOWN),setTimeout(()=>{chrome.tabs.sendMessage(e,{content_op:"dismissBanner"})},5e3)}():o.event(n.LOCAL_FTE_PERMISSION_GRANTED),oe())}catch(e){}Q(n.LOCAL_FILE_PERMISSION_GRANTED),await async function(){const e=await chrome.tabs.query({url:"file:///*"});for(let t in e){const{id:o,url:n}=e[t];n.toLowerCase().endsWith(".pdf")&&chrome.tabs.reload(o)}}(),function(e,t){const o=i.getItem("settingsWindow");o&&!e&&(chrome.tabs.remove(o?.id),i.removeItem("settingsWindow"),setTimeout(()=>{t&&chrome.tabs.sendMessage(t,{content_op:"showLocalFileAccessToast",action:o?.action})},2e3))}(s,t),l&&(o.event(n.LOCAL_FILE_OPTIONS_PAGE_PERMISSION_GRANTED),ee())}else l&&(o.event(n.LOCAL_FILE_OPTIONS_PAGE_PERMISSION_DISABLED),oe(),ee()),i.removeItem("loadedTabsInfo")}catch(e){A.error({message:x+`checkLocalFileAccess: Error checking local file access permissions: ${e}`})}}function oe(){const e=i.getItem("loadedTabsInfo");let t=e?.tabsInfo||[];if(t.length){const e=i.getItem("lastOpenTabId");i.removeItem("lastOpenTabId"),o.event(o.e.REOPENED_TABS_ON_LOCAL_FILE_ACCESS),t=t.sort((e,t)=>e.index-t.index);const n=[];let a={},s={};t.forEach(e=>{const t=e.url||e.pendingUrl;t.includes("file:///")||n.push(chrome.tabs.create({url:t,index:e.index,active:!1,windowId:e.windowId}))}),Promise.allSettled(n).then(o=>{o.forEach((o,n)=>{if(o.reason&&o.reason?.message?.includes("No window with id")){A.error({message:"Error in reopening tab",error:o.reason?.message});const e=t[n].windowId,i=t[n].url;a[e]=a[e]?[...a[e],i]:[i]}e&&o?.value?.id&&(s[o.value.id]=t[n].id,e===t[n].id&&setTimeout(()=>{chrome.tabs.highlight({tabs:o.value.index,windowId:o.value.windowId});const e=i.getItem("settingsWindow");e&&(chrome.tabs.remove(e?.id),i.removeItem("settingsWindow"),chrome.tabs.sendMessage(o.value.id,{content_op:"showLocalFileAccessToast",action:e?.action}))},2e3))}),i.setItem("tabIdMap",s);for(const o in a)chrome.windows.create({url:a[o],focused:!1}).then(n=>{if(e){for(const a of n.tabs){const n=a.url||a.pendingUrl;s[a.id]=t.find(e=>e.url===n&&e.windowId===Number(o))?.id,s[a.id]===e&&setTimeout(()=>{chrome.tabs.highlight({tabs:a.index,windowId:a.windowId});const e=i.getItem("settingsWindow");e&&(chrome.tabs.remove(e?.id),i.removeItem("settingsWindow"),chrome.tabs.sendMessage(a.id,{content_op:"showLocalFileAccessToast",action:e?.action}))},2e3)}i.setItem("tabIdMap",s)}})}),i.removeItem("loadedTabsInfo")}}function ne(){const e={LEGACY:"acrobat-gsuite-touch-points",OLD:"acrobat-touch-points-in-other-surfaces",PARENT:"show-acrobat-shortcuts-master-switch",INDIVIDUAL:["acrobat-touch-point-in-gmail","acrobat-touch-point-in-gdrive","acrobat-touch-point-in-outlook","acrobat-touch-point-in-linkedin","acrobat-touch-point-in-google-docs"]},t=e=>{const t=i.getItem(e);return t&&""!==t&&null!=t};if(t(e.LEGACY)&&!t(e.OLD)&&(i.setItem(e.OLD,i.getItem(e.LEGACY)),i.removeItem(e.LEGACY)),t(e.OLD)&&!t(e.PARENT)&&!e.INDIVIDUAL.some(e=>t(e))){const t=i.getItem(e.OLD);i.setItem(e.PARENT,t),o=t,e.INDIVIDUAL.forEach(e=>i.setItem(e,o))}var o}async function ae(n){O.setCommonItems(),O.initializeViewerVariables(e.version),(async()=>{i.getItem("appLocale")||i.setItem("appLocale",i.getItem("viewer-locale")||t.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale")))})(),ne(),l.isMimeHandlerAvailable().then(e=>{e?s.getItem("startupComplete")||t.mimeReloadAllTabs():te()}),g(),async function(){try{await r.hasFlag("dc-cv-new-preferences",w.NO_CALL)&&i.setItem("always-show-pdf-menu","true")}catch(e){console.error("Error setting always-show-pdf-menu:",e)}}(),setTimeout(q,1e4),function(){try{t.isEdge()&&i.setItem("IsRunningInEdge","true")}catch(e){}}(),async function(){if(!i.getItem("ANALYTICS_OPT_IN_ADMIN")){const e=await chrome.storage.managed.get("UsageMeasurement"),t=e&&"false"===e.UsageMeasurement?"false":"true";i.setItem("ANALYTICS_OPT_IN_ADMIN",t)}}(),async function(){const e=await chrome.storage.managed.get("DisableGenAI"),t=e&&"true"===e.DisableGenAI?"true":"false";i.setItem("DISABLE_GENAI_BY_ADMIN",t)}(),async function(){const e=await chrome.storage.managed.get("DisableWhatsNewAutoOpen"),t="true"===e?.DisableWhatsNewAutoOpen,o=i.getItem("whatsNewState")||{};i.setItem("whatsNewState",{...o,disableAutoOpenByAdmin:t})}(),P();const c=await E(),{repromptDone:m,pdfOwner:I,isAcrobatInstalled:u,isReaderInstalled:h}=c??{};r.hasFlag("dc-cv-adobe-yolo",w.NO_CALL).then(e=>{e&&a.ADOBE_YOLO_ENABLED&&!i.getWithTTL("adobe-yolo-freeze")&&d.updateUserDetails()}),W({env:n,msg:c}),N.checkAndLogGeminiNanoModel(),s.getItem("startupComplete")||(Y(),y(c.ver),"true"!==m&&!0!==m||o.logEventOnce(o.e.ENABLED_AFTER_READER_REPROMPT,{storageKey:"repromptAnalyticsLogged"}),setTimeout(()=>{i.getItem("firstTimeStartup")?i.setItem("firstTimeStartup","false"):i.setItem("firstTimeStartup","true"),o.event(o.e.EXTENSION_STARTUP,{ownershipStatus:J(),pdfOwner:I,isAcrobatInstalled:u,isReaderInstalled:h})},5e3),s.setItem("startupComplete",!0),async function(){if("true"!==i.getItem("pdfViewer"))return!1;const e=Date.now();let t=6048e5;const o="dc-cv-offscreen-wp-grace-period";if(!await r.hasFlag(o,w.NO_CALL))return!0;const n=r.getFeatureMeta(o);if(n)try{const e=JSON.parse(n);e.gracePeriod&&(t=parseInt(e.gracePeriod,10))}catch(e){}const a=parseInt(i.getItem("lastPdfOpenTimestamp"),10);return a?e-a<=t:(i.setItem("lastPdfOpenTimestamp",e),!0)}().then(e=>{e&&S.setupWorkerOffscreen({startup:!0})}))}function ie(e){const{id:t,timestamp:n}=V,a=(new Date).getTime();e===t&&a-n<=15e3&&o.event(o.e.WELCOME_PDF_TAB_CLOSED);const s=i.getItem("signInExperimentShown");if(s){const{currTabId:t,timestamp:n}=JSON.parse(s),r=a-n,l="true"===i.getItem("signInExperimentSuppressed");e===t&&r<=15e3&&!l&&o.event(o.e.SIGN_IN_PROMPT_TAB_CLOSED),i.removeItem("signInExperimentShown"),i.removeItem("signInExperimentSuppressed")}}const se=e=>{const{height:t,width:o}=h;return{height:t,width:o,top:Math.round(.5*(e.height-t)+e.top),left:Math.round(.5*(e.width-o)+e.left)}},re=e=>{const t=Math.min(Math.round(.8*e.height),900),o=Math.min(Math.round(.9*e.width),1550);return{height:t,width:o,top:Math.round(.5*(e.height-t)+e.top),left:Math.round(.5*(e.width-o)+e.left)}},le=async({windowId:e})=>{const t=await chrome.windows.get(e);if("fullscreen"===t?.state||"locked-fullscreen"===t?.state)return;const{tabId:o,url:n}=i.getItem("localFileFteData"),[a]=await chrome.tabs.query({currentWindow:!0,active:!0}),s=i.getItem("localFteWindow");if(a&&a.id===o&&a.url===n){let{height:e,width:o,top:n,left:a}=se(t);"localFilePrompt"===await Ee()&&({height:e,width:o,top:n,left:a}=re(t)),await chrome.windows.update(s?.id,{height:e,width:o,left:a,top:n,focused:!0})}},ce=async e=>{const t=await Ee();switch(t){case"localFileAccessAndSummaryCoachmark":Ie(e);break;case"combinationOfLocalFilePrompt":fe(e);break;case"localFilePrompt":we(e);break;case"localFileBlockingPrompt":Le(e);break;case"localFileFteControl":case"localFileFte":Ae(e,t);break;default:A.error({message:x+"openLocalFileFTEPrompts: No Valid local file prompt found"})}},me=e=>{const t=i.getItem("localFileConfig");return!t||!t.localFilePermission&&(e.promptLimit>t.promptCount&&t.eligibleDate<=new Date(Date.now()).toISOString())},de=(e,t=!1)=>{try{let o=i.getItem("localFileConfig");o?t||(o.promptCount=o.promptCount+1):o={promptCount:1},o.eligibleDate=(e=>{const t=Number(e);return isNaN(t)&&A.error({message:x+`_getLocalFilePromptCooldown: cooldownConfig.settingsCoolDown must be a valid number: ${e}`}),new Date(Date.now()+t*p).toISOString()})(e),i.setItem("localFileConfig",o)}catch(e){A.error({message:x+`updateLocalFilePromptCooldown: Error updating local file prompt cooldown: ${e}`})}},ge=async()=>{let e;try{e=await r.getFeatureMeta("dc-cv-local-file-permission-prompt"),e=JSON.parse(e)}catch(t){e={promptLimit:5,ignoreCoolDown:7,settingsCoolDown:7,dismissCoolDown:7}}return e},Ie=async e=>{try{const t=i.getItem("localFileConfig")||{},n=await C();if(!me(n))return;if(!t.onceBlockingPromptShown)return["LSC2","LSC3"].forEach(v),D("LSC1"),void he(e,n,o.e.LOCAL_FILE_BLOCKING_SUMMARY_COMBINATION_SHOWN);if(await(async()=>{const e="false"!==i.getItem("egaf"),t="true"===i.getItem("genAIEligible"),o="true"===(await chrome.storage.managed.get("DisableGenAI"))?.DisableGenAI;return!(!e||!t||o)&&!(i.getItem("localFileConfig")||{}).summaryCoachmarkShown})())return["LSC1","LSC3"].forEach(v),D("LSC2"),ue(e,n),void o.event(o.e.LOCAL_FILE_ACCESS_AND_SUMMARY_COACHMARK_COMBINATION_OF_PROMPT_SHOWN);["LSC1","LSC2"].forEach(v),D("LSC3");const a=i.getItem("localFileConfig");a.summaryCoachmarkShown=!1,i.setItem("localFileConfig",a),pe(e,n,o.e.LOCAL_FILE_PROMPT_SUMMARY_COMBINATION_SHOWN)}catch(e){A.error({message:x+`openLocalFileAccessAndSummaryCoachmarkCombination: Error handling local file access and summary coachmark: ${e}`})}},ue=async(e,t,n)=>{b.setPopupContext(e.id,e.url,f.LOCAL_FILE_ACCESS_AND_SUMMARY_COACHMARK),chrome.action.openPopup().then(()=>{i.setItem("localFileFteData",{tabId:e.id,url:e.url}),de(t?.ignoreCoolDown);const a=i.getItem("localFileConfig");a.summaryCoachmarkShown=!0,o.event(n),i.setItem("localFileConfig",a)}).catch(e=>console.error(e))},he=async(e,t,n)=>{i.setItem("localFileFteData",{tabId:e.id,url:e.url}),chrome.tabs.update(e.id,{url:chrome.runtime.getURL("browser/js/local-file/local-file-blocking-page.html")}),o.event(n),de(t?.ignoreCoolDown);const a=i.getItem("localFileConfig");a.onceBlockingPromptShown=!0,i.setItem("localFileConfig",a)},pe=async(e,t,n)=>{const a=await chrome.windows.get(e.windowId);if(await Ce(a)&&!_e){const{height:s,width:r,top:l,left:c}=re(a);i.setItem("localFileFteData",{tabId:e.id,url:e.url}),_e=!0;const m=await chrome.windows.create({height:s,width:r,left:c,top:l,focused:e.active,type:"popup",url:chrome.runtime.getURL("browser/js/local-file/local-file-prompt.html")});o.event(n),i.setItem("localFteWindow",m),Se(m),de(t?.ignoreCoolDown)}},fe=async e=>{try{const t=i.getItem("localFileConfig")||{},n=await _();if(!me(n))return;if(!t.onceBlockingPromptShown)return v("CLP2"),D("CLP1"),void he(e,n,o.e.LOCAL_FILE_BLOCKING_COMBINATION_OF_PROMPT_SHOWN);v("CLP1"),D("CLP2"),pe(e,n,o.e.LOCAL_FILE_PROMPT_COMBINATION_OF_PROMPT_SHOWN)}catch(e){A.error({message:x+`openCombinationOfLocalFilePrompt: Error handling local PDF prompt: ${e}`})}},we=async e=>{try{const t=await chrome.windows.get(e.windowId);if(!await Ce(t))return;const n=await ge();if(me(n)&&!_e){const{height:a,width:s,top:r,left:l}=re(t);i.setItem("localFileFteData",{tabId:e.id,url:e.url}),_e=!0;const c=await chrome.windows.create({height:a,width:s,left:l,top:r,focused:e.active,type:"popup",url:chrome.runtime.getURL("browser/js/local-file/local-file-prompt.html")});i.setItem("localFteWindow",c),o.event(o.e.LOCAL_FILE_PERMISSION_PROMPT_SHOWN),Se(c),de(n?.ignoreCoolDown)}}catch(e){A.error({message:x+`openLocalFilePrompt: Error handling local PDF prompt: ${e}`})}},Le=async e=>{try{const t=await(async()=>{let e;try{e=await r.getFeatureMeta("dc-cv-local-file-permission-blocking-prompt"),e=JSON.parse(e)}catch(t){A.error({message:x+`_fetchLocalFileBlockingPromptCooldownConfig: Error fetching local file prompt cooldown config: ${t}`}),e={promptLimit:1,ignoreCoolDown:1,settingsCoolDown:1,dismissCoolDown:1}}return e})();me(t)&&(i.setItem("localFileFteData",{tabId:e.id,url:e.url}),o.event(o.e.LOCAL_FILE_BLOCKING_PAGE_SHOWN),de(t?.ignoreCoolDown),chrome.tabs.update(e.id,{url:chrome.runtime.getURL("browser/js/local-file/local-file-blocking-page.html")}))}catch(e){A.error({message:x+`openLocalFileBlockingPrompt: Error handling local PDF blocking: ${e}`})}},Ee=async()=>{const[e,t,o,n,a,i]=await Promise.all([r.hasFlag("dc-cv-local-file-access-and-summary-coachmark"),r.hasFlag("dc-cv-local-file-permission-prompt"),r.hasFlag("dc-cv-local-file-permission-blocking-prompt"),r.hasFlag("dc-cv-local-file-permission-control"),r.hasFlag("dc-cv-local-file-fte"),r.hasFlag("dc-cv-combination-of-local-file-prompt")]);return e?"localFileAccessAndSummaryCoachmark":i?"combinationOfLocalFilePrompt":t?"localFilePrompt":o?"localFileBlockingPrompt":n?"localFileFteControl":a?"localFileFte":void 0};let _e=!1;const Ce=async e=>!("fullscreen"===e?.state||"locked-fullscreen"===e?.state),Ae=async(e,n)=>{const a=await chrome.windows.get(e.windowId);if(!await Ce(a))return;let s,l;if((e=>{("localFileFteControl"===e&&!i.getItem("localFileConfig")||i.getItem("rc")&&!i.getItem("localFteCounterResetNew"))&&(i.removeItem("localFteCount"),i.removeItem("localFteCooldown"),i.removeItem("localFteCounterReset"),i.setItem("localFteCounterResetNew",!0))})(n),"localFileFteControl"===n){const e=i.getItem("localFteDontShowAgain");l=await(async()=>{let e;try{e=await r.getFeatureMeta("dc-cv-local-file-fte"),e=JSON.parse(e)}catch(t){A.error({message:x+`_fetchLocalFileControlPromptCooldownConfig: Error fetching local file prompt cooldown config: ${t}`}),e={promptLimit:5,ignoreCoolDown:7,settingsCoolDown:7,dismissCoolDown:7}}return e})(),s=me(l)&&!e}else s=await(async()=>{const e=t.isEdge(),o=i.getWithTTL("localFteCooldown"),n=i.getItem("localFteCount")||0,a=i.getItem("localFteDontShowAgain"),s=await chrome.extension.isAllowedFileSchemeAccess();return!(e||s||a||o||n>=20)})();if(s&&!_e){const{height:t,width:s,top:r,left:c}=se(a);i.setItem("localFileFteData",{tabId:e.id,url:e.url}),_e=!0;const m=await chrome.windows.create({height:t,width:s,left:c,top:r,focused:e.active,type:"popup",url:chrome.runtime.getURL("browser/js/local-fte.html")});o.event(o.e.LOCAL_FILE_FTE_SHOWN),"localFileFteControl"===n&&de(l?.ignoreCoolDown),i.setItem("localFteWindow",m),Se(m)}},Se=t=>{const o=t?.tabs?.[0]?.id;o&&setTimeout(()=>{chrome.tabs.setZoom(o,1)},500),e.registerHandlers({closeLocalFte:()=>chrome.windows.remove(t.id)})},Oe=async e=>{const t=i.getItem("localFteWindow");e===t?.id&&(_e=!1,i.removeItem("localFteWindow"),Te())},Fe=async e=>{const{tabId:t}=i.getItem("localFileFteData");if(t===e){const e=i.getItem("localFteWindow");chrome.windows.remove(e?.id)}},Ne=e=>{const t=i.getItem("isAllowedLocalFileAccess"),{filename:n,id:a}=e||{};if(n&&a){let e=i.getItem("downloadCount")||0;i.setItem("downloadCount",++e),chrome.downloads.search({id:a},async n=>{const{mime:a,referrer:s,finalUrl:l,totalBytes:c}=n[0],m=(s||l).split("/")[2];r.hasFlag("dc-cv-express-image-download-analytics").then(e=>{e&&L.SUPPORTED_TYPES.includes(a)&&(A.info({message:"Image Download Event",domain:m,mime:a,size:c}),o.event(o.e.IMAGE_DOWNLOAD_EVENT,{domain:m,eventContext:a}))}),t||"application/pdf"===a&&(m===chrome.runtime.id?chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.tabs.sendMessage(e[0].id,{main_op:"downloadFileSuccess"})}):!u.includes(m)&&e>=3&&(async()=>{if(!await r.hasFlag("dc-cv-download-banner",w.NO_CALL))return!1;i.getItem("downloadBannerFlag")||(i.setItem("downloadBannerFlag",!0),o.event(o.e.DOWNLOAD_BANNER_ENABLED));const e=i.getItem("downloadBannerData");if(e){const{count:t,lastShown:o,doNotShow:n}=e;if(n||t>=10)return!1;const a=t>=3?12096e5:864e5;if((new Date).getTime()-o<a)return!1}return!0})().then(e=>{e&&chrome.tabs.query({active:!0,currentWindow:!0},e=>{e[0]?.id&&(chrome.tabs.sendMessage(e[0].id,{panel_op:"load-downloadBanner"}),o.event(o.e.DOWNLOAD_BANNER_SHOWN),(()=>{const e=i.getItem("downloadBannerData")||{};e.count=(e.count||0)+1,e.lastShown=(new Date).getTime(),i.setItem("downloadBannerData",e),e.count>=10&&o.event(o.e.DOWNLOAD_BANNER_MAX_LIMIT_SHOWN)})())})}))})}},Te=async()=>{try{const e=await Ee(),t=i.getItem("settingsWindow");if("localFilePrompt"===e&&!t){const e=await ge();de(e?.dismissCoolDown,!0),o.event(o.e.LOCAL_FILE_PERMISSION_PROMPT_CLOSED)}}catch(e){A.error({message:x+`handleLocalFilePromptDismiss: Error updating dismiss cooldown ${e}`})}};e.registerHandlers({themeChange:()=>c.registerUninstallUrl(),reRegisterUninstallUrl:()=>c.registerUninstallUrl(),localeChange:e=>c.registerUninstallUrl({locale:e.locale}),updateLoadedTabsInfo:(e,t)=>{const o=i.getItem("loadedTabsInfo");let n=o?.tabsInfo||[];const a=t.tab;if(o.tabsInfo){const e=n.findIndex(e=>e.id==a.id);-1===e?n.push(a):n[e]={...a}}else n=[a];i.setItem("loadedTabsInfo",{tabsInfo:n})},"storage-migration-sync-to-async-cleanup":I});export{ae as startup,$ as registerActions,ie as onWelcomeTabRemoved,R as contextMenuOnClickHandler,z as updateAnalyticsOptInAdmin,le as refocusLocalFteWindow,Fe as onLocalFileClosed,Oe as onLocalFteWindowClosed,X as startQAWithWebpage,Ne as onDownloadChanged,ce as openLocalFileFTEPrompts,re as getLocalFilePromptDimensions};