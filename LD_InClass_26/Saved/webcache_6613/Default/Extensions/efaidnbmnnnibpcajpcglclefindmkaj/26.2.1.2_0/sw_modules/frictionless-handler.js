/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{util as e}from"./util.js";import{communicate as t}from"./communicate.js";import{analytics as i}from"../common/analytics.js";import{common as s}from"./common.js";import{Proxy as o}from"./proxy.js";import{dcLocalStorage as n}from"../common/local-storage.js";import{sendPingEventHandler as _}from"../common/util.js";const a={SIGNED_IN:"signed_in",LIMITS:"limits",COMPLETE_CONVERSION:"complete_conversion"},r={SEARCH:"search",TREFOIL:"trefoil"},c={PRE_PROCESSING_ERROR:"pre-processing-error",PROCESSING_ERROR:"processing-error",FILE_UPLOAD_START:"file-upload-start",FILE_UPLOAD_COMPLETE:"file-upload-complete",FILE_UPLOAD_CANCEL:"file-upload-cancel",FILE_SELECT_CLICK:"file-select-click",GOTOACROBAT_CLICK:"gotoacrobat-click",DROPZONE_DISPLAYED:"dropzone-displayed",STARTUP_ERROR:"startup-error"},l={DISMISS:"dismiss",NONE:"none"},p={LOAD_FRICTIONLESS:"load-frictionless",SEND_EXTERNAL_MESSAGE:"send-external-msg",SHOW_FRICTIONLESS_ERROR:"show-frictionless-error",CLEAR_FRICTIONLESS_ERROR:"clear-frictionless-error"},d={LIMITS_TIME:"limits_time",SIGNED_IN_TIME:"signed_in_time",DROPZONE_DISPLAY_TIME:"dropzone_display_time",STARTUP_TO_FRAME_LOAD:"startup_to_iframe_load"},E="word-to-pdf",f="ppt-to-pdf",O="jpg-to-pdf",m="png-to-pdf",I="excel-to-pdf",R="createpdf",S="compress-pdf",L="pdf-to-word",T="pdf-to-excel",u="pdf-to-ppt",N="pdf-to-image",C={CREATE_PDF:"create_pdf",COMPRESS_PDF:"compress_pdf",EXPORT_PDF:"export_pdf",ORGANISE_PDF:"organize_pdf",DOWNLOAD:"download",UPLOAD:"upload",PROTECT_PDF:"protect_pdf",COMBINE_PDF:"combine_pdf",OCR_PDF:"ocr_pdf"},g="reorder-pages",D="rotate-pages",F="delete-pages",A="split-pdf",P="extract-pages",w="insert-pdf",M="crop-pages",h="number-pages",v="add-comment",k="fillsign",b="sendforsignature",W="chat-pdf",U="combine-pdf",G="protect-pdf",y="ocr-pdf";let K=null;K||(K=new function(){const K={};function x(){this.received_limits=!1,this.limits_time=null,this.received_signedin=!1,this.signed_in_time=null,this.signed_in=!1,this.received_display=!1,this.dropzone_display_time=null,this.received_error=!1,this.error_title=null,this.error_description=null,this.pdf_action=null,this.workflow=null,this.startup_time=null,this.iframe_onload_time=null,this.iframe_call_time=null}function H(e){return K[e]||(K[e]=new x),K[e]}this.proxy=o.proxy.bind(this),this.LOG=(...e)=>s.LOG(...e);const j=function(e,t,s,o){const n=H(e);if(1==n.received_limits&&1==n.received_signedin&&1==n.received_display){if(s===r.SEARCH){if(1==n.has_free_ops||"v2"===t?.data?.variant){let n=t.panel_op;V(e,t),q(e,t),t.panel_op=n;let _=o?o.toUpperCase().replace(/\-/g,"_"):"UNKNOWN";i.event(i.e.FRICTIONLESS_WIDGET_LOADED,{TOOL:_,WORKFLOW:s})}}else if(Z(e,t),1==n.has_free_ops){let e=t.pdf_action?t.pdf_action.toUpperCase().replace(/\-/g,"_"):"UNKNOWN";i.event(i.e.FRICTIONLESS_WIDGET_LOADED,{TOOL:e,WORKFLOW:t.frictionless_workflow})}!function(e){delete K[e]}(e)}},z=function(e,i){const s=i.panel_op;i.panel_op=p.CLEAR_FRICTIONLESS_ERROR,"search"===i.frictionless_workflow?t.sendMessage(i,!1):t.sendMessageToPopup(i,!1),i.panel_op=s},B=function(e,t,s,o,n){const _=H(e);_.received_limits=!0,_.limits_time=n.timeStamp;const a=t.limits;if(!s||!a)return!1;_.has_free_ops=function(e,t){let i=null;switch(e){case E:case f:case O:case m:case I:case R:i=C.CREATE_PDF;break;case S:i=C.COMPRESS_PDF;break;case L:case T:case u:case N:i=C.EXPORT_PDF;break;case G:i=C.PROTECT_PDF;break;case y:i=C.OCR_PDF;break;case U:i=C.COMBINE_PDF;break;case D:case g:case F:i=C.ORGANISE_PDF;break;case A:case P:case w:case k:case M:case W:case h:case v:case b:i=C.DOWNLOAD}if(null===i)return!1;let s=t[i];return s&&(s.can_process||s.can_download)||!1}(s,a);const c=_.has_free_ops?"UnderLimit":"OverLimit";i.event(i.e.FRICTIONLESS_CONVERSION_LIMITS,{WORKFLOW:o,RESULT:c}),Y(e,n,d.LIMITS_TIME),"v2"===n.variant||o!==r.SEARCH||_.has_free_ops?j(e,n,o,s):X(e,n)},X=function(e,i){i.content_op=l.DISMISS,"search"==i.frictionless_workflow?t.sendMessage(i,!1):t.sendMessageToPopup(i,!1)},Y=function(e,i,s){if("false"===n.getItem("logAnalytics"))return;const o=H(e),_=i.panel_op;let a={content:"timing_info"};a.workflow=i.frictionless_workflow,function(e,t,i){switch(i){case d.STARTUP_TO_FRAME_LOAD:t.startup_time&&(t.iframe_onload_time&&(e.startup_to_iframe_load=t.iframe_onload_time-t.startup_time),t.iframe_call_time&&(e.startup_to_iframe_call=t.iframe_call_time-t.startup_time));break;case d.SIGNED_IN_TIME:t.startup_time&&t.signed_in_time&&(e.startup_to_signin=t.signed_in_time-t.startup_time);break;case d.LIMITS_TIME:t.startup_time&&t.limits_time&&(e.startup_to_limits=t.limits_time-t.startup_time);break;case d.DROPZONE_DISPLAY_TIME:t.startup_time&&t.dropzone_display_time&&(e.startup_to_display=t.dropzone_display_time-t.startup_time)}}(a,o,s);const r=i.data?.variant;i.data=a,null!=r&&(i.data.variant=r),i.panel_op=p.SEND_EXTERNAL_MESSAGE,"search"==i.frictionless_workflow?t.sendMessage(i,!1):t.sendMessageToPopup(i,!1),i.panel_op=_},Z=function(e,i){i.panel_op=p.LOAD_FRICTIONLESS,i.content_op=l.NONE,i.hide_spinner=!0,"search"==i.frictionless_workflow?t.sendMessage(i,!1):t.sendMessageToPopup(i,!1),i.hide_spinner=void 0},V=function(e,i){i.panel_op=p.SEND_EXTERNAL_MESSAGE,i.data={valid:"true"},t.sendMessage(i,!1)},q=function(e,i){_(),i.content_op=l.NONE,i.panel_op=p.LOAD_FRICTIONLESS,i.frame_visibility="visible",t.sendMessage(i,!1)};this.startNewInteraction=function(e){return K[e]=new x,K[e]},this.externalMsgHandler=function(s,o,n){try{const n=s.data,_=o.tab.id,E=t.getTabLastMessage(_);if(!E)return;let f=!1;switch(n.content_op){case a.SIGNED_IN:!function(e,t,s,o,n){const _=H(e);_.received_signedin=!0,_.signed_in_time=n.timeStamp,_.signed_in=t.is_signed_in;const a=_.signed_in?"SignedIn":"SignedOut";i.event(i.e.FRICTIONLESS_USER_SIGNEDIN,{WORKFLOW:o,RESULT:a}),Y(e,n,d.SIGNED_IN_TIME),j(e,n,o,s)}(_,n,E.pdf_action,E.frictionless_workflow,s),f=!0;break;case a.LIMITS:B(_,n,E.pdf_action,E.frictionless_workflow,s),f=!0;break;case a.COMPLETE_CONVERSION:!function(t,s,o,n){if(!s||!s.conversion_url)return!1;"v2"===n.variant&&z(0,n),e.createTab(s.conversion_url),i.event(i.e.FRICTIONLESS_SWITCH_TAB,{WORKFLOW:o}),"v2"!==n.variant&&X(t,n)}(_,n,E.frictionless_workflow,s),f=!0}if(!f&&n.dc_hosted_event){const e=n.dc_hosted_event.event,o=n.dc_hosted_event.event_data;switch(e){case c.PRE_PROCESSING_ERROR:case c.PROCESSING_ERROR:!function(e,i,s,o){o.panel_op=p.SHOW_FRICTIONLESS_ERROR,o.content_op=l.NONE,o.error_title=i,o.error_description=s,"search"==o.frictionless_workflow?t.sendMessage(o,!1):t.sendMessageToPopup(o,!1)}(0,o.title,o.description,s);break;case c.FILE_UPLOAD_START:i.event(i.e.FRICTIONLESS_FILE_UPLOAD_STARTED,{WORKFLOW:E.frictionless_workflow}),z(0,s);break;case c.FILE_UPLOAD_COMPLETE:i.event(i.e.FRICTIONLESS_FILE_UPLOAD_COMPLETED,{WORKFLOW:E.frictionless_workflow});break;case c.FILE_UPLOAD_CANCEL:i.event(i.e.FRICTIONLESS_FILE_UPLOAD_CANCELLED,{WORKFLOW:E.frictionless_workflow});break;case c.FILE_SELECT_CLICK:i.event(i.e.FRICTIONLESS_FILE_SELECT_CLICKED,{WORKFLOW:E.frictionless_workflow});break;case c.GOTOACROBAT_CLICK:i.event(i.e.ACROBAT_ONLINE_CLICKED,{WORKFLOW:E.frictionless_workflow});break;case c.DROPZONE_DISPLAYED:!function(e,t,i,s){const o=H(e);o.received_display=!0,o.dropzone_display_time=s.timeStamp,Y(e,s,d.DROPZONE_DISPLAY_TIME),j(e,s,i,t)}(_,E.pdf_action,E.frictionless_workflow,s);break;case c.STARTUP_ERROR:!function(e,t,i){t===r.SEARCH?X(e,i):t===r.TREFOIL&&Z(e,i)}(_,workflow,E);const e=E.pdf_action?E.pdf_action.toUpperCase().replace(/\-/g,"_"):"UNKNOWN";i.event(i.e.FRICTIONLESS_WIDGET_STARTUP_ERROR,{TOOL:e})}}E&&E.timeStamp&&delete E.timeStamp}catch(e){}},this.sendFrictionlessURL=async function(e,i,o){e.panel_op=p.LOAD_FRICTIONLESS,e.frictionless_uri=s.getFrictionlessUri(),e.env=s.getEnv();let n=H(e.tabId);!e.startup_time||n.startup_time&&n.startup_time===e.startup_time||(n=this.startNewInteraction(e.tabId),n.startup_time=e.startup_time),t.sendMessageToPopup(e,!1)},this.handleTimingInformationFromWidget=function(e,i,s){let o=H(e.tabId);const n=e.timing_op;if(delete e.timing_op,t.getTabLastMessage(e.tabId)){t.updateTabMessage(e.tabId,e);const i=t.getTabLastMessage(e.tabId);o.startup_time=o.startup_time||e.startup_time,o.iframe_onload_time=o.onload_time||e.iframe_onload_time,o.iframe_call_time=o.iframe_call_time||e.iframe_call_time,n&&Y(e.tabId,i,n)}}},t.registerHandlers({"get-frictionless-url":K.proxy(K.sendFrictionlessURL),external_msg:K.proxy(K.externalMsgHandler),timing_info:K.proxy(K.handleTimingInformationFromWidget)}));export const frictionlessHandler=K;