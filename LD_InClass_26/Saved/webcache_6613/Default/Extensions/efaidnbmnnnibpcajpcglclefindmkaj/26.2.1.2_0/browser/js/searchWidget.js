/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{events as e}from"../../common/analytics.js";import{dcLocalStorage as t}from"../../common/local-storage.js";import{util as i}from"./content-util.js";import{updateExtUserState as r}from"../../common/util.js";import{OptionsPageSource as s}from"../../common/constant.js";import{offscreenConfig as n}from"./offscreen/offscrenUtil.js";import{SETTINGS as a}from"../../sw_modules/settings.js";await t.init();class o{constructor(e){this.widget=e}sendToMain(e,t=!1){const r=this.cleanMessage(e);i.messageToMain(r),t||"dismiss"===e.content_op||"resize_window"===e.content_op||"external_msg"===e.main_op||this.widget.dismiss()}cleanMessage(e){const t={...e};return delete t.click_context,delete t.newUI,delete t.analytics,delete t.is_viewer,delete t.reload_in_native,!0===t.authenticatedPDF&&delete t.authenticatedPDF,t}handleExternalMessage(e){try{const t=this.widget.state.currentRequest.frictionless_uri;if(!t)return;const r=new URL(t);if(e.origin===r.origin){let t=!1;if(e.data&&"dc_hosted_event"===e.data.content_op&&e.data.dc_hosted_event&&"upload-error"===e.data.dc_hosted_event.event){t=!0;const r=e.data.dc_hosted_event;let s=r.error;s=r.file&&r.file.name?`"${r.file.name}" ${i.getTranslation("frictionlessWidgetErrorUnsupportedFormat")}`:"string"==typeof r.error?r.error:r.error&&r.error.message?r.error.message:i.getTranslation("frictionlessWidgetErrorUploadFailed"),this.sendToMain({main_op:"relay_to_content",content_op:"show_error_toast",error_message:s},!0)}this.sendToMain({main_op:"external_msg",data:e.data,timeStamp:Date.now()},t)}}catch(e){}}}class c{constructor(e){this.widget=e}clearTimer(){this.widget.state.timer&&(clearTimeout(this.widget.state.timer),this.widget.state.timer=null);const e=document.querySelector(".acrobatMainDiv");e&&(a.IS_ERP_READER?e.style.display="none":e.style.opacity="1.0")}setTimer(){if(!this.widget.state.timer&&!this.widget.state.timerOff){const e=this.widget.state.currentRequest?.is_pdf?this.widget.config.PDF_MENU_TIME:this.widget.config.MENU_TIME;this.widget.state.timer=setTimeout(()=>{this.fadeAway()},e)}}fadeAway(){this.widget.state.timer=null;const e=document.querySelector(".acrobatMainDiv");e&&(e.style.transition=`opacity ${this.widget.config.FADE_TIME}ms ease-in-out`,e.style.opacity="0",setTimeout(()=>{this.widget.dismiss()},this.widget.config.FADE_TIME))}resetUI(){i.translateElements(".translate");const e=document.getElementById("action_message");e&&(e.textContent="")}prepareWidgetScreen(){const e=document.querySelector(".acrobatMainDiv");e&&(e.classList.remove("home-screen"),e.classList.add("widget-screen-main-div"));const t=document.querySelector(".actions");t&&t.classList.add("hidden")}showLoader(){const e=document.querySelector(".frictionless-host");e&&e.classList.remove("hidden");const t=document.querySelector(".frictionless-loader");t&&t.classList.remove("hidden")}hideLoader(){const e=document.querySelector(".frictionless-loader");e&&e.classList.add("hidden")}showIframe(e){const t=document.querySelector(".frictionless-container");t&&(t.classList.remove("hidden"),t.appendChild(e));const i=document.querySelector(".frictionless-host");i&&i.classList.remove("hidden")}hideSpinner(){const e=document.querySelector(".frictionless-container");e&&e.classList.remove("hidden"),this.hideLoader()}showError(e,t){const i=document.querySelector(".error-title");i&&(i.textContent=e);const r=document.querySelector(".error-details");r&&(r.textContent=t);const s=document.querySelector(".frictionless-error");s&&s.classList.remove("hidden"),this.widget.messageHandler.sendToMain({content_op:"resize_window",panel_op:"load-frictionless",main_op:"relay_to_content"})}hideError(){const e=document.querySelector(".frictionless-error");e&&e.classList.add("hidden"),this.widget.messageHandler.sendToMain({content_op:"resize_window",panel_op:"load-frictionless",main_op:"relay_to_content"})}showOfflineUI(){const e=document.querySelector(".frictionless-container");e&&e.classList.add("hidden");const t=document.querySelector(".frictionless-loader");t&&t.classList.add("hidden");const r=document.querySelector(".frictionless-error");r&&r.classList.add("hidden");const s=document.querySelector(".frictionless-offline-ui");s&&s.remove();const n=`\n            <div class="frictionless-offline-ui">\n                <div class="offline-icon">\n                    <img src="../images/no_connection.svg" alt="No connection" />\n                </div>\n                <div class="offline-title">${i.getTranslation("frictionlessWidgetNoConnectionTitle")}</div>\n                <div class="offline-message">${i.getTranslation("frictionlesOfflineMessage")}</div>\n            </div>\n        `,a=document.querySelector(".frictionless-host");a&&(a.insertAdjacentHTML("afterbegin",n),a.classList.remove("hidden")),this.widget.messageHandler.sendToMain({content_op:"resize_window",panel_op:"load-frictionless",main_op:"relay_to_content"})}hideOfflineUI(){const e=document.querySelector(".frictionless-offline-ui");e&&e.remove();const t=document.querySelector(".frictionless-host");t&&t.classList.add("hidden")}showErrorUI(t,r){const s=document.querySelector(".frictionless-container");s&&s.classList.add("hidden");const n=document.querySelector(".frictionless-loader");n&&n.classList.add("hidden");const a=document.querySelector(".frictionless-error-ui");a&&a.remove();const o=this.widget.getAcrobatOnlineUrl(),c=i.getTranslation("frictionlessWidgetGoToAcrobat")||"Go to Acrobat",l=`\n            <div class="frictionless-error-ui">\n                <div class="error-content-box">\n                    <div class="error-content-inner">\n                        <div class="error-warning-icon">\n                            <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <path d="M23.9995 15.522C24.6623 15.522 25.1995 16.0592 25.1995 16.722V28.422C25.1995 29.0847 24.6623 29.622 23.9995 29.622C23.3368 29.622 22.7995 29.0847 22.7995 28.422V16.722C22.7995 16.0592 23.3368 15.522 23.9995 15.522Z" class="error-icon-path"/>\n                                <path class="error-icon-path" d="M25.7995 33.222C25.7995 34.2161 24.9936 35.022 23.9995 35.022C23.0054 35.022 22.1995 34.2161 22.1995 33.222C22.1995 32.2279 23.0054 31.422 23.9995 31.422C24.9936 31.422 25.7995 32.2279 25.7995 33.222Z"/>\n                                <path class="error-icon-path" fill-rule="evenodd" clip-rule="evenodd" d="M19.8428 8.92283C21.688 5.72082 26.3083 5.72288 28.1557 8.92186L42.8767 34.4219C44.7244 37.6216 42.4166 41.622 38.7205 41.622H9.27554C5.57943 41.622 3.27157 37.6216 5.11934 34.4219L19.8428 8.92283ZM26.0773 10.1219C25.1526 8.52107 22.8431 8.52318 21.9223 10.1211L7.19775 35.622C6.27359 37.2223 7.42768 39.222 9.27554 39.222H38.7205C40.5684 39.222 41.7225 37.2224 40.7984 35.6221L26.0773 10.1219Z"/>\n                            </svg>\n                        </div>\n                        <div class="error-content-text">\n                            <div class="error-ui-title">${t||"Unable to load this section"}</div>\n                            <div class="error-ui-message">\n                                ${r||"The request is taking longer than expected."}\n                                <a href="#" class="error-reload-link">${i.getTranslation("frictionlessWidgetTryReloading")||"Try reloading"}</a>\n                            </div>\n                        </div>\n                        <button type="button" class="error-go-to-acrobat-btn">\n                            <svg width="40" height="32" viewBox="0 0 40 32" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <mask id="mask0_8060_686" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="14" y="7" width="18" height="18">\n                                <path d="M29.9346 23.6154H16.0657C15.6896 23.6154 15.3848 23.3105 15.3848 22.9345V9.06558C15.3848 8.68951 15.6896 8.38464 16.0657 8.38464H21.6188C21.9948 8.38464 22.2997 8.68951 22.2997 9.06558V9.74652C22.2997 10.1226 21.9948 10.4275 21.6188 10.4275H17.4276V21.5726H28.5727V17.33C28.5727 16.9539 28.8776 16.6491 29.2536 16.6491H29.9346C30.3107 16.6491 30.6155 16.9539 30.6155 17.33V22.9345C30.6155 23.3105 30.3107 23.6154 29.9346 23.6154Z" fill="currentColor"/>\n                                <path d="M25.4914 8.48996L25.5175 9.18065C25.5319 9.56254 25.8531 9.86049 26.235 9.84631L27.7708 9.78932L23.2653 14.2948C22.9949 14.5652 22.9949 15.0035 23.2653 15.2739L23.7546 15.7633C24.025 16.0337 24.4633 16.0337 24.7337 15.7633L29.2392 11.2578L29.1823 12.7936C29.1681 13.1755 29.466 13.4967 29.8479 13.5111L30.5386 13.5372C30.9208 13.5517 31.2424 13.2534 31.2566 12.8712L31.4261 8.32002C31.4411 7.91765 31.1109 7.58744 30.7085 7.60242L26.1574 7.77197C25.7751 7.7862 25.4769 8.10773 25.4914 8.48996Z" fill="currentColor"/>\n                                </mask>\n                                <g mask="url(#mask0_8060_686)">\n                                <rect x="14" y="7" width="18" height="18" fill="currentColor"/>\n                                </g>\n                            </svg>\n                            ${c}\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `,d=document.querySelector(".frictionless-host");if(d){d.insertAdjacentHTML("afterbegin",l),d.classList.remove("hidden"),this.widget.analytics.track(e.FRICTIONLESS_WIDGET_RETRY_SCREEN_SHOWN);const t=d.querySelector(".error-reload-link");t&&t.addEventListener("click",t=>{t.preventDefault(),this.widget.analytics.track(e.FRICTIONLESS_WIDGET_RETRY_RELOAD_CLICKED),this.hideErrorUI(),this.widget.offlineManager.retryLoadContent()});const i=d.querySelector(".error-go-to-acrobat-btn");i&&i.addEventListener("click",()=>{this.widget.analytics.track(e.FRICTIONLESS_WIDGET_RETRY_GO_TO_ACROBAT_CLICKED),window.open(o,"_blank")})}this.widget.messageHandler.sendToMain({content_op:"resize_window",panel_op:"load-frictionless",main_op:"relay_to_content"})}hideErrorUI(){const e=document.querySelector(".frictionless-error-ui");e&&e.remove();const t=document.querySelector(".frictionless-host");t&&t.classList.add("hidden")}}class l{constructor(e){this.widget=e}createIframe(e){const t=document.createElement("iframe");t.setAttribute("referrerpolicy","no-referrer"),t.classList.add("frictionless-iframe");const i=this.buildIframeUrl(e);return this.setupIframeEvents(t,e),t.setAttribute("src",i),t}buildIframeUrl(e){if(!e.frictionless_uri)throw new Error("frictionless_uri is required to build iframe URL");if(!e.pdf_action)throw new Error("pdf_action is required to build iframe URL");this.widget.state.currentRequest={...this.widget.state.currentRequest,...e};const i=new URL(e.frictionless_uri);if(i.hash){let t=i.hash.substring(1);t.endsWith("/")||(t+="/"),t+=e.pdf_action,i.hash=t}else{let t=i.pathname;t.endsWith("/")||(t+="/"),t+=e.pdf_action,i.pathname=t}const r="false"!==t.getItem("logAnalytics"),s="false"!==t.getItem("ANALYTICS_OPT_IN_ADMIN"),n={workflow:e.frictionless_workflow,dropzone2:"true",useExtensionStorage:!0,locale:this.getLocale(),showHeader:!1,showFooter:!0,theme:this.widget.state.theme,la:r&&s},a=new URLSearchParams(i.search);return Object.keys(n).forEach(e=>{const t=n[e];null!=t&&a.set(e,String(t))}),"test"!==e.env&&"stage"!==e.env||a.set("app!versions","latest"),i.search=a.toString(),i.hash=i.hash.split("?")[0],i.toString()}getLocale(){return this.widget.state.appLocale||this.widget.state.currentRequest?.locale||chrome.i18n.getMessage("@@ui_locale")}setupIframeEvents(t,r){let s=!1;const n=this.widget.config.WIDGET_LOAD_TIMEOUT,a=Date.now(),o=()=>{this.widget.clearLoaderFallbackTimeout(),this.widget.uiManager.hideLoader();document.querySelectorAll(".frictionless-iframe").forEach(e=>e.remove());const e=document.querySelector(".frictionless-container");e&&(e.innerHTML=""),this.widget.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorTimeout"),i.getTranslation("frictionlessWidgetErrorTimeoutMessage"));try{this.widget.messageHandler.sendToMain({main_op:"relay_to_content",content_op:"remove_skeleton_on_timeout"},!0)}catch(e){console.warn("SearchWidget: Could not send remove_skeleton_on_timeout",e)}},c=()=>{if(this.widget.clearLoaderFallbackTimeout(),!s)try{this.widget.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"timeout",timeoutMs:n})}finally{navigator.onLine?o():this.widget.offlineManager.handleOffline()}};this.widget.state.loaderFallbackTimeoutId=setTimeout(c,n),this.widget.state.loaderFallbackCheckIntervalId=setInterval(()=>{null===this.widget.state.loaderFallbackTimeoutId&&null===this.widget.state.loaderFallbackCheckIntervalId||Date.now()-a>=n&&c()},2e3),t.onerror=t=>{s=!0,this.widget.clearLoaderFallbackTimeout(),console.error("SearchWidget: Iframe onerror event fired",t),this.widget.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"iframe_onerror",error_message:t?.message||"unknown"}),this.widget.uiManager.hideLoader(),this.widget.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorTimeout "),i.getTranslation("frictionlessWidgetErrorTimeoutMessage"))},t.onload=()=>{s=!0,this.widget.clearLoaderFallbackTimeout(),this.widget.uiManager.hideLoader(),this.widget.messageHandler.sendToMain({iframe_onload_time:Date.now(),main_op:"timing_info",timing_op:"startup_to_iframe_load"},!0);try{this.sendMessageToIframe(t,{valid:!0},r)}catch(e){console.error("SearchWidget: Error posting message to iframe",e)}},this.widget.messageHandler.sendToMain({iframe_call_time:Date.now(),main_op:"timing_info"},!0)}getCurrentIframe(){const e=document.querySelectorAll(".frictionless-iframe");return 1===e.length?e[0]:null}sendMessageToIframe(e,t,i){const r=i?.frictionless_uri||this.widget.state.currentRequest.frictionless_uri;if(!r)return void console.warn("No frictionless_uri available for iframe message");const s=new URL(r);e.contentWindow.postMessage(t,s.origin)}}class d{constructor(e){this.widget=e}track(e,t={}){const r={main_op:"analytics",analytics:[[e,t]]};i.messageToMain(r)}}class h{constructor(e){this.widget=e,this.pendingRequest=null}setupOfflineDetection(){window.addEventListener("online",()=>this.handleOnline()),window.addEventListener("offline",()=>this.handleOffline()),navigator.onLine||(this.widget.state.isOnline=!1)}handleOffline(){this.widget.state.isOnline=!1,this.widget.analytics.track(e.FRICTIONLESS_WIDGET_OFFLINE),this.widget.state.currentRequest?.frictionless_uri&&(this.pendingRequest={...this.widget.state.currentRequest});const t=document.querySelectorAll(".frictionless-iframe"),i=document.querySelector(".frictionless-loader"),r=i&&null!==i.offsetParent;(t.length>0||r)&&this.widget.uiManager.showOfflineUI()}handleOnline(){this.widget.state.isOnline=!0,this.widget.analytics.track(e.FRICTIONLESS_WIDGET_ONLINE),this.widget.uiManager.hideOfflineUI(),this.widget.uiManager.hideErrorUI(),this.pendingRequest&&this.retryLoadContent()}retryLoadContent(){if(!this.widget.state.isOnline)return;const t=this.pendingRequest||this.widget.state.currentRequest;if(t&&t.frictionless_uri)try{this.widget.clearLoaderFallbackTimeout();const r=document.querySelector(".frictionless-loader");r&&r.classList.remove("hidden");const s=document.querySelector(".frictionless-offline-ui");s&&s.remove();const n=document.querySelector(".frictionless-error-ui");n&&n.remove();document.querySelectorAll(".frictionless-iframe").forEach(e=>e.remove());const a=document.querySelector(".frictionless-container");a&&(a.innerHTML="");const o=document.querySelector(".frictionless-host");o&&o.classList.add("hidden");try{this.widget.uiManager.prepareWidgetScreen();const e=this.widget.iframeManager.createIframe(t);this.widget.uiManager.showIframe(e),this.pendingRequest&&(this.pendingRequest=null)}catch(t){console.error("SearchWidget: Failed to create iframe",t),this.widget.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"retry_iframe_creation_failed",error_message:t?.message||"unknown"});const r=document.querySelector(".frictionless-loader");r&&r.classList.add("hidden"),this.widget.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorLoading"),i.getTranslation("frictionlessWidgetErrorGeneric"))}}catch(t){console.error("SearchWidget: Retry failed",t),this.widget.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"retry_failed",error_message:t?.message||"unknown"});const r=document.querySelector(".frictionless-loader");r&&r.classList.add("hidden"),this.widget.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorLoading"),i.getTranslation("frictionlessWidgetErrorGeneric"))}}}new class{constructor(){this.state={initialized:!1,currentRequest:{frictionless_uri:"",pdf_action:"",frictionless_workflow:"",env:"prod",locale:"en",variant:"v1"},timer:null,timerOff:!1,appLocale:t.getItem("appLocale"),isOnline:navigator.onLine,theme:this.detectTheme(),loaderFallbackTimeoutId:null,loaderFallbackCheckIntervalId:null},this.config={MENU_TIME:1500,PDF_MENU_TIME:3e3,FADE_TIME:1500,WIDGET_LOAD_TIMEOUT:18e3,ERROR_TOOLTIP_DURATION:5e3,SKELETON_MIN_DURATION:1500,FADE_TRANSITION_DURATION:300},this.messageHandler=new o(this),this.uiManager=new c(this),this.iframeManager=new l(this),this.analytics=new d(this),this.offlineManager=new h(this),this.init()}detectTheme(){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return this.applyThemeToBody(e),e}applyThemeToBody(e){document.body.setAttribute("data-theme",e)}async init(){this.state.initialized||(this.state.initialized=!0,this.initializeTranslations(),this.setupEventListeners(),this.setupMessageHandling(),this.setupThemeDetection(),this.offlineManager.setupOfflineDetection(),this.handleInitialRequest())}initializeTranslations(){i.translateElements(".translate");const e=i.getTranslation("loadingStatus"),t=document.querySelector(".frictionless-loader");t&&t.setAttribute("data-loading-title",e)}setupThemeDetection(){if(!window.matchMedia)return;const e=window.matchMedia("(prefers-color-scheme: dark)"),t=e=>{const t=e.matches?"dark":"light";this.state.theme=t,this.handleThemeChange(t)};e.addEventListener?e.addEventListener("change",t):e.addListener&&e.addListener(t)}handleThemeChange(e){this.applyThemeToBody(e);const t=this.iframeManager.getCurrentIframe();if(t&&t.contentWindow)try{this.iframeManager.sendMessageToIframe(t,{type:"theme-change",theme:e},this.state.currentRequest)}catch(e){console.error("SearchWidget: Error sending theme change to iframe",e)}}getAcrobatOnlineUrl(){const e=this.state.currentRequest.env||"prod";return`${(n[e]||n.prod).acrobat_viewer_origin}?x_api_client_location=frictionless:header_redirect&x_api_client_id=dc-chrome-extension`}setupEventListeners(){const t=document.querySelector(".close-dialog"),i=document.querySelector(".settings-dialog"),r=document.querySelector(".acrobat-branding"),s=document.querySelector(".action-available-click"),n=document.querySelector(".acrobatMainDiv"),a=document.querySelector(".sign-out"),o=document.querySelector(".do-acro-prefs");t&&t.addEventListener("click",()=>{n&&n.classList.contains("widget-screen-main-div")&&this.analytics.track(e.FRICTIONLESS_WIDGET_CROSS_CLICKED),this.dismiss()}),i&&i.addEventListener("click",()=>this.openSettingsPage()),r&&r.addEventListener("click",()=>{this.analytics.track(e.FRICTIONLESS_WIDGET_HEADER_CLICKED);const t=this.getAcrobatOnlineUrl();window.open(t,"_blank")}),s&&s.addEventListener("click",()=>{this.uiManager.clearTimer(),this.analytics.track(e.TREFOIL_ACROBAT_LABEL_CLICKED),this.messageHandler.sendToMain({main_op:"go_to_aonline",verb:"acrobat_label"})}),n&&(n.addEventListener("mouseenter",()=>this.uiManager.clearTimer()),n.addEventListener("mouseleave",()=>this.uiManager.setTimer())),a&&a.addEventListener("click",()=>{this.uiManager.clearTimer(),this.analytics.track(e.SIGN_OUT_CLICKED),this.messageHandler.sendToMain({main_op:"sign-out"})}),o&&o.addEventListener("click",()=>{this.analytics.track(e.TREFOIL_HTML_PREFERENCES_CLICK),this.messageHandler.sendToMain({main_op:"showConversionSettingsDialog"})})}setupMessageHandling(){i.addMainListener(e=>this.handleMessage(e)),window.addEventListener("message",e=>this.messageHandler.handleExternalMessage(e),!1)}handleInitialRequest(){if(window.location.search)try{const t=new URLSearchParams(window.location.search).get("message");if(!t)throw new Error('Missing required "message" parameter');const i=JSON.parse(decodeURIComponent(t));if(!i||"object"!=typeof i)throw new Error("Invalid request data format");if(a.TEST_MODE&&window.addEventListener("message",e=>this.handleMessage(e.data),!1),document.body.classList.add("desktop-app-reader"),"html_menu"===i.panel_op){const t=document.querySelector(".acrobatMainDiv");t&&t.classList.add("home-screen"),this.analytics.track(e.FRICTIONLESS_HOME_SCREEN_SHOWN)}this.processRequest(i)}catch(t){console.error("SearchWidget: Failed to parse initial request:",t),this.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"url_parse_failed",error_message:t?.message||"unknown"}),this.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorUnableToLoad"),i.getTranslation("frictionlessWidgetErrorInitFailed"))}else console.warn("SearchWidget: No query parameters found")}handleMessage(e){this.isValidMessage(e)&&(this.state.currentRequest={...this.state.currentRequest,...e,tabId:this.state.currentRequest?.tabId||e.tabId},this.state.timerOff=!1,this.uiManager.clearTimer(),this.uiManager.resetUI(),this.processRequest(e))}isValidMessage(e){return(!this.state.currentRequest?.tabId||!e.tabId||e.tabId===this.state.currentRequest.tabId)&&void 0!==e.panel_op}processRequest(e){const t=e.panel_op;switch(delete e.panel_op,t){case"load-frictionless":this.handleLoadFrictionless(e);break;case"show-frictionless-error":this.handleShowError(e);break;case"clear-frictionless-error":this.handleClearError();break;case"send-external-msg":this.handleSendExternalMessage(e);break;default:console.warn("Unknown panel operation:",t)}this.uiManager.setTimer()}handleLoadFrictionless(t){if(this.state.timerOff=!0,this.state.currentRequest={...this.state.currentRequest,...t},"resize_window"===t.content_op)return;if(t.hide_spinner)return this.clearLoaderFallbackTimeout(),void this.uiManager.hideSpinner();const s=document.querySelector(".frictionless-container");if(s&&0===s.children.length){if(this.uiManager.prepareWidgetScreen(),"search"===t.frictionless_workflow&&r(),!this.state.isOnline)return this.offlineManager.pendingRequest=t,this.uiManager.showOfflineUI(),void this.analytics.track(e.FRICTIONLESS_WIDGET_OFFLINE);try{this.clearLoaderFallbackTimeout(),this.uiManager.showLoader();const e=this.iframeManager.createIframe(t);this.uiManager.showIframe(e)}catch(r){this.clearLoaderFallbackTimeout(),this.uiManager.hideLoader(),console.error("SearchWidget: Failed to create iframe",r),this.analytics.track(e.FRICTIONLESS_WIDGET_LOADING_FAILED,{error_type:"iframe_creation_failed",error_message:r?.message||"unknown",variant:t.variant}),this.uiManager.showErrorUI(i.getTranslation("frictionlessWidgetErrorUnableToLoad"),i.getTranslation("frictionlessWidgetErrorInitFailed"))}}}handleShowError(e){e.error_title&&e.error_description&&this.uiManager.showError(e.error_title,e.error_description)}handleClearError(){this.uiManager.hideError()}handleSendExternalMessage(e){try{const t=this.iframeManager.getCurrentIframe();t&&(this.iframeManager.sendMessageToIframe(t,e.data,e),delete e.data)}catch(e){console.error("Failed to send external message:",e)}this.state.timerOff=!0}openSettingsPage(){this.analytics.track(e.TREFOIL_SETTINGS_ICON_CLICKED),t.setItem("optionsPageSource",s.FRICTIONLESS_WIDGET_SETTINGS),chrome.runtime.openOptionsPage(()=>{chrome.runtime.lastError&&this.analytics.track(e.TREFOIL_SETTINGS_FAILED_TO_OPEN)})}clearLoaderFallbackTimeout(){this.state.loaderFallbackTimeoutId&&(clearTimeout(this.state.loaderFallbackTimeoutId),this.state.loaderFallbackTimeoutId=null),this.state.loaderFallbackCheckIntervalId&&(clearInterval(this.state.loaderFallbackCheckIntervalId),this.state.loaderFallbackCheckIntervalId=null)}dismiss(){if(!chrome.runtime?.id)return void(document.body.style.display="none");const e=document.querySelector(".acrobatMainDiv");e&&(e.style.opacity="0",e.style.height="0",e.style.overflow="hidden"),this.messageHandler.sendToMain({forced_cancel:!0,content_op:"dismiss",main_op:"relay_to_content"})}};