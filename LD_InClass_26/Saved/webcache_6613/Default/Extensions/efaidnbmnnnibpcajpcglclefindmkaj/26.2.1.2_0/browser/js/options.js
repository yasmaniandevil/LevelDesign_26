/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e,events as t}from"../../common/analytics.js";import{dcLocalStorage as n}from"../../common/local-storage.js";import{util as s}from"./content-util.js";import{privateApi as a}from"./content-privateApi.js";import{LOCALES as o,LOCAL_FILE_PERMISSION_URL as i,OptionPageActions as r}from"../../common/constant.js";import{getGenAIServiceVariant as c}from"../../common/util.js";import l from"./highlight-overlay.js";import{loggingApi as p}from"../../common/loggingApi.js";import{largeBlobStorage as d}from"../../common/large-blob-storage.js";await n.init(),$(function(){const h="analyticsOptinTitle",u="web2pdfOptOut",g="web2pdfOptOutDisabled",m="LearnMoreURL",f="web2pdfPrivacy",S="web2pdfShowPDFTools",I="web2pdfFrictionlessToggleDescription",E="whatsNewAutoOpenTitle",T="whatsNewAutoOpenDescription",_="pdfOwnershipExploreOptionsTitle",b="pdfOwnershipExploreOptionsDescription",P="web2pdfOpenConvertedPDFTitle",v="web2pdfOpenConvertedPDFDescription",O="web2pdfShowPersistentOpen",A="web2pdfShowPersistentOpenDescription",w="webpagePDFConversion",N="webpagePDFConversionDescription",D="enableGenAIFeaturesTitle",R="enableGenAIFeaturesDescription",L="enableGenAIAutoSummarizeTitle",x="enableGenAIAutoSummarizeDescription",C="bypassGenAIWebpageEligibilityTitle",B="bypassGenAIWebpageEligibilityDescription",M="optionsSuccessPrompt",y="optionsSuccessPromptReloadRequired",F="optionsFailurePrompt",k="appearancePrefTitle",U="appearancePrefDesc",G="appearancePrefOp1",H="appearancePrefOp2",K="appearancePrefOp3",V="saveLocationPreferenceTitle",W="saveLocationPreferenceDescription",q="saveLocationOp1",j="saveLocationOp2",z="saveLocationOp3",X="userLocale",Y="acrobatGsuiteTouchPointPreferenceTitle",Z="acrobatGsuiteTouchPointPreferenceDescription",J="acrobatTouchPointInOtherSitesPreferenceTitle",Q="acrobatEmbeddedTouchPointPreferenceTitle",ee="acrobatEmbeddedTouchPointPreferenceDescription",te="acrobatTouchPointInOtherSurfacesPreferenceDescription",ne="acrobatLinkedInPDFTouchPointPreferenceDescription",se="expressTouchpointPreferenceTitle",ae="expressTouchpointPreferenceDescription",oe="aiMarkerTouchpointPreferenceTitle",ie="aiMarkerTouchpointPreferenceDescription",re="localFileOptionTitle",ce="localFileOptionDesc",le="askAssistantBannerTitle",pe="askAssistantBannerContentText",de="acrobatTouchPointInOtherSitesPrefDescription";let he=[],ue={},ge=null;class me{constructor(){this.showEligibleSaveButton(),this.ID="#web2pdfSaveButton",this.closePromptID="#prompt-close",this.enableState=!1,this.optionStates=new Set,this.timeoutId=null,this.reloadRequiredForPreference=!1,$(this.ID).click(e=>this.SavePreferences(e)),$(this.closePromptID).click(e=>this.HideSavedPrompt(e))}showEligibleSaveButton(){let e,t;[e,t]=[$("#saveButtonHeader"),$("#saveButtonFooter")],e.removeClass("hidden"),t.remove()}Reset(){this.enableState=!1,this.optionStates.clear(),$(this.ID).prop("disabled",!0)}setEnabled(e){this.optionStates.add(e),$(this.ID).prop("disabled",!1),this.enableState=!0}setDisabled(e){this.optionStates.has(e)&&(this.optionStates.delete(e),0===this.optionStates.size&&($(this.ID).prop("disabled",!0),this.enableState=!1))}GetState(){return this.enableState}_checkAndClearSSRBlobStorage(e=[]){e.some(e=>e.titleId===X)&&d.removeItem("anonGenAISSRHtml")}SavePreferences(){const e={analytics:[]};for(const t in ue)ue[t].hasUpdated&&(e[t]=ue[t].GetCurrentState());const t=he.find(e=>"pdfViewer"===e.storageKey&&e.hasUpdated);if(t){let e;!0===t.currentState||"true"===t.currentState?(n.setItem("viewer-enabled-source","ownership-consent"),e="true"):e="false",s.isEdge()&&s.messageToMain({main_op:"pdfViewerChanged",value:e}),setTimeout(()=>{s.messageToMain({main_op:"reRegisterUninstallUrl"})},1e3)}ue.environment&&ue.environment.hasUpdated&&(s.messageToMain({main_op:"init-floodgate"}),s.messageToMain({main_op:"closeOffscreenDocument"}));const a=he.filter(e=>e.hasUpdated),o=a.length,i=[],r=n.getItem("optionsPageSource");this._checkAndClearSSRBlobStorage(a),a.map(e=>e.SavePreferences()).filter(e=>e).forEach(t=>{e.analytics.push([t,{optionsPageSource:r}]),i.push(t)}),o>0&&p.info({message:"Options preferences updated",updatedSettingsCount:o,analyticsEvents:i,optionsPageSource:r}),function(e,t){s.messageToMain({main_op:"save-preferences",...e},t)}(e,e=>{e.success?this.ShowSavedPrompt(!0):this.ShowSavedPrompt(!1),this.Reset(),Be(async e=>{Re(e.settings),await Ce(e),Le()})})}ShowSavedPrompt(e){const t=$("#savePrompt"),n=$(".prompt"),a=$("#optionsSuccessPrompt");e?(this.reloadRequiredForPreference?a.text(s.getTranslation(y)):a.text(s.getTranslation(M)),this.reloadRequiredForPreference=!1,n.removeClass("failure")):(a.text(s.getTranslation(F)),n.addClass("failure")),t.show(),this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=setTimeout(e=>this.HideSavedPrompt(),5e3)}HideSavedPrompt(){$("#savePrompt").hide()}}class fe{constructor(e,t,s,a){this.titleId=e,this.descriptionId=t,this.storageKey=a,this.defaultState=n.getItem(this.storageKey)||s,this.currentState=this.defaultState,this.hasUpdated=!1,this.savePreferencesButton=null}AttachEventHandler(e){this.savePreferencesButton=e}RenderInputItem(){return $("<div/>")}Render(e=""){const t=$("<div/>",{class:"option "+e}),n=$("<label/>",{class:"label",for:this.titleId}),a=$("<span/>",{class:"label-title",text:s.getTranslation(this.titleId)||this.titleId,id:this.titleId}),o=$("<span/>",{class:"label-description",text:s.getTranslation(this.descriptionId)||this.descriptionId,id:this.descriptionId});n.append(a),n.append(o),t.append(n);const i=this.RenderInputItem();return t.append(i),t}GetCurrentState(){return this.currentState}SavePreferences(){this.hasUpdated&&(this.storageKey&&(s.consoleLog("Updating Preference for ",this.storageKey,"from",n.getItem(this.storageKey,this.defaultState),"to",this.currentState),"pdfViewer"===this.storageKey&&(n.getWithTTL("ownership-upgrade")&&!1===this.currentState&&(s.messageToMain({main_op:"analytics",analytics:[[t.USE_ACROBAT_VIEWER_DISABLED_DEFAULT_OWNERSHIP_EXPERIMENT,{SOURCE:"OptionsPage",EXPERIMENT:n.getItem("experiment-ownership")}],[t.USE_ACROBAT_VIEWER_DISABLED_DEFAULT_OWNERSHIP,{SOURCE:"OptionsPage"}]]}),n.removeItem("ownership-upgrade"),n.removeItem("defaultOwnerShipExperiment")),a.setViewerState(!0===this.currentState?"enabled":"disabled"),ge.reloadRequiredForPreference=!0,this.publishDVStatusUpdate("gmail"),this.publishDVStatusUpdate("gdrive")),"acrobat-touch-points-in-other-surfaces"!==this.storageKey&&"acrobat-gsuite-touch-points"!==this.storageKey||(ge.reloadRequiredForPreference=!0,this.sendAcrobatTouchPointsAlert(this.currentState),this.syncOldTouchPointSettingToIndividual(String(this.currentState))),"acrobat-touch-point-in-embedded-pdf"===this.storageKey&&(ge.reloadRequiredForPreference=!0),"express-touch-points"==this.storageKey&&(ge.reloadRequiredForPreference=!0,chrome.runtime.sendMessage({main_op:"toggle-express-touch-points",allowed:this.currentState})),n.setItem(this.storageKey,String(this.currentState)),"appLocale"!==this.storageKey&&"egaf"!==this.storageKey||setTimeout(()=>{chrome.runtime.sendMessage({main_op:"toggle-add-webpage-to-project-context-menu"})},1e3),"appLocale"===this.storageKey&&setTimeout(()=>{chrome.runtime.sendMessage({main_op:"localeChange",locale:String(this.currentState)})},100)),this.hasUpdated=!1,this.defaultState=this.currentState)}sendAcrobatTouchPointsAlert(e){let t;t=e?"acrobatTouchPointsEnabled":"acrobatTouchPointsDisabled",chrome.tabs.query({url:["https://mail.google.com/*","https://drive.google.com/*","https://outlook.office365.com/*","https://outlook.office.com/*","https://outlook.live.com/*"]},function(e){e?.forEach(function(e){chrome.tabs.sendMessage(e.id,{content_op:t})})})}publishDVStatusUpdate=e=>{chrome.runtime?.sendMessage({main_op:"changeDefaultViewershipForSurface",surfaceId:e,isDefault:this.currentState,source:"extensionPreferencePage"})};syncOldTouchPointSettingToIndividual(e){["acrobat-touch-point-in-gmail","acrobat-touch-point-in-gdrive","acrobat-touch-point-in-outlook","acrobat-touch-point-in-linkedin","acrobat-touch-point-in-google-docs","acrobat-touch-point-in-google-slides","acrobat-touch-point-in-google-sheets"].forEach(t=>{n.setItem(t,e)});n.setItem("show-acrobat-shortcuts-master-switch",e)}}class Se extends fe{constructor(e,t,s,a,o,i){super(e,t,s,a),this.defaultState=function(e,t=!1){const s=n.getItem(e);return s&&""!==s?"true"===s:t}(this.storageKey,s),this.currentState=this.defaultState,this.analyticsId={enabled:o,disabled:i}}onToggleChange(e){const t=$(e.currentTarget);this.currentState=!t.hasClass("checked"),this.hasUpdated=!this.hasUpdated,t.toggleClass("checked"),this.savePreferencesButton&&this.currentState===this.defaultState?this.savePreferencesButton.setDisabled(this.titleId):this.savePreferencesButton.setEnabled(this.titleId),$e.checkAndRemoveIfHighlightedSettingChanged(t[0])}RenderDisabledInputItem(){const e=$("<span/>"),t=$("<button/>",{class:"option-toggle-disabled"});return e.append(t),e}RenderInputItem(){const e=$("<span/>"),t=$("<button/>",{class:"option-toggle"});return t.click(e=>this.onToggleChange(e)),this.currentState&&t.addClass("checked"),e.append(t),e}GetAnalytics(){return this.currentState?this.analyticsId.enabled:this.analyticsId.disabled}SavePreferences(){return super.SavePreferences(),this.GetAnalytics()}}class Ie extends fe{constructor(e,t,s,a,o,i,r){super(e,t,a,o),this.valuesMap=s,this.onSavePreferences=i,r&&!n.getItem(o)&&n.setItem(o,String(a))}onSelectionChange(e){this.currentState=$(e.currentTarget).val(),this.currentState===this.defaultState?(this.hasUpdated=!1,this.savePreferencesButton&&this.savePreferencesButton.setDisabled(this.titleId)):(this.hasUpdated=!0,this.savePreferencesButton&&this.savePreferencesButton.setEnabled(this.titleId)),$e.checkAndRemoveIfHighlightedSettingChanged(e.currentTarget)}RenderInputItem(){const e=$("<span/>"),t=$("<select/>",{class:"option-select"});for(const e in this.valuesMap){const n=$("<option/>",{value:e,text:this.valuesMap[e]});t.append(n)}return t.change(e=>this.onSelectionChange(e)),this.currentState&&t.val(this.currentState),e.append(t),e}SavePreferences(){const e=this.defaultState;super.SavePreferences(),this.onSavePreferences&&this.onSavePreferences(this.currentState,e)}}class Ee extends Se{constructor(){let e="false"===n.getItem("ANALYTICS_OPT_IN_ADMIN")?g:u;super(h,e,!0,"logAnalytics",t.OPTIONS_ENABLED_ANALYTICS,t.OPTIONS_DISABLED_ANALYTICS),this.learnMoreLink=m,this.learnMoreTitle=f}Render(){const e=$("<div/>",{class:"option"}),a=$("<label/>",{class:"label",for:this.titleId}),o=$("<span/>",{class:"label-title",text:s.getTranslation(this.titleId),id:this.titleId}),i=$("<span/>",{class:"label-description",text:s.getTranslation(this.descriptionId)+" ",id:this.descriptionId}),r=$("<a/>",{class:"learn-more",href:s.getTranslation(this.learnMoreLink),text:s.getTranslation(this.learnMoreTitle),target:"_blank"});let c;return r.click(function(){s.messageToMain({main_op:"analytics",analytics:[[t.OPTIONS_ABOUT_ADOBE_ACROBAT_CLICKED]]})}),a.append(o),a.append(i),e.append(a),"false"===n.getItem("ANALYTICS_OPT_IN_ADMIN")?c=this.RenderDisabledInputItem():(c=this.RenderInputItem(),i.append(r)),e.append(c),e}SavePreferences(){if(this.hasUpdated)return this.hasUpdated=!1,this.defaultState=this.currentState,this.GetAnalytics()}}class Te extends Se{constructor(e,t,n,s,a,o){super(e,t,n,s,a,o)}Render(){return $("<div/>",{class:"ai-contextual-menu-toggle"}).append(super.Render())}}class _e extends Se{Render(){return $("<div/>",{class:"whats-new-auto-open-toggle"}).append(super.Render())}}class be extends fe{constructor(e,t,s){super(e,t,[],s),this.currentState=n.getItem(this.storageKey)||[]}RenderInputItem(){const e=$("<div/>",{class:"domain-container"}),t=this.renderTags(this.currentState);return $("<button/>",{id:"show-more-btn",text:"Show all"}).click(()=>{}),e.append(t),e}renderTags(e){const t=$("<div/>",{class:"tag-list",id:"tag-list"});for(let n of e){const e=$("<div/>",{class:"tag"});e.html(`${n} <span class="close-btn">Ã—</span>`),t.append(e)}return t.on("click",".close-btn",e=>{const t=e.currentTarget.parentElement,n=t.textContent.trim();this.removeDomain(n.slice(0,-2)),t.remove()}),t}Render(){if(this.currentState?.length)return super.Render("domain-option")}removeDomain(e){this.currentState=this.currentState.filter(t=>t!==e),this.hasUpdated=!0,this.savePreferencesButton?.setEnabled(this.titleId)}SavePreferences(){this.hasUpdated&&(this.storageKey&&(s.consoleLog("Updating domains for",this.storageKey,"to",this.currentState),n.setItem(this.storageKey,this.currentState)),this.hasUpdated=!1,this.defaultState=this.currentState)}}class Pe extends fe{constructor(e,t){super(e,t,null,null)}onButtonClick(n){chrome.tabs.create({url:i,active:!0}),chrome.extension.isAllowedFileSchemeAccess().then(n=>{e.event(t.LOCAL_FILE_OPTIONS_CLICKED,{STATE:n?"Disable":"Enable"})})}RenderInputItem(){const e=$("<span/>"),t=$("<button/>",{class:"option-localfile"}),n=$("<span/>",{class:"option-localfile-text"});return chrome.extension.isAllowedFileSchemeAccess().then(e=>{n.text(s.getTranslation(e?"Disable":"Enable")),t.append(n),t.append($("<img>",{class:"option-localfile-icon"}).attr("src","../images/SDC_LinkOut_13_N.svg"))}),t.click(e=>this.onButtonClick(e)),e.append(t),e}SavePreferences(){}}class ve extends fe{constructor(e,t){super(e,t,null,null)}handleClick(){s.messageToMain({main_op:"analytics",analytics:[t.TREFOIL_HTML_PREFERENCES_CLICK]}),s.messageToMain({main_op:"showConversionSettingsDialog"})}RenderInputItem(){const e=$("<span/>"),t=$("<button/>",{class:"option-webpage-conversion"}),n=$("<span/>",{class:"option-webpage-conversion-text"});return n.text(s.getTranslation("editMegaVerbText")),t.append(n),t.click(this.handleClick),e.append(t),e}}class Oe extends fe{constructor(e,t,n,s){super(e),this.optionClassOverride=s,this.contentTextId=t,this.contentImagePath=n}Render(){const e=$("<div/>",{class:"option "+this.optionClassOverride}),t=$("<label/>",{class:"label",for:this.titleId}),n=$("<span/>",{class:"label-title",id:this.titleId});n.append(document.createTextNode(s.getTranslation(this.titleId)||this.titleId),$("<span/>",{text:"Beta",class:"beta-label"}));const a=$("<span/>",{class:"label-description",text:s.getTranslation(this.descriptionId)||this.descriptionId,id:this.descriptionId}),o=$("<div/>",{class:"preference-item-banner-content-wrapper"}),i=$("<div/>",{class:"banner-content-text-wrapper"}),r=$("<span/>",{class:"banner-content-text",text:s.getTranslation(this.contentTextId)||this.contentTextId});if(i.append(r),o.append(i),this.contentImagePath){const e=$("<div/>",{class:"banner-content-image-wrapper"}),t=$("<img>",{class:"banner-content-image"}).attr("src",this.contentImagePath);e.append(t),o.append(e)}return t.append(n),t.append(a),e.append(t),e.append(o),e}}class Ae extends fe{constructor(e,t){super(),this.optionClassOverride=e,this.contentImagePath=t}Render(){const e=$("<div/>",{class:`${this.optionClassOverride}`}),t=$("<div/>",{class:`option ${this.optionClassOverride}`}).append($("<img>",{class:"banner-image",src:this.contentImagePath,id:"aiMarkerTouchpointBanner"}));return e.append(t),e}}function we(e){return e.version>13}function Ne(e){return 13==e.version}function De(){const e=n.getItem("fteDenied")||"0",t="false"===n.getItem("pdfViewer");return SETTINGS.VIEWER_SHOW_OPEN_IN_ACRO&&(10===parseInt(e)||t)}function Re(e){if(e&&e.settings){for(const t in e.settings)SETTINGS[t]=e.settings[t];(function(e){return null===e.locale})(e)&&(SETTINGS.FRICTIONLESS_ENABLED=!1)}}function Le(){null==ge&&(ge=new me);const e=$("#toggles");$("#progress").remove(),e.empty(),he.forEach(t=>{t.AttachEventHandler(ge);const n=t.Render();e.append(n)})}async function xe(e){try{const t=await chrome.runtime.sendMessage({main_op:"getFloodgateMeta",flag:e}),n=JSON.parse(t||"{}");return{isEnLocalEnabled:n.enLocaleEnabled||!1,isNonEnLocalEnabled:n.nonEnLocaleEnabled||!1}}catch(e){return{isEnLocalEnabled:!1,isNonEnLocalEnabled:!1}}}async function Ce(e){he=[],ue={};const i=new Ee,r=new _e(E,T,!0,"whatsNewAutoOpen",t.OPTIONS_ENABLE_WHATS_NEW_AUTO_OPEN,t.OPTIONS_DISABLE_WHATS_NEW_AUTO_OPEN),l=new Se(S,I,!0,"always-show-pdftools",t.FRICTIONLESS_AUTO_SUGGESTION_ENABLED,t.FRICTIONLESS_AUTO_SUGGESTION_DISABLED),p=new Te(oe,ie,!0,"aiMarkers",t.OPTIONS_ENABLE_AI_MARKERS,t.OPTIONS_DISABLE_AI_MARKERS),d=new Se(_,b,!1,"pdfViewer",t.USE_ACROBAT_IN_CHROME_ENABLED,t.USE_ACROBAT_IN_CHROME_DISABLED),h=new Se(P,v,!0,"ViewResultsPref",t.TREFOIL_HTML_OPENPDF_PREF_ON,t.TREFOIL_HTML_OPENPDF_PREF_OFF),u=new Se(O,A,!0,"always-show-pdf-menu",t.OPTIONS_ENABLED_OPEN_IN_ACROBAT,t.OPTIONS_DISABLED_OPEN_IN_ACROBAT),g=new Se(D,R,!0,"egaf",t.OPTIONS_ENABLE_GENAI_FEATURES,t.OPTIONS_DISABLE_GENAI_FEATURES),m=new Se(L,x,!0,"autoSum",t.OPTIONS_ENABLE_GENAI_AUTO_SUMMARIZE,t.OPTIONS_DISABLE_GENAI_AUTO_SUMMARIZE),f=new Se(C,B,!1,"bypassGenAIWebpageEligibility",void 0,void 0),M=new Pe(re,ce),y=new ve(w,N);we(e)?(he.push(h),SETTINGS.VIEWER_ENABLED&&SETTINGS.VIEWER_ENABLED_FOR_ACROBAT?(he.push(d),De()&&he.push(u)):he.push(u)):Ne(e)?await async function(){const e=await async function(){return!(s.isEdge()&&await a.isMimeHandlerAvailable()&&n.getItem("openInAcrobatEnable")&&"admin"!==n.getItem("installSource"))}();SETTINGS.VIEWER_ENABLED?(he.push(d),De()&&e&&he.push(u)):e&&he.push(u)}():SETTINGS.VIEWER_ENABLED&&he.push(d);const F=[],ge=["dc-cv-gmail-acrobat-touch-point","dc-cv-gdrive-prompt","dc-cv-embedded-pdf-touch-point","dc-cv-outlook-pdf-touch-point","dc-cv-linkedin-pdf-touch-point","dc-cv-linkedin-chat-pdf-touch-point","dc-cv-google-docs-convert-to-pdf-touch-point","dc-cv-google-slides-convert-to-pdf-touch-point","dc-cv-google-sheets-convert-to-pdf-touch-point"];for(const ut of ge)F.push(chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:ut}));const[me,Re,Le,Ce,Be,Me,ye,$e,Fe]=await Promise.all(F),ke=me||Re||Ce||Be||Me||ye||$e||Fe,Ue="en-US"===n.getItem("locale")||"en-GB"===n.getItem("locale");if(ke){let gt=Y,mt=Z;if(Ce&&(gt=J,mt=te),Be||Me){let St=!1,It=!1;if(Be){const Et=await xe("dc-cv-linkedin-pdf-touch-point");St||=Et.isEnLocalEnabled,It||=Et.isNonEnLocalEnabled}if(Me){const Tt=await xe("dc-cv-linkedin-chat-pdf-touch-point");St||=Tt.isEnLocalEnabled,It||=Tt.isNonEnLocalEnabled}(Ue&&St||!Ue&&It)&&(gt=J,mt=ne)}Ue&&(mt=de);const ft=new Se(gt,mt,!0,"acrobat-touch-points-in-other-surfaces",t.OPTIONS_ACROBAT_TOUCH_POINT_ENABLED,t.OPTIONS_ACROBAT_TOUCH_POINT_DISABLED);he.push(ft)}if(Le){const _t=new Se(Q,ee,!0,"acrobat-touch-point-in-embedded-pdf",t.OPTIONS_ACROBAT_EMBEDDED_TOUCH_POINT_ENABLED,t.OPTIONS_ACROBAT_EMBEDDED_TOUCH_POINT_DISABLED);_t.Render=function(){return fe.prototype.Render.call(this,"embedded-pdf-touchpoint-section")},he.push(_t)}const Ge=await chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:"dc-cv-genai-disable-pref"}),He="true"===n.getItem("genAIEligible");He&&Ge&&(he.push(g),n.getItem("autoSummaryEligible")&&he.push(m));const Ke=await chrome.runtime.sendMessage({main_op:"getWhatsNewFlag"}),Ve=(n.getItem("whatsNewState")||{}).disableAutoOpenByAdmin;Ke&&!Ve&&he.push(r),SETTINGS.FRICTIONLESS_ENABLED&&he.push(l);const We=await chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:"dc-cv-local-file-fte"}),qe=await chrome.extension.isAllowedFileSchemeAccess();!We||s.isEdge()||qe||he.push(M);const je=s.getTranslation(G),ze=s.getTranslation(H),Xe=s.getTranslation(K);const Ye=new Ie(k,U,{auto:je,dark:ze,light:Xe},"auto","theme",function(e,n){s.messageToMain({main_op:"themeChange",analytics:[[t.OPTIONS_APPEARENCE_THEME_CHANGED,{OLDTHEME:n,NEWTHEME:e}]]})},!0);if(he.push(Ye),!0===n.getItem("isSaveLocationPrefEnabled")){const bt=s.getTranslation(q),Pt=s.getTranslation(j),vt=s.getTranslation(z);function Ot(e,a){s.messageToMain({main_op:"analytics",analytics:[[t.SAVE_LOCATION_PREFERENCE_CHANGED,{OLDPREF:a,NEWPREF:e}]]}),n.setItem("selectedSaveLocationPreference",!0)}const At=new Ie(V,W,{ask:bt,cloud:Pt,local:vt},"ask","saveLocation",Ot,!0);he.push(At)}const Ze=new Ie(X,null,o,n.getItem("viewer-locale")||s.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale")),"appLocale",async()=>{},!0);he.push(Ze);const Je=[chrome.runtime.sendMessage({main_op:"express-init"}),chrome.runtime.sendMessage({main_op:"whatsapp-express-init"}),chrome.runtime.sendMessage({main_op:"gmail-express-init"}),chrome.runtime.sendMessage({main_op:"google-image-preview-express-init"}),chrome.runtime.sendMessage({main_op:"gdrive-express-init"}),chrome.runtime.sendMessage({main_op:"facebook-express-init"}),chrome.runtime.sendMessage({main_op:"chatgpt-express-init"}),chrome.runtime.sendMessage({main_op:"outlook-express-init"}),chrome.runtime.sendMessage({main_op:"gemini-express-init"}),chrome.runtime.sendMessage({main_op:"google-chat-express-init"})],[Qe,et,tt,nt,st,at,ot,it,rt,ct]=await Promise.all(Je);if(Qe.shouldEnableExpressTouchpointsPreference||et.enableExpressOptionsPagePreference||tt.enableExpressOptionsPagePreference||nt.enableExpressOptionsPagePreference||st.enableExpressOptionsPagePreference||at.enableExpressOptionsPagePreference||ot.enableExpressOptionsPagePreference||it.enableExpressOptionsPagePreference||rt.enableExpressOptionsPagePreference||ct.enableExpressOptionsPagePreference){const wt=new Se(se,ae,!0,"express-touch-points",t.OPTIONS_EXPRESS_TOUCHPOINT_ENABLED,t.OPTIONS_EXPRESS_TOUCHPOINT_DISABLED);wt.Render=function(){return fe.prototype.Render.call(this,"express-touchpoints-section")},he.push(wt)}he.push(i),ue.analytics_on=i,function(e){function t(e){s.messageToMain({panel_op:"common",type:"update_env",env:e})}const a=new Ie("Development Environment","Select the target environment for the extension.",{prod:"Production",stage:"Stage",test:"Test",dev:"Dev","local-dev":"Local Dev"},e.environment||"prod","env",t),o=new Ie("GenAI Cluster","Select the target cluster for the extension.",{develop:"Develop",beta:"Beta",release:"Release"},c(),"cluster"),i=new Ie("Development Environment","Select the target environment for the extension.",{prod:"Production",stage:"Stage"},e.environment||"prod","env",t),r=we(e)?"acrobat":Ne(e)?"reader":"no-app",l=new Ie("Connected Application","Select the target connected application for the extension functionalities. This settings only mock the views, the functionality may be broken.",{acrobat:"Acrobat",reader:"Reader","no-app":"No App"},r||"acrobat"),p="true"===n.getItem("adobeInternal");SETTINGS.DEBUG_MODE?(he.push(a,o,l),ue.environment=a,ue.product=l):p&&(he.push(i),ue.environment=i)}(e),we(e)&&he.push(y);const lt=new Oe(le,pe,"../images/ai_assistant_web_page.svg","ai-assistant-banner-header-wrapper"),pt=new Se("genAIFabPreferenceTitle","genAIFabPreferenceDescription",!1,"enableGenAIFab",t.OPTIONS_ENABLE_GEN_AI_FAB,t.OPTIONS_DISABLE_GEN_AI_FAB),dt=(new class extends fe{constructor(e,t,n,a){super(e,t,null,null),this.url=n,this.buttonText=s.getTranslation(a)}onButtonClick(e){chrome.tabs.create({url:this.url,active:!0})}RenderInputItem(){const e=$("<span/>"),t=$("<button/>",{class:"option-localfile"}),n=$("<span/>",{class:"option-localfile-text"});return n.text(this.buttonText),t.append(n),t.append($("<img>",{class:"option-localfile-icon"}).attr("src","../images/SDC_LinkOut_13_N.svg")),t.click(e=>this.onButtonClick(e)),e.append(t),e}SavePreferences(){}}("sidepanelLocationPreferenceTitle","sidepanelLocationPreferenceDescription","chrome://settings/appearance#:~:text=Side%20panel%20position","sidepanelLocationPreferenceButtonText"),new be("domainPreferenceTitle","","hideFabDomainList"));if(n.getItem("sidePanelRegistered")){he.push(lt),pt.Render=function(){return fe.prototype.Render.call(this,"fab-preference-toggle")},he.push(pt),he.push(dt);"true"===n.getItem("adobeInternal")&&he.push(f)}const ht=await chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:"dc-cv-genai-markers"});if(He&&Ge&&ht){const Nt=new Ae("ai-contextual-menu-section","../images/SummarizeBanner.svg");he.push(Nt),he.push(p)}}function Be(e){s.messageToMain({main_op:"fetch-preferences"},e)}function Me(e){const t=he.filter(t=>t.titleId===e);return t.length>0?t[0]:null}function ye(e,t,n){if(SETTINGS.TEST_MODE)return;const s=e.toggleId,a=Me(s),o=e.requestType;let i,c;switch(o){case r.OPTIONS_UPDATE_TOGGLE:a?(a.currentState=e.toggleVal,a.savePreferencesButton.SavePreferences(),i=a.currentState):c="Toggle not visible.",n&&n({requestType:o,toggleId:s,response:i,error:c});case r.OPTIONS_HIGHLIGHT_SECTION:e.sectionClassNames&&function(e){$e.remove();const t=[];if(e.forEach(e=>{if(!e)return;$(`.${e}`).each(function(){t.push($(this))})}),0===t.length)return;let n=1/0,s=1/0,a=-1/0,o=-1/0;t.forEach(e=>{const t=e.offset(),i=e.outerWidth(),r=e.outerHeight();n=Math.min(n,t.top),s=Math.min(s,t.left),a=Math.max(a,t.top+r),o=Math.max(o,t.left+i)});const i=0,r=38;n-=i,s-=r,a+=i,o+=r;const c={top:n,left:s,width:o-s,height:a-n};$e.create(c,e);const l=n+(a-n)/2,p=$("<div/>").css({position:"absolute",top:l+"px",left:"0px",height:"1px",width:"1px"});$("body").append(p),p[0].scrollIntoView({behavior:"smooth",block:"center"}),p.remove()}(e.sectionClassNames),n&&n({success:!0})}}let $e=new l;$(document).ready(function(){$e.remove(),s.translateElements(".translate"),Be(async e=>{Re(e),await Ce(e),Le(),s.addMainListener(ye),function(){if(!SETTINGS.TEST_MODE)return;const e="check_toggle_state",t="update_toggle_state";chrome.runtime.onMessage.addListener(function(n,s,a){if(!n.panel_op||"test"!==n.panel_op)return;const o=n.test_extension,i=n.toggleId,r=Me(i);let c,l;switch(o){case e:r?c=r.currentState:l="Toggle not visible.";break;case t:r?(r.currentState=n.toggleVal,r.hasUpdated=!0,r.savePreferencesButton.SavePreferences(),c=r.currentState):l="Toggle not visible.";break;default:l="Invalid request type."}a({requestType:o,toggleId:i,response:c,error:l})})}();await a.isMimeHandlerAvailable()||chrome.runtime.sendMessage({main_op:"updateLoadedTabsInfo"})})}),$(document).on("visibilitychange",()=>{document.hidden&&$e.remove()})});