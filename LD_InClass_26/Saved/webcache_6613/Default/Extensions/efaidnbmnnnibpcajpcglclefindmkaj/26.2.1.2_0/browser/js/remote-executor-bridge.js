/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
let e=null,t=null,n=null,o=null,r=null,i=null;async function a(...e){const t=await chrome.storage.local.get("remoteExecutionDebugMode"),n=t?.remoteExecutionDebugMode;"prod"!==await async function(){if(i)return i;const e=await chrome.runtime.sendMessage({main_op:"getEnvironment"});return i=e.environment,i}()&&n&&console.log(...e)}function d(){var i;i="Remote Execution: Remote executor bridge initialized",chrome.runtime.sendMessage({main_op:"log-info",log:{message:i,executionSource:"remoteExecution"}}),e=document.getElementById("cdn-iframe"),e.onload=function(){const e=document.getElementById("loaderId");e&&e.remove()},t=window.parent,a("Remote executor bridge initialized");const d=new URLSearchParams(window.location.search);r=d.get("parentOrigin"),window.addEventListener("message",i=>{if(i.source===t){if(i.origin!==r)return void a("Rejected message from unauthorized parent origin:",i.origin,"Expected:",r);const{type:t,data:d,cdnUrl:c}=i.data;switch(t){case"SETUP_CDN_IFRAME":if(c){n=c,o=new URL(c).origin;const t=i.data.iframeConfig||{};a("Setting up CDN iframe with URL:",c,"and config:",t),function(t,n={}){if(e)try{const o={allowfullscreen:!1!==n.allowFullscreen?"true":"false",allow:n.allow||"clipboard-read; clipboard-write;",...n.attributes};Object.entries(o).forEach(([t,n])=>{null!=n&&e.setAttribute(t,n)});const r={width:n.iframeWidth||"100%",height:n.iframeHeight||"100%",border:n.iframeBorder||"none",overflow:n.iframeOverflow||"hidden",...n.iframeStyles};Object.entries(r).forEach(([t,n])=>{null!=n&&e.style.setProperty(t,n,"important")}),e.src=t,a("CDN iframe injected with URL:",t)}catch(e){a("Failed to inject CDN iframe",{error:e})}else a("CDN iframe element not found")}(c,t)}break;case"RELAY_TO_CDN":e&&e.contentWindow&&o?(a("Relaying message to CDN:",d),e.contentWindow.postMessage(d,o)):a("CDN iframe not ready for message relay or CDN origin not set");break;case"REMOVE_CDN_IFRAME":a("Removing CDN iframe"),e&&(e.src="",a("CDN iframe removed"))}}if(i.source===e?.contentWindow){if(o&&i.origin!==o)return void a("Rejected message from unauthorized CDN origin:",i.origin);if("DOWNLOAD_FILE_USING_CHROME_API"===i.data.type)return void function(e){let{buffer:t,fileName:n,fileType:o}=e,r=t.split(",")[1],i=atob(r),d=new ArrayBuffer(i.length),c=new Uint8Array(d);for(let e=0;e<i.length;e++)c[e]=i.charCodeAt(e);let s=new Blob([d],{type:o}),l=URL.createObjectURL(s);chrome.downloads.download({url:l,filename:n,conflictAction:"uniquify"},function(e){chrome.downloads.onChanged.addListener(function t(n){n.id===e&&n.state&&"complete"===n.state.current&&(l&&URL.revokeObjectURL(l),chrome.downloads.onChanged.removeListener(t))}),chrome.runtime.lastError&&a(chrome.runtime.lastError)})}(i.data.payload);a("Relaying message from CDN to parent:",i.data),t.postMessage({type:"RELAY_FROM_CDN",data:i.data},r)}}),t.postMessage({type:"BRIDGE_READY"},r),a("BridgeReady message sent to parent with origin:",r)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",d):d();