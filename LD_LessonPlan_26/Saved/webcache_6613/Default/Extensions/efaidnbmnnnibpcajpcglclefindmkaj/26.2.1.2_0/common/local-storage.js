/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class t{constructor(t){switch(this.storage=null,this.storagePromise=null,this.type=t,t){case"local":this.storageApi=chrome.storage.local;break;case"session":this.storageApi=chrome.storage.session;break;default:throw new Error("dcStorage type not supported")}this.ignoreKeys=["Floodgate","Common","Communicate"]}logError(t){try{chrome?.runtime?.sendMessage&&chrome.runtime.sendMessage({main_op:"log-error",log:{...t,storageType:this.type}})}catch(t){}}async shouldLogQuotaError(){try{const t=Date.now(),e=864e5,r="local"===this.type?"qe_l":"qe_s",s=await chrome.storage.session.get(r);return t-(s[r]||0)>e&&(await chrome.storage.session.set({[r]:t}),!0)}catch(t){return!1}}async logQuotaError(t,e){if(await this.shouldLogQuotaError())try{chrome?.runtime?.sendMessage&&chrome.runtime.sendMessage({main_op:"log-quota-error",key:t,storageType:this.type,errorMessage:e})}catch(t){}}async init(){try{this.storagePromise||(this.storagePromise=this.storageApi.get()),this.storage||(this.storage=await this.storagePromise)}catch(t){this.logError({message:`Error initializing ${this.type} storage`,error:t?.toString?.()||"Unknown error"})}}getAllItems(){return this.storage||{}}length(){return Object.keys(this.getAllItems()).length}getItem(t){return this.storage&&void 0!==this.storage[t]?this.storage[t]:""}async setItem(t,e){try{return this.storage[t]=e,await this.storageApi.set({[t]:e})}catch(e){if(this.ignoreKeys.includes(t))return;const r=e?.toString?.()||"Unknown error";return void this.logQuotaError(t,`Error setting item in ${this.type} storage: ${r}`)}}async removeItem(t){try{this.storage&&delete this.storage[t],await this.storageApi.remove(t)}catch(e){this.logError({message:"Error removing item from local storage",key:t,error:e?.toString?.()||"Unknown error"})}}setWithTTL(t,e,r){try{const s=(new Date).getTime()+r;return this.setItem(t,{value:e,expiry:s})}catch(t){}}getWithTTL(t){try{const e=(new Date).getTime(),r=this.getItem(t);if(r){if(e<=r.expiry)return r.value;this.removeItem(t)}}catch(t){}}updateWithTTL(t,e){try{const r=this.storage[t];if(r)return this.setItem(t,{value:e,expiry:r.expiry})}catch(t){}}getItems(t){const e={};return t.forEach(t=>{this.storage&&void 0!==this.storage[t]&&(e[t]=this.storage[t])}),e}}const e=new t("local"),r=new t("session"),s=(...t)=>(...s)=>{Promise.all([e.init(),r.init()]).then(()=>t.forEach(t=>t(...s)))};chrome.storage.onChanged.addListener(async(t,s)=>{let o;switch(s){case"local":o=e;break;case"session":o=r;break;default:return}await o.init(),Object.entries(t).forEach(([t,{newValue:e}])=>{void 0!==e?o.storage[t]=e:delete o.storage[t]})});export{e as dcLocalStorage,r as dcSessionStorage,s as callWithStorage};