/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import state from"./state.js";import{sendAnalytics,sendErrorLog,buildAcrobatPromotionSource}from"../utils/util.js";import{createURLForAttachment,getParentElementForNativeViewerPrompt}from"./util.js";import{createFteTooltip,updateFteToolTipCoolDown,addFteCloseButtonListener}from"../utils/fte-utils.js";const PDF_TOOLS_FTE_TOOLTIP_STORAGE_KEY="acrobat-gmail-pdf-tools-fte-config",DIRECT_VERB_FTE_DISMISSED_ANALYTICS_EVENT="DCBrowserExt:DirectVerb:Fte:Dismissed",PDF_TOOLS_TOUCHPOINT_CLASS="acrobat-native-viewer-pdf-tools-touchpoint",handleFteClickOutside=(e,o)=>{if(o.getRootNode()instanceof ShadowRoot){e.composedPath().includes(o)||(o.remove(),state.fteToolTip.eligibleFte.type="",sendAnalytics([["DCBrowserExt:DirectVerb:Fte:Dismissed",{source:"gmail_chrome",workflow:"pdf_tools"}]]),o.clickOutsideHandler&&document.removeEventListener("click",o.clickOutsideHandler))}},addPdfToolsFteTooltipToAttachmentDiv=e=>{const o=createFteTooltip({title:state?.gmailConfig?.pdfToolsFteToolTipStrings?.title,description:state?.gmailConfig?.pdfToolsFteToolTipStrings?.description,button:state?.gmailConfig?.pdfToolsFteToolTipStrings?.button},"pdfTools");function t(e){handleFteClickOutside(e,o)}o.clickOutsideHandler=t,addFteCloseButtonListener(o,{fteType:"pdfTools",onClose:()=>{state.fteToolTip.eligibleFte.type="",sendAnalytics([["DCBrowserExt:DirectVerb:Fte:Dismissed",{source:"gmail_chrome",workflow:"pdf_tools"}]])},sendErrorLog:sendErrorLog}),document.addEventListener("click",t,{once:!0,signal:state?.eventControllerSignal}),state.fteToolTip.eligibleFte.type="pdfTools";const r=e.shadowRoot;r?setTimeout(()=>{const e=r.querySelector("#pdf-tools-react-root"),t=r.querySelector(".cvPdfTools-pdf-entrypoint-button");if(!e||!t)return void sendErrorLog("PDFToolsFTE_ReactElementsNotFound","React root or CTA button not found in shadow DOM");e.appendChild(o);const i=()=>{o.remove(),state.fteToolTip.eligibleFte.type="",sendAnalytics([["DCBrowserExt:DirectVerb:Fte:Dismissed",{source:"gmail_chrome",workflow:"pdf_tools"}]]),o.clickOutsideHandler&&document.removeEventListener("click",o.clickOutsideHandler),t.removeEventListener("mouseenter",i)};t.addEventListener("mouseenter",i,{once:!0}),sendAnalytics([["DCBrowserExt:DirectVerb:Fte:Shown",{source:"gmail_chrome",workflow:"pdf_tools"}]]),updateFteToolTipCoolDown(state?.gmailConfig?.fteConfig?.tooltip,PDF_TOOLS_FTE_TOOLTIP_STORAGE_KEY).then(e=>{state.fteToolTip={...state?.fteToolTip,...e}})},50):sendErrorLog("Add_PDFToolsFTE_NoShadowRoot","Shadow root not found on pdfToolsDropdownElement")},addPdfToolsFTETooltipIfEligible=async e=>{await initDcLocalStorage();const o=(await chrome.storage.local.get(PDF_TOOLS_FTE_TOOLTIP_STORAGE_KEY))[PDF_TOOLS_FTE_TOOLTIP_STORAGE_KEY];o?.count>=1?gmailPdfToolsFteCoachmark.setEligibility(!1):(gmailPdfToolsFteCoachmark.setEligibility(!0,()=>{addPdfToolsFteTooltipToAttachmentDiv(e)}),chrome.runtime.sendMessage({main_op:"reRenderShowOneChild"}))},renderPdfToolsDropdown=async(e,o,t)=>{const r=getParentElementForNativeViewerPrompt();if(r&&r?.childNodes?.length>0)return import(chrome.runtime.getURL("dist/PdfToolsDropdown.js")).then(t=>t.default.render(t=>{const r=buildAcrobatPromotionSource("gmail_chrome","openInAcrobat"===t?"native_view":t),i=createURLForAttachment(e,r,o,"openInAcrobat"===t?"preview":t);window.open(i,"_blank")},"gmailNativeViewer")).then(o=>{r.insertBefore(o,r.childNodes[0]),state.nativeViewerPromptState.nativeViewerAttachmentURL=e,state.nativeViewerPromptState.previousFileDetailsElement=t(),window.innerWidth>1200&&addPdfToolsFTETooltipIfEligible(o)}).catch(e=>{throw sendErrorLog("PDFTools_ReactRenderError",e.message),e});throw new Error("Parent element not found for PDF Tools dropdown")},removePdfToolsDropdown=async()=>document.querySelector(`.${PDF_TOOLS_TOUCHPOINT_CLASS}`)?import(chrome.runtime.getURL("dist/PdfToolsDropdown.js")).then(e=>{const o=e.default;o&&o.isRendered()&&o.remove()}).catch(()=>{}).finally(()=>{const e=document.querySelector(`.${PDF_TOOLS_TOUCHPOINT_CLASS}`);e&&e.parentElement&&e.parentElement.removeChild(e)}):Promise.resolve();export{renderPdfToolsDropdown,removePdfToolsDropdown};