/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
const isGoogleSearchLink=checkGoogleSearchLink(),isDarkMode=window.matchMedia("(prefers-color-scheme: dark)").matches;let hoverTimeout,showAssistantMarker=!0,isCursorOnPopup=null,hoveredLink=null,currentPopupTimeouts=new Map,genaiMarkersConfig=null,autoPopupHref=null,linkRanking=new Map;async function getGenaiMarkersConfig(){if(null===genaiMarkersConfig){const e=await chrome.runtime.sendMessage({main_op:"getFloodgateMeta",flag:"dc-cv-genai-markers"});genaiMarkersConfig=JSON.parse(e||"{}")}return genaiMarkersConfig}async function showPopup(e,t,n=!1,o=!1){if(isInvalidContentScript())return;const i=`__assistantPopup__${t}`;if(document.getElementById(i))o||(hoverTimeout=setTimeout(()=>showPopup(e,t,!1,!0),300));else{let o=document.createElement("iframe");o.id=i,o.style.cssText=`\n            border: 0;\n            z-index: 127;\n            position: absolute;\n            margin: auto;\n            background: transparent;\n            color-scheme: auto;\n            left: ${e.right+(scrollX||0)}px;\n            top: ${e.top+(scrollY||0)-13}px;\n            width: 250px;\n            height: 50px;\n            min-height: unset;\n            overflow: hidden;\n            opacity: 0;\n        `,o.src=chrome.runtime.getURL("browser/js/newAssistantPopup.html?pdfMarkerLink="+encodeURIComponent(t)+"&theme="+(isDarkMode?"dark":"light")+"&expanded="+n),document.body.appendChild(o),validateIframePosition(e,o),o.addEventListener("mouseenter",()=>{isCursorOnPopup=t}),o.addEventListener("mouseleave",()=>{isCursorOnPopup=null,setTimeout(()=>hidePopup(t),400)})}}async function validateIframePosition(e,t){const n=await getGenaiMarkersConfig(),{horizontalOffset:o=20,verticalOffset:i=20}=n,r=t.getBoundingClientRect();(r.left-e.right>o||e.top-r.top>i)&&(t?.remove(),chrome.runtime.sendMessage({main_op:"log-info",log:{message:"AI marker popup is too far from the text",link:hoveredLink}}))}function hidePopup(e,t=!1){if(!t&&(hoveredLink===e||isCursorOnPopup===e))return;const n=`__assistantPopup__${e}`,o=document.getElementById(n);if(o){currentPopupTimeouts.has(e)&&clearTimeout(currentPopupTimeouts.get(e)),o.contentWindow.postMessage({action:"exit"},`chrome-extension://${chrome.runtime.id}`);const t=setTimeout(()=>{o.remove(),currentPopupTimeouts.delete(e)},400);currentPopupTimeouts.set(e,t)}}function checkGoogleSearchLink(){const e=window.location.href;return/https:\/\/www\.google\.(com|[a-z]{2}|com\.[a-z]{2}|co\.[a-z]{2}|cat)\/search\?/.test(e)&&e.includes("q=")}function isPDFLink(e,t){return e&&e.match(/\.pdf(?=\?|#|$)/i)&&t.trim().length>0}let pdfLinksCache=null;function getPDFLinks(){if(null===pdfLinksCache){const e=Array.from(document.querySelectorAll("a[href]")).filter(e=>e.classList.contains("zReHs"));pdfLinksCache=e.filter((e,t)=>{const n=decodeURIComponent(e.getAttribute("href")),o=isPDFLink(n,e.textContent);return o&&linkRanking.set(n,t+1),o})}return pdfLinksCache}const ONE_WEEK_MS=6048e5,AUTO_POPUP_STORAGE_KEY="aiMarkerAutoPopupLastShown";async function shouldShowAutoPopup(){try{const e=(await chrome.storage.local.get(AUTO_POPUP_STORAGE_KEY))[AUTO_POPUP_STORAGE_KEY];return!e||Date.now()-e>=6048e5}catch(e){return!0}}async function recordAutoPopupShown(){try{await chrome.storage.local.set({[AUTO_POPUP_STORAGE_KEY]:Date.now()})}catch(e){}}function getTargetRect(e){let t=e.getBoundingClientRect();if(isGoogleSearchLink){const n=e.getElementsByTagName("h3")[0]?.firstChild;if(n&&n.nodeType===Node.TEXT_NODE){const e=document.createRange();e.selectNodeContents(n),t=e.getBoundingClientRect()}}return t}async function showAutoPopupForFirstLink(e,t){if(!isGoogleSearchLink)return;if(!await shouldShowAutoPopup())return;const n=getTargetRect(e);n&&(hoveredLink=t,autoPopupHref=t,showPopup(n,t,!0),recordAutoPopupShown())}function trackPDFDescriptionsHover(){const e=document.querySelectorAll(".Hdw6tb");0!==e.length&&e.forEach(e=>{let t=null;e.addEventListener("mouseenter",()=>{t=setTimeout(()=>{chrome.runtime.sendMessage({main_op:"analytics",analytics:[["DCBrowserExt:PDFDescription:Hovered"]]})},1e3)}),e.addEventListener("mouseleave",()=>{t&&(clearTimeout(t),t=null)})})}function addPdfIconToLinks(){getPDFLinks().forEach((e,t)=>{const n=decodeURIComponent(e.getAttribute("href"));0===t&&showAutoPopupForFirstLink(e,n),e.addEventListener("mouseenter",()=>{autoPopupHref&&autoPopupHref!==n&&(hidePopup(autoPopupHref,!0),autoPopupHref=null);const t=getTargetRect(e);t&&showAssistantMarker&&(hoveredLink=n,hoverTimeout=setTimeout(()=>{showPopup(t,n),chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:"dc-cv-genai-markers-impression-analytics",cachePurge:"NO_CALL"},async e=>{e&&(await chrome.storage.local.set({AiMarkerRanking:linkRanking.get(n)}),chrome.runtime.sendMessage({main_op:"analytics",analytics:[["DCBrowserExt:PdfLink:Hovered"]]}))})},200))}),e.addEventListener("mouseleave",()=>{setTimeout(()=>hidePopup(n),400),hoveredLink=null,clearTimeout(hoverTimeout)})}),trackPDFDescriptionsHover(),window.addEventListener("scroll",()=>{if(hoveredLink){const e=`__assistantPopup__${hoveredLink}`,t=document.getElementById(e);t&&t.remove()}},{passive:!0})}async function validateOverlappingElements(e,t){if(!e||t!==hoveredLink)return;const n=document.getElementById("__assistantPopup__"+t),o=n?.getBoundingClientRect();if(!n)return;const i={top:o.top+e.top,left:o.left+e.left,bottom:o.top+e.bottom,right:o.left+e.right,width:e.width,height:e.height,x:o.left+e.x,y:o.top+e.y},r=getOverlappingElement(n,i),a=await getGenaiMarkersConfig(),{validatorClass:s=".b8lM7"}=a,c=getClickableOverlappingElement(n,i)?.filter(e=>!e.closest(s));if(c.length>0)n?.remove(),chrome.runtime.sendMessage({main_op:"log-info",log:{message:"AI marker popup is overlapped a clickable element",link:t}});else if(r.length>0){function l(e){for(const t of e.children)if("IMG"===t.tagName)return!0}function u(e){for(const t of e.childNodes)if(t.nodeType===Node.TEXT_NODE&&t.textContent.trim().length>0)return!0}for(const p of r)if(l(p)||u(p)){n?.remove(),chrome.runtime.sendMessage({main_op:"log-info",log:{message:"AI marker popup is overlapped a non-clickable text or image element",link:t}});break}}n.style.opacity="1"}!async function(){const e=getPDFLinks().length>0;chrome.runtime.sendMessage({main_op:"resolve-has-pdf-promise",hasPDFLink:e});const t=await chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:"dc-cv-genai-markers",cachePurge:"NO_CALL"});if(!e||!t)return;const{appLocale:n,pdfViewer:o,egaf:i,aiMarkers:r,genAIEligible:a,locale:s}=await chrome.storage.local.get(["appLocale","pdfViewer","egaf","aiMarkers","genAIEligible","locale"]);if("en"!==n?.split("-")[0]||"en"!==s?.split("-")[0]||"false"===o||"false"===i||"false"===r||"true"!==a)return;const c="true"===(await chrome.storage.managed.get("DisableGenAI"))?.DisableGenAI,l=await chrome.runtime.sendMessage({main_op:"getFloodgateMeta",flag:"dc-cv-genai-markers-allowlist"});let u;try{u=JSON.parse(l||"[]").some(e=>window.location.href.match(e))}catch(e){u=!1}!c&&u&&(chrome.runtime.sendMessage({main_op:"addExperimentCodeForAnalytics",experimentCode:"EGMS"}),addPdfIconToLinks())}(),chrome.runtime.onMessage.addListener((e,t,n)=>{switch(e.content_op){case"hideAIMarkerPopup":hidePopup(e.href,!0),showAssistantMarker=e.showMarkerInSession;break;case"updateIframeHeight":const t=`__assistantPopup__${e.href}`,n=document.getElementById(t);n?(n.style.height=(e.menuOpen?125:50)+"px",n.style.width=(e.menuOpen?400:250)+"px"):chrome.runtime.sendMessage({main_op:"log-info",log:{message:"Menu not shown because AI marker popup iframe is not found",link:e.href}});break;case"validateOverlappingElements":validateOverlappingElements(e.elementRect,e.link)}});