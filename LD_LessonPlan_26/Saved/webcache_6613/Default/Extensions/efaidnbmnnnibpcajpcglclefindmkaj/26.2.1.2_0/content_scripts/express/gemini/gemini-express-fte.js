/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class GeminiExpressFte{id="GeminiExpressFte";timeout=3e3;maxFteCount=3;fteGapBetweenIterations=6048e5;geminiExpressStateKey="geminiExpressState";geminiExpressInitialState={previewTouchpointUsed:!1,hoverTouchpointUsed:!1,fte:{shown:0,lastShown:null}};geminiChatViewContainerXPath="//infinite-scroller[contains(@class, 'chat-history')]";constructor(){this.initPromise=this.init()}isGeminiDomain=()=>window.location.hostname.includes("gemini.google.com");init=async()=>{if(!this.isGeminiDomain())return this.isEligible=async()=>!1,void(this.render=async()=>{});const t=await chrome.runtime.sendMessage({main_op:"gemini-express-init"});this.config=t,await this.loadContentScripts()};loadContentScripts=async()=>{const t=chrome.runtime.getURL("content_scripts/express/fte/express-contextual-fte.js");return Promise.all([import(t)]).then(t=>{this.expressContextualFteClass=t[0].default})};updateGeminiExpressState=async()=>{let t=await chrome.storage.local.get(this.geminiExpressStateKey);t=t?.geminiExpressState?t.geminiExpressState:this.geminiExpressInitialState,t.fte||(t.fte={shown:0,lastShown:null}),t.fte.shown=(t.fte.shown||0)+1,t.fte.lastShown=Date.now(),chrome.storage.local.set({[this.geminiExpressStateKey]:t})};isEligible=async()=>{if(await this.initPromise,this.rendered)return!1;if(!this.config?.enableGeminiExpressFte)return!1;let t=await chrome.storage.local.get(this.geminiExpressStateKey);if(t?.geminiExpressState?t=t.geminiExpressState:(t=this.geminiExpressInitialState,chrome.storage.local.set({[this.geminiExpressStateKey]:t})),t.previewTouchpointUsed)return!1;if(t.fte?.shown>=this.maxFteCount)return!1;if(t.fte?.lastShown&&t.fte?.lastShown+this.fteGapBetweenIterations>Date.now())return!1;return!!await this.getCtaElement()};_renderFte=t=>{document.body.appendChild(t),this._positionFte(this.expressContextualFTE.getFteElement(),this.ctaButtonWrapper)};_positionFte=(t,e)=>{const i=e.getBoundingClientRect(),n=t.getElementsByClassName("ae1eed7c-express-contextual-fte")?.[0];if(!n)return;n.style.top=`${i.top+e.offsetHeight+window.scrollY}px`,n.style.left=`${i.left+e.offsetWidth/2+window.scrollX}px`,n.style.transform="translate(-50%, 0%)";const s=n.getBoundingClientRect();s&&0!==s.height&&0!==s.width&&(s.top<63||window.innerHeight-s.bottom<150)&&this.expressContextualFTE.remove()};handleChatWindowScroll=()=>{this._positionFte(this.expressContextualFTE.getFteElement(),this.ctaButtonWrapper)};getMatchingElementsFromXPath=t=>{const e=[],i=document.evaluate(t,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(let t=0;t<i.snapshotLength;t++)e.push(i.snapshotItem(t));return e};addChatWindowScrollListener=()=>{const t=this.getMatchingElementsFromXPath(this.geminiChatViewContainerXPath);t.length>0&&t[0].addEventListener("scroll",this.handleChatWindowScroll)};_fteRemovedCallback=()=>{if(this.ctaButtonWrapper.classList.contains("geminiChatView")){const t=this.getMatchingElementsFromXPath(this.geminiChatViewContainerXPath);t.length>0&&t[0].removeEventListener("scroll",this.handleChatWindowScroll)}};render=async()=>{if(this.rendered)return;if(this.ctaButtonWrapper=await this.getCtaElement(),!this.ctaButtonWrapper)return;const t=this.ctaButtonWrapper?.getElementsByClassName("cc440d50ba-express-entrypoint-button")[0];t&&(this.rendered=!0,this.expressContextualFTE=new this.expressContextualFteClass({touchpoint:this.touchpoint,ctaButtonElement:this.ctaButtonWrapper,fteStrings:{fteTitle:this.config.fteStrings?.title||"Acrobat is now in Gemini",fteDescription:this.config.fteStrings?.description||"Easily crop, remove background, adjust colors and more.\nPowered by Adobe Express.",fteCtaLabel:this.config.fteStrings?.ctaLabel||"Close"},updateFteStateCallback:this.updateGeminiExpressState,positionFteCallback:this._positionFte,renderCallback:this._renderFte,fteRemovedCallback:this._fteRemovedCallback}),await this.expressContextualFTE.render(),this.ctaButtonWrapper.classList.contains("geminiChatView")&&(this.handleChatWindowScroll=this.handleChatWindowScroll.bind(this),this.addChatWindowScrollListener()))};getCtaElement=async()=>{const t=["gemini-preview-adobe-express-entry-point"];for(let e=0;e<10;e++){let e=null;const i=document.getElementsByClassName("cc440d50ba-express-entrypoint-wrapper");for(const n of i)if(n&&t.includes(n.id)){if(this.touchpoint=Array.from(n.classList).find(t=>t.includes("gemini")),"geminiChatView"!==this.touchpoint){const t=n.getBoundingClientRect();if(t.left<0||window.innerWidth-t.right<112){e=null;break}e=n;break}{if(!n.checkVisibility({opacityProperty:!0,visibilityProperty:!0}))continue;const t=n.getBoundingClientRect();if(t.top<120||t.bottom<0||window.innerHeight-t.bottom<180)continue;e=n}}if(e)return e;await new Promise(t=>setTimeout(t,100))}return null};remove=()=>{this.expressContextualFTE&&(this.expressContextualFTE.remove(),this.rendered=!1)}}