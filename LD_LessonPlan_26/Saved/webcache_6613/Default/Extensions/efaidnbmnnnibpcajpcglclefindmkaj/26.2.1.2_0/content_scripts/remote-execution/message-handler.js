/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
"use strict";import messageHelpers from"./message-helpers.js";import iframeManager from"./iframe-manager.js";import requestCallbackManager from"./request-callback-manager.js";import domOperations from"./dom-operations.js";import reUtils from"./re-utils.js";function getStorageByType(e){return"local"===e?chrome.storage.local:"session"===e?chrome.storage.session:null}function getStorageValue(e){const{requestId:s,payload:a,_sender:o}=e,{storageType:r,keyArgument:t}=a;reUtils.consoleLog("getStorageValue",r,t);const n=getStorageByType(r);if(!n){reUtils.consoleLog("getStorageValue error: invalid storageType",r);const e=`Invalid storageType: ${r}. Must be "local" or "session".`;return void messageHelpers.sendGetStorageValueResponse(s,o,r,null,e)}n.get(t).then(e=>{reUtils.consoleLog("getStorageValue response",e),messageHelpers.sendGetStorageValueResponse(s,o,r,e,null)}).catch(e=>{reUtils.consoleLog("getStorageValue error",e),messageHelpers.sendGetStorageValueResponse(s,o,r,null,e.message)})}function setStorageValue(e){const{requestId:s,payload:a,_sender:o}=e,{storageType:r,data:t}=a;reUtils.consoleLog("setStorageValue",r,t);const n=getStorageByType(r);if(!n){reUtils.consoleLog("setStorageValue error: invalid storageType",r);const e=`Invalid storageType: ${r}. Must be "local" or "session".`;return void messageHelpers.sendSetStorageValueResponse(s,o,r,!1,e)}n.set(t).then(()=>{reUtils.consoleLog("setStorageValue success"),messageHelpers.sendSetStorageValueResponse(s,o,r,!0,null)}).catch(e=>{reUtils.consoleLog("setStorageValue error",e),messageHelpers.sendSetStorageValueResponse(s,o,r,!1,e.message)})}class MessageHandler{handleCdnMessage(e){try{if(requestCallbackManager&&requestCallbackManager.has(e.requestId))return reUtils.consoleLog("requestId callback map has requestId:",e.requestId),void requestCallbackManager.execute(e.requestId,e);switch(e.type){case"BUILD_RE_INDEX_LOADED":messageHelpers.sendDomainInformationMessage(e);break;case"START_MUTATION_OBSERVER":domOperations.startMutationObserver(e);break;case"DOCUMENT_GET_ELEMENT":domOperations.getElement(e);break;case"DOCUMENT_REMOVE_ELEMENT":domOperations.removeElement(e);break;case"APPEND_HTML_TO_TARGET":domOperations.appendHtmlToTarget(e);break;case"SUBSCRIBE_TO_EVENT_HANDLER":domOperations.subscribeToEventHandler(e);break;case"INJECT_IFRAME":domOperations.injectIframeInWindow(e);break;case"DOWNLOAD_BUFFER_FROM_URL":domOperations.downloadBufferFromUrl(e);break;case"CLOSE_INJECTED_IFRAME":domOperations.closeIframeInWindow(e);break;case"CLOSE_CDN":chrome.runtime.sendMessage({main_op:"removeRemoteExecutionIframe",target:"offscreen"});break;case"LOGGING":"info"===e.payload.level?chrome.runtime.sendMessage({main_op:"log-info",log:{message:e.payload.message,...e.payload.args,executionSource:"remoteExecution"}}):"error"===e.payload.level&&chrome.runtime.sendMessage({main_op:"log-error",log:{message:e.payload.message,...e.payload.args,executionSource:"remoteExecution"}});break;case"SEND_ANALYTICS_EVENT":for(let s=0;s<e.payload.analytics.length;s++){let[a,o]=e.payload.analytics[s];o||(o={}),o={...o,executionSource:"remoteExecution"},e.payload.analytics[s]=[a,o]}chrome.runtime.sendMessage({main_op:"analytics",analytics:e.payload.analytics});break;case"GET_STORAGE_VALUE":getStorageValue(e);break;case"SET_STORAGE_VALUE":setStorageValue(e);break;case"RELAY_MESSAGE_TO_SERVICE_WORKER":chrome.runtime.sendMessage({...e.payload});break;default:reUtils.consoleLog("unknown message type",e.type)}}catch(e){reUtils.consoleLog("Error handling CDN message:",e)}}sendMessageToSender(e,s){const a=s;if(a)try{reUtils.consoleLog("targetWindow",a);const s=iframeManager.getIframeInfoBySender(a),o=s&&s[1].isBridge;if(reUtils.consoleLog("isTrackedBridge",o),reUtils.consoleLog("message to sender",e),o){const s=chrome.runtime.getURL("/").slice(0,-1);a.postMessage({type:"RELAY_TO_CDN",data:e},s)}}catch(e){reUtils.consoleLog("Error sending message to sender:",e)}else chrome.runtime.sendMessage({main_op:"sendMessageToRemoteExecutionIframe",target:"offscreen",...e})}}const messageHandler=new MessageHandler;export default messageHandler;