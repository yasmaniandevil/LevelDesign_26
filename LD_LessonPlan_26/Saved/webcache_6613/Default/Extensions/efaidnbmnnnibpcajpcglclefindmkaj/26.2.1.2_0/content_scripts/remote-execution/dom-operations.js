/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
"use strict";import messageHelpers from"./message-helpers.js";import iframeManager from"./iframe-manager.js";import requestCallbackManager from"./request-callback-manager.js";import reUtils from"./re-utils.js";function startMutationObserver(e){const{requestId:t,payload:r,_sender:n}=e,{targetNodeSelector:o,mutationObserverConfig:s}=r;reUtils.consoleLog("startMutationObserver",o,s);new MutationObserver(e=>{reUtils.consoleLog("mutation",e),messageHelpers.sendMutationObserverEventMessage(t,n)}).observe(document.querySelector(o),s)}function findElementByStrategy(e,t=!1){const r=e.getElementBy;let n=e.selector||e.className||e.id||e.tagName||e.name;switch(r){case"id":const e=document.getElementById(n);return t?e?[e]:[]:e;case"className":const o=document.getElementsByClassName(n);return t?Array.from(o):o[0]||null;case"tagName":const s=document.getElementsByTagName(n);return t?Array.from(s):s[0]||null;case"name":const a=document.getElementsByName(n);return t?Array.from(a):a[0]||null;case"cssSelector":return t?Array.from(document.querySelectorAll(n)):document.querySelector(n);case"xpath":if(t){const e=document.evaluate(n,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),t=[];for(let r=0;r<e.snapshotLength;r++)t.push(e.snapshotItem(r));return t}return document.evaluate(n,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;default:return reUtils.consoleLog(`Unsupported query strategy: ${r}`),t?[]:null}}function collectElementData(e){const t={tagName:e.tagName,id:e.id,className:e.className,textContent:e.textContent,src:e.src,href:e.href,value:e.value,innerHTML:e.innerHTML,attributes:{}};if(e.attributes)for(let r of e.attributes)t.attributes[r.name]=r.value;return t}function getElement(e){const{requestId:t,payload:r,_sender:n}=e;reUtils.consoleLog("getElement",r,t);const o=r.selector||r.className||r.id||r.tagName||r.name,s=!0===r.returnAllElements,a=findElementByStrategy(r,s);if(s){const e=Array.isArray(a)?a:[];if(e.length>0){const s=e.map(collectElementData);messageHelpers.sendElementsFoundMessage(t,n,r.getElementBy,o,s)}else messageHelpers.sendElementsNotFoundMessage(t,n,r.getElementBy,o)}else{if(a){const e=collectElementData(a);messageHelpers.sendElementFoundMessage(t,n,r.getElementBy,o,e)}else messageHelpers.sendElementNotFoundMessage(t,n,r.getElementBy,o)}}function removeElement(e){const{payload:t}=e;reUtils.consoleLog("removeElement",t);const r=findElementByStrategy(t);r?(r.remove(),reUtils.consoleLog("Element removed successfully")):reUtils.consoleLog("Element not found for removal")}function appendHtmlToTarget(e){const{payload:t}=e;reUtils.consoleLog("appendHtmlToTarget",t);const r=findElementByStrategy({getElementBy:t.getTargetElementBy,selector:t.targetElementSelector});if(reUtils.consoleLog("targetNodeForAppendHtmlToTarget",r),r)if(0===r.getElementsByClassName(t.targetNodeCtaClassname).length){r.setAttribute("acrobat-processed","Y");const e=document.createElement("div");e.innerHTML=t.html,r.insertBefore(e,r.firstChild)}else reUtils.consoleLog("element already exists");else reUtils.consoleLog("Target node not found for HTML append")}function subscribeToEventHandler(e){const{requestId:t,payload:r,_sender:n}=e;reUtils.consoleLog("subscribeToEventHandler",r);const o=r.eventHandlerType,s=document.querySelectorAll(r.targetNodeSelector);s?s.forEach(e=>{e.addEventListener(o,e=>{reUtils.consoleLog("event",e),messageHelpers.sendEventHandlerEventMessage(t,n,o,r.targetNodeSelector)}),e.setAttribute("acrobat-handler-attached","Y")}):reUtils.consoleLog("No target nodes found for event handler subscription")}function createDomAnchor(e,t={}){if(document.querySelector(`#${e}`))return document.querySelector(`#${e}`);const r=document.createElement("div");r.id=e;const n={position:"fixed",zIndex:t.anchorZIndex||"2147483646",width:t.anchorWidth||"100%",height:t.anchorHeight||"100%",top:t.anchorTop||"0",left:t.anchorLeft||"0",colorScheme:"light",backgroundColor:t.anchorBackgroundColor||"rgba(0, 0, 0, 0.5)",display:t.anchorDisplay||"block",...t.anchorStyles};return Object.assign(r.style,n),r}function insertIntoDOM(e,t="prepend"){if("prepend"===t)document.body.insertBefore(e,document.body.childNodes[0]);else if("append"===t)document.body.appendChild(e);else if("string"==typeof t){const r=document.querySelector(t);r?r.appendChild(e):document.body.appendChild(e)}}function injectIframeInWindow(e){const{requestId:t,payload:r}=e;reUtils.consoleLog("injectIframeInWindow",r);const n=r.iframeUrl,o=r.iframeConfig||{},s=r.iframeData;requestCallbackManager.registerCallback(t,e=>{reUtils.consoleLog("Request ID callback map:",e);const{requestId:t,payload:r,_sender:n}=e;messageHelpers.sendSessionDataMessage(t,n,s)},!0),function(){const e=`remoteExecutionBridge_${t}`,r=`remoteExecutionAnchor_${t}`,s=createDomAnchor(r,o),a=window.location.origin,l=`${chrome.runtime.getURL("./browser/js/remote-executor-bridge.html")}?parentOrigin=${encodeURIComponent(a)}`,i=document.createElement("iframe");i.setAttribute("src",l),i.setAttribute("id",e);const c={width:o.iframeWidth||"100%",height:o.iframeHeight||"100%",border:o.iframeBorder||"none",overflow:o.iframeOverflow||"hidden",...o.iframeStyles};Object.entries(c).forEach(([e,t])=>{null!=t&&i.style.setProperty(e,t,"important")}),s.appendChild(i),insertIntoDOM(s,o.insertPosition),iframeManager.iframeTrackingMap.set(t,{iframe:i,parent:s,iframeId:e,anchorId:r,isBridge:!0}),reUtils.consoleLog("iframeTrackingMap.entries() ",iframeManager.getIframeTrackingMap()),function(e,t,r,n){const o=chrome.runtime.getURL("/").slice(0,-1),s=function(s){if(s.source===e.contentWindow)if(s.origin===o){if(reUtils.consoleLog("Bridge message received:",s.data),"BRIDGE_READY"===s.data.type)return reUtils.consoleLog("Bridge iframe is ready, sending iframe setup message"),void s.source.postMessage({type:"SETUP_CDN_IFRAME",cdnUrl:r+"?sessionId="+t,iframeConfig:n},o);if("RELAY_FROM_CDN"===s.data.type){reUtils.consoleLog("RELAY_FROM_CDN sender",s.source);const e={...s.data.data,_sender:s.source};if(requestCallbackManager&&requestCallbackManager.has(e.requestId))return reUtils.consoleLog("requestId callback map has requestId:",e.requestId),void requestCallbackManager.execute(e.requestId,e)}}else reUtils.consoleLog("Rejected message from unauthorized bridge origin:",s.origin)};window.addEventListener("message",s),iframeManager.iframeTrackingMap.get(t).messageHandler=s}(i,t,n,o)}()}function closeIframeInWindow(e){const{_sender:t}=e;reUtils.consoleLog("closeIframeInWindow",t);const r=iframeManager.getIframeInfoBySender(t);if(r){const[e,t]=r;if(reUtils.consoleLog("Closing iframe for requestId:",e),t.isBridge&&t.iframe&&t.iframe.contentWindow)try{const e=chrome.runtime.getURL("/").slice(0,-1);t.iframe.contentWindow.postMessage({type:"REMOVE_CDN_IFRAME"},e)}catch(e){reUtils.consoleLog("Error sending cleanup message to bridge iframe:",e)}t.messageHandler&&window.removeEventListener("message",t.messageHandler),t.iframe&&t.iframe.remove(),t.parent&&t.parent.remove(),iframeManager.iframeTrackingMap.delete(e)}else reUtils.consoleLog("No iframe found for the given sender")}function downloadBufferFromUrl(e){const{requestId:t,payload:r,_sender:n}=e;reUtils.consoleLog("downloadBufferFromUrl",r);const o=r.url;chrome.runtime.sendMessage({main_op:"downloadAssetFromUrl",url:o}).then(e=>{reUtils.consoleLog("response",e),messageHelpers.sendDownloadBufferFromUrlResponseMessage(t,n,e.base64data)})}export default{startMutationObserver:startMutationObserver,getElement:getElement,removeElement:removeElement,appendHtmlToTarget:appendHtmlToTarget,subscribeToEventHandler:subscribeToEventHandler,injectIframeInWindow:injectIframeInWindow,closeIframeInWindow:closeIframeInWindow,downloadBufferFromUrl:downloadBufferFromUrl,createDomAnchor:createDomAnchor,insertIntoDOM:insertIntoDOM};