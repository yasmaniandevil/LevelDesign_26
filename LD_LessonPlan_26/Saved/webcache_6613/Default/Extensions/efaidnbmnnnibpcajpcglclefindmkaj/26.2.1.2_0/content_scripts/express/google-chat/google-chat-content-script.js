/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class GoogleChatExpressIntegration{previewEntryPointId="google-chat-preview-adobe-express-entry-point";touchpoint="googleChatNativeViewer";headerContainerSelectors=["a-b-K-sg-Ec","ndfHFb-c4YZDc-Wrql6b-LQLjdd"];activeViewElementId=["drive-active-item-info"];expressButtonTextSelector="cc440d50ba-express-entrypoint-button-text";expressButtonIconSelector="cc440d50ba-express-entrypoint-button-icon";expressButtonSelector="cc440d50ba-express-entrypoint-button";unsupportedMimeTypes=["image/svg+xml","image/tiff","image/tiff-fx"];googleChatExpressStateKey="googleChatExpressState";async loadContentScripts(){const e=chrome.runtime.getURL("content_scripts/express/single-click-cta.js"),t=chrome.runtime.getURL("content_scripts/express/express-utils.js"),s=await Promise.all([import(e),import(t)]);this.ExpressCTAClass=s[0].default,this.expressUtils=s[1].default,this.expressCTA=new this.ExpressCTAClass}nativeViewerObserverHandler=()=>{this.removeTooltipIfFteRendered();const e=this.getPreviewedImageURL();if(!e)return void this.removeExpressTouchpoints();this.imageURL!==e&&(this.imageURL=e),this.nativeViewerTouchpointVisible||this.addExpressTouchpoint()};removeExpressTouchpoints=()=>{const e=document.getElementById(this.previewEntryPointId);e&&(this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.imageURL=null,this.nativeViewerTouchpointVisible=!1,e.parentElement?.removeChild(e)),this.tooltip?.tooltip?.remove(),this.tooltip=null};addExpressTouchpoint=async()=>{this.nativeViewerTouchpointVisible=!0;const e=await this.expressCTA.renderMenuButton(this.clickCallback,this.touchpoint);e.id=this.previewEntryPointId,this.addExpressTouchpointToHeader(this.expressCTA,e)};toggleButtonSize=(e,t)=>{const s=e;s.style.width=t?"32px":"";const i=s.getElementsByClassName(this.expressButtonTextSelector)[0],o=s.getElementsByClassName(this.expressButtonIconSelector)[0];i&&(i.style.display=t?"none":""),o&&(o.style.padding=t?"7px 9px 7px 5px":"",o.style.width=t?"32px":"")};updateButtonStyles=e=>{if(!e)return;const t=e;t.style.visibility="hidden",this.toggleButtonSize(t,!1);const s=t.offsetWidth,i=window.innerWidth-s<1e3;this.toggleButtonSize(t,i),t.style.visibility="visible"};handleResponsiveButton=e=>{const t=e.getElementsByClassName(this.expressButtonSelector)[0];this.updateButtonStyles(t),this.resizeHandler=()=>this.updateButtonStyles(t),window.addEventListener("resize",this.resizeHandler)};addExpressTouchpointToHeader=(e,t)=>{const s=this.expressUtils.getElementsFromClassNames(document,this.headerContainerSelectors)[0];s&&s?.childNodes?.length>0&&(s.insertBefore(t,s.childNodes[0]),this.handleResponsiveButton(t),this.tooltip=e.attachTooltip("bottom"),chrome.runtime.sendMessage({main_op:"reRenderShowOneChild"}),this.expressUtils.sendAnalyticsEventOncePerDay("DCBrowserExt:Express:GoogleChat:NativeViewerEntryPoint:Shown"))};getPreviewedImageURL=()=>{const[e,t]=this.getVisibleViewer();if(!e)return null;const s=this.getFileDetails(t);if(!s?.mimeType?.startsWith("image/")||this.unsupportedMimeTypes.includes(s?.mimeType))return null;const i=e.getElementsByTagName("IMG")[0];return i?i?.src?.startsWith("blob:")?null:i?.src:null};getVisibleViewer=()=>{for(let e=0;e<this.activeViewElementId.length;e+=1){const t=this.activeViewElementId[e],s=document.getElementById(t);if(s)return[s.parentElement,s]}return[null,null]};getFileDetails=e=>{try{return JSON.parse(e?.textContent?.replace(/\\/g,""))}catch{return null}};addNativeViewerObserver=()=>{this.mObserver=new MutationObserver(()=>{this.nativeViewerObserverHandler()}),this.mObserver.observe(document.body,{childList:!0,subtree:!0})};clickCallback=e=>{chrome.runtime.sendMessage({main_op:"launch-express",imgUrl:this.imageURL,intent:e,touchpoint:this.touchpoint}),this.setTouchpointClickedForFteState()};setTouchpointClickedForFteState=async()=>{this.removeContextualFte();let e=await chrome.storage.local.get(this.googleChatExpressStateKey);e=e?.googleChatExpressState?e.googleChatExpressState:{},e.nativeViewerTouchpointUsed=!0,chrome.storage.local.set({[this.googleChatExpressStateKey]:e})};cleanup=()=>{this.removeExpressTouchpoints(),this.cleanupTooltips(),this.removeContextualFte()};cleanupTooltips=()=>{this.tooltip?.tooltip?.remove(),this.tooltip=null};removeContextualFte=()=>{const e=document.getElementById("express-contextual-fte");e&&e.remove()};removeTooltipIfFteRendered=()=>{document.getElementById("express-contextual-fte")&&this.cleanupTooltips()};init=async()=>{const e=await chrome.runtime.sendMessage({main_op:"google-chat-express-init"});this.config=e,this.config.enableGoogleChatNativeViewerExpressMenu&&(this.headerContainerSelectors=this.config?.selectors?.headerContainerSelectors||this.headerContainerSelectors,this.activeViewElementId=this.config?.selectors?.activeViewElementId||this.activeViewElementId,await this.loadContentScripts(),this.addNativeViewerObserver())}}const googleChatExpressIntegration=new GoogleChatExpressIntegration;googleChatExpressIntegration.init();