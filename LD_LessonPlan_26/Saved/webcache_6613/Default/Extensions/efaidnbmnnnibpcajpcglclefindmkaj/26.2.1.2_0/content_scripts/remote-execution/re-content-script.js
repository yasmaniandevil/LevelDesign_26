/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
"use strict";let dcLocalStorage=null,env=null,reUtils=null,iframeManager=null,messageHandler=null,remoteExecutionCdnUrl=null;const isRemoteExecutionEnabledPromise=chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:"dc-cv-remote-execution"}),remoteExecutionLoggingConfigPromise=chrome.runtime.sendMessage({main_op:"getFloodgateMeta",flag:"dc-cv-remote-execution-logging"}),remoteExecutionCdnUrlPromise=chrome.runtime.sendMessage({main_op:"get-remote-execution-cdn-url"});function injectRemoteExecutorIframe(){try{setupMessageListener(),chrome.runtime.onMessage.addListener((e,o,t)=>{reUtils.consoleLog("message received from chrome.runtime",e),e&&e.type&&messageHandler.handleCdnMessage(e)}),chrome.runtime.sendMessage({main_op:"setupOffscreenDocument"},e=>{reUtils.consoleLog("response from chrome.runtime",e),chrome.runtime.sendMessage({main_op:"createRemoteExecutionIframe",target:"offscreen",iframeURL:remoteExecutionCdnUrl})})}catch(e){reUtils.consoleLog("Failed to inject remote executor bridge iframe:",e)}}function setupMessageListener(){window.addEventListener&&window.addEventListener("message",function(e){if(!reUtils.isValidMessageOrigin(e.origin))return;if(Array.from(iframeManager.getIframeTrackingMap().values()).some(o=>o.iframe&&e.source===o.iframe.contentWindow&&o.isBridge)&&(reUtils.consoleLog("message received",e.data),"RELAY_FROM_CDN"===e.data.type)){const o={...e.data.data,_sender:e.source};messageHandler.handleCdnMessage(o)}})}function initializeRemoteExecutorCommunication(){reUtils.isDomainExcluded()||("loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){injectRemoteExecutorIframe()}):injectRemoteExecutorIframe())}const sendInfoLog=e=>{chrome.runtime.sendMessage({main_op:"log-info",log:{message:e,executionSource:"remoteExecution"}})};async function loadDependencies(){try{const[{dcLocalStorage:e},o,t,n]=await Promise.all([import(chrome.runtime.getURL("./common/local-storage.js")),import(chrome.runtime.getURL("./content_scripts/remote-execution/re-utils.js")),import(chrome.runtime.getURL("./content_scripts/remote-execution/iframe-manager.js")),import(chrome.runtime.getURL("./content_scripts/remote-execution/message-handler.js"))]);await e.init(),dcLocalStorage=e,reUtils=o.default,iframeManager=t.default,messageHandler=n.default}catch(e){throw reUtils.consoleLog("Failed to load dependencies:",e),e}}function initialize(){loadDependencies().then(()=>{env=dcLocalStorage.getItem("env");const e=window.dcLocalStorage.getItem("locale");("en-US"===e||"en-GB"===e)&&(remoteExecutionLoggingConfigPromise?.then(e=>{const o=JSON.parse(e);o?.loggingEnabled&&sendInfoLog("Remote Execution: Initializing remote execution communication")}).catch(()=>{}),initializeRemoteExecutorCommunication(),window.addEventListener("beforeunload",()=>{chrome.runtime.sendMessage({main_op:"removeRemoteExecutionIframe",target:"offscreen"})}))})}Promise.all([isRemoteExecutionEnabledPromise,remoteExecutionCdnUrlPromise]).then(([e,o])=>{e&&(remoteExecutionCdnUrl=o,initialize())}).catch(e=>{console.error("Failed to fetch remote execution configuration:",e)});