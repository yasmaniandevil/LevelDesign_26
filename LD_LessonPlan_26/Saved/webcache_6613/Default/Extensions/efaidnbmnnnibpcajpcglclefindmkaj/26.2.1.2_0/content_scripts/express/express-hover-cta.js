/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import expressUtils from"./express-utils.js";import ExpressCTATooltip from"./express-cta-tooltip.js";import{OptionsPageSource}from"../../common/constant.js";const CLASS_PREFIX="cdf40d50ba";class ExpressHoverCTA{BUTTON_CTA_CLASS="cdf40d50ba-express-hover-cta";BUTTON_ICON_IMG_CLASS="cdf40d50ba-express-button-icon-img";FLOATING_MENU_CLASS="cdf40d50ba-express-floating-menu";EXPAND_MENU_ICON_CLASS="cdf40d50ba-express-expand-menu-icon";MENU_ITEM_EDIT_IMAGE_CLASS="cdf40d50ba-express-edit-cta-button";SUBMENU_MANAGE_SETTINGS_CLASS="cdf40d50ba-express-submenu-manage-settings";SUBMENU_HIDE_SESSION_CLASS="cdf40d50ba-express-submenu-hide-session";DEFAULT_THROTTLE_CONFIG={frequency:"always"};constructor(t={}){this.ready=this.init(),this.maxWidth=t.maxWidth,this.hasOverflow=!1}async init(){await fetch(chrome.runtime.getURL("resources/express/expressHoverCTA.html")).then(t=>t.text()).then(t=>{this.htmlData=t}),await expressUtils.addFontToDocument()}_addCTAClickEventListener(t){t.onclick=t=>{t.stopPropagation();const e="editImage",i=new URL(window.location.href).hostname;expressUtils.sendAnalyticsEvent([["DCBrowserExt:Express:HoverCTA:Clicked",{domain:i,dvDisableSessionCount:e,expressTouchpoint:this.surface},this.DEFAULT_THROTTLE_CONFIG]]),this.onClickCallback(e)}}_addHideSessionClickEventListener(t){t.onclick=t=>{t.stopPropagation();const e=new URL(window.location.href).hostname;expressUtils.sendAnalyticsEvent([["DCBrowserExt:Express:HoverCTA:HideForSession:Clicked",{domain:e,expressTouchpoint:this.surface},this.DEFAULT_THROTTLE_CONFIG]]),this.onHideClickCallback()}}_addManageSettingsClickEventListener(t){t.onclick=t=>{t.stopPropagation();const e=new URL(window.location.href).hostname;expressUtils.sendAnalyticsEvent([["DCBrowserExt:Express:HoverCTA:ManageSettings:Clicked",{domain:e,expressTouchpoint:this.surface},this.DEFAULT_THROTTLE_CONFIG]]),chrome.storage.local.set({optionsPageSource:`${OptionsPageSource.EXPRESS_CTA}_${this.surface}`}).then(()=>{chrome.runtime.sendMessage({type:"open_options_page",preferenceTabId:"connected-apps",controlId:"expressTouchpointPreferenceTitle",highlightSection:["express-touchpoints-section"]})})}}async renderButton(t){await this.ready;const{onClickCallback:e,onHideClickCallback:i,surface:s,interactionCallback:n}=t;this.onClickCallback=e,this.interactionCallback=n,this.onHideClickCallback=i,this.surface=s;const o=document.createElement("div");o.innerHTML=this.htmlData,o.className=s,o.style.display="none";const a=o.getElementsByClassName(this.BUTTON_CTA_CLASS)[0],l=a.getElementsByClassName(this.BUTTON_ICON_IMG_CLASS)[0],h=a.getElementsByClassName(this.FLOATING_MENU_CLASS)[0],r=a.getElementsByClassName(this.EXPAND_MENU_ICON_CLASS)[0],c=o.querySelector(".cdf40d50ba-express-menu-item-text"),d=o.getElementsByClassName(this.MENU_ITEM_EDIT_IMAGE_CLASS)[0],u=h.getElementsByClassName(this.SUBMENU_MANAGE_SETTINGS_CLASS)[0],m=h.getElementsByClassName(this.SUBMENU_HIDE_SESSION_CLASS)[0];l.src=chrome.runtime.getURL("browser/images/acrobat_prodc_appicon_24.svg"),d&&this._addCTAClickEventListener(d),m&&this._addHideSessionClickEventListener(m),u&&this._addManageSettingsClickEventListener(u),util.translateElements(".translate",o),this.button=a,this.container=o,this.floatingMenu=h,this.rightTranslate=0,this.expandMenu=r,this.labelEl=c,this.maxWidth&&this.updateLabelOverflowFade(),this.addHoverEventListeners(),this.addHamburgerMenuClickListeners()}injectDynamicWidthStyles(){try{if(!this.container||this.dynamicStyleEl)return;const t=this.container.querySelector(".cdf40d50ba-express-menu-item-text");if(!t)return;const e=t.style.width,i=t.style.maxWidth;t.style.width="auto",t.style.maxWidth="none";let s=Math.ceil(t.scrollWidth);this.maxWidth&&s>this.maxWidth?(s=this.maxWidth,this.hasOverflow=!0):this.hasOverflow=!1,t.style.width=e,t.style.maxWidth=i,this.dynamicStyleEl||(this.dynamicStyleEl=document.createElement("style"),this.container.appendChild(this.dynamicStyleEl));const n=".cdf40d50ba-express-menu-item-text";this.dynamicStyleEl.textContent=`\n                ${n} { width: ${s}px; }\n                .minify ${n} { width: 0; }\n            `}catch(t){}}adjustFloatingMenuPosition(){const t=this.floatingMenu.getBoundingClientRect(),e=window.innerWidth-t.right<0?window.innerWidth-t.right:0;this.rightTranslate+=e,this.floatingMenu.style.transform=`translate(${this.rightTranslate}px, 0)`}addHamburgerMenuClickListeners(){this.expandMenu.addEventListener("click",t=>{t.stopPropagation(),this.floatingMenuShown?this.hideFloatingMenu():this.showFloatingMenu()}),this.expandMenu.addEventListener("dblclick",t=>{t.stopPropagation()})}addHoverEventListeners(){this.container.addEventListener("mouseenter",()=>{clearTimeout(this.hideTimeout),this.maximizeButton(),this.interactionCallback?.()}),this.container.addEventListener("mouseleave",()=>{clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>{this.minimizeButton()},100)})}closeFloatingMenuAndMinimizeButton(){this.hideFloatingMenu(),setTimeout(()=>{this.minimizeButton()},100)}showFloatingMenu(){this.hideTooltip(),this.button.classList.add("expand-menu-open"),this.adjustFloatingMenuPosition(),this.floatingMenuShown=!0,document.addEventListener("click",()=>this.closeFloatingMenuAndMinimizeButton())}hideFloatingMenu(){this.button.classList.remove("expand-menu-open"),this.floatingMenuShown=!1,document.removeEventListener("click",()=>this.closeFloatingMenuAndMinimizeButton())}minimizeButton(){this.floatingMenuShown||this.container.classList.add("minify")}maximizeButton(){this.injectDynamicWidthStyles(),this.container.classList.remove("minify")}showButton(){this.container.style.display="flex",this.adjustFloatingMenuPosition(),this.injectDynamicWidthStyles(),this.maxWidth&&this.updateLabelOverflowFade()}hideButton(){this.floatingMenuShown&&this.hideFloatingMenu(),this.container.style.display="none"}remove(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.button=null,this.container=null,this.hideTimeout=null}getCTAElement(){return this.container}attachTooltip(t,e=null){this.tooltip=new ExpressCTATooltip({button:this.button,tooltipPosition:t,surface:this.surface}),this.tooltip.addTooltipToDOM(e,()=>this.floatingMenuShown)}hideTooltip(){this.tooltip&&this.tooltip.hideTooltip()}updateLabelOverflowFade(){try{if(!this.labelEl)return;this.labelEl.classList.toggle("fade-effect",this.hasOverflow)}catch(t){}}}export default ExpressHoverCTA;