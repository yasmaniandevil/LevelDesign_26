/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
export const extractWebpageHTML=async(e,t={})=>{const{customiseHtml:r=null}=t;return window.extractionPromise=new Promise(t=>{const o=()=>{const o=performance.now(),a=window.location.href,s=e.cloneNode(!0),n=["data:","blob:","chrome-extension:","javascript:","mailto:","tel:","file:","ftp:","about:","chrome:","edge:"],c=()=>{const e=Array.from(s.querySelectorAll("img[src]")),t=Array.from(s.querySelectorAll('*[style*="background-image"]')),r=Array.from(s.querySelectorAll(["*[data-bgsrc]","*[data-bg]","*[data-background]","*[data-background-src]","*[data-bg-src]","*[data-lazy-bg]","*[data-lazy-background]"].join(", "))),o=e.map((e,t)=>e.src.startsWith("data:")?Promise.resolve():fetch(e.src,{mode:"cors"}).then(e=>e.blob()).then(t=>new Promise(r=>{const o=new FileReader;o.onload=()=>{e.src=o.result,e.hasAttribute("srcset")&&e.removeAttribute("srcset"),r()},o.onerror=()=>{e.hasAttribute("srcset")&&e.removeAttribute("srcset"),r()},o.readAsDataURL(t)})).catch(()=>{e.hasAttribute("srcset")&&e.removeAttribute("srcset")})),n=t.map(e=>{const t=e.getAttribute("style"),r=t.match(/background-image:\s*url\(['"]?([^'"()]+)['"]?\)/);return r&&!r[1].startsWith("data:")?fetch(r[1],{mode:"cors"}).then(e=>e.blob()).then(o=>new Promise(a=>{const s=new FileReader;s.onload=()=>{const o=t.replace(r[0],`background-image: url(${s.result})`);e.setAttribute("style",o),a()},s.onerror=()=>a(),s.readAsDataURL(o)})).catch(()=>{}):Promise.resolve()}),c=r.map(e=>{const t=["data-bgsrc","data-bg","data-background","data-background-src","data-bg-src","data-lazy-bg","data-lazy-background"];let r=null,o=null;for(const a of t){const t=e.getAttribute(a);if(t&&t.trim()){r=t.trim(),o=a;break}}if(r&&!r.startsWith("data:"))try{const t=new URL(r,a).href;return fetch(t,{mode:"cors"}).then(e=>e.blob()).then(t=>new Promise(a=>{const s=new FileReader;s.onload=()=>{const t=e.getAttribute("style")||"",r=t+(t&&!t.endsWith(";")?"; ":"")+`background-image: url(${s.result});`;e.setAttribute("style",r),e.removeAttribute(o),a()},s.onerror=()=>{console.warn(`Failed to process data background image: ${r}`),a()},s.readAsDataURL(t)})).catch(e=>(console.warn(`Failed to fetch data background image: ${r}`,e),Promise.resolve()))}catch(e){return console.warn(`Invalid data background URL: ${r}`,e),Promise.resolve()}return Promise.resolve()});return Promise.race([Promise.allSettled([...o,...n,...c]),new Promise(e=>setTimeout(e,15e3))]).then(()=>{})},l=async e=>{const t=e.head,r=window.location.href,o=[],a=Array.from(t.querySelectorAll("link"));for(const e of a){const t=e.getAttribute("rel"),a=e.getAttribute("href");switch(t){case"stylesheet":break;case"icon":case"shortcut icon":case"apple-touch-icon":if(a&&!a.startsWith("data:"))try{const t=new URL(a,r).href;o.push({element:e,url:t,attribute:"href",type:"favicon"})}catch(t){console.warn("Invalid favicon URL:",a),e.remove()}else a||e.remove();break;case"canonical":if(a)try{const t=new URL(a,r).href;e.setAttribute("href",t)}catch(t){console.warn("Invalid canonical URL:",a),e.remove()}break;case"preload":case"prefetch":case"preconnect":case"dns-prefetch":case"modulepreload":case"manifest":e.remove();break;case"alternate":if(a)try{const t=new URL(a,r).href;e.setAttribute("href",t)}catch(t){console.warn("Invalid alternate URL:",a),e.remove()}break;default:if(a&&!a.startsWith("data:")&&!a.startsWith("#"))try{const t=new URL(a,r).href;e.setAttribute("href",t)}catch(e){console.warn("Invalid link URL:",a)}}}const s=Array.from(t.querySelectorAll("meta"));for(const e of s){const t=e.getAttribute("property"),a=e.getAttribute("name"),s=e.getAttribute("content");if(s)if(t&&(t.includes("og:image")||t.includes("twitter:image"))||a&&(a.includes("twitter:image")||a.includes("msapplication-TileImage"))){if(!s.startsWith("data:"))try{const t=new URL(s,r).href;o.push({element:e,url:t,attribute:"content",type:"meta-image"})}catch(t){console.warn("Invalid meta image URL:",s),e.remove()}}else if(t&&(t.includes("og:url")||t.includes("twitter:url"))||a&&a.includes("twitter:url"))try{const t=new URL(s,r).href;e.setAttribute("content",t)}catch(e){console.warn("Invalid meta URL:",s)}else"refresh"===e.getAttribute("http-equiv")&&e.remove()}if(Array.from(t.querySelectorAll("script")).forEach(e=>{(e.getAttribute("src")||e.textContent)&&e.remove()}),o.length>0){const e=o.map(async e=>{try{const t=await fetch(e.url,{mode:"cors",headers:{Accept:"image/*,*/*;q=0.8"}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const r=await t.blob(),o=await new Promise((e,t)=>{const o=new FileReader;o.onload=()=>e(o.result),o.onerror=t,o.readAsDataURL(r)});e.element.setAttribute(e.attribute,o)}catch(t){console.warn(`Failed to embed ${e.type}:`,e.url,t),e.element.remove()}});await Promise.race([Promise.allSettled(e),new Promise(e=>setTimeout(e,15e3))])}if(!t.querySelector("base")){const o=e.createElement("base");o.setAttribute("href",r),t.insertBefore(o,t.firstChild)}return e};s.querySelectorAll("a[href], link[href]").forEach(e=>{const t=e.getAttribute("href");if(t&&!t.startsWith("javascript:")&&!t.startsWith("mailto:")&&!t.startsWith("tel:"))try{const r=new URL(t,a).href;e.setAttribute("href",r)}catch(e){console.warn("Invalid href URL:",t)}}),s.querySelectorAll("[src]").forEach(e=>{const t=e.getAttribute("src");if(t&&!n.some(e=>t.startsWith(e)))try{const r=new URL(t,a).href;e.setAttribute("src",r)}catch(e){console.warn("Invalid src URL:",t)}}),s.querySelectorAll("img[srcset]").forEach(e=>{const t=e.getAttribute("srcset");if(t)try{const r=t.split(",").map(e=>{const t=e.trim().split(/\s+/),r=t[0],o=t[1]||"";if(!n.some(e=>r.startsWith(e))){const e=new URL(r,a).href;return o?`${e} ${o}`:e}return e.trim()});e.setAttribute("srcset",r.join(", "))}catch(e){console.warn("Invalid srcset:",t)}}),s.querySelectorAll("form[action]").forEach(e=>{const t=e.getAttribute("action");if(t&&!t.startsWith("javascript:"))try{const r=new URL(t,a).href;e.setAttribute("action",r)}catch(e){console.warn("Invalid action URL:",t)}}),Promise.all([(()=>{let t="";try{const r=Array.from(e.styleSheets).map((e,t)=>new Promise(r=>{try{if(e.cssRules){let t="";Array.from(e.cssRules).forEach(e=>{t+=e.cssText+"\n"}),r(t)}else r(e.href?`/* External stylesheet: ${e.href} */\n`:"")}catch(o){console.warn(`Cannot access stylesheet ${t}:`,o),r(e.href?`/* External stylesheet: ${e.href} */\n`:"")}}));return e.querySelectorAll("style").forEach((e,r)=>{e.textContent&&(t+=`/* Inline Style Block ${r+1} */\n`,t+=e.textContent+"\n")}),Promise.all(r).then(e=>(t=e.join("")+t,t))}catch(e){return console.warn("Error capturing CSS rules:",e),Promise.resolve(t)}})(),(Array.from(e.querySelectorAll("*")),void Array.from(s.querySelectorAll("*")))]).then(([e])=>Promise.all([c(),l(s)]).then(([,t])=>(e=>{const t=new Set,r=new Map;if([/(-webkit-mask-image|mask-image):\s*url\(['"]?([^'"()]+)['"]?\)/gi,/background-image:\s*url\(['"]?([^'"()]+)['"]?\)/gi,/border-image(-source)?:\s*url\(['"]?([^'"()]+)['"]?\)/gi,/list-style-image:\s*url\(['"]?([^'"()]+)['"]?\)/gi,/@font-face[^}]*src:\s*url\(['"]?([^'"()]+)['"]?\)/gi,/cursor:\s*url\(['"]?([^'"()]+)['"]?\)/gi,/filter:\s*url\(['"]?([^'"()]+)['"]?\)/gi].forEach(r=>{let o;const a=new RegExp(r.source,r.flags);for(;null!==(o=a.exec(e));){let e;if(o[2]?e=o[2]:o[1]&&(e=o[1]),e&&!e.startsWith("data:")&&!e.startsWith("#"))try{const r=new URL(e,window.location.href).href;t.add(r)}catch(t){console.warn("Invalid CSS URL:",e)}}}),0===t.size)return Promise.resolve(e);const o=Array.from(t).map(e=>fetch(e,{mode:"cors",headers:{Accept:"image/*,*/*;q=0.8"}}).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.blob()}).then(t=>new Promise((o,a)=>{const s=new FileReader;s.onload=()=>{r.set(e,s.result),o()},s.onerror=()=>{console.warn(`Failed to convert CSS resource to data URL: ${e}`),a()},s.readAsDataURL(t)})).catch(t=>(console.warn(`Failed to fetch CSS resource: ${e}`,t),Promise.resolve())));return Promise.race([Promise.allSettled(o),new Promise(e=>setTimeout(e,2e4))]).then(()=>{let t=e;return r.forEach((e,r)=>{const o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(o,"g");t=t.replace(a,e)}),t})})(e))).then(async a=>{const n=s.getElementById("html-extraction-progress");n&&n.remove();const c=s.getElementById("addWebpageToProjectExtnIframe");c&&c.remove();const l=s.getElementById("__AcrobatToastManager__");l&&l.remove();const i=s.getElementById("__AcrobatToastStyles__");i&&i.remove();const m=s.querySelector('link[href*="dist/spectrum.css"]');m&&m.remove();const u=Array.from(s.querySelectorAll('link[rel="stylesheet"]')).map(t=>fetch(t.href).then(e=>e.text()).then(r=>{const o=e.createElement("style");o.textContent=r,s.head.appendChild(o),t.remove()}).catch(e=>{console.warn("Failed to fetch stylesheet:",t.href,e),t.remove()}));await Promise.all(u),s.querySelectorAll("script").forEach(e=>e.remove());const d=s.createElement("style");if(d.textContent=`\n/* Original CSS with all media queries intact and embedded resources */\n${a}\n\n/* Screen-specific computed styles (won't affect print) */\n@media screen {\n${window.extractedElementStyles||""}\n}\n`,!s.querySelector("meta[charset]")){const e=s.createElement("meta");e.setAttribute("charset","UTF-8"),s.head.insertBefore(e,s.head.firstChild)}s.head.appendChild(d),delete window.extractedElementStyles;const h=performance.now()-o,f=new Blob([s.documentElement.outerHTML],{type:"text/html"}),w=URL.createObjectURL(f),b=e.createElement("a");b.href=w,b.download="webpage.html",r&&r(s),t({html:s.documentElement.outerHTML,title:e.title,url:window.location.href,processingTime:h,timestamp:Date.now()})}).catch(r=>{t({html:s.documentElement.outerHTML,title:e.title,url:window.location.href,error:r.message,partial:!0})})};if("complete"===e.readyState)setTimeout(o,500);else{let e;const t=setTimeout(()=>{window.removeEventListener("load",e),o()},3e4);e=()=>{o(),clearTimeout(t)},window.addEventListener("load",e)}}),window.extractionPromise};window.extractWebpageHTML=extractWebpageHTML;