/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e,dcSessionStorage as t}from"../../../common/local-storage.js";import{dcTabStorage as a}from"../tab-storage.js";import{util as n}from"../content-util.js";import{signInUtil as r}from"./signInUtils.js";import{privateApi as o}from"../content-privateApi.js";import{COOLDOWN_FOR_LFT_PROMPT as i,OptionPageActions as s,LOCAL_FILE_PERMISSION_URL as c,OptionsPageSource as l,ACROBAT_USER_STATE as d}from"../../../common/constant.js";import{getRetryConfig as m,createRetryState as f,logRetrySuccess as g,handleRetry as u}from"./pdfFetchRetry.js";import{indexedDBScript as p}from"../../../common/indexDB.js";import{loggingApi as w}from"../../../common/loggingApi.js";import{updateExtUserState as h,isNewUser as I,isEdgeBrowser as b,isDemoMode as v,getGenAIServiceVariant as y,getSearchParams as _,isMigrationCompleted as S,getWhatsappOpenerOrigins as E,getSurfaceId as L}from"../../../common/util.js";import{urlParamCleanup as R}from"./urlParamCleanup.js";import C from"./ResponseHeaders.js";import U from"./BookmarkUtils.js";import P from"./LruUtil.js";import{analytics as k,events as D}from"../../../common/analytics.js";import{fileUtil as T}from"./fileUtil.js";import{buildAcrobatPromotionSource as F}from"../../../content_scripts/utils/util.js";import{initializeBlobCacheCleanupAlarm as A}from"../../../content_scripts/blob-cache-cleanup.js";import{EXPERIMENT_VARIANTS_STORAGE_KEY as x,STORAGE_KEYS as B}from"../../../sw_modules/constant.js";import{getSessionKey as V,removeAllPDFRenderingSessionsFromTab as M,registerPDFRenderingSession as O,shouldShowImplicitDVCoachmark as N}from"../../../common/pdf-rendering-tracking.js";import{markDirectFlowSuccess as W,logDirectVerbPerfMetrics as $}from"../../../sw_modules/direct-verb-utils.js";import{initTemporaryURLBufferIndexedDB as G}from"../../../common/temporaryURLBufferIndexDB.js";import{ALLOWED_IFRAME_SEARCH_PARAMS as j,ALLOWED_IFRAME_HASH_PARAMS as H}from"./iframeUrlParamsAllowlist.js";import{handlePostPDFConversionInDirectFlow as q,sendFileBufferToViewerForDirectFlow as z,isDirectFlowWithoutPreview as J,handleUpsellCloseInDirectFlow as K,isPreviewPostDirectFlow as Y,previewOriginalPDF as X,getAcrobatPromotionSource as Z,updateDirectVerbMetrics as Q,waitForPendingMetricUpdates as ee}from"./DirectVerb.js";import{getActiveExperimentAnalyticsArray as te}from"../../../common/experimentUtils.js";await e.init(),await t.init();const ae=e.getItem("appLocale"),ne="acrobatPromotionSource";let re=!1;!function(){let oe,ie,se,ce,le,de,me,fe,ge,ue,pe,we,he,Ie,be,ve,ye,_e,Se,Ee,Le,Re,Ce,Ue,Pe,ke,De="",Te=!1,Fe=null;const Ae=chrome.runtime.getURL("viewer.html"),xe=chrome.runtime.getURL("signInHandler.html"),Be="file:",Ve="blob:",Me=["https:","http:",Be],Oe=["webpage","gslides","gsheets"],Ne=new URLSearchParams(window.location.search),We=Ne.get("sessionId")?.trim();let $e,Ge;const je=()=>(Fe||(Fe=G()),Fe);$e=new Promise(e=>Ge=e),qe({main_op:"chrome_viewer_opened",activeTabId:Ke(document.location.search,"tabId")});function He(e){const t=a.getItem("search");return new URLSearchParams(t).get(e)}function qe(e,t){return Ie?(be=be||1,e.tabId=be,e.mimeHandled=!0,chrome.runtime.sendMessage(e,t)):chrome.runtime.sendMessage(e,t)}const ze=`pdf_convert_${Date.now()}`;function Je(e,t={}){qe({main_op:"pdf-convert-perf-mark",data:{requestId:ze,name:e,metadata:t}})}function Ke(e,t){return new URLSearchParams(e).get(t)||""}async function Ye(){if(ce=Ke(document.location.search,"pdfurl"),ke=await chrome.tabs.getCurrent(),Le=Ke(document.location.search,"tabId")||ke?.id,Re=Ke(document.location.search,"aw"),Ue=await(async e=>{if(!e)return!1;try{const t=new URL(e),a=t.protocol;let n=-1!==Me.indexOf(a);if(n=a===Be?t.pathname.toLowerCase().endsWith(".pdf"):n,a===Ve)if(n=await p.hasKey(`chrome-extension://${chrome.runtime.id}/${t.href}`),n)A(),Te=!0;else if(t?.origin?.includes("outlook"))return!0;return n}catch(e){return!1}})(ce),Pe=Ke(document.location.search,"acrobatPromotionWorkflow")||a.getItem("acrobatPromotionWorkflow"),Pe&&a.setItem("acrobatPromotionWorkflow",Pe),!Ue)return void(le=!1);Te&&(ce=`chrome-extension://${chrome.runtime.id}/${ce}`),function(){const e=new URLSearchParams(document.location.search),n=t.getItem("rtParams");if(n){const a=n.split(",").map(t=>e.has(t)?`&${t}=${e.get(t)}`:null).join("")||"";t.setItem("payPalUrl",a),t.removeItem("rtParams")}e.has("dialog!dropin")&&a.setItem("dialog!dropin",e.get("dialog!dropin")),e.has("load!dropin")&&a.setItem("load!dropin",e.get("load!dropin"))}();const e=a.getItem("search");if((!e||Ke(e,"pdfurl")!==ce||e.length<document.location.search)&&a.setItem("search",document.location.search),se=Ke(document.location.search,"pdffilename")||Ke(e,"pdffilename")||_t(ce),document.title=se,!Te){const e="/"+ce+location.hash;history.replaceState({},se,e)}}function Xe(e,t){const a={main_op:"analytics"};a.analytics=[[e]],t&&a.analytics[0].push(t),qe(a)}function Ze(t,a,n="unknown",r={}){e.setItem(`reloadurl-${t.id}`,ce);const o=new URL(ce);if(function(t,a="unknown",{status:n,retryCount:r}={}){if(t?.searchParams?.has(ne)||He(ne)?.length>0){const e=t.searchParams.get(ne)||He(ne);w.info({message:"reloadInNativeViewer",source:e,domain:t.hostname,reason:a,...void 0!==n&&{status:n},...void 0!==r&&{retryCount:r}}),Xe("DCBrowserExt:Viewer:ReloadInNativeViewer",{source:e,workflow:a})}else if(e.getItem("nativeFallbackLogging")){const e={message:"reloadInNativeViewer",reason:a,url:t.origin+t.pathname,...void 0!==n&&{status:n},...void 0!==r&&{retryCount:r}};w.info(e)}}(o,n,r),qt(o)&&!a?.includes("text/html")){const e=o?.searchParams?.get("id");window.location.href=`https://drive.google.com/file/d/${e}`}else window.location.href=ce}function Qe(e=!1,t,a="unknown",n={}){if(Ie)try{e||qe({main_op:"viewer-type",viewer:"mime-native"}),setTimeout(()=>{o.reloadWithNativeViewer({contentLength:parseInt(oe)||0})},100)}catch(e){tt("DCBrowserExt:Viewer:FallbackToNative:Failed")}else try{setTimeout(()=>{chrome.tabs.getCurrent(e=>Ze(e,t,a,n))},500)}catch(e){Xe("DCBrowserExt:Viewer:FallbackToNative:Failed",{tabURL:ce,source:_(ce).get(ne)})}}const et=t=>{try{const a=new URL(e.getItem("cdnUrl")),n=[/^https:\/\/([a-zA-Z\d-]+\.){0,}(adobe|acrobat)\.com(:[0-9]*)?$/];return t===a.origin&&!!n.find(e=>e.test(t))}catch(e){return!1}};function tt(e){const t={main_op:"analytics"};t.analytics=[[e]],qe(t)}const at=e=>{const t=_(e),a=F("outlook_chrome","native_view");return t.get(ne)===a||He(ne)===a};function nt(){if(!sessionStorage.getItem("uuid-for-shortened-redirect-url")){const e=n.uuid();sessionStorage.setItem("uuid-for-shortened-redirect-url",e),sessionStorage.setItem(e,ce)}return new URL(ce)?.origin+"?uuid="+sessionStorage.getItem("uuid-for-shortened-redirect-url")}function rt(){if(We)return`${Ae}?${Ne.toString()}`;let e=ce;return at(ce)&&(e=nt()),Ht(ce)?`${Ae}?pdfurl=${encodeURIComponent(e)}&pdffilename=${encodeURIComponent(document.title)}`:ce}function ot(){let e,t=Ae;if(Ie)if(Te){const t=new URLSearchParams(window.location.search),a=t.get("pdfurl"),n=t.get("pdffilename");e="?pdfurl="+encodeURIComponent(a)+"&pdffilename="+encodeURIComponent(n)}else e="?mimePdfUrl="+encodeURIComponent(ce),t=xe;else e=a.getItem("search"),e||(e="?pdfurl="+encodeURIComponent(ce)),at(ce)&&(e="?pdfurl="+encodeURIComponent(nt()));return new URL(t+e)}const it=["AdobeID","openid","DCAPI","sign_user_read","sign_user_write","sign_user_login","sign_library_read","sign_library_write","agreement_send","agreement_read","agreement_write","ab.manage","additional_info.account_type","sao.ACOM_ESIGN_TRIAL","widget_read","widget_write","workflow_read","workflow_write"];function st(t={}){if(e.getItem("csi")){const e=rt(),a={...t,pdfUrl:e};return void r.cdnSignIn(a)}const a=ot(),o=e.getItem("cdnUrl"),i=t.sign_up?1:0,s=n.generateStateCSRF(),c=e.getItem("enableCSRF"),l=JSON.stringify({touchp:t.touchpoint||"",signIn:!0,...c&&{state:s}}),d=e.getItem("theme")||"auto",m=`${o}?la=true&locale=${ae||e.getItem("locale")}&theme=${d}&ru=${encodeURIComponent(a.href)}&rp=${l}&su=${i}#/susi`;chrome.tabs.update({url:m,active:!0})}function ct(){const e={main_op:"signout",pdfUrl:rt(),callingApp:chrome.runtime.id};r.cdnSignIn(e)}function lt(t={}){if(e.getItem("csi")){const e={...t,pdfUrl:ce};return void r.cdnSignIn(e)}let n=new URL(xe);const o=t.idp_token;return n.searchParams.append("socialSignIn","true"),n.searchParams.append("mimePdfUrl",encodeURIComponent(ce)),a.setItem("idp_token",o),n.href}function dt(e={}){Ie?chrome.tabs.update({url:lt(e),active:!0}):r.socialSignIn(e,ot(),ce)}function mt(t={}){if(e.getItem("csi")){try{const e=new URL(JSON.parse(t.url));delete t.url;const a={...t,pdfUrl:rt()},n=r.getCDNSignURL(a);e.searchParams.append("redirect_uri",n),chrome.tabs.update({url:e.href,active:!0})}catch(e){chrome.tabs.update({url:ce})}return}const o=t.application||"google",i=e.getItem("viewerImsClientIdSocial"),s=e.getItem("imsURL"),c=n.uuid(),l=ot();l.hash=l.hash+"signIn=true";const d=new URL(s+"/ims/authorize/v1"),m={ac:n.getAppCode(),csrf:c};a.setItem("csrf",c),d.searchParams.append("response_type","token"),d.searchParams.append("idp_flow","social.deep_link.web"),d.searchParams.append("client_id",i),d.searchParams.append("provider_id",o),d.searchParams.append("redirect_uri",l),d.searchParams.append("scope",it.join(",")),d.searchParams.append("locale",ae||e.getItem("locale")),d.searchParams.append("state",JSON.stringify(m)),d.searchParams.append("xApiClientId",i),d.searchParams.append("xApiClientLocation ",o),chrome.tabs.update({url:d.href,active:!0})}const ft={isSharePointURL:!1,isSharePointFeatureEnabled:!1,isFrictionlessEnabled:!0,featureFlags:[],isFillAndSignRegisteryEnabled:!1};class gt{constructor(e){this.iframeElement=void 0,this.parentDiv=e}createIframe=e=>{const t=window.document,a=t.createElement("iframe");a.onerror=()=>{w.error({message:"cdnIframeLoadFailed"})},a.setAttribute("src",e),a.setAttribute("id","dc-view-frame"),a.setAttribute("allowfullscreen","allowfullscreen"),a.setAttribute("allow","clipboard-read; clipboard-write; local-fonts; payment;"),a.style.width="100vw",a.style.height="100vh",a.style.border="none",a.style.overflow="hidden",this.parentDiv.appendChild(a),this.iframeElement=t.getElementById("dc-view-frame"),this.createOpenerMessageChannel()};createOpenerMessageChannel=async()=>{const e=await E();if(We){const t=new URL(this.iframeElement.src).origin;window.addEventListener("message",a=>{if(a.source===window.opener&&e.includes(a.origin))this.iframeElement.contentWindow.postMessage(a.data,t);else if(a.source===this.iframeElement.contentWindow&&"whatsapp_acrobat"===a.data?.identifier?.type){const e={...a.data};delete e.identifier,window.opener.postMessage(e,a.data?.identifier?.origin)}})}};_sendMessage=(e,t)=>{this.iframeElement&&et(t)&&function(e){let t=Date.now();return new Promise(function a(n,r){const o=le||Ie||We;de&&o?n(o):e&&Date.now()-t>=e?r(new Error("timeout")):setTimeout(a.bind(this,n,r),30)})}(1e6).then(a=>a&&this.iframeElement.contentWindow.postMessage(e,t))};sendStartupConfigs=(a,n)=>{this._sendMessage({type:"nativeConfigs",nativeConfigs:ft,extUrl:encodeURI(a),returnParamsUrl:t.getItem("payPalUrl"),isInstallTypeUpsell:re,gmailGDriveData:{gmailFteState:e.getItem("acrobat-gmail-fte-config"),gDriveFteState:e.getItem("acrobat-gdrive-fte-state")}},n),this.sendExperimentInfo(n)};sendFileMetaData=(e,t,a,n,r,o,i,s)=>{this._sendMessage({fileUrl:r,fileName:o,fileSize:a,acceptRanges:n,handShakeTime:t,type:e,isFrictionlessEnabled:ft.isFrictionlessEnabled,isReloadOrBackForward:s,isMimeHandled:Ie},i)};executeDirectVerb=(e,t,a,n,r,o,i,s,c={})=>{this._sendMessage({type:e,fileBuffer:t,fileBufferSize:a,fileName:n,downLoadstartTime:r,downLoadEndTime:o,mimeType:i,verbConfig:c},s)};sendSubmitFormResponse=(e,t)=>{this._sendMessage({type:"submitForm",response:e},t)};sendRecentUrl=async(e,t,a,n=!1)=>{await chrome.extension.isAllowedFileSchemeAccess()||(t=t?.filter(e=>!e.url.startsWith("file://"))),this._sendMessage({type:"RecentUrls",permission:e,showOverlay:n,recentUrls:t},a)};sendProgress=(e,t,a,n)=>{this._sendMessage({total:t,loaded:a,type:e},n)};sendInitialBuffer=(e,t,a,n,r)=>{this._sendMessage({type:e,downLoadstartTime:t,downLoadEndTime:a,buffer:n},r)};sendBufferRanges=(e,t,a,n)=>{this._sendMessage({type:e,range:t,buffer:a},n)};preview=(e,t,n,r,o,i,s)=>{const c="true"===a.getItem("bufferFromIndexedDB");a.removeItem("bufferFromIndexedDB"),this._sendMessage({fileSize:n,type:e,fileBuffer:t,fileName:r,downLoadstartTime:o,downLoadEndTime:i,fromIndexedDB:c,isLocalBlobFile:Te},s)};openInAcrobatResponse=(e,t,a)=>{this._sendMessage({type:e,res:t},a)};postLog=(e,t,a,n,r)=>{this._sendMessage({type:e,reqId:t,message:a,error:n},r)};sendCertificateValidationResponse=(e,t)=>{this._sendMessage({type:"certificateValidationResponse",response:e},t)};sendExperimentInfo=t=>{const a=e.getItem(x);let n=Array.isArray(a)?a.sort():[];ge._sendMessage({type:"experimentInfo",activeExperiments:n},t)}}function ut(t,a){try{pe=void 0!==pe?pe:"false"!==e.getItem("logAnalytics")&&"false"!==e.getItem("ANALYTICS_OPT_IN_ADMIN"),pe&&(ge&&ie?ge.postLog("log",ue,t,a,ie.origin):setTimeout(()=>{ge&&ie&&ge.postLog("log",ue,t,a,ie.origin)},500))}catch(e){}}function pt(){let e;return e=Ie?ce:window.location.href,e}function wt(){const t=pt(),n=(t.split("#")||[]).pop();if(n.indexOf("access_token=")>-1)try{const o=new URLSearchParams(n).get("access_token"),{client_id:i}=JSON.parse(window.atob(o.split(".")[1]))||{},s=e.getItem("viewerImsClientId");if([s,e.getItem("viewerImsClientIdSocial")].includes(i)){const e=a.getItem("csrf");a.removeItem("csrf");const n=r.parseCSRF(new URL(t));(!e||!n||n!==e)&&(tt("DCBrowserExt:Viewer:User:Error:NonMatchingCsrfToken:FailedToLogin"),ct())}}catch{}}function ht(t,a,n,r,o){o&&t.forEach(e=>{n.has(e)&&It(a,e,n.get(e))}),r&&t.forEach(t=>{""!==e.getItem(t)&&It(a,t,e.getItem(t))})}function It(t,a,n,r=!1){if(!n)return;if(!(j.includes(a)||r&&j.some(e=>a.startsWith(e)))){return void("prod"===e.getItem("env")?console.error(`Iframe URL param "${a}" blocked.`):console.error(`The param "${a}" was blocked because it isn't on the allowlist. If this param needs to be passed, add it to iframeUrlParamsAllowlist.js (requires code review from CodeOwners). Refer to the wiki for details: https://wiki.corp.adobe.com/x/CVTf2w#Extension:StorageUsage,BeaconAPI,andCDNParamPassing-3.PassingParametersintheCDNiframeURL.`))}const o="string"==typeof n?n:JSON.stringify(n);t.searchParams.append(a,o)}const bt=async()=>{try{let r;r=!Ie||Te||We?new URLSearchParams(window.location.search):new URLSearchParams(new URL(ce).search);const o=function(t){const a=e.getItem("cdnUrl");try{if("prod"===e.getItem("env"))return a;const n=t.get("ephemeralUrl");if(!n)return a;const r=new URL(n);return"https:"===r.protocol&&["stage.acrobat.adobe.com","dev.acrobat.adobe.com"].includes(r.hostname)&&r.pathname.startsWith("/ephemeral/dc-chrome-extension/")?n:a}catch(e){return console.error("Error validating ephemeral URL:",e?.message||"Unknown error"),a}}(r),i=new URL(o);if(!et(i.origin))return ut("Invalid CDN URL detected","Invalid Origin"),void Qe(!1,null,"invalid_cdn_origin");ie||(ie=i);let s=e.getItem("viewer-locale");s||(s=e.getItem("locale"));const c="false"!==e.getItem("logAnalytics"),l="false"!==e.getItem("ANALYTICS_OPT_IN_ADMIN"),d=c&&l?"true":l?"optinOff":"gpoOff",m=r.get("blob-uri");v(m,ce)&&(It(i,"blob-uri",m),It(i,"isDemoMode",!0),b()&&["returnURL","returnTabId"].forEach(e=>{const t=r.get(e);t&&i.searchParams.set(e,t)})),"true"===r.get("ogap")&&It(i,"ogap","true"),r.get("olfs")&&It(i,"olfs",r.get("olfs")),It(i,"aiFAB",e.getItem("enableGenAIFab")),It(i,"locale",ae||s),It(i,"logAnalytics",d),It(i,"callingApp",chrome.runtime.id),It(i,"lfa",e.getItem("isAllowedLocalFileAccess")||"false"),t.getItem("signInTp")&&It(i,"touchp",t.getItem("signInTp")),It(i,"rvu",e.getItem("userState")?.rvu??null);const f=e.getItem("installType")||"update",g=e.getItem("installSource");It(i,"version",`${chrome.runtime.getManifest().version}:${f}`),It(i,"installSource",g),It(i,"storage",JSON.stringify(e.getItem("viewerStorage")||{})),It(i,"fgContextVars",JSON.stringify(e.getItem("fgContextVars")||{})),It(i,"tabId",Le),It(i,"anonUserUUID",e.getItem("anonUserUUID"));try{It(i,"sv",void 0!==ke?.splitViewId&&-1!==ke?.splitViewId?"1":"0")}catch(e){}if(We){const e=r.get("sessionId"),t=r.get("fromChatsApp");It(i,"whatsappSessionId",e),It(i,"fromChatsApp",t)}"true"!==He("googlePrint")&&!0!==ve||"false"===a.getItem("googleAppsPrint")||It(i,"googleAppsPrint","true"),It(i,"lf",e.getItem("lf")?"1":"0");const u=Ee.read(ce);u&&(delete u.filename,delete u.lastVisited,It(i,"docState",JSON.stringify(u))),It(i,"nu",I()),It(i,"md",S()?"1":"0"),It(i,"dpt",e.getItem("isDarkPageThemeEnabled")?"1":"0");const p=t.getWithTTL("pdfMarkerAction");p&&(It(i,"action",p),t.removeItem("pdfMarkerAction")),It(i,"wn",e.getItem("whatsNew")?"1":"0"),It(i,"adminDisableGenAI","true"===e.getItem("DISABLE_GENAI_BY_ADMIN")?"1":"0"),SETTINGS.DEBUG_MODE&&It(i,"serVar",y()),It(i,"autoSum","false"!==e.getItem("autoSum"));if("true"===e.getItem("adobeInternal")){const t="true"===e.getItem("betaOptOut");It(i,"betaOptOut",t)}let h=a.getItem("signinTouchPointData");h=JSON.parse(h||"{}"),h&&"object"==typeof h&&Object.keys(h).length&&(It(i,"tp",h.touchpoint),It(i,"acmt",h.allowCommentsInShare?"1":"0")),a.removeItem("signinTouchPointData");const _=e.getItem("env"),E=(We?new URLSearchParams:new URLSearchParams(new URL(ce).search)).get(ne)||He(ne),C=L(E),U=E?.split("-")||[];if(U.length>1&&(i.searchParams.append("xId",U[0]),i.searchParams.append("xLoc",U[1])),E&&C){if(It(i,"sfceId",C),a.getItem("acrobatPromotionWorkflow"))It(i,"sfceIdWf",Pe);else{const t=("true"===e.getItem(`${C}-pdf-default-viewership`)).toString();It(i,"aDFrSfce",t),"true"===e.getItem(`${C}-pdf-implicit-dv-feature-enabled`)?It(i,"sfceIDVFe",!0):It(i,"sfceDVFe","true"===e.getItem(`${C}-pdf-dv-feature-enablement-status`)),It(i,"aDFrSfceUsrDsbl",function(t,a){return"true"===e.getItem(`${t}-pdf-default-viewership-user-disabled`)||"gdrive_chrome-native_view-NDV"===a}(C,E))}const t=Oe.includes(C),n=e.getItem(`enableMeterIQ${C}`);It(i,"emi",t||n?"1":"0")}n=i,["dialog!dropin","load!dropin"].forEach(e=>{""!==(a.getItem(e)||"")&&It(n,e,a.getItem(e))});ht(["analytics","logToConsole","enableLogging","frictionless","sessionId","linearization","ev","ao"],i,r,!1,!0);ht(["rrv","fgRearch","isDeskTop","isAcrobat","SFV","theme","defaultOwnerShipExperiment","sessionId","ev","ao","ip","genAI","mv","pi","ks","edd","lft","fsu","dcs","egal","ots","egaf","pnb","subv2","s3d","ripe","od","kwgn","rat"],i,r,!0,!1);"prod"!==_&&["dropin!","provider!","app!","forceDisableGenAI"].forEach(e=>{r.forEach((t,a)=>{a.startsWith(e)&&It(i,a,t,!0)})});let P=i.href;""===t.getItem("payPalUrl")||""===a.getItem("dialog!dropin")&&""===a.getItem("load!dropin")||(P+=t.getItem("payPalUrl")),P=await(async e=>{if(e.length>6553.6&&w.warn({message:"CDN iframe length breached 80% limit",iframeUrl:e}),e.length>8192){const t=await R.cleanUrl(e);return w.error({message:"CDN iframe length breached threshold",iframeUrl:e,cleanUrl:t}),t}return e})(P);let k=new URLSearchParams;const D=a.getItem("access_token");a.removeItem("access_token"),function(t,a,n){if(!n)return;if(!H.includes(a))return void("prod"===e.getItem("env")?console.error(`Iframe hash param "${a}" blocked.`):console.error(`The hash param "${a}" was blocked because it isn't on the allowlist. If this param needs to be passed, add it to iframeUrlParamsAllowlist.js (requires code review from CodeOwners). Refer to the wiki for details: https://wiki.corp.adobe.com/x/CVTf2w#Extension:StorageUsage,BeaconAPI,andCDNParamPassing-3.PassingParametersintheCDNiframeURL.`));const r=["access_token"].includes(a)?2048:128,o="string"==typeof n?n:JSON.stringify(n);o.length>r&&w.warn({message:`Hash param value too long: ${a}`,length:n.length}),t.set(a,o)}(k,"access_token",D);const T=`${P}${k.toString()?`#${k.toString()}`:""}`;return e.setItem("lastPdfOpenTimestamp",(new Date).getTime()),T}catch(e){throw tt("DCBrowserExt:Viewer:Iframe:Creation:Failed"),e}var n},vt=(a,n,r="localStorage")=>{if(n){const o="localStorage"===r?e.getItem(a):t.getItem(a);let i;o&&o.tabsInfo?(i=o.tabsInfo,i.includes(n)||i.push(n)):i=[n],"localStorage"===r?e.setItem(a,{tabsInfo:i}):t.setItem(a,{tabsInfo:i})}},yt=async()=>{try{!function(){try{let e=pt();e&&e.indexOf("#")>-1&&(r.saveAccessToken(e),r.signInAnalyticsLogging(e),r.checkSignInFromEditVerbPaywall(e),e=e.split("#")[0],Ie?ce=e:(window.location.hash=e,history.replaceState(null,document.title,e)))}catch(e){}}(),Ie&&(Le=be);const a=window.document.getElementById("Adobe-dc-view");Ie||(oe=He("clen")||-1),ge=new gt(a),Wt.removeItem("DCExt_Free_vs_Paid");const n=await bt();ge.createIframe(n),h(),window.addEventListener("message",a=>{!a.data||!et(a.origin)||me||"hsready"!==a.data.type&&"ready"!==a.data.type||(me=!0,fe=(new Date).getTime(),ue=a.data.requestId,J()&&Q("requestId","metadata",ue),"on"===a.data.killSwitch?(tt("DCBrowserExt:Viewer:KillSwitch:Turned:On"),e.setItem("pdfViewer","false"),o.setViewerState("disabled"),e.setItem("killSwitch","on"),Ie?Qe(!0):setTimeout(()=>{window.location.href=ce},200)):e.getItem("killSwitch")&&(tt("DCBrowserExt:Viewer:KillSwitch:Turned:Off"),e.removeItem("killSwitch")),t.getItem("signInTp")&&t.removeItem("signInTp"))})}catch(e){throw ut("Error create Iframe",e),e}};function _t(e){if(We)return"";if(se)return se;let t=e;try{const a=e.split("?")[0].split("/").filter(e=>e.length>0),n=a.length>0?a[a.length-1]:"untitled";t=n;const r=n.length-4;(n.length<4||n.toLowerCase().indexOf(".pdf")!==r)&&(t+=".pdf")}catch(e){ut("Error in getFileNameFromURL",e)}return t}function St(e,t){return function(a){if(this.readyState==this.HEADERS_RECEIVED){if(!function(e,t){const a=e.getResponseHeader("content-type"),n=Ht(t),r=e.getResponseHeader("content-disposition");if(a){const e=a.toLowerCase().split(";",1)[0].trim();if(!n&&r&&/^\s*attachment[;]?/i.test(r))return!1;if("application/pdf"===e)return!0;if("application/octet-stream"===e&&r&&/\.pdf(["']|$)/i.test(r))return!0}return!1}(e,t)&&!J())return ut("Fall back to native - not pdf from headers"),Qe(!1,e.getResponseHeader("content-type"),"invalid_content_type");if(le=!0,"true"===Re){const e=this.getResponseHeader("accept-ranges"),a=this.getResponseHeader("content-length");e&&"bytes"===e&&a&&Number(a)>0&&qe({main_op:"setupWorkerOffscreen",pdfURL:t,pdfSize:+a,acceptRanges:!0,tabId:Le})}}}}function Et(e,t){let a=!1;return function(n){n.lengthComputable&&(oe=n.total,e.sendProgress("progress",n.total,n.loaded,t),a||(!function(e){const t=Ee.read(ce)||{},a={main_op:"getFileSize",fileSize:e,tabId:Le,docLastOpenState:t,target:"offscreen"};chrome.runtime.sendMessage(a)}(oe),a=!0))}}function Lt(e,t){"PDF"===function(e){if(e)try{let t=new URL(e).pathname;return t.substr(t.lastIndexOf(".")+1).toUpperCase()}catch(e){return""}return""}(e)&&(le=!0);const a=new XMLHttpRequest;a.open("GET",e),a.responseType="arraybuffer",a.onreadystatechange=function(){4===a.readyState&&(200!==a.status&&0!=a.status||(t({buffer:a.response,mimeType:a.getResponseHeader("content-type")}),Ct(a.response)))},a.send(null)}async function Rt(t){try{const n=a.getItem("bufferTabId"),r=(at(ce)||Y())&&await je().hasKey(t);if(function(e,t){"preview"!==a.getItem("acrobatPromotionWorkflow")||e||ut("Direct Flow : Tab storage has acrobatPromotionWorkflow equivalent to preview but does not have key in indexedDB",t)}(r,t),n||r){const e=n&&await p.getDataFromIndexedDB(n)||await je().getDataFromIndexedDB(t);if(e&&e.fileBuffer)return a.setItem("bufferFromIndexedDB",!!n),le=!0,{buffer:e.fileBuffer}}else{const t=e.getItem("tabIdMap");if(t){const n=(Ie?await chrome.tabs.query({active:!0,currentWindow:!0}):[await chrome.tabs.getCurrent()])[0];if(n&&t[n.id]){a.setItem("bufferTabId",t[n.id]);const r=await p.getDataFromIndexedDB(t[n.id]);if(Object.keys(t).length>1?(delete t[n.id],e.setItem("tabIdMap",t)):e.removeItem("tabIdMap"),r&&r.fileBuffer)return a.setItem("bufferFromIndexedDB",!0),le=!0,{buffer:r.fileBuffer}}}}}catch(e){}return a.setItem("bufferFromIndexedDB",!1),{}}function Ct(e){const t=Ee.read(ce)||{},a=new Blob([e],{type:"application/pdf"}),n={main_op:"getFileBuffer",fileBufferBlob:URL.createObjectURL(a),tabId:Le,docLastOpenState:t,target:"offscreen"};chrome.runtime.sendMessage(n)}async function Ut(e){const t=at(ce),a=J();if(t||a){const t=(await chrome.tabs.getCurrent())?.id;try{await je().storeInIndexedDB(e,t)}catch(e){}}}const Pt=["embeddedpdfs_chrome-native_view","linkedin_chrome-chat_view","linkedin_chrome-message_view","gsheets_chrome-convert_to_pdf","gdocs_chrome-convert_to_pdf","gslides_chrome-convert_to_pdf"];function kt(e,t,a){if(!We)return new Promise((n,r)=>{const o=new URL(ce),i=o.searchParams.get("acrobatPromotionSource");if("webpage_chrome-convert_to_pdf"===i&&o.searchParams.has("tabId")){const e=o.searchParams.get("tabId"),t=o.searchParams.get("tabOriginalUrl");return void(e?chrome.runtime.sendMessage({main_op:"get-webpage-html-by-tab-id",sourceTabId:parseInt(e)},e=>{if(e&&e.success&&e.html){const t=(new TextEncoder).encode(e.html).buffer,a={buffer:t,mimeType:"text/html",downLoadEndTime:(new Date).getTime(),pdffilename:(e.title||"webpage")+".html"};Je("PDF_Convert_Source_File_Received",{fileSize:t.byteLength,contentType:"text/html"}),tt("DCBrowserExt:Viewer:WebpageConversion:HtmlExtract:Success"),J()?(le=!0,n(a)):(tt("DCBrowserExt:Viewer:WebpageConversion:Error:UnexpectedPreviewWorkflow"),r({message:"Unexpected preview workflow for webpage conversion"}))}else t?(tt("DCBrowserExt:Viewer:WebpageConversion:Fallback:TabClosed"),window.location.href=t):(tt("DCBrowserExt:Viewer:WebpageConversion:Error:NoFallbackUrl"),r({message:"Failed to get webpage HTML and no fallback URL available",error:e?.error||"Unknown error"}))}):(tt("DCBrowserExt:Viewer:WebpageConversion:Error:MissingTabId"),r({message:"Invalid webpage conversion request",error:"Tab ID is required for webpage conversion"})))}Pt.includes(i)&&o.searchParams.delete("acrobatPromotionSource");const s=o.toString();s.startsWith("file://")?Lt(s,n):(async()=>{const{maxRetries:o,retryDelayMs:i,retryableStatusCodes:c}=await m(),l=f(),d=()=>{const m=new XMLHttpRequest;m.open("GET",s),m.responseType="arraybuffer",t&&m.setRequestHeader("If-Range","randomrange"),m.onreadystatechange=St(m,ce),m.onprogress=Et(e,a),m.onload=()=>{if(m.status>=200&&m.status<400){l.retryCount>0&&g(s,l.lastFailedStatus,l.retryCount);const e={buffer:m.response,mimeType:m.getResponseHeader("content-type"),downLoadEndTime:(new Date).getTime(),pdfFetchRetryCount:l.retryCount};if(Je("PDF_Convert_Source_File_Received",{fileSize:m.response.byteLength,contentType:m.getResponseHeader("content-type")}),J())return e.pdffilename=se,le=!0,void n(e);n(e),Ct(m.response),Ut(m.response)}else{const e={status:m.status,statusText:m.statusText};u({retryState:l,maxRetries:o,statusOrType:m.status,logMessage:"PDF buffer fetch failed, retrying",pdfURL:s,attemptFetch:d,retryDelayMs:i,retryableStatusCodes:c,onMaxRetriesExceeded:()=>{r({message:"Invalid response fetching content",error:e,status:m.status,retryCount:l.retryCount})}})}},m.onerror=e=>{Te?p.getFileByHash(ce).then(async e=>{if(e)le=!0,oe=e.byteLength,n({buffer:e,mimeType:"application/pdf",downLoadEndTime:(new Date).getTime(),fileSize:e.byteLength});else{w.info({message:"User tried opening blob file after expiry"});const e=chrome.runtime.getURL("browser/js/viewer/sessionExpired.html");chrome.tabs.update({url:e})}}).catch(e=>{r({message:"Error to get file contents from indexedDB",error:e})}):u({retryState:l,maxRetries:o,statusOrType:"network_error",logMessage:"PDF buffer fetch network error, retrying",pdfURL:s,attemptFetch:d,retryDelayMs:i,onMaxRetriesExceeded:()=>{r({message:"Error to download file contents",error:e,status:"network_error",retryCount:l.retryCount})}})},m.ontimeout=e=>{u({retryState:l,maxRetries:o,statusOrType:"timeout",logMessage:"PDF buffer fetch timeout, retrying",pdfURL:s,attemptFetch:d,retryDelayMs:i,onMaxRetriesExceeded:()=>{r({message:"Timeout to download file contents",error:e,status:"timeout",retryCount:l.retryCount})}})},m.send()};d()})()})}function Dt(e,t){tt(`DCBrowserExt:Viewer:SignIn:AdobeYolo:${e}:clicked`),chrome.tabs.query({active:!0,currentWindow:!0},function(e){var t=e[0]&&e[0].id;vt("adobeYoloTabsInfo",t,"sessionStorage")}),qe({main_op:"launchJumpUrl",details:{source:e,userGuid:t}},t=>{ge._sendMessage({type:"adobeYoloJumpResponse",response:t,source:e},ie.origin)})}function Tt(e,t,...a){We&&t?t(...a):Ie?p.storeBufferAndCall(e,t,be,...a):chrome.tabs.getCurrent(function(n){p.storeBufferAndCall(e,t,n.id,...a)})}function Ft(e){ge._sendMessage({type:"redirectToAcrobatWeb",response:e},ie.origin)}function At(){Ie?chrome.tabs.reload(be):chrome.tabs.getCurrent(e=>{chrome.tabs.reload(e.id)})}async function xt(e){J()||ut("Convert to PDF : tab stoage does not have acrobatPromotionWorkflow equivalent to createpdf",a.getItem("acrobatPromotionWorkflow")),Je("PDF_Convert_PDF_Received",{fileSize:e.data.buffer?.byteLength,promotionSource:Z()}),qe({main_op:"pdf-convert-perf-emit",data:{requestId:ze}}),await Ut(e.data.buffer);const t=_(ce).get(ne);"webpage_chrome-convert_to_pdf"===t?tt("DCBrowserExt:Viewer:WebpageConversion:Success"):t&&e?.data?.buffer&&Xe("DCBrowserExt:Viewer:DirectFlow:Success",{source:t}),chrome.tabs.getCurrent().then(e=>{e?.id&&W(e.id)}),Pe=null,q(e,Ae,ce)}function Bt(r,m){switch(m.data.main_op){case"processPreviewPostPDFConversion":xt(m),Q("fileSizePostExecution","metadata",m.data.fileSize),Q("assetDownloadPostExecution","event",m.data.timestamp,"end");break;case"directVerbExecutionEvent":Q(m.data.eventName,"event",m.data.timestamp,m.data.phase);break;case"directVerbExecutionError":chrome.tabs.getCurrent().then(e=>{let a="unknown";if(e?.id){const n=V(e.id),r=t.getItem(n);a=r?.directFlowSuccess?"afterDirectFlowSuccess":"beforeDirectFlowSuccess",M(e.id)}Xe("DCBrowserExt:Viewer:DirectFlow:Error",{source:_(ce)?.get(ne),workflow:a})}),"compresspdf"===a.getItem("acrobatPromotionWorkflow")&&X();break;case"KW_FTE_COMPLETED":m.data?.fteCompleted&&(e.setItem(B.KW_FTE_COMPLETED,!0),tt("DCBrowserExt:Viewer:KW:FTE:Completed",m.data));break;case"open_in_acrobat":case"fillsign":!async function(t,a){const r={main_op:"open_in_acrobat"};if("fillsign"===a.data.main_op?r.paramName="FillnSign":a.data.paramName&&(r.paramName=a.data.paramName),r.url=a.data.url,r.click_context="pdfviewer",r.timeStamp=Date.now(),r.filename=a.data&&a.data.filename,a.data.fileBuffer){const e=new Blob([a.data.fileBuffer],{type:"application/pdf"});r.dataURL=URL.createObjectURL(e)}if(ye=function(e){"fillsign"===a.data.main_op?t.openInAcrobatResponse("FILLSIGN_IN_DESKTOP_APP",e,a.origin):t.openInAcrobatResponse("OPEN_IN_DESKTOP_APP",e,a.origin),ut(`Open In Acrobat - (${a.data.main_op}) response- ${e}`)},e.getItem("isSharepointFeatureEnabled"))if(ft.isSharePointURL)r.workflow_name="SharePoint",r.isSharePointURL=!0,qe(r,ye);else{const e=await n.checkForSharePointURL(r.url);r.isSharePointURL=e,e&&(r.workflow_name="SharePoint"),qe(r,ye)}else qe(r,ye)}(r,m);break;case"complete_conversion":tt("DCBrowserExt:Viewer:Verbs:Conversion:Redirection"),function(e){const t={};t.main_op=e.data.main_op,t.conversion_url=decodeURIComponent(e.data.conversion_url),t.timeStamp=Date.now(),qe(t)}(m);break;case"updateLocale":tt("DCBrowserExt:Viewer:User:Locale:Updated"),e.setItem("viewer-locale",m.data.locale),qe({main_op:"localeChange",locale:m.data.locale}),chrome.tabs.reload();break;case"setInitialLocale":let u=!1;e.getItem("viewer-locale")||(u=!0,e.setItem("viewer-locale",m.data.locale),tt("DCBrowserExt:Viewer:User:Locale:Initial")),m.data.reloadReq&&u&&chrome.tabs.reload();break;case"error-sign-in":!function(e){const t=n.uuid();a.setItem("csrf",t);const r=new URL(e),o=ot();o.hash=o.hash+`state=${t}&signInError=true`,r.searchParams.set("redirect_uri",o),chrome.tabs.update({url:r.href,active:!0})}(m.data.url);break;case"deleteViewerLocale":e.getItem("viewer-locale")&&(e.removeItem("viewer-locale"),chrome.tabs.reload());break;case"signin":tt("DCBrowserExt:Viewer:Ims:Sign:In"),a.setItem("signInSource",m.data.source),a.setItem("signinTouchPointData",JSON.stringify({touchpoint:m.data.tp,allowCommentsInShare:m.data.allowCommentsInShare})),tt(`DCBrowserExt:Viewer:Ims:Sign:In:${m.data.source}`),Tt(m.data.fileBuffer,st,m.data);break;case"googleSignIn":tt("DCBrowserExt:Viewer:Ims:Sign:In"),tt(`DCBrowserExt:Viewer:Ims:Sign:In:${m.data.source}`),a.setItem("signInSource",m.data.source),Tt(m.data.fileBuffer,mt,m.data);break;case"signup":tt("DCBrowserExt:Viewer:Ims:Sign:Up"),a.setItem("signUpSource",m.data.source),tt(`DCBrowserExt:Viewer:Ims:Sign:Up:${m.data.source}`),Tt(m.data.fileBuffer,st,m.data);break;case"reload_viewer":chrome.tabs.reload();break;case"reload_current_tab":At();case"upsell_event":!function(e){if(e&&e.url){const a=new URL(decodeURIComponent(e.url));e.returnUrlParams&&t.setItem("rtParams",e.returnUrlParams.toString()),"_blank"===e.target?chrome.tabs.create({url:a.href,active:!0}):chrome.tabs.update({url:a.href,active:!0})}}(m.data);break;case"upsell_remove_urlParams":t.removeItem("rtParams"),t.removeItem("payPalUrl"),a.removeItem("dialog!dropin"),a.removeItem("load!dropin");break;case"fetchLocalRecents":const h=new URL(e.getItem("cdnUrl")).origin;if(m.data.fetchRecents){const e=m.data.showOverlay;!async function(e,t,a=!1){const n=Ee.getAllItems();e.sendRecentUrl(!0,n,t,a)}(ge,h,e)}else ge.sendRecentUrl(!0,null,h);break;case"socialSignIn":tt("DCBrowserExt:Viewer:Ims:Sign:In"),tt(`DCBrowserExt:Viewer:Ims:Sign:In:${m.data.source}`),a.setItem("signInSource",m.data.source),Tt(m.data.fileBuffer,dt,m.data);break;case"openRecentFileLink":const I={};I.main_op=m.data.main_op,I.recent_file_url=decodeURIComponent(m.data.recent_file_url),I.file_name=m.data.file_name,qe(I);break;case"updateCurrentURL":!async function(e){const{redirectURL:t,copyToClipboard:a}=e;if(a)try{await navigator.clipboard.writeText(a)}catch(e){}const n=Ie?be:(await chrome.tabs.getCurrent())?.id;chrome.tabs.update(n,{url:t})}(m.data);break;case"saveFileBufferAndReload":Tt(m.data.fileBuffer,At);break;case"userSubscriptionData":const b=e.getItem("enableFabForPaidUsers"),{userSubscriptionData:v,main_op:y}=m.data;if(b&&function(e=[]){return e.some(e=>"GenAIServices"===e?.name&&e?.level!==d.free)}(v)&&(e.getItem("enableGenAIFab")||(e.setItem("isGenAIPaidUser",!0),tt("DCBrowserExt:SidePanel:GenAIPaid:FABEnabled"))),Ie){qe({eventType:y,userSubscriptionData:v,data:m.data,main_op:y},function(e){e&&"showUninstallPopUp"===e.main_op&&ge._sendMessage({type:"showUninstallPopUp"},ie.origin)})}break;case"uninstall":Ie&&qe({main_op:"uninstall",defaultUrl:ce});break;case"submit_form":fetch(m.data.resource,m.data.options).then(e=>{ge.sendSubmitFormResponse(e.ok,m.origin)}).catch(()=>{ge.sendSubmitFormResponse(!1,m.origin)});break;case"ownerShipExperimentShown":e.removeItem("defaultOwnerShipExperiment");break;case"openAcrobatOptions":e.setItem("optionsPageSource",l.VIEWER_PREFERENCES).then(()=>{chrome.runtime.openOptionsPage()}),tt(`DCBrowserExt:Viewer:ManagePref:clicked:${m.data.source}`);break;case"openOnboardingTutorialFile":const S={};S.main_op=m.data.main_op,S.onboardingDemoFileURL=m.data.onboardingDemoFileURL,S.blobParam=m.data.blobParam,S.pdfURL=m.data.pdfURL,qe(S);break;case"returnToYourFile":const E={};E.main_op=m.data.main_op,E.returnTabId=m.data.returnTabId,E.returnURL=m.data.returnURL,qe(E);break;case"openLocalFileThoughFilePicker":!async function(e,t,a,n,r,o){p.storeFileByHash(t,`chrome-extension://${chrome.runtime.id}/${n}`).then(()=>{const t={};t.main_op=e,t.file_name=a,t.fileURL=n,t.openGenAIAssistantPanel=r,t.openLocalFileSource=o,qe(t)})}(m.data.main_op,m.data.fileBuffer,m.data.file_name,m.data.fileURL,m.data.openGenAIAssistantPanel,m.data.openLocalFileSource);break;case"openExtensionSettings":if("pinToolbar"===m.data.action)chrome.tabs.query({active:!0,currentWindow:!0},function(e){const t=e[0];n.openExtensionSettingsInWindow({tab:t,action:m.data.action})});else{const t=e.getItem("openSettingsInWindow");t?chrome.tabs.query({active:!0,currentWindow:!0},function(t){const a=t[0];e.setItem("lastOpenTabId",a.id),n.openExtensionSettingsInWindow({tab:a,action:m.data.action})}):chrome.tabs.create({url:n.constructUrlWithParams(c,{context:POPUP_CONTEXT.LOCAL_FILE_COACHMARK,autoDismiss:!0}),active:!0},e=>{chrome.windows.update(e.windowId,{focused:!0},()=>{chrome.action.openPopup().catch(e=>console.error(e))})}),k.event(D.LOCAL_FILE_ACCESS_TOUCHPOINT_SETTINGS_OPENED,{VARIANT:t?"InWindow":"InTab"}),e.setWithTTL("LocalFileAccessTouchpointsFromViewer",!0,i),"localFileAccessBannerChallenger"===m.data.variant?e.setWithTTL("LocalFileAccessBannerChallengerTouchpointsFromViewer",!0,i):"localFileAccessBannerControl"===m.data.variant&&e.setWithTTL("LocalFileAccessBannerControlTouchpointsFromViewer",!0,i),qe({main_op:"triggerBufferSave"})}break;case"encryptedWriteFile":({secureString:De}=m.data),Nt(document.title);break;case"showAutoSummaryPreference":e.setItem("autoSummaryEligible",m.data.isEligible);break;case"genAIAutoSummarizeToggledFromViewer":g=m.data,e.getItem("autoSum")!==g.isEnabled&&(e.setItem("autoSum",g.isEnabled.toString()),qe({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"enableGenAIAutoSummarizeTitle",toggleVal:g.isEnabled}));break;case"launchJump":Tt(m.data.fileBuffer,Dt,m.data.source,m.data.userGuid);break;case"saveAsEvent":!async function(e){try{if(tt("DCBrowserExt:Viewer:SaveToMyComputer:"+(Se?"fileHandlerExist":"fileHandlerNotExist")),Se)Ce=!1;else{const t={suggestedName:`${e.fileName}.pdf`,types:[{description:"PDF file",accept:{"application/pdf":[".pdf"]}}]};Se=await window.showSaveFilePicker(t),Ce=!0,Nt(Se?.name)}ge._sendMessage({type:"newSaveToLocalResponse",newAsset:Ce,updatedFileName:Se?.name},ie.origin)}catch(e){Se=null,ut("Save As Handler Error",e),ge._sendMessage({type:"newSaveToLocalResponse",error:e},ie.origin)}}(m.data);break;case"downloadFile":!async function(e){let t=null,a=null;try{let n=e.fileUrl;const r=e.fileName||se||"untitled";if(!n){const a=new Blob([e.fileBuffer],{type:"application/pdf"});t=URL.createObjectURL(a),n=t}const o=e.silentDownload||!1;a=await chrome.downloads.download({url:n,conflictAction:"uniquify",saveAs:!o,filename:e?.fileNameWithExtension?e?.fileNameWithExtension:`${r}.pdf`}),a&&function(e){const t=a=>{a?.id===e&&(a?.state&&"complete"===a?.state?.current?(ge._sendMessage({type:"showDownloadCompletedOnCard"},ie.origin),w.info({message:"File downloaded successfully",downloadId:e}),chrome.downloads.onChanged.removeListener(t)):a?.state&&"interrupted"===a?.state?.current&&(chrome.downloads.onChanged.removeListener(t),w.info({message:"File download interrupted",downloadId:e})))};chrome.downloads.onChanged.addListener(t)}(a),w.info({message:"File downloaded",url:n,fileName:r,fileNamefromViewer:e.fileName})}catch(e){ut("downloadFile error",e),ge._sendMessage({type:"downloadFileError"},ie.origin)}finally{t&&URL.revokeObjectURL(t)}}(m.data);break;case"rememberSaveLocationPreference":!function(t){let a="";t.cloudStorage&&!e.getItem("selectedSaveLocationPreference")?a="PreferenceMigrationSuccess":t.cloudStorage||(a="SaveDialogRememberMe");a&&tt(`DCBrowserExt:Viewer:ChangeSaveLocationPreference:${a}`);(!t.cloudStorage||t.cloudStorage&&!e.getItem("selectedSaveLocationPreference"))&&(e.setItem("saveLocation",t.saveLocation),e.setItem("selectedSaveLocationPreference",!0),qe({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"saveLocationPreferenceTitle",toggleVal:t.saveLocation}))}(m.data);break;case"appRenderingDone":Zt();break;case"saveFileBuffer":Tt(m.data.fileBuffer);break;case"deleteFileBuffer":const L=a.getItem("bufferTabId");L&&p.deleteDataFromIndexedDB(L),a.removeItem("bufferTabId");case"appRenderingDone":Zt();break;case"writeToLocalSavedFile":!async function(e){try{const t=await Se.createWritable();await t.write(e.fileBuffer),await t.close(),ge._sendMessage({type:"newSaveToLocalResponse",newAsset:Ce,updatedFileName:Se?.name,isFileWriteStage:!0},ie.origin)}catch(e){Se=null,ut("Write to Local File Error",e),ge._sendMessage({type:"newSaveToLocalResponse",error:e,isFileWriteStage:!0},ie.origin)}}(m.data);break;case"bookmarkWeb":U(m.data.url,Ft,tt);break;case"updateDocumentViewState":!function(e){const{documentViewState:t}=e;Ee.writeAndSyncWithHistory(ce,t)}(m.data);break;case"validateEdgeCertificateForDigitalSignature":o.validateCertificate(m.data).then(e=>ge.sendCertificateValidationResponse(e,m.origin));break;case"documentViewThemeChange":!function(t){e.getItem("theme")!==t.data&&(e.setItem("theme",t.theme),qe({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"appearancePrefTitle",toggleVal:t.theme}));e.getItem("isDarkPageThemeEnabled")!==t.isDarkPageThemeEnabled&&e.setItem("isDarkPageThemeEnabled",t.isDarkPageThemeEnabled)}(m.data);break;case"enableGenAIFeaturesToggledFromViewer":!function(t){e.getItem("egaf")!==t.isEnabled&&(e.setItem("egaf",t.isEnabled.toString()),qe({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"enableGenAIFeaturesTitle",toggleVal:t.isEnabled}))}(m.data);break;case"genAIEligible":!function(t){e.setItem("genAIEligible",t?.isEligible?.toString()),Ge(t?.isEligible||!1)}(m.data);break;case"rrvLayerRemoved":qe({main_op:"rrvLayerRemoved",tabId:m.data.tabId,target:"offscreen"});break;case"setFloodgateResponseFromViewer":qe({main_op:"handleViewerFloodgateResponse",fgResponse:m.data.fgResponse});break;case"getSignedInCachedffResponse":f=m.data.userId,ge._sendMessage({type:"signedInCachedffResponse",ffResponse:e.getItem(`ffResponse_${f}`)||"{}"},ie.origin);break;case"changeDefaultViewershipForSurface":chrome.runtime.sendMessage({...m.data});break;case"openWhatsNew":qe({main_op:"openWhatsNew",source:m.data.source});break;case"sendAnalytics":tt(m?.data?.event);break;case"openCollectionTab":qe({...m.data});break;case"upsell_dialog_close":K(m);break;case"previewReadyPostDirectFlow":chrome.tabs.getCurrent().then(e=>{e?.id&&(M(e.id),Q("filePreview","event",Date.now(),"end"),ee().then(()=>{$(e.id)}))})}var f,g}function Vt(e){try{const t=new TextDecoder("utf-8").decode(e.buffer);let a=!1;-1!=t.indexOf("Linearized 1")?a=!0:-1!=t.indexOf("Linearized")&&tt("DCBrowserExt:Viewer:Linearization:Linearized:Version:Other"),ge._sendMessage({type:"Linearization",linearized:a},ie.origin)}catch(e){tt("DCBrowserExt:Viewer:Linearization:Linearized:Detection:Failed"),ut("Linearization Detection failed",e)}}function Mt(t,a,n,r){n.then(n=>{const o=n.downLoadEndTime,i=n.buffer;n.buffer.byteLength;t.preview("preview",i,oe,se,r,o,a.origin),ge._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},ie.origin),n.pdfFetchRetryCount&&n.pdfFetchRetryCount>0&&ge._sendMessage({type:"pdfFetchRetryCount",retryCount:n.pdfFetchRetryCount},ie.origin),!0===e.getItem("isSaveLocationPrefEnabled")&&ge._sendMessage({type:"changeSaveLocationPreference",saveLocation:e.getItem("saveLocation"),onLoad:!0},ie.origin)}).catch(e=>(Xe("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed",{tabURL:ce,source:_(ce).get(ne)}),Qe(!1,null,"file_download_failed",{status:e?.status,retryCount:e?.retryCount}))).finally(()=>{e.removeItem("sessionStarted")})}class Ot{constructor(){this.request={main_op:"analytics"}}analytics=e=>{this.request.analytics||(this.request.analytics=[]),this.request.analytics.push([e])};sendAnalytics=()=>{qe(this.request)}}function Nt(e){e&&(document.title=e+De)}const Wt={setItem:(t,a,n)=>{const r=n?"viewerStorage":"viewerStorageAsync",o=e.getItem(r)||{};o[t]=a,e.setItem(r,o)},removeItem:(t,a=null)=>{if(null!==a){const n=a?"viewerStorage":"viewerStorageAsync",r=e.getItem(n)||{};delete r[t],e.setItem(n,r)}else{const a=e.getItem("viewerStorage")||{},n=e.getItem("viewerStorageAsync")||{};delete a[t],delete n[t],e.setItem("viewerStorage",a),e.setItem("viewerStorageAsync",n)}},removeItems:(t,a=null)=>{if(Array.isArray(t))if(null!==a){const n=a?"viewerStorage":"viewerStorageAsync",r=e.getItem(n)||{};t.forEach(e=>{delete r[e]}),e.setItem(n,r)}else{const a=e.getItem("viewerStorage")||{},n=e.getItem("viewerStorageAsync")||{};t.forEach(e=>{delete a[e],delete n[e]}),e.setItem("viewerStorage",a),e.setItem("viewerStorageAsync",n)}}};function $t(t,n,r,o){return i=>{try{if(i.data&&i.origin&&et(i.origin)&&(e=>{try{return e&&e.source&&e.source.top.location.origin==="chrome-extension://"+chrome.runtime.id}catch(e){return!1}})(i)){if(i.data.main_op)return Bt(t,i);switch(i.data.type){case"ready":if(J()&&Q("viewerReady","event"),window.hideLoader&&window.hideLoader(),Ie?async function(t,n,r,o){let i=new Ot;de=!0;let s=ce;if(Te){const e=ce.substring(ce.indexOf("blob"));s=Ae+"?pdfurl="+encodeURIComponent(e)+"&pdffilename="+encodeURIComponent(se)}document.title=se;const c=_e.getHeaderValue("accept-ranges"),l=!a.getItem("bufferTabId")&&c&&"bytes"===c.toLowerCase()?"true":"false";Yt(),t.sendFileMetaData("metadata",fe,oe,l,s,encodeURIComponent(se),n.origin,!1),Jt(),r&&r.then(e=>{t.sendInitialBuffer("initialBuffer",e.startTime,e.endTime,e.buffer,n.origin),Vt(e)}).catch(e=>{t.sendInitialBuffer("initialBuffer",0,0,-1,n.origin),i.analytics("DCBrowserExt:Viewer:Error:Linearization:InitialBufiled")}),e.removeItem("isReload"),e.removeItem("isBackForward");const d=window.performance&&window.performance.timing&&window.performance.timing.navigationStart,m=Rt(),f=await m;if(Te){const a=new URL(e.getItem("cdnUrl"));Mt(t,n,kt(ge,!1,a.origin),d)}else f.buffer?Mt(t,n,m,d):(fetch(o.streamUrl).then(e=>{let a=0;return new Response(new ReadableStream({start(r){const o=e.body.getReader();!function e(){o.read().then(({done:o,value:i})=>{o?r.close():(a+=i.byteLength,t.sendProgress("progress",oe,a,n.origin),r.enqueue(i),e())}).catch(e=>{r.error(e)})}()}}))}).then(e=>e.arrayBuffer()).then(a=>{oe=a.byteLength,Ct(a),t.preview("preview",a,a.byteLength,se,d,(new Date).getTime(),n.origin),ge._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},n.origin),!0===e.getItem("isSaveLocationPrefEnabled")&&ge._sendMessage({type:"changeSaveLocationPreference",saveLocation:e.getItem("saveLocation"),onLoad:!0},n.origin)}).catch(e=>(i.analytics("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed"),Qe(!1,null,"mime_file_download_failed"))),i.sendAnalytics());ut("Viewer loaded")}(t,i,r,n):function(e,t,n,r,o){de=!0;let i=ce;if(Te){const e=ce.substring(ce.indexOf("blob"));i=Ae+"?pdfurl="+encodeURIComponent(e)+"&pdffilename="+encodeURIComponent(se)}const s=!a.getItem("bufferTabId")&&He("chunk")||"false",c=window.performance.getEntriesByType("navigation").map(e=>e.type).includes("reload"),l=window.performance.getEntriesByType("navigation").map(e=>e.type).includes("back_forward");Yt(),e.sendFileMetaData("metadata",fe,oe,s,encodeURI(i),encodeURIComponent(se),t.origin,c||l),Jt(),n?n.then(a=>{e.sendInitialBuffer("initialBuffer",a.startTime,a.endTime,a.buffer,t.origin),Vt(a)}).catch(a=>{e.sendInitialBuffer("initialBuffer",0,0,-1,t.origin)}):e.sendInitialBuffer("initialBuffer",0,0,-1,t.origin),J()?z(e,t,r,o):Mt(e,t,r,o),ut("Viewer loaded"),(J()||"embeddedpdfs_chrome-native_view"===Z())&&Xe("DCBrowserExt:Viewer:DirectFlow:ViewerLoaded",{source:Z()})}(t,i,r,n,o),qe({main_op:"getUserInfoFromAcrobat"},e=>{ge._sendMessage({type:"adobeYoloUserData",...e},ie.origin)}),i.data.visitorID){const t=e.getItem("viewerVisitorID");e.setItem("viewerVisitorID",i.data.visitorID),t&&t!==i.data.visitorID&&tt("DCBrowserExt:Analytics:viewerVisitorID:MCMID:Changed")}qe({main_op:"getWhatsNewAutoOpenEligibility"},(e={})=>{ge._sendMessage({type:"whatsNewAutoOpenEligibility",eligible:!!e.eligible},ie.origin)});break;case"getFileBufferRange":!function(e,t){let a={url:ce};T.getFileBufferRange(a,e.data.range).then(a=>{he||(he=!0),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,a.buffer,e.origin)}).catch(a=>{tt("DCBrowserExt:Viewer:Error:Linearization:Range:Failed"),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,-1,e.origin)})}(i,t);break;case"previewFailed":we||(tt("DCBrowserExt:Viewer:Error:FallbackToNative:Preview:Failed"),we=!0,Qe(!1,null,"preview_failed"));break;case"lastUserGuid":e.setItem("lastUserGuid",i.data.value);break;case"signin":tt("DCBrowserExt:Viewer:Ims:Sign:In"),st();break;case"signout":tt("DCBrowserExt:Viewer:Ims:Sign:Out"),e.removeItem("viewer-locale"),e.removeItem("userDetailsFetchedTimeStamp"),e.removeItem("discoveryExpiryTime"),e.removeItem("viewer-locale"),Tt(i.data.fileBuffer,ct);break;case"googleAppsPrintShown":a.setItem("googleAppsPrint","false"),tt("DCBrowserExt:Viewer:GoogleApps:Print:Shown");break;case"signInExperimentShown":chrome.tabs.query({active:!0,currentWindow:!0},function(t){const a=t[0],n=(new Date).getTime();e.setItem("signInExperimentShown",JSON.stringify({currTabId:a.id,timestamp:n}))});break;case"disableViewer":e.setItem("pdfViewer","false"),chrome.tabs.reload();break;case"signInExperimentClosed":case"signInExperimentSkipped":e.setItem("signInExperimentSuppressed","true");break;case"enableBeta":e.setItem("betaOptOut","false"),chrome.tabs.reload();break;case"disableBeta":e.setItem("betaOptOut","true"),chrome.tabs.reload();break;case"updateTitle":Nt(i.data.title);break;case"viewer_set_item":Wt.setItem(i.data.key,i.data.value,i.data.startup);break;case"viewer_remove_item":Wt.removeItem(i.data.key,i.data.startup);break;case"tab_storage_set_item":a.setItem(i.data.key,i.data.value);break;case"tab_storage_get_item":ge._sendMessage({type:"tab_storage_get_item_response",messageId:i.data.messageId,value:a.getItem(i.data.key)},ie.origin);break;case"tab_storage_remove_item":a.removeItem(i.data.key);break;case"viewer_remove_items":Wt.removeItems(i.data.keys,i.data.startup);break;case"storage_sync_to_async_cleanup":qe({main_op:"storage-migration-sync-to-async-cleanup"});break;case"adminStatus":e.setItem("isAdminUser",i.data.isAdmin);break;case"toggleGenAIFab":!function(t){const a=null==t.value?"false":`${t.value}`;e.setItem("enableGenAIFab",a),qe({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"genAIFabPreferenceTitle",toggleVal:a})}(i.data)}}}catch(e){tt("DCBrowserExt:Viewer:Error:MessageHandler:Unknown")}}}function Gt(){if(!me)return Xe("DCBrowserExt:Viewer:Error:Handshake:TimedOut",{source:Z()}),Qe(!1,null,"handshake_timeout"),!1}const jt=async t=>{try{e.getItem("enableCSRF")&&wt();const n=_e.getHeaderValue("content-length");oe=n;const r=_e.getHeaderValue("accept-ranges"),o=r&&"bytes"===r.toLowerCase();ce=t.originalUrl,await yt();const i=new URLSearchParams(We?"":new URL(ce).search).get("blob-uri");v(i,ce)?se="Acrobat Tutorial.pdf":se||(se=function(){let e;const t=_e.getHeaderValue("content-disposition");if(t&&/\.pdf(["']|$)/i.test(t)){const a=/filename[^;=\n\*]?=((['"]).*?\2|[^;\n]*)/.exec(t);null!=a&&a.length>1&&(e=a[1].replace(/['"]/g,""))}return e||(e=_t(ce)),decodeURIComponent(e)}());const s={url:ce},c=new URL(e.getItem("cdnUrl"));ie||(ie=c);let l=null;const d="false"!==He("linearization")&&!a.getItem("bufferTabId");!We&&d&&o&&n>0&&(l=T.getFileBufferRange(s,{start:0,end:1024})),window.addEventListener("message",$t(ge,t,l)),Kt(),setTimeout(Gt,25e3)}catch(e){ut("InitMimeHandlerScript failed",e),Qe(!1,null,"mime_handler_init_failed")}},Ht=e=>_(e).has(ne)||He(ne)?.length>0,qt=e=>"https://drive.usercontent.google.com"===e?.origin&&e?.searchParams?.has(ne),zt=async()=>{try{if(e.getItem("enableCSRF")&&wt(),!We&&!1===Ue)return void(le=!1);await yt();const t=He("clen")||-1,n=He("chunk")||!1,r="false"!==He("linearization")&&!a.getItem("bufferTabId"),o={url:ce},i=(new Date).getTime();J()&&Q("assetDownloadPreExecution","event",i,"start"),Je("PDF_Convert_Viewer_Initialized");const s=new URL(e.getItem("cdnUrl")),c=new URLSearchParams(ce?new URL(ce).search:"").get("blob-uri");v(c,ce)?se="Acrobat Tutorial.pdf":(se=He("pdffilename"),se=se?encodeURIComponent(se):_t(ce)),document.title=decodeURIComponent(se),ie||(ie=s);let l=null;const d=!We&&r&&n&&t>0;d&&(l=T.getFileBufferRange(o,{start:0,end:1024}));const m=(await chrome.tabs.getCurrent())?.id,f=Z();f&&m&&O(m,f);const g=Rt(m),u=(await g).buffer?g:kt(ge,d,s.origin);window.addEventListener("message",$t(ge,u,l,i)),setTimeout(Gt,25e3),(()=>{try{if(ce&&Ht(ce)&&!a.getItem("acrobatPromotionWorkflow")){const t=Ke(new URL(ce)?.search,ne)||He(ne),a=L(t),n=e.getItem(`${a}-pdf-default-viewership`);N(t)&&Xe(`DCBrowserExt:${a}:DefaultViewership:PDFOpenedWillShowCoachmark`,{source:t}),Xe(`DCBrowserExt:Viewer:ExtnViewerPdfOpened:${t}`,{experimentEnablementStatus:n})}}catch(e){}})()}catch(e){ut("InitScript failed",e),Qe(!1,null,"init_script_failed")}};function Jt(){if(a.getItem("signInAction")){const e=a.getItem("signInAction");ge._sendMessage({type:"signInInformation",action:e,source:"signIn"===e?a.getItem("signInSource"):a.getItem("signUpSource")},ie.origin),a.removeItem("signInSource"),a.removeItem("signUpSource"),a.removeItem("signInAction")}}async function Kt(){chrome.storage.onChanged.addListener((t,a)=>{"local"===a&&Object.entries(t).forEach(([t,{newValue:a}])=>{switch(t){case"theme":ge._sendMessage({type:"themeChange",theme:a},ie.origin);break;case"ANALYTICS_OPT_IN_ADMIN":{const t="false"!==e.getItem("logAnalytics"),n="false"!==a;ge._sendMessage({type:"analyticsTrackingChange",value:t&&n},ie.origin);break}case"saveLocation":ge._sendMessage({type:"changeSaveLocationPreference",saveLocation:a},ie.origin);break;case"isDarkPageThemeEnabled":ge._sendMessage({type:"darkPageThemeChange",isDarkPageThemeEnabled:a},ie.origin);break;case"egaf":ge._sendMessage({type:"enableGenAIFeaturesToggled",enableGenAIFeatures:a},ie.origin);break;case"akamai":qe({main_op:"reRegisterUninstallUrl"})}})}),await async function(){return re=await o.isInstalledViaUpsell(),re}(),ge._sendMessage({type:"setAsyncStorage",storage:e.getItem("viewerStorageAsync")},ie.origin),qe({main_op:"viewer-startup",url:ce,startup_time:Date.now(),viewer:!0},e=>{ft.isSharePointURL=!!e.isSharePointURL,ft.isSharePointFeatureEnabled=!!e.isSharePointEnabled,ft.isFrictionlessEnabled=!!e.isFrictionlessEnabled,ft.featureFlags=e.featureFlags,ft.isFillAndSignRegisteryEnabled=e.isFillnSignEnabled;const t=ot().href;ge.sendStartupConfigs(t,ie.origin)}),qe({main_op:"get-features&groups",cachePurge:"LAZY"},e=>{ge._sendMessage({type:"featureGroups",featureGroups:e.featureGroups,featureFlags:e.featureFlags,ffResponse:e.ffResponse},ie.origin)}),Ie?setTimeout(()=>vt("loadedTabsInfo",be),2e3):qe({main_op:"updateLoadedTabsInfo"}),Te||"preview"===a.getItem("acrobatPromotionWorkflow")||Ee.writeAndSyncWithHistory(ce,{filename:se,lastVisited:Date.now()})}function Yt(){ge._sendMessage({type:"fgFlagsResponse",ffResponse:e.getItem("ffResponse_anon")||"{}",anonUserUUID:e.getItem("anonUserUUID")},ie.origin)}function Xt(t,a,n){switch(t.panel_op&&!0===t.reload_in_native&&(delete t.is_viewer,chrome.tabs.reload(t.tabId)),t.content_op){case"showLocalFileAccessToast":if(!t.tabId||t.tabId===e.getItem("lastOpenTabId")){const e=["CLP","LSC"],a=te().filter(t=>e.includes(t));ge._sendMessage({type:"showLocalFileAccessToast",activeLocalExperiments:a,action:t.action},ie.origin)}break;case"rapidRenditionResponse":ge._sendMessage({type:"rapidRenditionResponse",pageRendition:t.pageRendition,perfMarker:t.perfMarker},ie.origin);break;case"rapidRenditionError":ge._sendMessage({type:"rapidRenditionError",error:t.error},ie.origin);break;case"removeAnonGenAIProvisionResponse":ge._sendMessage({type:"removeAnonGenAIProvisionResponse"},ie.origin)}switch(t.main_op){case"relay_to_content":if("dismiss"===t.content_op){delete t.content_op,delete t.reload_in_native;let e=document.getElementById("__acrobatDialog__");return void(e&&(e.remove(),e=null))}break;case"reset":ge._sendMessage({type:"toggleAnalytics",logAnalytics:t.analytics_on},ie.origin);break;case"showUninstallPopUp":ge._sendMessage({type:"showUninstallPopUp"},ie.origin);break;case"jumpUrlSuccess":(!Ie||t.tabInfo&&t.tabInfo.includes(be))&&ge._sendMessage({type:"adobeYoloJumpUrlSuccess"},ie.origin);break;case"triggerBufferSave":ge._sendMessage({type:"triggerBufferSave"},ie.origin);break;case"downloadFileSuccess":ge._sendMessage({type:"downloadFileSuccess"},ie.origin);break;case"openViewerAIAssistant":ge._sendMessage({type:"openViewerAIAssistant"},ie.origin);break;case"isGenAIEligibleInCDN":if(t.activeTabId==Le)return $e.then(n),!0;break;case"updateSplitView":ge._sendMessage({type:"updateSplitView",splitViewId:t.splitViewId},ie.origin)}return!1}function Zt(){const t=e.getItem("userState");let a=!1;if(void 0!==t?.rvu&&(a=!0),!0!==t.rvu){const t={rvu:a};e.setItem("userState",t)}}document.addEventListener("DOMContentLoaded",function(e){const t=(new Date).getTime();let a=window.setInterval(function(){(function(){const e=document.getElementById("dc-view-frame");return e&&e.contentWindow&&1===e.contentWindow.length}()||(new Date).getTime()-t>15e3)&&(window.clearInterval(a),e.call(this))},200)}(function(){const e=document.getElementById("dc-view-frame");e&&e.contentWindow&&e.contentWindow.focus()})),window.onerror=e=>{w.error({message:"Viewer errored out",error:e})},window.addEventListener("unhandledrejection",e=>{const t=(e=>{if(e instanceof Error)return e?.message||e?.toString?.();if("string"==typeof e)return e;if("object"==typeof e&&null!==e)try{return JSON.stringify(e)}catch(t){return String(e)}return String(e)})(e.reason);t?.includes("the message channel closed before a response was received")||w.error({message:"Viewer unhandled promise rejection",reason:t,stack:e.reason?.stack})}),void 0!==chrome.runtime&&(Ee=new P,o.isMimeHandlerAvailable().then(async function(t){if(chrome.runtime.onMessage.addListener(Xt),t){Ie=!0,e.getItem("sessionStarted")||(e.setItem("sessionId",n.uuid()),e.setItem("sessionStarted",!0));let t=await o.getStreamInfo()||{};if(_e=new C(t.responseHeaders),be=t.tabId,0===Object.keys(t).length){const e=new URLSearchParams(window.location.search),a=e.get("pdfurl");if(a){const n=new URL(a);if(n.protocol===Ve){se=e.get("pdffilename");if(await p.hasKey(`chrome-extension://${chrome.runtime.id}/${n.href}`)){const e=await p.getFileByHash(`chrome-extension://${chrome.runtime.id}/${n.href}`);A(),Te=!0,le=!0,_e=new C({"content-type":"application/pdf","content-length":e.byteLength}),t={mimeType:"application/pdf",originalUrl:`chrome-extension://${chrome.runtime.id}/${n.href}`,responseHeaders:_e},be=(await chrome.tabs.getCurrent())?.id}}}}let a=await qe({main_op:"check-is-google-print"});ve=a&&a.isGooglePrint,qe({main_op:"viewer-preview",startup_time:Date.now(),viewer:!0},()=>jt(t));const r=_e.getHeaderValue("content-length"),i=_e.getHeaderValue("accept-ranges"),s=i&&"bytes"===i.toLowerCase();r>0&&s&&qe({main_op:"setupWorkerOffscreen",pdfURL:t.originalUrl,pdfSize:+r,acceptRanges:s});e.getItem("firstOpenedTabId")||e.setItem("firstOpenedTabId",be)}else!function(){const e=new URL(window.location.href);if(e?.searchParams?.has("pdfurl")){const t=e.searchParams.get("pdfurl"),a=new URL(t);if(a?.searchParams.has("uuid")&&sessionStorage.getItem(a?.searchParams?.get("uuid"))){e.searchParams.set("pdfurl",sessionStorage.getItem(a?.searchParams?.get("uuid")));const t=Ke(document.location.search,"pdffilename");history.replaceState({},t,e)}}}(),await Ye(),zt(),Kt()}))}();