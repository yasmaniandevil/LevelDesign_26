/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{fileUtil as e}from"../viewer/fileUtil.js";import{getActiveTasks as t,setCloseRequested as r,wrapTask as n}from"./offscreenTaskManager.js";import{consoleLog as o,offscreenConfig as a}from"./offscrenUtil.js";import{saveGenAISidePanelRenderedHTML as i}from"./sidePanelCSSSRService.js";import{getRemoteExecutionTaskHandlers as s,handleRemoteExecutionEvent as c}from"./offscreenRemoteExecutionHandler.js";function d(e=5e3){let t,r;const n=new Promise((e,n)=>{t=e,r=n});return setTimeout(()=>{r(new Error("Operation timed out"))},e),{promise:n,resolve:t,reject:r}}let l;const m=new URLSearchParams(window.location.search).get("env")||"prod",f="iframe#user-subscription-iframe",u="iframe#floodgate-activity-iframe";let g,p,I;const w=new Map,b=(e,t)=>(t&&e.searchParams.append("anonUserUUID",t),e);function R(e){if(!window.document.querySelector(f)&&e.cdnURL){const t=window.document;let r;e.isCDNSignInEnabled?(r=new URL(e.signInURL),r.searchParams.append("main_op","fus")):(r=new URL(e.cdnURL),r.hash="#/susi/fetchUserSubscription"),r=b(r,e.anonUserUUID),l=r.toString();const n=t.createElement("iframe");n.setAttribute("src",l),n.setAttribute("id","user-subscription-iframe");t.getElementById("cdn-dnr-iframe").appendChild(n)}}function U(e,t="ajs-worker-iframe"){const r=window.document.getElementById(t),n=a[m].acrobat_viewer_origin;r&&r.contentWindow.postMessage(e,n)}function y(e){const t=window.document.querySelector(e);t?.remove()}function S(e){return new Promise(t=>{const{requestId:r}=e,n=window.document,o=`kw-ingestion-iframe-${r}`,i=n.getElementById(o);i&&i.remove();const s=function(e){const{requestId:t,collectionId:r,collectionName:n,tabId:o,pageTitle:i,extensionId:s,context:c}=e;return`${a[m]?.kw_ingestion_uri||a.prod.kw_ingestion_uri}?${new URLSearchParams({requestId:t,collectionId:r,collectionName:n||"",tabId:String(o),pageTitle:i||"Web page",extensionId:s,context:c||""}).toString()}#/kw-ingestion`}(e),c=n.createElement("iframe");c.setAttribute("src",s),c.setAttribute("id",o),c.style.display="none",c.onload=()=>{t(c)},c.onerror=()=>{t(null)};n.getElementById("cdn-dnr-iframe").appendChild(c)})}function h(e){return new Promise((t,r)=>{const n=window.document.querySelector(u);if(n){if("callFloodgateAPI"!==e.main_op)return void t(n);y(u)}if(e.iframeURL){const r=window.document,n=b(new URL(e.iframeURL),e.anonUserUUID);l=n;const o=r.createElement("iframe");o.setAttribute("src",l),o.setAttribute("id","floodgate-activity-iframe"),o.onload=()=>{t(o)},o.onerror=()=>{t(null)};r.getElementById("cdn-dnr-iframe").appendChild(o)}else r(new Error("signInURL is not provided"))})}function v(){0===t()?chrome.runtime.sendMessage({main_op:"closeOffscreenDocument",target:"background",tab:{id:""}}):setTimeout(v,100)}chrome.runtime.onMessage.addListener(function(e,t,r){if("offscreen"!==e.target)return!1;o("handleExtensionMessages",e);const c={getUserSubscriptions:n("getUserSubscriptions",R),getFileBuffer:n("getFileBuffer",async e=>{const t=await fetch(e.fileBufferBlob),r=await t.blob(),n=await new Response(r).arrayBuffer();U({main_op:"getFileBuffer",tabId:e.tabId,fileInfo:{fileBuffer:n,docLastOpenState:e.docLastOpenState}})}),closeIframeOfUserSubscription:n("closeIframeOfUserSubscription",()=>{y(f)}),getLinearizedRendition:n("getLinearizedRendition",e=>{U({main_op:"getLinearizedRendition",tabId:e.tabId,pdfURL:e.pdfURL,pdfSize:e.pdfSize,docLastOpenState:e.docLastOpenState})}),getFileSize:n("getFileSize",U),rrvLayerRemoved:n("rrvLayerRemoved",e=>{U({main_op:"rrvLayerRemoved",tabId:e.tabId})}),fgResponseFromCDN:n("fgResponseFromCDN",async e=>{e.main_op="handleFgResponseFromCDN";await h(e)&&U({main_op:"fgResponseFromCDN",response:e.response},"floodgate-activity-iframe")}),callFloodgateAPI:n("callFloodgateAPI",async e=>{e.main_op="callFloodgateAPI";await h(e)&&(g=d(),U({...e,main_op:"callFloodgateAPI"},"floodgate-activity-iframe"),g.promise.then(e=>{r({response:e})}).catch(()=>{r({response:void 0})}))}),getUserState:n("getUserState",async e=>{e.main_op="getUserState";var t;await(t=e,new Promise((e,r)=>{const n=window.document.querySelector("iframe#user-state-iframe");if(n)e(n);else if(t.iframeURL){const r=window.document,n=b(new URL(t.iframeURL),t.anonUserUUID);l=n;const o=r.createElement("iframe");o.setAttribute("src",l),o.setAttribute("id","user-state-iframe"),o.onload=()=>{e(o)},o.onerror=()=>{e(null)},r.getElementById("cdn-dnr-iframe").appendChild(o)}else r(new Error(`iframeURL in user state detection is not found for requestId: ${t.requestId}`))}))&&(p=d(),U({...e},"user-state-iframe"),p.promise.then(e=>{r({response:e})}).catch(()=>{r({response:!1})}))}),createIframeToLoadAjsWorker:n("createIframeToLoadAjsWorker",async e=>{const t=await(n=e,new Promise(e=>{const t=n.env||m,r=b(new URL(a[t].ajs_worker_uri),n.anonUserUUID);r.searchParams.append("callingApp",window.location.host),l=r.toString();const o=window.document.querySelector("iframe#ajs-worker-iframe");if(o)return void e(o);const i=n.rrvEnabled,s=window.document;if(i){const t=s.createElement("iframe");t.setAttribute("src",l),t.setAttribute("id","ajs-worker-iframe"),t.onload=()=>{e(t)},t.onerror=()=>{e(null)},s.getElementById("cdn-dnr-iframe").appendChild(t)}else e(null)}));var n;r({iframeLoaded:!!t})}),fetchImageBlobURL:n("fetchImageBlobURL",async e=>{try{const t=await fetch(e.imgUrl);if(!t.ok)return void r({error:`Response not in 2xx range. Status: ${t.status}`});const n=await t.blob(),o=URL.createObjectURL(new Blob([n],{type:n.type||"application/octet-stream"}));r({blobUrl:o})}catch(e){r({error:e.message})}}),revokeImageBlobURL:n("revokeImageBlobURL",e=>{URL.revokeObjectURL(e.blobUrl)}),callTargetAPI:n("callTargetAPI",async e=>{e.main_op="callTargetAPI";await new Promise(e=>{const t=window.document.querySelector("iframe#target-activity-iframe");if(t)return void e(t);const r=window.document,n=new URL(a[m].target_uri);n.searchParams.append("ao","false"),n.searchParams.append("la","true"),n.searchParams.append("callingApp",window.location.host),l=n;const o=r.createElement("iframe");o.setAttribute("src",l),o.setAttribute("id","target-activity-iframe"),o.onload=()=>{e(o)},o.onerror=()=>{e(null)},r.getElementById("cdn-dnr-iframe").appendChild(o)})&&(I=d(),U({...e,main_op:"callTargetAPI",mboxes:e.mboxes},"target-activity-iframe"),I.promise.then(e=>{r(e)}).catch(e=>{r({targetResponse:{},error:e.message})}))}),saveGenAIPanelRender:n("saveGenAIPanelRender",async e=>{await i(e)}),startKWIngestion:n("startKWIngestion",async e=>{let t=null;const{requestId:n,collectionId:o,collectionName:a,tabId:i,pageTitle:s,extensionId:c,context:l}=e;if(n)if(o)if(c)try{if(t=await S({requestId:n,collectionId:o,collectionName:a,tabId:i,pageTitle:s,extensionId:c,context:l}),!t)throw new Error("Failed to create ingestion iframe");const e=d(12e4);w.set(n,{deferred:e,iframe:t,tabId:i,collectionName:a});const m=await e.promise;w.delete(n),r({success:m.success,tabId:i,requestId:n,collectionName:m.collectionName||a,assetName:m.assetName,error:m.error,collectionId:o})}catch(e){const t=w.get(n);t?.iframe&&t.iframe.remove(),w.delete(n),r({success:!1,requestId:n,collectionId:o,error:e.message})}finally{t?.remove()}else r({success:!1,error:"extensionId is required for KW ingestion"});else r({success:!1,error:"collectionId is required for KW ingestion"});else r({success:!1,error:"requestId is required for KW ingestion"})}),...s()};return c[e.main_op]?((async()=>{await c[e.main_op](e,t,r)})(),!0):(console.warn(`Unexpected message type received: '${e.main_op}'.`),!1)}),window.addEventListener("message",function(t){try{c(t);const o=t.data;if(l)try{const e=new URL(l).origin;if(t.origin!==e)return}catch(e){return void console.error("[Offscreen] Failed to parse cdnURL for origin check:",l,e)}"lastUserGuid"===o.type&&(o.main_op="updateSignInStatus",delete o.type);const a={userSubscriptions:n("userSubscriptions",()=>{chrome.runtime.sendMessage({...o,target:"background",tab:{id:""}})}),updateSignInStatus:n("updateSignInStatus",()=>{chrome.runtime.sendMessage({...o,target:"background",tab:{id:""}})}),closeOffscreenDocument:()=>{r(!0),v()},getFileBufferRange:n("getFileBufferRange",async()=>{try{const t=await e.getFileBufferRange({url:o.pdfURL},o.range),r=await new Response(t.buffer).arrayBuffer();U({main_op:"acceptRangesBuffer",tabId:o.tabId,fileBuffer:r,rangeKey:`${o.range.start}-${o.range.end}`,fileSize:t.fileSize})}catch{U({main_op:"acceptRangesBuffer",tabId:o.tabId,fileBuffer:-1,rangeKey:`${o.range.start}-${o.range.end}`,fileSize:-1})}}),rapidRenditionResponse:n("rapidRenditionResponse",()=>{chrome.runtime.sendMessage({...o,target:"background",tab:{id:o.tabId}})}),rapidRenditionError:n("rapidRenditionError",()=>{chrome.runtime.sendMessage({...o,target:"background",tab:{id:o.tabId}})}),callFloodgateAPIResponse:n("callFloodgateAPIResponse",e=>{g.resolve(e.data)}),getUserStateResponse:n("getUserStateResponse",e=>{p.resolve(e.data)}),callTargetAPIResponse:n("callTargetAPIResponse",e=>{I.resolve(e.data)}),kwIngestionSuccess:n("kwIngestionSuccess",()=>{const{requestId:e,collectionName:t,assetName:r}=o,n=w.get(e);n&&n.deferred.resolve({success:!0,collectionName:t,assetName:r})}),kwIngestionError:n("kwIngestionError",()=>{const{requestId:e,error:t}=o,r=w.get(e);r&&r.deferred.resolve({success:!1,error:t})})};a[o?.main_op]&&a[o.main_op](t)}catch(e){console.error("Error in handling CDN event",e)}});