/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
jest.mock("../../common/analytics.js"),jest.mock("../../common/local-storage.js",()=>({dcLocalStorage:{init:jest.fn().mockResolvedValue(void 0),getItem:jest.fn(),setItem:jest.fn(),getAllItems:jest.fn().mockReturnValue({}),removeItem:jest.fn(),clear:jest.fn()}})),jest.mock("./content-util.js",()=>({util:{translateElements:jest.fn(),getTranslation:jest.fn(e=>e),addMainListener:jest.fn(),messageToMain:jest.fn()}})),jest.mock("../../common/util.js",()=>({updateExtUserState:jest.fn()})),jest.mock("../../common/constant.js",()=>({OptionsPageSource:{FRICTIONLESS_WIDGET_SETTINGS:"frictionless_widget_settings"}})),jest.mock("./offscreen/offscrenUtil.js",()=>({offscreenConfig:{prod:{acrobat_viewer_origin:"https://acrobat.adobe.com"},test:{acrobat_viewer_origin:"https://test.acrobat.adobe.com"},stage:{acrobat_viewer_origin:"https://stage.acrobat.adobe.com"}}}));import{events as e}from"../../common/analytics.js";import{dcLocalStorage as t}from"../../common/local-storage.js";import{util as o}from"./content-util.js";import{updateExtUserState as n}from"../../common/util.js";import{OptionsPageSource as s}from"../../common/constant.js";import{offscreenConfig as i}from"./offscreen/offscrenUtil.js";global.$=jest.fn(e=>({addClass:jest.fn().mockReturnThis(),removeClass:jest.fn().mockReturnThis(),hasClass:jest.fn().mockReturnValue(!1),on:jest.fn().mockReturnThis(),hover:jest.fn().mockReturnThis(),attr:jest.fn().mockReturnThis(),text:jest.fn().mockReturnThis(),css:jest.fn().mockReturnThis(),children:jest.fn().mockReturnValue([]),length:0,append:jest.fn().mockReturnThis(),prepend:jest.fn().mockReturnThis(),remove:jest.fn().mockReturnThis(),stop:jest.fn().mockReturnThis(),animate:jest.fn().mockReturnThis(),is:jest.fn().mockReturnValue(!1),empty:jest.fn().mockReturnThis()})),global.chrome={runtime:{id:"test-extension-id",openOptionsPage:jest.fn(),lastError:null},i18n:{getMessage:jest.fn(e=>e)}},global.SETTINGS={TEST_MODE:!1,IS_ERP_READER:!1},global.navigator={onLine:!0},global.window={location:{search:""},matchMedia:jest.fn(e=>({matches:!1,addEventListener:jest.fn(),addListener:jest.fn()})),addEventListener:jest.fn(),open:jest.fn()},global.document={body:{setAttribute:jest.fn(),style:{}},createElement:jest.fn(()=>({setAttribute:jest.fn(),classList:{add:jest.fn()},contentWindow:{postMessage:jest.fn()}}))},describe("SearchWidget",()=>{beforeEach(()=>{jest.clearAllMocks(),t.init.mockResolvedValue(void 0),t.getItem.mockImplementation(e=>"appLocale"===e?"en-US":"logAnalytics"===e?"true":null),t.getAllItems.mockReturnValue({}),o.translateElements.mockImplementation(()=>{}),o.getTranslation.mockImplementation(e=>e),o.addMainListener.mockImplementation(()=>{}),o.messageToMain.mockImplementation(()=>{}),window.location.search=""}),describe("SearchWidget Class",()=>{describe("initialization",()=>{it("should initialize with default state",()=>{expect(t.init).toBeDefined()}),it("should detect light theme by default",()=>{window.matchMedia=jest.fn(e=>({matches:!1,addEventListener:jest.fn()}));const e=window.matchMedia("(prefers-color-scheme: dark)").matches;expect(e?"dark":"light").toBe("light")}),it("should detect dark theme when system prefers dark",()=>{window.matchMedia=jest.fn(e=>({matches:"(prefers-color-scheme: dark)"===e,addEventListener:jest.fn()}));const e=window.matchMedia("(prefers-color-scheme: dark)").matches;expect(e?"dark":"light").toBe("dark")}),it("should apply theme to body element",()=>{document.body.setAttribute("data-theme","dark"),expect(document.body.setAttribute).toHaveBeenCalledWith("data-theme","dark")}),it("should setup event listeners on init",()=>{expect(o.addMainListener).toBeDefined(),expect(window.addEventListener).toBeDefined()})}),describe("theme handling",()=>{it("should update theme when system theme changes",()=>{const e=jest.fn(),t={matches:!0,addEventListener:jest.fn((t,o)=>{e.mockImplementation(o)})};window.matchMedia=jest.fn(()=>t),e({matches:!0}),expect(t.addEventListener).toBeDefined()}),it("should send theme change message to iframe",()=>{const e={contentWindow:{postMessage:jest.fn()}},t=new URL("https://example.com/frictionless");e.contentWindow.postMessage({type:"theme-change",theme:"dark"},t.origin),expect(e.contentWindow.postMessage).toHaveBeenCalledWith({type:"theme-change",theme:"dark"},"https://example.com")})}),describe("getAcrobatOnlineUrl",()=>{it("should return prod URL by default",()=>{const e=`${i.prod.acrobat_viewer_origin}?x_api_client_location=frictionless:header_redirect&x_api_client_id=dc-chrome-extension`;expect(e).toBe("https://acrobat.adobe.com?x_api_client_location=frictionless:header_redirect&x_api_client_id=dc-chrome-extension")}),it("should return test URL when env is test",()=>{const e=`${i.test.acrobat_viewer_origin}?x_api_client_location=frictionless:header_redirect&x_api_client_id=dc-chrome-extension`;expect(e).toBe("https://test.acrobat.adobe.com?x_api_client_location=frictionless:header_redirect&x_api_client_id=dc-chrome-extension")})}),describe("message handling",()=>{it("should validate messages with matching tabId",()=>{expect(true).toBe(!0)}),it("should reject messages with non-matching tabId",()=>{const e=123,t=456;expect(e&&t&&t!==e).toBe(!0)}),it("should accept messages without panel_op as invalid",()=>{expect(void 0!=={tabId:123}.panel_op).toBe(!1)})}),describe("request processing",()=>{it("should handle load-frictionless operation",()=>{const e="https://example.com";expect("load-frictionless").toBe("load-frictionless"),expect(e).toBeDefined()}),it("should handle show-frictionless-error operation",()=>{const e="Error Title",t="Error Description";expect("show-frictionless-error").toBe("show-frictionless-error"),expect(e).toBeDefined(),expect(t).toBeDefined()}),it("should handle clear-frictionless-error operation",()=>{expect("clear-frictionless-error").toBe("clear-frictionless-error")}),it("should handle send-external-msg operation",()=>{const e={type:"test",payload:"data"};expect("send-external-msg").toBe("send-external-msg"),expect(e).toBeDefined()})}),describe("openSettingsPage",()=>{it("should set optionsPageSource in localStorage",()=>{t.setItem("optionsPageSource",s.FRICTIONLESS_WIDGET_SETTINGS),expect(t.setItem).toHaveBeenCalledWith("optionsPageSource",s.FRICTIONLESS_WIDGET_SETTINGS)}),it("should call chrome.runtime.openOptionsPage",()=>{chrome.runtime.openOptionsPage(jest.fn()),expect(chrome.runtime.openOptionsPage).toHaveBeenCalled()})}),describe("dismiss",()=>{it("should hide body when extension context is invalid",()=>{chrome.runtime.id=null,document.body.style.display="none",expect(document.body.style.display).toBe("none")}),it("should send dismiss message when extension context is valid",()=>{chrome.runtime.id="test-extension-id";const e={forced_cancel:!0,content_op:"dismiss",main_op:"relay_to_content"};o.messageToMain(e),expect(o.messageToMain).toHaveBeenCalledWith(e)})})}),describe("MessageHandler Class",()=>{describe("cleanMessage",()=>{it("should remove specific properties from message",()=>{const e={content_op:"test",click_context:"context",newUI:!0,analytics:{},is_viewer:!0,reload_in_native:!1,authenticatedPDF:!0,keepThis:"value"};delete e.click_context,delete e.newUI,delete e.analytics,delete e.is_viewer,delete e.reload_in_native,!0===e.authenticatedPDF&&delete e.authenticatedPDF,expect(e).toEqual({content_op:"test",keepThis:"value"})}),it("should keep authenticatedPDF if not true",()=>{const e={authenticatedPDF:!1};!0===e.authenticatedPDF&&delete e.authenticatedPDF,expect(e.authenticatedPDF).toBe(!1)})}),describe("handleExternalMessage",()=>{it("should process upload-error events",()=>{const e={event:"upload-error",error:"Upload failed",file:{name:"test.pdf"}},t=e.file.name;expect(t).toBe("test.pdf"),expect(e.event).toBe("upload-error")}),it("should format error message with file name",()=>{o.getTranslation=jest.fn(e=>"is an unsupported format");const e=`"test.pdf" ${o.getTranslation("frictionlessWidgetErrorUnsupportedFormat")}`;expect(e).toBe('"test.pdf" is an unsupported format')}),it("should use default error message when file name is not available",()=>{o.getTranslation=jest.fn(e=>"Upload failed");expect("Upload failed").toBe("Upload failed")})})}),describe("UIManager Class",()=>{describe("timer management",()=>{it("should clear timer when clearTimer is called",()=>{let e=setTimeout(()=>{},1e3);clearTimeout(e),e=null,expect(e).toBeNull()}),it("should use PDF_MENU_TIME for PDF files",()=>{expect(3e3).toBe(3e3)}),it("should use MENU_TIME for non-PDF files",()=>{expect(1500).toBe(1500)})}),describe("UI state management",()=>{it("should prepare widget screen correctly",()=>{const e=$(".acrobatMainDiv"),t=$(".actions");e.removeClass("home-screen"),e.addClass("widget-screen-main-div"),t.addClass("hidden"),expect(e.removeClass).toHaveBeenCalledWith("home-screen"),expect(e.addClass).toHaveBeenCalledWith("widget-screen-main-div"),expect(t.addClass).toHaveBeenCalledWith("hidden")}),it("should show iframe correctly",()=>{const e=document.createElement("iframe"),t=$(".frictionless-container"),o=$(".frictionless-host"),n=$(".frictionless-loader");t.removeClass("hidden").append(e),o.removeClass("hidden"),n.addClass("hidden"),expect(t.removeClass).toHaveBeenCalledWith("hidden"),expect(o.removeClass).toHaveBeenCalledWith("hidden"),expect(n.addClass).toHaveBeenCalledWith("hidden")}),it("should show error with title and message",()=>{const e=$(".error-title"),t=$(".error-details"),o=$(".frictionless-error");e.text("Error Title"),t.text("Error Description"),o.removeClass("hidden"),expect(e.text).toHaveBeenCalledWith("Error Title"),expect(t.text).toHaveBeenCalledWith("Error Description"),expect(o.removeClass).toHaveBeenCalledWith("hidden")}),it("should hide error",()=>{const e=$(".frictionless-error");e.addClass("hidden"),expect(e.addClass).toHaveBeenCalledWith("hidden")})}),describe("offline UI",()=>{it("should create offline UI with correct structure",()=>{o.getTranslation=jest.fn(e=>"frictionlessWidgetOfflineTitle"===e?"No Internet Connection":"frictionlessWidgetOfflineMessage"===e?"Please check your connection":e);const e=`\n                    <div class="frictionless-offline-ui">\n                        <div class="offline-icon">\n                            <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <path d="M59.5 35C59.5 35 59.5 34.875 59.5 34.75C59.5 26.875 53.125 20.5 45.25 20.5C39.125 20.5 33.875 24.5 31.75 30C30.5 29.5 29.125 29.25 27.75 29.25C21.875 29.25 17 34 17 40C17 45.875 21.875 50.75 27.75 50.75H58.5C62.625 50.75 66 47.375 66 43.25C66 39.25 62.875 35.875 59 35.5" stroke="#6E6E6E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                <path d="M40.5 38.5V52.5" stroke="#6E6E6E" stroke-width="2" stroke-linecap="round"/>\n                                <circle cx="40.5" cy="58.5" r="1.5" fill="#6E6E6E"/>\n                            </svg>\n                        </div>\n                        <div class="offline-title">${o.getTranslation("frictionlessWidgetOfflineTitle")}</div>\n                        <div class="offline-message">${o.getTranslation("frictionlessWidgetOfflineMessage")}</div>\n                    </div>\n                `;expect(e).toContain("frictionless-offline-ui"),expect(e).toContain("No Internet Connection"),expect(e).toContain("Please check your connection")})}),describe("error UI",()=>{it("should create error UI with retry button",()=>{o.getTranslation=jest.fn(e=>"frictionlessWidgetRetryButton"===e?"Retry":e);const e=`\n                    <div class="frictionless-error-ui">\n                        <div class="error-icon">\n                            <svg width="48" height="48" viewBox="0 0 48 48" fill="none">\n                                <circle cx="24" cy="24" r="20" stroke="#E34850" stroke-width="2"/>\n                                <line x1="24" y1="16" x2="24" y2="28" stroke="#E34850" stroke-width="2" stroke-linecap="round"/>\n                                <circle cx="24" cy="34" r="1.5" fill="#E34850"/>\n                            </svg>\n                        </div>\n                        <div class="error-ui-title">Error Title</div>\n                        <div class="error-ui-message">Error Message</div>\n                        <button class="error-retry-btn">${o.getTranslation("frictionlessWidgetRetryButton")}</button>\n                    </div>\n                `;expect(e).toContain("frictionless-error-ui"),expect(e).toContain("error-retry-btn"),expect(e).toContain("Retry")})})}),describe("IframeManager Class",()=>{describe("buildIframeUrl",()=>{it("should throw error when frictionless_uri is missing",()=>{const e={pdf_action:"convert"};expect(()=>{if(!e.frictionless_uri)throw new Error("frictionless_uri is required to build iframe URL")}).toThrow("frictionless_uri is required")}),it("should throw error when pdf_action is missing",()=>{const e={frictionless_uri:"https://example.com"};expect(()=>{if(!e.pdf_action)throw new Error("pdf_action is required to build iframe URL")}).toThrow("pdf_action is required")}),it("should build URL with hash path correctly",()=>{const e="convert";let t=new URL("https://example.com#/tools").hash.substring(1);t.endsWith("/")||(t+="/"),t+=e,expect(t).toBe("/tools/convert")}),it("should build URL with pathname correctly",()=>{const e="convert";let t=new URL("https://example.com/tools").pathname;t.endsWith("/")||(t+="/"),t+=e,expect(t).toBe("/tools/convert")}),it("should include correct query parameters",()=>{const e={workflow:"search",dropzone2:"true",useExtensionStorage:!0,locale:"en-US",showHeader:!1,showFooter:!0,theme:"light"},t=new URLSearchParams;Object.keys(e).forEach(o=>{t.append(o,e[o])}),expect(t.get("workflow")).toBe("search"),expect(t.get("dropzone2")).toBe("true"),expect(t.get("useExtensionStorage")).toBe("true"),expect(t.get("theme")).toBe("light")}),it("should add analytics disable parameter when logAnalytics is false",()=>{t.getItem=jest.fn(e=>"logAnalytics"===e?"false":null);const e=new URLSearchParams;"false"===t.getItem("logAnalytics")&&e.append("app!analytics","disable"),expect(e.get("app!analytics")).toBe("disable")}),it("should add versions parameter for test/stage env",()=>{const e=new URLSearchParams;e.append("app!versions","latest"),expect(e.get("app!versions")).toBe("latest")})}),describe("iframe events",()=>{it("should handle iframe load event",()=>{const e={onload:null,contentWindow:{postMessage:jest.fn()}};e.onload=jest.fn(),e.onload(),expect(e.onload).toHaveBeenCalled()}),it("should handle iframe error event",()=>{const e={onerror:null};e.onerror=jest.fn(),e.onerror(new Error("Load failed")),expect(e.onerror).toHaveBeenCalled()}),it("should send valid message to iframe after load",()=>{const e={contentWindow:{postMessage:jest.fn()}},t=new URL("https://example.com");e.contentWindow.postMessage({valid:!0},t.origin),expect(e.contentWindow.postMessage).toHaveBeenCalledWith({valid:!0},"https://example.com")})}),describe("getLocale",()=>{it("should return appLocale if available",()=>{expect("en-US").toBe("en-US")}),it("should fallback to chrome.i18n locale",()=>{chrome.i18n.getMessage=jest.fn(()=>"fr-FR");const e=chrome.i18n.getMessage("@@ui_locale");expect(e).toBe("fr-FR")})})}),describe("AnalyticsManager Class",()=>{it("should track event with params",()=>{const e={main_op:"analytics",analytics:[["test_event",{key:"value"}]]};o.messageToMain(e),expect(o.messageToMain).toHaveBeenCalledWith(e)}),it("should track event without params",()=>{const e={main_op:"analytics",analytics:[["test_event",{}]]};o.messageToMain(e),expect(o.messageToMain).toHaveBeenCalledWith(e)})}),describe("OfflineManager Class",()=>{describe("offline detection",()=>{it("should detect offline state",()=>{navigator.onLine=!1,expect(navigator.onLine).toBe(!1)}),it("should detect online state",()=>{navigator.onLine=!0,expect(navigator.onLine).toBe(!0)})}),describe("handleOffline",()=>{it("should store pending request when going offline",()=>{const e={frictionless_uri:"https://example.com",pdf_action:"convert"},t={...e};expect(t).toEqual(e)}),it("should show offline UI when iframe is present",()=>{const e=$(".frictionless-iframe");e.length=1,expect(e.length).toBeGreaterThan(0)})}),describe("handleOnline",()=>{it("should restore online state",()=>{navigator.onLine=!0,expect(navigator.onLine).toBe(!0)}),it("should retry pending request when coming online",()=>{expect("https://example.com").toBeDefined()})}),describe("retryLoadContent",()=>{it("should not retry when offline",()=>{navigator.onLine=!1,navigator.onLine||expect(navigator.onLine).toBe(!1)}),it("should retry when online and pending request exists",()=>{navigator.onLine=!0;const e={frictionless_uri:"https://example.com",pdf_action:"convert"};navigator.onLine&&e&&expect(e.frictionless_uri).toBeDefined()}),it("should clean up UI elements before retry",()=>{const e=$(".frictionless-loader"),t=$(".frictionless-offline-ui"),o=$(".frictionless-error-ui"),n=$(".frictionless-iframe"),s=$(".frictionless-container");e.removeClass("hidden"),t.remove(),o.remove(),n.remove(),s.empty(),expect(e.removeClass).toHaveBeenCalledWith("hidden"),expect(t.remove).toHaveBeenCalled(),expect(o.remove).toHaveBeenCalled(),expect(n.remove).toHaveBeenCalled(),expect(s.empty).toHaveBeenCalled()})})}),describe("Integration scenarios",()=>{it("should handle complete frictionless workflow",()=>{const e="https://example.com",t="convert";expect("load-frictionless").toBe("load-frictionless"),expect(e).toBeDefined(),expect(t).toBeDefined()}),it("should handle error flow",()=>{const e="Upload Failed";expect("show-frictionless-error").toBe("show-frictionless-error"),expect(e).toBeDefined()}),it("should handle offline to online transition",()=>{navigator.onLine=!1;expect(navigator.onLine).toBe(!1),expect({frictionless_uri:"https://example.com",pdf_action:"convert"}).toBeDefined(),navigator.onLine=!0,expect(navigator.onLine).toBe(!0)}),it("should handle theme change during active session",()=>{document.body.setAttribute("data-theme","light"),expect(document.body.setAttribute).toHaveBeenCalledWith("data-theme","light"),document.body.setAttribute("data-theme","dark"),expect(document.body.setAttribute).toHaveBeenCalledWith("data-theme","dark")})})});