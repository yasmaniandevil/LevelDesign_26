/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{util as e}from"./util.js";import{common as t}from"./common.js";import{analytics as a,events as s}from"../common/analytics.js";import{Proxy as r}from"./proxy.js";import{floodgate as i}from"./floodgate.js";import{authProvider as o}from"./auth-provider.js";import{sharepointModule as n}from"./sharepoint-module.js";import{privateApi as l}from"./private-api.js";import{gmailConvertToPdfInit as c}from"./gmail-convert-to-pdf-module.js";import{gmailDocumentStartInit as d}from"./gmail-document-start-module.js";import{gmailCompressPDFInit as p}from"./gmail-compress-pdf-module.js";import{viewerModuleUtils as u}from"./viewer-module-utils.js";import{SETTINGS as g}from"./settings.js";import{dcLocalStorage as m,dcSessionStorage as h}from"../common/local-storage.js";import{OFFSCREEN_DOCUMENT_PATH as b}from"../common/constant.js";import{CACHE_PURGE_SCHEME as f}from"./constant.js";import{closeExpress as v,getModalSessionId as I,launchExpress as w,removeSessionFromUnloadedExpressSessions as T}from"./express.js";import{isExpressContextMenuEnabled as E,toggleExpressTouchpoints as F}from"./express/express-context-menu.js";import{isExpressMenuEnabled as x}from"./express/express-enablement.js";import{loggingApi as _}from"../common/loggingApi.js";import{resetDVSessionCount as P,getDVSessionCountString as S,fetchDefaultViewershipConfig as C}from"../content_scripts/utils/util.js";import{sendPingEventHandler as k,checkForImsSidCookie as D}from"../common/util.js";import{getAccountSpecificRedirectUrl as M}from"./gsuite/util.js";import{checkForBlockedDomain as L,handleAddWebpageToProjectAction as R,isAddWebpageToProjectEnabled as y,toggleAddWebpageToProjectContextMenu as N}from"./add-webpage-to-project.js";import{getActiveExperimentAnalyticsArray as O,setExperimentCodeForAnalytics as A,removeExperimentCodeForAnalytics as V}from"../common/experimentUtils.js";import{initTemporaryURLBufferIndexedDB as U}from"../common/temporaryURLBufferIndexDB.js";import{linkedinInit as G}from"./linkedin-module.js";import{createPerfTracker as W}from"./perf-tracker.js";import{googleQueryAnalyzer as B}from"./googleQueryAnalyzer.js";import{executeDirectVerb as H}from"./direct-verb-utils.js";import{implicitDefaultViewershipInit as j}from"./implicit-default-viewership-module.js";import{googleDocsInit as J}from"./gsuite/google-docs-module.js";let $=null,z={},q={};class K{constructor(){this.tabs={},this.version=-1,this.NMHConnStatus=!0,this.activeTab=void 0,this.isAllowedLocalFileAccess=!1,this.pdfConvertPerfTrackers=new Map}proxy(...e){return r.proxy.bind(this)(...e)}LOG(...e){return t.LOG(...e)}setIsAllowedLocalFileAccess(e){const t=m.getItem("isAllowedLocalFileAccess");this.isAllowedLocalFileAccess=e,m.setItem("isAllowedLocalFileAccess",e),e&&!0!==t&&"true"!==m.getItem("pdfViewer")&&(m.setItem("pdfViewer","true"),l.setViewerState("enabled"))}registerHandlers(t){q=e.extend(q,t)}registerModule(e,t){z[e]=t}getModule(e){return z[e]}getTabLastMessage(e){return this.tabs[e]}updateTabMessage(t,a){this.tabs[t]?this.tabs[t]=e.extend(this.tabs[t],a):this.tabs[t]=a}setNMHConnectionStatus(e){this.NMHConnStatus=e}legacyShim(){return this.version<=1}setVersion(e){this.version=e}resetPersistPrefCount(){m.setItem("persist-menu-closed",0)}incrementPersistPrefCount(e){let t=m.getItem("persist-menu-closed");t<10&&"false"!==m.getItem("always-show-pdf-menu")&&(t++,m.setItem("persist-menu-closed",t)),t>=10&&(m.setItem("always-show-pdf-menu","false"),e||a.event(a.e.PERSIST_PDF_OPENPDF_PREF_OFF))}diffDays(e,t){const a=Math.abs(e-t);return Math.floor(a/864e5)}enableReprompt(){if(!m.getItem("repromptCount")||parseInt(m.getItem("repromptCount"))<g.REPROMPT_DORMANT_USER_ATTEMPTS){let e=Date.now(),t=m.getItem("fteDenied")&&10===parseInt(m.getItem("fteDenied")),a=m.getItem("pdfViewer"),s=g.VIEWER_ENABLED,r=!m.getItem("reprompt-user-timestamp"),i=m.getItem("repromptCount")?m.getItem("repromptCount"):0,o=m.getItem("reprompt-user-timestamp")&&this.diffDays(e,m.getItem("reprompt-user-timestamp"))>=g.REPROMPT_DORMANT_USER_TIME_INTERVALS[i];return s&&!a&&t&&(o||r)}return!1}async isEnablePersistMenu(e){if(e&&"mime-native"===e.viewer&&(g.IS_ERP_READER||g.IS_READER)&&m.getItem("openInAcrobatEnable")&&"admin"!==m.getItem("installSource"))return!1;if(await l.isInstalledViaUpsell()&&!m.getItem("pdfViewer"))return!1;if(e&&"mime"===e.viewer)return!1;if(g.VIEWER_ENABLED&&(g.IS_ACROBAT&&!g.VIEWER_ENABLED_FOR_ACROBAT||m.getItem("fteDenied")||"true"!==m.getItem("pdfViewer")||this.resetPersistPrefCount()),g.REPROMPT_DORMANT_USER&&this.enableReprompt()){let e=m.getItem("repromptCount")?parseInt(m.getItem("repromptCount"))+1:1;m.setItem("repromptCount",e),m.setItem("fteDenied",9),m.setItem("persist-menu-closed",9),m.removeItem("always-show-pdf-menu")}return"false"!==m.getItem("always-show-pdf-menu")&&(m.getItem("persist-menu-closed")<10?!(this.legacyShim()&&(!g.VIEWER_ENABLED||m.getItem("pdfViewer"))):"true"===m.getItem("always-show-pdf-menu")&&(this.resetPersistPrefCount(),!0))}isViewerEnabled(){return!(!g.VIEWER_ENABLED||g.IS_ACROBAT&&!g.VIEWER_ENABLED_FOR_ACROBAT||"true"!==m.getItem("pdfViewer"))}async relayMessageToContentScript(e,t,a){if(1==e.newUI&&"dismiss"===e.content_op)e.persist=!1,null!=e.tabId&&(this.tabs[e.tabId].persist=!1),this.incrementPersistPrefCount(e.fteClosed);else if(1==e.newUI&&"pdf_menu"===e.panel_op){await this.isEnablePersistMenu(e)?null!=e.tabId&&(this.tabs[e.tabId].persist=!0):e.persist=!1,this.resetPersistPrefCount()}this.sendMessage(e,t,a)}isViewerEnabledOrFromExternalTouchPoint(e){return this.isViewerEnabled()||u.isPDFURLFromExternalTouchPoint(e)}sendViewerStartupInformation(t,s,r){if(this.isViewerEnabledOrFromExternalTouchPoint(s)&&e.isViewerURL(s)||t.mimeHandled){if("viewer-startup"===t.main_op&&(delete t.main_op,t.isFrictionlessEnabled=g.FRICTIONLESS_ENABLED,t.isSharePointEnabled=n.isFeatureEnabled(),t.isSharePointURL=!1),t.isSharePointEnabled)try{let e=new URL(s).searchParams.get("pdfurl");t.isSharePointURL=n.isAllowListedSharePointURL(e)}catch(e){}t.mimeHandled&&(a.event(a.e.VIEWER_EXTN_PDF_OPENED,{tabURL:s}),s.startsWith("file://")?a.event(a.e.VIEWER_PDF_LOCAL_FILE):a.event(a.e.VIEWER_PDF_OPENED_MIME_HANDLER)),t.isFillnSignEnabled=g.FILL_N_SIGN_ENABLED,i.getFeaturesAndGroups().then(({featureFlags:e})=>{t.featureFlags=e,r(t)}).catch(a=>{r(t),e.consoleLog(a)})}}async sendViewerPreviewInformation(e,t){this.sendMessage({dend_op:"viewer-type",viewer:"mime",tabId:e.tabId,is_pdf:!0}),await u.updateVariables(this.version),t()}handlerTabs(e){e&&e.tabId&&"outermost_frame"===e.frameType&&communicate.filterLoadedTabs(e)}async filterLoadedTabs(e){const t=await l.isMimeHandlerAvailable(),a=m.getItem("loadedTabsInfo");if(a&&a.tabsInfo){const s=a.tabsInfo||[];if(t){if(s.includes(e.tabId)){const t=s.filter(t=>t!==e.tabId);t.length>0?m.setItem("loadedTabsInfo",{tabsInfo:t}):m.removeItem("loadedTabsInfo")}}else{-1!==s.findIndex(t=>t.id==e.tabId)&&this.getCurrentTabInfoAndUpdateLoadedTabs()}}}async getCurrentTabInfoAndUpdateLoadedTabs(){const e=await l.isMimeHandlerAvailable(),t=m.getItem("loadedTabsInfo"),a=t?.tabsInfo;if(!e&&a){const e=`chrome-extension://${chrome.runtime.id}/*`;let t=await chrome.tabs.query({url:e});t=t.filter(e=>e.url!==chrome.runtime.getURL("browser/js/local-fte.html")),t.length?m.setItem("loadedTabsInfo",{tabsInfo:t}):m.removeItem("loadedTabsInfo")}}async handleFrictionlessStartup(e,t){if(!g.FRICTIONLESS_ENABLED)return void t({pdf_action:null});if(e.show_frictionless=!0,e.startup_time){const t=this.getModule("frictionlessHandler");if(t){t.startNewInteraction(e.tabId).startup_time=e.startup_time}}const a=g.TEST_MODE||e.show_frictionless,s="false"!==m.getItem("always-show-pdftools"),r="v2"===this.tabs[e.tabId]?.variant,i=!0===this.tabs[e.tabId]?.suppress_frictionless,o=r||!i,n=B&&B.isGoogleQuery(e),l={pdf_action:null};if(!(a&&s&&o&&n))return void t(l);const c=B.getSearchQuery(e);c?B.mapQueryStringToAction(c,e,a=>{a&&a.pdf_action&&e.tabId&&(this.updateTabMessage(e.tabId,a),"v2"===a.variant&&this.tabs[e.tabId]&&(delete this.tabs[e.tabId].content_op,delete this.tabs[e.tabId].forced_cancel,delete this.tabs[e.tabId].suppress_frictionless)),t(a||l)}):t(l)}detectSenderType(e){if(!e)return"unknown";if(e.id===chrome.runtime.id&&!e.tab&&!e.url)return"service-worker";const t=`chrome-extension://${chrome.runtime.id}/${b}`;return e.url===t?"offscreen":e.url&&e.url.startsWith(`chrome-extension://${chrome.runtime.id}/`)?"web-accessible-resource":!e.tab||e.url&&e.url.startsWith(`chrome-extension://${chrome.runtime.id}/`)?e.id&&e.id!==chrome.runtime.id?"external":"unknown":"content-script"}handler(r,n,g){var E,x=this;if(!r)return;this.dump(r,"Communicate Handler receive: ");const P=this.detectSenderType(n);if("offscreen"===r.target&&"content-script"===P)return;if(r.mimeHandled){var S={id:r.tabId,url:r.url};n.tab=S}const C=`chrome-extension://${chrome.runtime.id}/browser/js/popup.html`,M=`chrome-extension://${chrome.runtime.id}/${b}`,U=`chrome-extension://${chrome.runtime.id}/resources/SidePanel/index.html`,W=n.url?.split("?")[0]||n.tab?.url;if([C,M,U].includes(W)&&(n.tab=r.tab,delete r.tab),n&&n.tab&&(r.tabId=n.tab.id,this.activeTab||(this.activeTab=n.tab.id),r.main_op)){switch(E=r.main_op,delete r.main_op,a.logBrowserAnalytics(r),this.tabs[r.tabId]&&this.tabs[r.tabId].suppress_frictionless&&(r.suppress_frictionless=this.tabs[r.tabId].suppress_frictionless),r.version=this.version,r.NMHConnStatus=this.NMHConnStatus,E){case"frictionless-startup":this.handleFrictionlessStartup(r,g);break;case"setupOffscreenDocument":const P=`${b}?env=${t.getEnv()}`;e.setupOffscreenDocument(P),g();break;case"relayOffscreenMessageToContentScript":delete r.main_op,delete r.target,chrome.tabs.sendMessage(r.tabId,{...r});break;case"embedded-pdf-touch-point-added":chrome.tabs.sendMessage(r.tabId,{type:"added-embedded-pdf-touch-point",frameId:r?.frameId,position:r?.position}),chrome.tabs.sendMessage(r.tabId,{action:"reRenderShowOneChild"});break;case"reRenderShowOneChild":chrome.tabs.sendMessage(r.tabId,{action:"reRenderShowOneChild"});break;case"hideAIMarkerPopup":chrome.tabs.sendMessage(r.tabId,{content_op:"hideAIMarkerPopup",href:r.href,showMarkerInSession:r.showMarkerInSession});break;case"updateIframeHeight":chrome.tabs.sendMessage(r.tabId,{content_op:"updateIframeHeight",href:r.href,menuOpen:r.menuOpen});break;case"getEnvironment":g({environment:t.getEnv()});break;case"downloadAssetFromUrl":fetch(r.url).then(e=>{if(!e.ok)throw new Error(`Response not in 2xx range. Status: ${e.status}`);return e.blob()}).then(e=>{const t=new FileReader;t.readAsDataURL(e),t.onloadend=()=>{const e=t.result;g({base64data:e})}}).catch(e=>{console.error("Error downloading asset from url:",e)});break;case"validateOverlappingElements":chrome.tabs.sendMessage(r.tabId,{content_op:"validateOverlappingElements",elementRect:r.elementRect,link:r.link});break;case"outlook-touch-point-added":chrome.tabs.sendMessage(r.tabId,{action:"reRenderShowOneChild"});break;case"linkedin-touch-point-added":chrome.tabs.sendMessage(r.tabId,{type:"added-linkedin-pdf-touch-point",frameId:r?.frameId,position:r?.position}),chrome.tabs.sendMessage(r.tabId,{action:"reRenderShowOneChild"});break;case"fte-eligible-linkedin-chat-touch-point-added":chrome.tabs.sendMessage(r.tabId,{type:"added-linkedin-chat-pdf-touch-point"}),chrome.tabs.sendMessage(r.tabId,{action:"reRenderShowOneChild"});break;case"log-error":_.error(r.log);break;case"log-info":_.info(r.log);break;case"resolve-analytics-event":if(r.eventKey){const e=s[r.eventKey];g({eventValue:e||null})}else g({eventValue:null});break;case"getEnv":const S=t.getEnv();g(S);break;case"update_env":t.updateEnvironment(r);break;case"getVersion":g(this.version);break;case"getSignInStatus":D().then(e=>{g({signInStatus:e})}).catch(()=>{g({signInStatus:!1})});break;case"isEdge":g(e.isEdge());break;case"getFrictionlessLocale":g(e.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale")));break;case"embedded-pdf-touch-point-fte":chrome.tabs.sendMessage(r.tabId,{type:"add-fte-for-embedded-pdf-touch-point"},{frameId:r.frameId});break;case"outlook-fte-render":chrome.tabs.sendMessage(r.tabId,{type:"add-fte-for-outlook-touch-point"});break;case"linkedin-fte-render":chrome.tabs.sendMessage(r.tabId,{type:"add-fte-for-linkedin-touch-point"},{frameId:r.frameId});break;case"linkedin-chat-fte-render":chrome.tabs.sendMessage(r.tabId,{type:"add-fte-for-linkedin-chat-touch-point"});break;case"changeDefaultViewershipForSurface":this.handleChangeDefaultViewershipForSurface(r,n);break;case"acrobat-gmail-fte-config":case"acrobat-gmail-convert-to-pdf-verb-fte-config":this.gmailFteConfigUpdated(r);break;case"reRenderShowOneChild":chrome.tabs.sendMessage(r.tabId,{action:"reRenderShowOneChild"});break;case"setExperimentCode":A(r.experimentCode);break;case"removeExperimentCode":V(r.experimentCode);break;case"get-express-modal-session-id":g({sessionId:I(r.tabId)});break;case"express-init":this.expressInit(g);break;case"whatsapp-express-init":this.whatsappExpressInit(g);break;case"gmail-express-init":this.gmailExpressInit(g);break;case"google-image-preview-express-init":this.googleImagePreviewExpressInit(g);break;case"gdrive-express-init":this.gdriveExpressInit(g);break;case"google-chat-express-init":this.googleChatExpressInit(g);break;case"facebook-express-init":this.facebookExpressInit(g);break;case"chatgpt-express-init":this.chatgptExpressInit(g);break;case"chatgpt-init":this.chatgptInit(g);break;case"gemini-express-init":this.geminiExpressInit(g);break;case"gmail-init":this.gmailInit(g);break;case"gmail-document-start-init":d(g);break;case"google_docs_init":J(r,g,this.version);break;case"google_docs_touch_point_added":chrome.tabs.sendMessage(r.tabId,{type:"acrobat-gdocs-touch-point-added"}),chrome.tabs.sendMessage(r.tabId,{action:"reRenderShowOneChild"});break;case"gmail-convert-to-pdf-init":c(g);break;case"gmail-compress-pdf-init":p(g);break;case"implicit-default-viewership-init":j(r?.surfaceId,g);break;case"acrobat-gdrive-fte-state":this.gdriveFteStateUpdated(r);break;case"gdrive-init":this.gdriveInit(g,r.tabId);break;case"outlook-init":this.outlookInit(g);break;case"outlook-express-init":this.outlookExpressInit(g);break;case"linkedin-init":G(this.version,n).then(g);break;case"embedded-pdf-touch-point-config":this.embeddedPDFTouchPointConfig(r,g,n);break;case"gdrive-download-init":this.gDriveDownloadPageInit(g);break;case"viewer-preview":return this.sendViewerPreviewInformation(r,g),!0;case"get-features&groups":return i.getFeaturesAndGroups(r.cachePurge).then(e=>g(e)),!0;case"getFloodgateFlag":i.hasFlag(r.flag,r.cachePurge).then(g);break;case"getFloodgateMeta":g(i.getFeatureMeta(r.flag));break;case"isUserSignedIn":o.isUserSignedIn().then(g);const C=m.getItem("imsConsciousTabs")||[];C.includes(r.tabId)||(C.push(r.tabId),m.setItem("imsConsciousTabs",C));break;case"openRecentFileLink":let M=r.recent_file_url;new URLSearchParams(r.recent_file_url)?.has("acrobatPromotionSource")&&(M=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(r.recent_file_url)+"&pdffilename="+encodeURIComponent(r.file_name)),e.createTab(M);break;case"openOnboardingTutorialFile":let U=new URL(r.onboardingDemoFileURL);U.searchParams.set("blob-uri",r.blobParam),U.searchParams.set("returnURL",r.pdfURL),U.searchParams.set("returnTabId",r.tabId),U=U.toString(),e.createTab(U);break;case"returnToYourFile":const W=`chrome-extension://${chrome.runtime.id}/*`;chrome.tabs.query({url:W},t=>{let a=t?.find(e=>e.id==r.returnTabId);a?chrome.tabs.update(a.id,{active:!0}):e.createTab(r.returnURL)});break;case"openLocalFileThoughFilePicker":e.createTab("").then(({id:e})=>{const t=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(r.fileURL)+"&pdffilename="+encodeURIComponent(r.file_name)+(r.openGenAIAssistantPanel?"&ogap="+r.openGenAIAssistantPanel:"")+"&tabId="+e+(r.openLocalFileSource?"&olfs="+r.openLocalFileSource:"");chrome.tabs.update(e,{url:t})});break;case"viewer-type":setTimeout(()=>{this.sendMessage({dend_op:"viewer-type",viewer:r.viewer,tabId:r.tabId,is_pdf:!0})},500);case"init-floodgate":setTimeout(()=>{i.init(),i.getFeaturesAndGroups()},2e3);break;case"complete_conversion":e.createTab(r.conversion_url);break;case"analytics":break;case"pdf-contentType-event":i.hasFlag("dc-cv-content-type-pdf-analtyics",f.NO_CALL).then(e=>{"true"===m.getItem("pdfViewer")&&e&&a.event(a.e.PDF_CONTENT_TYPE_EVENT)});break;case"relay_to_content":this.relayMessageToContentScript(r,r.shouldCache??!0,g);break;case"viewer-startup":r.main_op="viewer-startup",this.sendViewerStartupInformation(r,n.tab.url,g);break;case"check-cookie":g(m.getItem(r.key));break;case"set-cookie":m.setItem(r.key,r.value);break;case"set-pdf-marker-action":h.setWithTTL("pdfMarkerAction",!0,5e3),g({success:!0});break;case"check-mime-viewer-availability":l.isMimeHandlerAvailable().then(e=>{e?"false"===m.getItem("pdfViewer")||"true"===m.getItem("cdnFailure")?this.sendMessage({dend_op:"viewer-type",tabId:n.tab.id,viewer:"mime-native",is_pdf:!0}):r.url&&r.url.startsWith("file://")&&(this.isAllowedLocalFileAccess||(a.event(a.e.VIEWER_PDF_LOCAL_FILE_IGNORED),x.sendMessage({dend_op:"viewer-type",tabId:n.tab.id,viewer:"mime-native",is_pdf:!0}))):this.sendMessage({dend_op:"viewer-type",tabId:n.tab.id,viewer:"native",is_pdf:!0})});break;case"uninstall":l.setViewerState("disabled"),m.setItem("pdfViewer","false"),m.setItem("always-show-pdf-menu","false"),e.mimeReloadAllTabs(),m.removeItem("userEligibleForUninstall"),chrome.runtime.setUninstallURL(""),a.event(a.e.UNINSTALL_DIALOG_UNINSTALLED_SUCCESSFUL),setTimeout(()=>{chrome.management.uninstallSelf()},1e3);break;case"initialise-popup":this.initialisePopup(n.tab,g);break;case"addExperimentCodeForAnalytics":A(r.experimentCode);break;case"cancelWebpageConversion":case"clearStatus":this.cancelConversion(this.tabs[n.tab.id]);break;case"triggerBufferSave":chrome.runtime.sendMessage({main_op:"triggerBufferSave"});break;case"closeExpressApp":v(n.tab.id);break;case"reloadCurrentTab":n.tab&&n.tab.id&&chrome.tabs.reload(n.tab.id);break;case"toggle-express-touch-points":F(r.allowed);break;case"removeSessionFromUnloadedExpressSessions":T(n.tab.id,r.touchpoint,r.domain);break;case"handleViewerFloodgateResponse":i.handleViewerFloodgateResponse(r.fgResponse);break;case"launch-express":w({srcUrl:r.imgUrl,intent:r.intent,touchpoint:r.touchpoint},n.tab);break;case"execute-direct-verb":H({srcUrl:r.fileUrl,name:r.fileName,viewerURL:r.viewerURL,promotionSource:r.promotionSource,verb:r.verb,clickTimestamp:r.clickTimestamp,verbConfig:r.verbConfig});break;case"get-tab-id":g({tabId:n.tab.id});break;case"get-webpage-html-by-tab-id":const B=r.sourceTabId||r.tabId;return B?((async()=>{try{await chrome.scripting.executeScript({target:{tabId:B},files:["content_scripts/extract-webpage-html.js"]});const e=await chrome.scripting.executeScript({target:{tabId:B},func:async()=>{if("function"==typeof getExtractWebpageHTML&&await getExtractWebpageHTML(),"function"==typeof window.extractWebpageHTML)return await window.extractWebpageHTML(document);throw new Error("extractWebpageHTML not found")}});e&&e[0]&&e[0].result?g({success:!0,html:e[0].result.html,title:e[0].result.title}):g({success:!1,error:"Extraction failed or returned no result"})}catch(e){g({success:!1,error:e.toString()})}})(),!0):void g({success:!1,error:"No sourceTabId provided"});case"local-storage-remove":m.removeItem(r?.key);break;case"getExperimentCodes":g(O());break;case"isAddWebpageToProjectEnabled":y().then(e=>g(e));break;case"kw-is-blocked-domain":L({domain:r.domain}).then(e=>g(e));break;case"add-webpage-to-project":R({...r,url:n?.tab?.url});break;case"toggle-add-webpage-to-project-context-menu":N();break;case"openPDFInNewTab":if(r.url?.match(/\.pdf(?=\?|#|$)/i)){const t=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(r.url);e.createTab(t)}break;case"get-welcome-pdf-url":const $=t.getWelcomePdfUrlHost(),z=e.getWelcomePDFUrl($);g(z);break;case"get-remote-execution-cdn-url":const K=t.getRemoteExecutionCdnUrl();g(K);break;case"initializeViewerVariables":u.initializeViewerVariables(this.version);break;case"check-ims-cookie":D().then(e=>g(e));break;case"akamai-ping":k();break;case"extnStorageSetKey":m.setItem(r.key,r.value).then(()=>{g({success:!0})});break;case"extnStorageRemoveKey":m.removeItem(r.key).then(()=>{g({success:!0})});break;case"extnStorageGetKey":g(m.getItem(r.key));break;case"log-event-once":a.logEventOnce(r.eventName,r.options);break;case"createNewTabWithUrl":e.createTab(r.url,null,{openerTabId:n?.tab?.id});break;case"pdf-convert-perf-mark":this.handlePdfConvertPerfMark(r);break;case"pdf-convert-perf-emit":this.handlePdfConvertPerfEmit(r);break;default:return q[E]?(a.setOp({preview:"Copy",image_preview:"Image",send:"Send",fillsign:"FillSign",export:"Export",acom:"GotoAcom",to_pdf:"ConvertToPdf"}[r.handleResult]),q[E](r,n,g)):void e.consoleLog("failed to find handler for: "+E)}return!0}}gmailSelectors(){return Promise.resolve((()=>{const e=i.getFeatureMeta("dc-cv-gmail-selectors"),t=i.getFeatureMeta("dc-cv-gmail-selectors-list-view"),a=i.getFeatureMeta("dc-cv-gmail-selectors-native-viewer");let s={};try{s.messageView=JSON.parse(e),s.listView=JSON.parse(t),s.nativeViewer=JSON.parse(a)}catch(e){}return s})())}gmailFteToolTipConfig(){return Promise.resolve((()=>{let e=i.getFeatureMeta("dc-cv-gmail-fte-tooltip");try{e=JSON.parse(e)}catch(t){e={tooltip:{shortCoolDown:7,longCoolDown:60,maxFteCount:-1,resetDay:-1}}}return e})())}initStorageForGSuiteFlows(e,t,a){m.setItem(`${e}-pdf-dv-feature-enablement-status`,t?.toString()),m.setItem(`${e}-pdf-dv-feature-control-enablement-status`,a?.toString())}fetchFeatureEnablementStatusForDefaultViewership(e){return i.hasFlag(`dc-cv-${e}-default-viewership`)}getPdfToolsFteToolTipStrings(){return{title:e.getTranslation("pdfToolsFteTooltipTitle"),description:e.getTranslation("pdfToolsFteTooltipDescription"),button:e.getTranslation("pdfToolsFteTooltipButton")}}async gmailInit(t){const[a,s,r,o,n,l]=await Promise.all([this.gmailSelectors(),this.gmailFteToolTipConfig(),C("gmail"),this.fetchFeatureEnablementStatusForDefaultViewership("gmail"),i.hasFlag("dc-cv-gmail-acrobat-touch-point"),i.hasFlag("dc-cv-gmail-pdftools-touch-point")]);this.initStorageForGSuiteFlows("gmail",o,!1);try{await u.initializeViewerVariables(this.version)}catch(e){console.error("Error initializing viewer variables for Gmail:",e)}t({touchPointSettingEnabled:e.isAcrobatTouchPointEnabled("acrobat-touch-point-in-gmail"),selectors:a,acrobatPromptText:e.getTranslation("gsuiteOpenWithAcrobat"),gmailFteToolTipStrings:this.getSurfaceFTEToolTipStrings(o,"gmail"),pdfToolsFteToolTipStrings:this.getPdfToolsFteToolTipStrings(),fteConfig:s,isAcrobatDefaultForSurface:"true"===r,enableDefaultViewershipFeatureForGmail:o,enableGmailTouchPoint:n,enablePdfToolsTouchPoint:l})}getSurfaceFTEToolTipStringsForGdriveNonDV(){return{title:e.getTranslation("acrobatGsuiteFteToolTipTitleNonDV"),description:e.getTranslation("acrobatGsuiteFteToolTipDescriptionNonDV",e.getTranslation("surfaceNameGdrive")),button:e.getTranslation("closeButton")}}getSurfaceFTEToolTipStrings(t,a){let s,r;return"gmail"===a?r=e.getTranslation("surfaceNameGmail"):"gdrive"===a&&(r=e.getTranslation("surfaceNameGdrive")),s=t&&!m.getItem(`${a}-pdf-default-viewership-user-disabled`)?{title:e.getTranslation("acrobatGsuiteFteToolTipTitleDV"),description:e.getTranslation("acrobatGsuiteFteToolTipDescriptionDV",r),button:e.getTranslation("closeButton")}:{title:e.getTranslation("acrobatGsuiteFteToolTipTitleNonDV"),description:e.getTranslation("acrobatGsuiteFteToolTipDescriptionNonDV",r),button:e.getTranslation("closeButton")},s}async embeddedPDFTouchPointConfig(t,a,s){const r=await i.hasFlag("dc-cv-embedded-pdf-touch-point"),o="false"===m.getItem("acrobat-touch-point-in-embedded-pdf");try{await u.initializeViewerVariables(this.version)}catch(e){console.error("Error initializing viewer variables for embedded PDF:",e)}let n;try{n=JSON.parse(i.getFeatureMeta("dc-cv-embedded-pdf-touch-point"))}catch(e){n={tooltip:{shortCoolDown:7,longCoolDown:60,maxFteCount:-1,resetDay:-1},blockedDomains:["outlook.office.com","attachments.office.net"]}}const l=r&&!o,c=s.tab.url,d=new URL(c).hostname;a({enableEmbeddedPDFTouchPoint:l,touchPointConfig:n,touchPointText:e.getTranslation("embeddedPDFOpenInAcrobatTooltip"),fteToolTipStrings:{title:e.getTranslation("embeddedPDFTouchPointFTEHeader"),description:e.getTranslation("embeddedPDFTouchPointFTEBody"),button:e.getTranslation("closeButton")},menuItemStrings:{hideIconForNow:e.getTranslation("embeddedPDFHideIconForNow"),openPDFInAcrobat:e.getTranslation("embeddedPDFOpenPDFInAcrobat"),managePreferences:e.getTranslation("embeddedPDFManagePreferences")},tabId:t?.tabId,frameId:s?.frameId,contextMenuTooltipText:e.getTranslation("preferences"),topDomain:d})}async outlookInit(t){const[a,s]=await Promise.all([i.hasFlag("dc-cv-outlook-pdf-touch-point"),i.hasFlag("dc-cv-outlook-pdf-touch-point-control")]);try{await u.initializeViewerVariables(this.version)}catch(e){console.error("Error initializing viewer variables for Outlook:",e)}let r,o,n;const l=!e.isAcrobatTouchPointEnabled("acrobat-touch-point-in-outlook");try{const e=JSON.parse(i.getFeatureMeta("dc-cv-outlook-pdf-touch-point"));r=e?e.tooltip:{},o=e?e.selectors:{},n=!!e&&e.fteEnabled}catch(e){r={shortCoolDown:7,longCoolDown:60,maxFteCount:-1,resetDay:-1}}t({enableOutlookPDFTouchPoint:a&&!l,selectors:o,fteConfig:r,touchPointString:e.getTranslation("gsuiteOpenWithAcrobat"),fteToolTipStrings:{title:e.getTranslation("outlookPDFTouchPointFTEHeader"),description:e.getTranslation("outlookPDFTouchPointFTEBody"),button:e.getTranslation("closeButton")},errorToastStrings:{title:e.getTranslation("outlookErrorToastTitle"),description:e.getTranslation("outlookErrorToastDescription")},enableOutlookFteTooltip:n})}async gdriveInit(t){const[a,s,r,o,n,l,c,d,p,g,h,b,f,v,I,w,T,E]=await Promise.all([i.hasFlag("dc-cv-gdrive-open-in-extension"),i.getFeatureMeta("dc-cv-gdrive-selectors"),i.hasFlag("dc-cv-gdrive-fte-tooltip"),i.getFeatureMeta("dc-cv-gdrive-fte-tooltip"),i.hasFlag("dc-cv-gdrive-grid-view-touchpoint"),i.getFeatureMeta("dc-cv-gdrive-grid-view-selectors"),i.hasFlag("dc-cv-gdrive-list-view-touchpoint"),i.getFeatureMeta("dc-cv-gdrive-list-view-selectors"),i.getFeatureMeta("dc-cv-gdrive-pdf-selectors"),i.hasFlag("dc-cv-gdrive-triple-dot-menu-analytics"),i.hasFlag("dc-cv-gdrive-list-grid-view-fte-tooltip"),i.hasFlag("dc-cv-gdrive-grid-view-touchpoint-migration"),i.hasFlag("dc-cv-gdrive-list-view-touchpoint-migration"),i.hasFlag("dc-cv-gdrive-search-bar-analytics"),i.getFeatureMeta("dc-cv-gdrive-search-selectors"),C("gdrive"),this.fetchFeatureEnablementStatusForDefaultViewership("gdrive"),i.hasFlag("dc-cv-gdrive-default-viewership-control")]);try{await u.initializeViewerVariables(this.version)}catch(e){console.error("Error initializing viewer variables for GDrive:",e)}let F,x,_,P,S,k,D;try{F=s?JSON.parse(s):{},x=o?JSON.parse(o):{},_=l?JSON.parse(l):{},P=d?JSON.parse(d):{},S=I?JSON.parse(I):{},D=p?JSON.parse(p):{},_.pdfSvgPath=D?.svg,P.pdfSvgPath=D?.svg,F.GoogleDriveListView=P,F.GoogleDriveGridView=_,F.GoogleDriveSearchBar=S,k=e.isAcrobatTouchPointEnabled("acrobat-touch-point-in-gdrive")}catch(e){x={tooltip:{shortCoolDown:7,longCoolDown:60,maxFteCount:-1,resetDay:-1}},k=!1}const M=n||b,L=c||f;n&&m.setItem("gvt","dc-cv-gdrive-grid-view-touchpoint"),c&&m.setItem("lvt","dc-cv-gdrive-list-view-touchpoint"),t({acrobatTouchPointEnabled:k,enableOpenInExtension:a,acrobatPromptText:e.getTranslation("gsuiteOpenWithAcrobat"),selectors:F,fteToolTipStrings:this.getSurfaceFTEToolTipStrings(T,"gdrive"),fteToolTipStringsForNativeViewNonDV:this.getSurfaceFTEToolTipStringsForGdriveNonDV(),enableGDriveGridViewTouchPoint:M,enableGDriveListViewTouchPoint:L,enableGDriveTripleDotMenuAnalytics:g,enableGDriveSearchBarAnalytics:v,fteConfig:x,enableFteToolTip:r,enableFteToolTipForListGridView:h,isAcrobatDefaultForSurface:"true"===w,enableDefaultViewershipFeatureForGoogleDrive:T}),this.initStorageForGSuiteFlows("gdrive",T,E)}gdriveFteStateUpdated(e){chrome.tabs.query({url:["https://drive.google.com/*"]},function(t){t?.forEach(function(t){t.id!==e.tabId&&chrome.tabs.sendMessage(t.id,{content_op:"acrobatGdriveFteStateUpdated",fteState:e?.fteState})})})}async gDriveDownloadPageInit(t){const[a]=await Promise.all([i.getFeatureMeta("dc-cv-gdrive-download-page-selectors")]);let s,r;try{s=JSON.parse(a),r=e.isAcrobatTouchPointEnabled("acrobat-touch-point-in-gdrive")}catch(e){r=!1}t({selectors:s,acrobatTouchPointEnabled:r})}gmailFteConfigUpdated(e){chrome.tabs.query({url:["https://mail.google.com/*"]},function(t){t?.forEach(function(t){t?.id!==e.tabId&&chrome.tabs.sendMessage(t.id,{content_op:"acrobatGmailFteStateUpdated",fteState:e?.fteState})})})}async handleChangeDefaultViewershipForSurface(e,t){if(!await this.fetchFeatureEnablementStatusForDefaultViewership(e.surfaceId))return;const s={gmail:{baseURL:"https://mail.google.com/*",basePath:"/mail/"},gdrive:{baseURL:"https://drive.google.com/*",basePath:"/drive/"}},r=`${e.surfaceId}-pdf-default-viewership`;if(m.getItem(r)!==e.isDefault?.toString()){const i=r+"-user-disabled";if(e.isDefault){if(e.isDefault){m.removeItem(i),a.event(`DCBrowserExt:${e.surfaceId}:DefaultViewership:Enabled`,{eventContext:e.source,...e.pageSource&&{pageSource:e.pageSource}}),P(e.surfaceId);if(["tripleDotMenu","extensionPreferencePage","extensionPopup"].includes(e.source)){const t=m.getItem("viewerStorage")||{},a=`${e.surfaceId}-default-viewership-coach-mark-shown`;t[a]||(t[a]="true",m.setItem("viewerStorage",t))}}}else{m.setItem(i,"true"),S(e.surfaceId).then(t=>{a.event(`DCBrowserExt:${e.surfaceId}:DefaultViewership:Disabled`,{dvDisableSessionCount:t,eventContext:e.source,...e.pageSource&&{pageSource:e.pageSource}})});const r=t?.tab?.id;if("implicitCoachmarkCTA"===e.source&&r){m.setItem(`${e.surfaceId}-show-implicit-dv-toast`,"true");const a=s[e.surfaceId]?.baseURL?.replace(/\/\*$/,""),i=s[e.surfaceId]?.basePath,o=t?.tab?.openerTabId;if(o)chrome.tabs.get(o,e=>{if(e&&e.windowId===t?.tab?.windowId&&e.url?.startsWith(a))chrome.tabs.update(e.id,{active:!0}),chrome.tabs.remove(r),chrome.tabs.sendMessage(e.id,{content_op:"show-implicit-dv-toast"});else{const e=M(t?.tab?.url,a,i);chrome.tabs.update(r,{url:e})}});else{const e=M(t?.tab?.url,a,i);chrome.tabs.update(r,{url:e})}}}m.setItem(r,e.isDefault?.toString()),chrome.tabs.query({url:s[e.surfaceId]?.baseURL},t=>{t?.forEach(t=>{e.tabId===t.id&&e.syncToOtherTabsOnly||chrome.tabs.sendMessage(t.id,{content_op:"changeDefaultViewershipForSurface",isDefault:e.isDefault,surfaceId:e.surfaceId,source:e.source})})})}}async expressInit(t){const[a]=await Promise.all([E()]),s=a.enableExpressContextMenu,r=a.enableExpressOptionsPagePreference,o=a.enableExpressTooltip,n=i.getFeatureMeta("dc-cv-express-context-menu-tooltip");let l;try{l=JSON.parse(n)}catch(e){l={minimumImageDimension:{height:100,width:150},imageCount:5}}const c=i.getFeatureMeta("dc-cv-express-context-menu-tooltip-allow-list");let d={allowListArray:[]};if(c)try{d.allowListArray=JSON.parse(c)}catch(e){}t({enableExpressContextMenu:s,shouldEnableExpressTouchpointsPreference:r,showExpressTooltip:o,imageDimension:l.minimumImageDimension,imageCount:l.imageCount,allowInfo:d,expressTooltipStrings:{title:e.getTranslation("expressFteTitle"),description:e.getTranslation("expressFteDescription"),footer:e.getTranslation("expressFTEFooter"),popoverTitle:e.getTranslation("expressPopoverFTETitle"),popoverDescription:e.getTranslation("expressPopoverFTEDescription")}})}async whatsappExpressInit(t){const a=await x("whatsapp-preview"),s=await x("whatsapp-hover"),r=i.getFeatureMeta("dc-cv-express-whatsapp-preview"),o=i.getFeatureMeta("dc-cv-express-whatsapp-hover");let n,l;try{n=JSON.parse(r)}catch(e){n=null}try{l=JSON.parse(o)}catch(e){l=null}const c=await i.hasFlag("dc-cv-express-whatsapp-fte");t({enableWhatsappPreviewExpressMenu:a.enableWhatsappPreviewExpressMenu,enableWhatsappHoverExpressMenu:s.enableWhatsappHoverExpressMenu,enableWhatsappPreviewExpressFte:c,enableExpressOptionsPagePreference:a.enableExpressOptionsPagePreference||s.enableExpressOptionsPagePreference,selectors:{...n?.selectorList,...l?.selectorList},fteStrings:{title:e.getTranslation("expressContextualFteTitle"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")}})}async gmailExpressInit(t){const[a,s,r,o,n]=await Promise.all([x("gmail-native-viewer"),x("gmail-message-view"),i.hasFlag("dc-cv-express-gmail-fte"),i.hasFlag("dc-cv-gmail-convert-to-pdf-in-images"),i.hasFlag("dc-cv-gmail-convert-to-pdf-in-images-control")]),l=i.getFeatureMeta("dc-cv-express-gmail-native-viewer"),c=i.getFeatureMeta("dc-cv-express-gmail-message-view"),d=i.getFeatureMeta("dc-cv-gmail-convert-to-pdf-in-images"),p=i.getFeatureMeta("dc-cv-gmail-convert-to-pdf-in-images-control");let u,g,h;try{u=JSON.parse(l)}catch(e){u=null}try{g=JSON.parse(c)}catch(e){g=null}try{o?h=JSON.parse(d):n&&(h=JSON.parse(p))}catch(e){h=null}const b=function(e,t){const a=m.getItem("locale"),s="en-US"===a||"en-GB"===a;return s&&e||!s&&t}(h?.enLocaleEnabled,h?.nonEnLocaleEnabled);o&&b?(V("GCIC"),A("GCI")):n&&b?(V("GCI"),A("GCIC")):(V("GCI"),V("GCIC"));let f=m.getItem("express-touch-points");f=""===f||f&&"false"!==f,t({...a,...s,enableExpressOptionsPagePreference:a.enableExpressOptionsPagePreference||s.enableExpressOptionsPagePreference,selectors:{...u?.selectorList,...g?.selectorList},enableGmailExpressFte:r,fteStrings:{title:e.getTranslation("expressContextualFteTitle"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")},imageToolsDropdownFteStrings:{title:e.getTranslation("imageToolsDropdownFteTitle"),description:e.getTranslation("imageToolsDropdownFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")},convertToPdfFteStrings:{title:e.getTranslation("gmailConvertToPdfFteToolTipTitle"),description:e.getTranslation("gmailConvertToPdfFteToolTipDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")},enableGmailConvertToPdfInImages:o&&b&&f,enableGmailConvertToPdfInImagesControl:n&&b})}async googleImagePreviewExpressInit(t){const a=await x("google-image-preview"),s=i.getFeatureMeta("dc-cv-express-google-image-preview"),r=await i.hasFlag("dc-cv-express-google-image-preview-single-cta"),o=await i.hasFlag("dc-cv-express-google-image-preview-fte");let n;try{n=JSON.parse(s)}catch(e){n=null}t({...a,selectors:n?.selectorList,singleCTAEnabled:r,enableGoogleImagePreviewExpressFte:o,fteStrings:{title:e.getTranslation("expressContextualFteTitle"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")}})}async gdriveExpressInit(t){const a=await x("gdrive-native-viewer"),s=i.getFeatureMeta("dc-cv-express-gdrive-native-viewer"),r=await i.hasFlag("dc-cv-express-gdrive-native-viewer-fte");let o;try{o=JSON.parse(s)}catch(e){o=null}const n=m.getItem("locale"),l="en-US"===n||"en-GB"===n,c=await i.hasFlag("dc-cv-remote-execution"),d=await i.hasFlag("dc-cv-remote-execution-control");c&&l?(a.enableGdriveNativeViewerExpressMenu=!1,A("REF")):d&&l?A("REFC"):(V("REF"),V("REFC"));const p=i.getFeatureMeta("dc-cv-remote-execution-logging");let u;try{u=JSON.parse(p)}catch(e){u=null}t({...a,selectors:{...o?.selectors},enableGdriveExpressFte:r,fteStrings:{title:e.getTranslation("expressContextualFteTitle"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")},remoteExecutionLoggingConfig:u})}async googleChatExpressInit(t){const a=await x("google-chat-native-viewer"),s=i.getFeatureMeta("dc-cv-express-google-chat-native-viewer");let r;try{r=JSON.parse(s)}catch(e){r=null}t({enableGoogleChatNativeViewerExpressMenu:a.enableGoogleChatNativeViewerExpressMenu,selectors:r?.selectors,enableGoogleChatExpressFte:r?.fte,fteStrings:{title:e.getTranslation("expressContextualFteTitle"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")}})}async facebookExpressInit(e){const t=await x("facebook-preview"),a=i.getFeatureMeta("dc-cv-express-facebook-preview");let s;try{s=JSON.parse(a)}catch(e){s=null}e({...t,selectors:s?.selectors})}async chatgptExpressInit(t){const a=await x("chatgpt-preview"),s=i.getFeatureMeta("dc-cv-express-chatgpt-preview"),r=i.getFeatureMeta("dc-cv-express-chatgpt-selectors"),o=await i.hasFlag("dc-cv-express-chatgpt-connected-app-moderation"),n=i.getFeatureMeta("dc-cv-express-chatgpt-connected-app-moderation");let l,c;try{l=JSON.parse(s)}catch(e){l=null}try{c=JSON.parse(n)}catch(e){c=null}try{l&&(l.selectorList={...l.selectorList,...JSON.parse(r)})}catch(e){}t({enableChatGPTPreviewExpressMenu:a.enableChatGPTPreviewExpressMenu&&l?.preview,enableChatGPTChatViewExpressMenu:a.enableChatGPTPreviewExpressMenu&&l?.chatView,enableChatGPTWebImagesPreviewExpressMenu:a.enableChatGPTPreviewExpressMenu&&l?.webImagesPreview,enableChatGPTExpressFte:l?.fte,enableExpressOptionsPagePreference:a.enableExpressOptionsPagePreference,selectors:l?.selectorList,enableConnectedAppBasedModeration:{enabled:o,config:c},fteStrings:{title:e.getTranslation("expressContextualFteTitle"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")}})}async geminiExpressInit(t){const a=await x("gemini-preview"),s=i.getFeatureMeta("dc-cv-express-gemini-preview"),r=i.getFeatureMeta("dc-cv-express-gemini-selectors");let o;try{o=JSON.parse(s)}catch(e){o=null}try{o&&(o.selectorList={...o.selectorList,...JSON.parse(r)})}catch(e){}t({enableGeminiPreviewExpressMenu:a.enableGeminiPreviewExpressMenu&&"true"===o?.preview,enableGeminiChatViewExpressMenu:a.enableGeminiPreviewExpressMenu&&"true"===o?.chatView,enableGeminiImmersivePanelExpressMenu:a.enableGeminiPreviewExpressMenu&&"true"===o?.immersivePanel,enableGeminiExpressFte:"true"===o?.fte,selectors:o?.selectorList,enableExpressOptionsPagePreference:a.enableExpressOptionsPagePreference,fteStrings:{title:e.getTranslation("expressContextualFteTitle"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")}})}async outlookExpressInit(t){const a=await x("outlook-native-viewer"),s=i.getFeatureMeta("dc-cv-express-outlook-native-viewer");let r;try{r=JSON.parse(s)}catch(e){r=null}t({enableOutlookNVExpressMenu:a.enableOutlookNVExpressMenu&&r?.preview,enableOutlookAttachmentViewExpressMenu:a.enableOutlookNVExpressMenu&&r?.attachmentView,enableOutlookInEmailImageViewExpressMenu:a.enableOutlookNVExpressMenu&&r?.inEmailImageView,enableOutlookExpressFte:r?.fte,enableExpressOptionsPagePreference:a.enableExpressOptionsPagePreference,selectors:r?.selectorList,fteStrings:{title:e.getTranslation("expressContextualFteTitle"),description:e.getTranslation("expressContextualFteDescription"),ctaLabel:e.getTranslation("expressContextualFteCtaLabel")}})}async chatgptInit(e){const t=await i.hasFlag("dc-cv-chatgpt-analytics-visited");let a=i.getFeatureMeta("dc-cv-chatgpt-analytics-visited");try{a=JSON.parse(a)}catch(e){a={}}e({enableChatGPTAnalytics:t,metaData:a})}async initialisePopup(a,s){let r={hostedURL:t.getPopupCDNUrl()};if(this.tabs[a.id]){r=e.extend(r,this.tabs[a.id]);const t=`chrome-extension://${chrome.runtime.id}`;a.url.startsWith(t)&&(r.is_extension_url=!0);["chrome://extensions/",t,"chrome://newtab/","https://chrome.google.com","https://acrobat.adobe.com/link/file/?uri=","https://acrobat.adobe.com/id/urn:","https://acrobat.adobe.com/link/review/?uri="].some(e=>a.url.startsWith(e))&&(r.isBlacklistedUrl=!0);if(!["downloading","pdf_downloading","waiting","in_progress","complete"].includes(r.current_status)||r.isBlacklistedUrl){const e=r.is_pdf;this.clearStatus(r),r.is_pdf=e}e.isLocalFileUrl(a.url)&&(r.is_pdf=!0,r.isFillnSignEnabled=g.FILL_N_SIGN_ENABLED),r.isAcrobat=e.isAcrobatAvailable(this.version),r.autoOpenPDFInAcrobat="false"!==m.getItem("ViewResultsPref")}s(r)}echoRequest(t){var a,s,r;if(!(g.CHROME_VERSION<g.SUPPORTED_VERSION)){if(!this.avoidUrl(t.url)){var i=t.id||t.tabId;return this.tabs[i]&&("cancelled"!==(a=this.tabs[i]).current_status&&"pdf_opened"!==a.current_status&&"pdf_failure"!==a.current_status&&"viewer_menu"!==a.panel_op||(r=a.is_pdf,this.clearStatus(a),a.is_pdf=r),a.current_status&&(a.panel_op="status"),s=a.is_pdf?"pdf_menu":"html_menu",a.panel_op&&"load-frictionless"===a.panel_op&&delete a.panel_op,"resize_window"===a.content_op&&(delete a.content_op,delete a.window_height),a.panel_op=a.panel_op||s,"html_menu"===s&&(a.persist=!1),a.incognito=t.incognito,e.isLocalFileUrl(t.url)&&(a.panel_op="pdf_menu",a.is_pdf=!0,a.isFillnSignEnabled=g.FILL_N_SIGN_ENABLED),t.url.startsWith(`chrome-extension://${chrome.runtime.id}`)?(a.panel_op="viewer_menu",a.is_viewer=!0):a.is_viewer=!1,e.consoleLog("repeat cached request: "+a.panel_op)),a}this.disable(t.id)}}setGlobals(e){this.globals=e}dump(t,a){var s,r=[a];for(s in t)t.hasOwnProperty(s)&&r.push("  "+s+": "+t[s]);e.consoleLog(r.join("\n"))}sendMessage(t,s=!0,r){var i,o=t.tabId;this.dump(t,"Sending message:"),t.version=this.version,e.consoleLog("sendMessage version",t),s&&(this.tabs[o]=e.extend(this.tabs[o],t)),t.NMHConnStatus=this.NMHConnStatus,t.show_frictionless=!0,t.is_edge=e.isEdge(),"flickr"===t.panel_op&&(i=a.e.FLICKR_OFFER_SHOWN),i&&a.checkAndLogAnalytics(i),e.sendMessage(t,this.globals,r),delete t.mimeHandled,delete this.tabs[o].mimeHandled}deferMessage(e){"undefined"==typeof setTimeout?this.sendMessage(e):setTimeout(this.proxy(this.sendMessage,e),0)}sendMessageToPopup(t,a=!0){const s=t.tabId;t.version=this.version,a&&(this.tabs[s]=e.extend(this.tabs[s],t)),t.NMHConnStatus=this.NMHConnStatus,t.is_edge=e.isEdge(),chrome.runtime.sendMessage(t)}filenameFromUrl(e){try{const t=decodeURIComponent(e),a=t.split("?")[0].split("/").filter(e=>e.length>0),s=a.length>0?a[a.length-1]:"untitled";let r=s;const i=s.length-4;return(s.length<4||s.toLowerCase().indexOf(".pdf")!==i)&&(r+=".pdf"),r}catch(e){return"untitled.pdf"}}async pdf_menu(t,s){var r;if(delete(r=this.tabs[s.tab.id]=e.extend(this.tabs[s.tab.id],{tabId:s.tab.id})).dend_op,r.filename=this.filenameFromUrl(t.url),r.panel_op="pdf_menu",r.url=t.url,r.viewer=t.viewer,r.incognito=s.tab.incognito,r.fteFeatureFlag=t.fteFeatureFlag,r.isFillnSignEnabled=g.FILL_N_SIGN_ENABLED,r.isSharePointEnabled=n.isFeatureEnabled(),1==r.isSharePointEnabled&&(r.isSharePointURL=n.isAllowListedSharePointURL(r.url)),1==t.persist){const e=await this.isEnablePersistMenu(t);r.persist=!!e}else r.persist=!1;const i=m.getItem("fteDenied");var o=!(0==t.version||1==t.version||t.version===g.READER_VER||t.version===g.ERP_READER_VER);const l=g.VIEWER_ENABLED&&!m.getItem("pdfViewer")&&(!i||10!==parseInt(i))&&(!o||g.VIEWER_ENABLED_FOR_ACROBAT);if("false"!==m.getItem("always-show-pdf-menu")&&"mime"!==r.viewer&&(1!=r.persist||l||(delete r.fteFeatureFlag,a.event(a.e.PERSIST_PDF_MENU_SHOWN)),this.deferMessage(r)),l){let e,s=m.getItem("repromptCount");switch(t.fteFeatureFlag){case"dc-cv-fte-pdf-redcard":e=a.e.PERSIST_PDF_MENU_RED_CARD_FTE_SHOWN;break;case"dc-cv-fte-pdf-dmb":e=a.e.PERSIST_PDF_MENU_DMB_FTE_SHOWN;break;default:e=a.e.PERSIST_PDF_MENU_FTE_SHOWN}s?a.event(e,{LAUNCH:"Reprompt"}):a.event(e,{LAUNCH:"Launch"})}if(!r.incognito)if("true"!==m.getItem("pdfViewer")||"native"!==r.viewer&&"mime-native"!==r.viewer){if(!m.getItem("pdfViewer")||"false"===m.getItem("pdfViewer")){let e="Acrobat";this.legacyShim()?e="NoApp":this.version!==g.READER_VER&&this.version!==g.ERP_READER_VER||(e="Reader"),"native"!==r.viewer&&"mime-native"!==r.viewer||a.event(a.e.VIEWER_DISABLED_PDF_OPEN_NATIVE_VIEWER,{APPLICATION:e})}}else a.event(a.e.VIEWER_ENABLED_PDF_OPEN_NATIVE_VIEWER)}loaded(t){this.tabs[t]=e.extend(this.tabs[t],{tabId:t,loaded:!0})}setIsPDF(t,a){this.tabs[t]=e.extend(this.tabs[t],{tabId:t,is_pdf:a})}cancelConversion(e){this.getModule("acro-web2pdf").cancelConversion(e.tabId),delete e.current_status,delete e.file_path,delete e.domtitle,delete e.timing,delete e.panel_op,delete e.is_pdf,delete e.newUI}clearStatus(e,t){"in_progress"!==e.current_status&&"downloading"!==e.current_status&&(t||"waiting"!==e.current_status)&&this.cancelConversion(e)}loading(t){var a=t.id;this.tabs[a]=e.extend(this.tabs[a],{tabId:a,loaded:!1}),this.clearStatus(this.tabs[a],!0)}async active(t){this.activeTab=t.tabId,this.tabs[this.activeTab]=e.extend(this.tabs[this.activeTab],{tabId:t.tabId});if(await this.isEnablePersistMenu()){var a=this.echoRequest(this.tabs[this.activeTab]);a&&a.persist&&this.sendMessage(a)}}disable(e){this.tabs[e]&&(this.tabs[e].loaded=!1)}close(e){this.getModule("acro-web2pdf").cancelConversion(e),delete this.tabs[e],this.activeTab===e&&(this.activeTab=null),U().cleanTemporaryURLBufferEntry(e)}tabReplace(e,t){this.close(t),this.loaded(e)}activeTab(){return this.activeTab}noop(){}avoidUrl(t){if(t=t||"",g.VIEWER_ENABLED&&m.getItem("pdfViewer")&&e.isViewerURL(t))return!1;if(this.version===g.ERP_READER_VER)return!0;if(t.startsWith("https://chrome.google.com"))return!0;if(this.version==g.READER_VER&&0==g.FRICTIONLESS_ENABLED)return!t.endsWith(".pdf")&&!t.endsWith(".PDF");if((0==this.version||1==this.version&&0==this.NMHConnStatus)&&!1===g.FRICTIONLESS_ENABLED)return!1;m.getItem("appLocale");const a=this.isAllowedLocalFileAccess&&e.isLocalFileUrl(t);return!t.startsWith("http")&&!a}handlePdfConvertPerfMark(e){const{requestId:t,name:a,metadata:s={}}=e?.data||{};if(!t||!a)return;this.pdfConvertPerfTrackers instanceof Map||(this.pdfConvertPerfTrackers=new Map);let r=this.pdfConvertPerfTrackers.get(t);r||(r=W({requestId:t}),this.pdfConvertPerfTrackers.set(t,r)),r.mark(a,s)}async handlePdfConvertPerfEmit(e){const{requestId:t}=e?.data||{};if(!t)return;const a=this.pdfConvertPerfTrackers.get(t);if(!a)return;const s=a.getMarker("PDF_Convert_PDF_Received"),r={requestId:t,promotionSource:s?.promotionSource||"",...a.getDurations([{start:"PDF_Convert_Viewer_Initialized",end:"PDF_Convert_Source_File_Received",label:"viewerInitialized_to_sourceFileReceived_ms"},{start:"PDF_Convert_Viewer_Initialized",end:"PDF_Convert_PDF_Received",label:"viewerInitialized_to_pdfReceived_ms"}])};_.info({message:"PDF_Convert_Performance_Metrics",...r}),this.pdfConvertPerfTrackers.delete(t)}}let Q=null;$||($=new K,$.registerHandlers({"send-analytics":$.proxy($.noop)}),!Q&&$&&$.pdfConvertPerfTrackers instanceof Map&&(Q=setInterval(()=>{if($&&$.pdfConvertPerfTrackers instanceof Map){const e=Date.now(),t=36e5;for(const[a,s]of $.pdfConvertPerfTrackers.entries())e-s.getStartTime()>t&&$.pdfConvertPerfTrackers.delete(a)}else clearInterval(Q),Q=null},6e5)));export const communicate=$;