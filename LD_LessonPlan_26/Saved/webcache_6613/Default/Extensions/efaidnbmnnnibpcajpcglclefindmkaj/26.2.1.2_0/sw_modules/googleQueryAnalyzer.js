/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{communicate as e}from"./communicate.js";import{Proxy as t}from"./proxy.js";import{analytics as o}from"../common/analytics.js";import{common as r}from"./common.js";import{util as s}from"./util.js";import{dcLocalStorage as n}from"../common/local-storage.js";import{floodgate as c}from"./floodgate.js";import{CACHE_PURGE_SCHEME as i}from"./constant.js";import{setExperimentCodeForAnalytics as l,removeExperimentCodeForAnalytics as a}from"../common/experimentUtils.js";let p=null;const f=["word-to-pdf","png-to-pdf","jpg-to-pdf","excel-to-pdf","ppt-to-pdf","pdf-to-ppt","pdf-to-excel","pdf-to-image","pdf-to-word","compress-pdf","createpdf","reorder-pages","rotate-pages","delete-pages","split-pdf","extract-pages","insert-pdf","protect-pdf","crop-pages","number-pages","add-comment","ocr-pdf","sendforsignature","fillsign","combine-pdf","chat-pdf"],g={google:"#topstuff",bing:"#b_results"},u={google:["#center_col","#rcnt","#main","#cnt","#search"],bing:["#b_content","#b_results"]};p||(p=new function(){this.proxy=t.proxy.bind(this),this.LOG=(...e)=>r.LOG(...e),this.getSearchEngine=e=>{try{const t=new URL(e.url);if(t.host.startsWith("www.google."))return"google";if(t.host.startsWith("www.bing."))return"bing"}catch(e){return null}return null},this.isGoogleQuery=e=>null!==this.getSearchEngine(e),this.getSearchQuery=function(e){try{const t=new URL(e.url).searchParams.get("q");if(t)return decodeURIComponent(t)}catch(e){return o.event(o.e.GOOGLE_URL_DECODE_ERROR),null}return null},this.mapQueryStringToAction=function(t,p,f){const d=n.getItem("appLocale"),h=chrome.i18n.getMessage("@@ui_locale"),m=d||s.getFrictionlessLocale(h);if(null==m)return;const _=chrome.runtime.getURL("browser/data/searchterms.json");fetch(_).then(e=>{if(e.status>=200&&e.status<=299)return e.json();throw o.event(o.e.GOOGLE_SEARCHTERM_FETCH_ERROR),Error(o.e.GOOGLE_SEARCHTERM_FETCH_ERROR)}).then(async o=>{const s=this.findAction(o,t);if(this.validLocale(s)){const[t,o]=await Promise.all([c.hasFlag("dc-cv-frictionless-variant2",i.NO_CALL),c.hasFlag("dc-cv-check-spw",i.NO_CALL)]);if(p.checkSPW=o,o)try{const e=c.getFeatureMeta("dc-cv-check-spw");if(e){const t=JSON.parse(e);t.checkSPWSelector&&(p.checkSPWSelector=t.checkSPWSelector)}}catch(e){}let n=t,d=null;if(t?(a("FSWO"),l("FSWN")):(a("FSWN"),l("FSWO")),n)try{let e=c.getFeatureMeta("dc-cv-frictionless-variant2");e||(e=JSON.stringify({supportedVerbs:["pdf-to-word"]})),d=JSON.parse(e),d.supportedVerbs&&Array.isArray(d.supportedVerbs)&&(d.supportedVerbs.includes("ALL")||d.supportedVerbs.includes(s)||(n=!1,d=null))}catch(e){n=!1,d=null}if(p.panel_op="load-frictionless",p.pdf_action=s,p.frictionless_uri=r.getFrictionlessUri(n?"v2":"v1"),p.env=r.getEnv(),p.frame_visibility="hidden",p.frictionless_workflow="search",p.variant=n?"v2":"v1",p.locale=m,n&&d){const e=this.getSearchEngine(p),t=g[e]||g.google,o=u[e]||u.google;p.dom_selector=d.domSelector||t,p.observer_containers=d.observerContainers||o}"function"!=typeof f?e.sendMessage(p):f(p)}}).catch(e=>{s.consoleError("googlequeryanalyzer::mapQueryStringToAction",e)})},this.validLocale=function(e){const t=chrome.i18n.getMessage("@@ui_locale");return"chat-pdf"===e?s.getFrictionlessLocaleChatPdf(t):"ocr-pdf"!==e||s.getFrictionlessLocaleOcrPdf(t)},this.findAction=function(e,t){const r=` ${t.replace(/^\s+|\s+$/g,"").replace(/\s+/g," ")} `.toLowerCase();for(let t=0;t<f.length;++t){const s=f[t],n=e[s]||[];for(let e=0;e<n.length;e++)if(r.includes(n[e]))return c.hasFlag("dc-cv-frictionless-false-positive-test",i.NO_CALL).then(t=>{if(t){const t=chrome.i18n.getMessage("@@ui_locale"),r=`${o.e.GOOGLE_SEARCHTERM_FOUND_MATCH}:${s}`;o.event(`${r}:${n[e]}:${t}`)}}),s}return null}});export const googleQueryAnalyzer=p;