/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e}from"../common/local-storage.js";import{analytics as t}from"../common/analytics.js";import{loggingApi as a}from"../common/loggingApi.js";import{communicate as r}from"./communicate.js";import{floodgate as n}from"./floodgate.js";import{CACHE_PURGE_SCHEME as s}from"./constant.js";import{safeJsonParse as o}from"../common/util.js";import{isAddWebpageToProjectEnabled as i}from"./add-webpage-to-project.js";const c="whatsNewVersionCheck",l=864e5;async function w(){try{return await n.hasFlag("dc-cv-whats-new-logging",s.NO_CALL)}catch{return!1}}const u={async info(...e){await w()&&a.info(...e)},async error(...e){await w()&&a.error(...e)}};function m(a){try{const r=e.getItem("whatsNewState")||{},n=r?.lastSeenWn;if(a===n?.tabId){const{openedAt:s,source:o}=n,i=Date.now(),c=s?Math.round((i-s)/1e3):0;u.info({message:"WhatsNew page closed",tabId:a,source:o,openedAt:s,closedAt:i,durationSeconds:c}),t.event("DCBrowserExt:WhatsNew:PageClosed",{source:o});const{tabId:l,source:w,openedAt:m,...g}=n;e.setItem("whatsNewState",{...r,lastSeenWn:g})}}catch(e){}}async function g(){try{return!!await n.hasFlag("dc-cv-whats-new",s.NO_CALL)&&function(){try{const{appLocale:t,viewerLocale:a,locale:r}=e.getItems(["appLocale","viewer-locale","locale"]),s=t||a||r,i=n.getFeatureMeta("dc-cv-whats-new");if(!i)return!0;const c=o(i,{}),l=c?.locales;return!l||!Array.isArray(l)||0===l.length||l.includes(s)}catch(e){return a.error({message:"Error checking What's New locale eligibility",error:e?.message}),!1}}()}catch(e){return a.error({message:"Error checking What's New eligibility",error:e?.message}),!1}}async function h(){try{if(!navigator.onLine)return!1;const t=e.getItem("whatsNewState")||{},a=t?.whatsNewJsonUrl;if(!a)return!1;const r=new URL(a),n=await fetch(r.toString(),{method:"GET"});if(!n.ok)throw new Error(`Failed to fetch wn.json: ${n.status}`);let s=await n.json();s=s.slice(0,13);const o=s[0];if(!o)return!1;const i=e.getItem("whatsNewState")?.lastSeenWn?.version,c=!i||i!==o.whatsNewVersion;if(c){const t=e.getItem("whatsNewState")||{};e.setItem("whatsNewState",{...t,currentAvailableWN:o.whatsNewVersion})}return c}catch(e){return a.error({message:"WhatsNew VersionCheck Failed",error:e?.message}),!1}}async function f(){try{const t=await g();if(e.setItem("whatsNew",!!t),!t)return void d();let a=10080;a=function(e,t=10080){if(!e)return t;try{const{alarmInterval:a}=JSON.parse(e)||{},r=parseInt(a,10);return Number.isFinite(r)&&r>0?r:t}catch{return t}}(n.getFeatureMeta("dc-cv-whats-new"));const r=await chrome.alarms.get(c);r&&r?.periodInMinutes===a||(await d(),chrome.alarms.create(c,{periodInMinutes:a,delayInMinutes:1}),u.info({message:"WhatsNew Alarm Created"}))}catch(e){}}async function d(){try{await chrome.alarms.get(c)&&chrome.alarms.clear(c)}catch(e){}}async function p(e){if(e&&e.name===c){if(!await g())return void await d();try{await h()&&u.info({message:"WhatsNew New Version Detected in alarm handler"})}catch(e){}}}async function N(t="browserStartup"){try{if(!navigator.onLine)return{eligible:!1,reason:"offline"};if(!await g())return{eligible:!1,reason:"disabled"};const{whatsNewState:a={},whatsNewAutoOpen:r}=e.getItems(["whatsNewState","whatsNewAutoOpen"]),{currentAvailableWN:n,lastSeenWn:s,disableAutoOpenByAdmin:o}=a||{};if(!n)return{eligible:!1,reason:"no_current_wn"};const i=Date.now();if("browserStartup"===t){if(!0===o)return{eligible:!1,reason:"admin_disabled"};if(s?.version&&n===s.version)return{eligible:!1,reason:"already_seen_version"};const t=e.getItem("installTimestamp");if(!s&&(t?(i-t)/l:0)<=15)return{eligible:!1,reason:"new_user_grace"};if("false"===r)return{eligible:!1,reason:"auto_open_toggle_off"};if(s?.timestamp){if((i-s.timestamp)/l<=25)return{eligible:!1,reason:"cooldown"}}}return{eligible:!0,currentAvailableWN:n}}catch{return{eligible:!1,reason:"error"}}}async function b(r){try{if(u.info({message:"WhatsNew page check initiated",source:r,isOnline:navigator.onLine}),!navigator.onLine)return;const n=await N(r);if(!n?.eligible)return void u.info({message:"WhatsNew page skipped - not eligible",source:r,reason:n?.reason||"unknown"});const s=n.currentAvailableWN,o=Date.now(),i=function(){try{const t=e.getItem("whatsNewState")?.whatsNewPageUrl;return t||(a.error({message:"No What's New URL found in servers config"}),null)}catch(e){return null}}();if(i){const a=e.getItem("whatsNewState")||{};e.setItem("whatsNewState",{...a,currentWhatsNewOpenSource:r});const n=await chrome.tabs.create({url:i,active:!0}),c={version:s,timestamp:a.lastSeenWn?.timestamp,tabId:n.id,source:r,openedAt:o};u.info({message:"WhatsNew page opened",url:i,source:r,version:s,tabId:n.id}),"browserStartup"===r&&(c.timestamp=o);const l=e.getItem("whatsNewState")||{};e.setItem("whatsNewState",{...l,lastSeenWn:c}),t.event("DCBrowserExt:WhatsNew:PageOpened",{version:s,trigger:r})}}catch(e){u.error({message:"WhatsNew page check failed",source:r,error:e?.message,stack:e?.stack})}}r.registerHandlers({getWhatsNewData:async function(t,a,r){try{let t=e.getItem("whatsNewState")||{};const a=t.currentWhatsNewOpenSource;if(a){const{currentWhatsNewOpenSource:a,...r}=t;e.setItem("whatsNewState",r),t=r}const{appLocale:n,viewerLocale:s,locale:o,isAllowedLocalFileAccess:c,anonUserUUID:l}=e.getItems(["appLocale","viewer-locale","locale","isAllowedLocalFileAccess","anonUserUUID"]),w=t.currentAvailableWN,u=t.disableAutoOpenByAdmin,m=n||s||o;let g=!1;try{g=await i()}catch(e){}r({success:!0,currentExtensionVersion:chrome.runtime.getManifest().version,whatsNewVersion:w,locale:m,source:a||"direct",isAllowedLocalFileAccess:c,disableAutoOpenByAdmin:u,isPDFSpacesEnabled:g,anonUserUUID:l})}catch(e){return{success:!1,error:e.message}}},openWhatsNew:({source:e})=>b(e),getWhatsNewAutoOpenEligibility:async function(e,t,a){try{if(await g()){await h()&&u.info({message:"WhatsNew New Version Detected"})}a({eligible:!!(await N()).eligible})}catch(e){a({eligible:!1})}},getWhatsNewFlag:async function(e,t,a){try{a(await g())}catch(e){a(!1)}}});export{d as clearWhatsNewVersionCheckAlarm,p as whatsNewAlarmHandler,b as checkAndOpenWhatsNewPage,f as checkAndInitialiseWhatsNewAlarm,m as onWhatsNewTabRemoved};