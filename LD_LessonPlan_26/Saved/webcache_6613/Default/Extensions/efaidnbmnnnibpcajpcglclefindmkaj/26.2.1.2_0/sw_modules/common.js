/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{util as e}from"./util.js";import{Proxy as t}from"./proxy.js";import{SETTINGS as s}from"./settings.js";import{dcLocalStorage as i}from"../common/local-storage.js";import{getActiveExperimentAnalyticsArray as r}from"../common/experimentUtils.js";import{OFFSCREEN_DOCUMENT_PATH as n}from"../common/constant.js";import{servers as o}from"./server-config.generated.js";let a=null;export function deriveCDNURL(e="prod"){if(!i.getItem("enableCDNVersioning")){const t="acrobatViewerUrl";return o[e]?.[t]}const t="viewerUrl";let s;const r="prod"===e?"prod":"non_prod";let n=o[e]?.[t].external_uri;try{const a=i.getItem("adobeInternal");"true"===a&&(n=o[e]?.[t].internal_uri);const l=i.getItem("version-config");l&&(s="true"===a?l[`iv_${r}`]:l[`ev_${r}`],s&&""!==s&&null!==s&&(n="latest"===s?o[e]?.[t].latest_uri:o[e]?.[t].version_template.replace(new RegExp("{VERSION}","g"),s)))}catch{}return n}export function updateEnvironment(e){const t=e.env,s=o[t],r=deriveCDNURL(t),n=s.viewer_ims_client_id,a=s.viewer_ims_client_id_social,l=s.ims_context_id,h=s.imsURL,c=s.imsLibUrl,g=s.dcApiUri,d=s.genAIPricingUri,p=new URL(s.uninstallUrl);p.searchParams.append("callingApp",chrome.runtime.id),p.searchParams.append("theme",i.getItem("theme")||"auto"),common.settings={...common.settings,...s};try{i.setItem("cdnUrl",r),i.setItem("signInUrl",common.getSignInUrl()),i.setItem("viewerImsClientId",n),i.setItem("viewerImsClientIdSocial",a),i.setItem("imsContextId",l),i.setItem("imsURL",h),i.setItem("imsLibUrl",c),i.setItem("dcApiUri",g),i.setItem("genAIPricingUri",d),i.setItem("sidepanelUrl",common.getSidepanelUrl());try{const e={...i.getItem("whatsNewState")||{},whatsNewPageUrl:common.getWhatsNewPageUrl(),whatsNewJsonUrl:common.getWhatsNewJsonUrl()};i.setItem("whatsNewState",e)}catch(e){}chrome.runtime.setUninstallURL(p.href)}catch(e){}}export function onMessageListener(t,s,r){switch(t.type){case"getItem":r(i.getItem(t.key));break;case"setItem":i.setItem(t.key,t.value);break;case"removeItem":i.removeItem(t.key);break;case"saveGenAIPanelRender":(async()=>{const t=`${n}?env=${common.getEnv()}`;await e.setupOffscreenDocument(t),setTimeout(()=>{chrome.runtime.sendMessage({main_op:"saveGenAIPanelRender",target:"offscreen"})},50)})();break;case"update_env":updateEnvironment(t)}}class l{constructor(){this.$GET_headers={Accept:"application/vnd.adobe.dex+json;version=1",Authorization:null,"x-api-client-id":"api_browser_ext"},this.$POST_headers={Accept:"application/vnd.adobe.dex+json;version=1","Content-Type":"application/vnd.adobe.dex+json;version=1;charset=utf-8",Authorization:null,"x-api-client-id":"api_browser_ext"},this.reset()}proxy(...e){return t.proxy.bind(this)(...e)}uuid(){return"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx".replace(/x/g,function(){return"0123456789abcdef"[Math.floor(16*Math.random())]})}updateEnvironment(e){return updateEnvironment(e)}deriveCDNURL(e="prod"){return deriveCDNURL(e)}reset(t="prod"){this.settings={cpdf_api:null,files_host:null,files_api:null,files_upload:null,files_root:null,fillsign_api:null,auth_token:null,ims_host:null},this.server=o[t]||o[Object.keys(o)[0]];const s=this.deriveCDNURL(t);this.settings=e.extend(this.settings,this.server);const i="acrobatViewerUrl";this.settings={...this.settings,[i]:s}}connected(){return!!this.settings.auth_token}setGlobals(e){this.globals=e}getFrictionlessUri(e="v1"){const t=`frictionlessUrl_${e}`;return o[this.getEnv()]?.[t]||o.prod[t]}getPopupCDNUrl(){return this.settings.popup_cdn_uri||o.prod.popup_cdn_uri}getRemoteExecutionCdnUrl(){const e="remoteExecutionCdnUrl";return this.settings[e]||o[this.getEnv()]?.[e]}getAddWebpageToProjectUrl(){return this.settings.addWebpageToProjectUrl||o.prod.addWebpageToProjectUrl}getUninstallUrl(){const e="uninstallUrl";return this.settings[e]||o.prod[e]}getWhatsNewPageUrl(){return o[this.getEnv()]?.whatsNewPageUrl}getWhatsNewJsonUrl(){return o[this.getEnv()]?.whatsNewJsonUrl}getVersionConfigUrl(){return this.settings.version_config_uri?this.settings.version_config_uri:o.prod.version_config_uri}getOteConfigUrl(){return this.settings.ote_config_uri?this.settings.ote_config_uri:o.prod.ote_config_uri}getModerationListUrl(){return this.settings.moderation_list_uri?this.settings.moderation_list_uri:o.prod.moderation_list_uri}getKWModerationListUrl(){return this.settings.kw_moderation_list_uri?this.settings.kw_moderation_list_uri:o.prod.kw_moderation_list_uri}getExpressBlockListUrl(){return o[this.getEnv()]?.express_moderation_list_uri}getSplunkAllowedEventsUrl(){const e="splunk_allowed_events_uri";return this.settings[e]||o.prod[e]}getEnv(){return this.settings.env||"prod"}getSignInUrl(){return o[this.getEnv()]?.signInUrl}getFloodgateUrl(){return o[this.getEnv()]?.floodgateUrl}getUserStateUrl(){return o[this.getEnv()]?.userStateUrl}getAnalyticsOverrideConfigUri(){return o[this.getEnv()]?.analyticsOverrideConfigUri}getAcroIpmURL(){return o[this.getEnv()]?.acrobat_ipm_uri}getSidepanelUrl(){return o[this.getEnv()]?.sidepanelUrl}getViewerIMSClientId(){return this.settings.viewer_ims_client_id?this.settings.viewer_ims_client_id:o.prod.viewer_ims_client_id}getViewerIMSClientIdSocial(){return this.settings.viewer_ims_client_id_social?this.settings.viewer_ims_client_id_social:o.prod.viewer_ims_client_id_social}getImsContextId(){return this.settings.ims_context_id?this.settings.ims_context_id:o.prod.ims_context_id}getIMSurl(){return this.settings.imsURL?this.settings.imsURL:o.prod.imsURL}getImsLibUrl(){return this.settings.imsLibUrl?this.settings.imsLibUrl:o.prod.imsLibUrl}getDcApiUri(){return this.settings.dcApiUri?this.settings.dcApiUri:o.prod.dcApiUri}getGenAIPricingUri(){return this.settings.genAIPricingUri?this.settings.genAIPricingUri:o.prod.genAIPricingUri}getExpressURLs(){return o[this.getEnv()]?.express||o.prod.express}getFloodgateuri(){return this.settings.floodgateUri?this.settings.floodgateUri:o.prod.floodgateUri}getWelcomePdfUrlHost(){return this.settings.welcomePdfUrlHost?this.settings.welcomePdfUrlHost:o.prod.welcomePdfUrlHost}getFloodgateSandboxName(){return this.settings.floodgate_sandbox_name?this.settings.floodgate_sandbox_name:o.prod.floodgate_sandbox_name}getLoggingUri(){return"development"===i.getItem("installSource")?"https://dc-api-stage.adobe.io":this.settings.loggingUri?this.settings.loggingUri:o.prod.loggingUri}isAdobeInternalUser(){return"true"===i.getItem("adobeInternal")}createAnonUserUUID(){const t=`${this.getEnv()}_${this.getViewerIMSClientId()}_${e.uuid()}`;try{i.setItem("anonUserUUID",t)}catch(e){}return t}GET_headers(){return this.$GET_headers["x-request-id"]=this.uuid(),this.$GET_headers.Authorization=this.settings.auth_token,this.$GET_headers}POST_headers(){return this.$POST_headers["x-request-id"]=this.uuid(),this.$POST_headers.Authorization=this.settings.auth_token,this.$POST_headers}noToken(e){e&&e.reject()}filesBaseUris(){var t=e.Deferred();return this.settings.files_api?t.resolve():e.ajax({url:this.settings.files_host+"api/base_uris",headers:{Accept:this.GET_headers().Accept,"x-api-client-id":this.GET_headers()["x-api-client-id"]}}).then(this.proxy(function(e){this.settings.files_api=e.api,this.settings.files_upload=e.upload,t.resolve()}),function(){t.reject()}),t.promise()}cloudBaseUris(){var t=e.Deferred();return this.settings.cloud_api?t.resolve():e.ajax({url:this.settings.cloud_host+"api/base_uris",headers:{Accept:this.GET_headers().Accept,"x-api-client-id":this.GET_headers()["x-api-client-id"]}}).then(this.proxy(function(e){this.settings.cloud_api=e.api,this.settings.files_host=e.files,this.settings.fillsign_api=e.fss,this.settings.ims_host=e.ims,this.settings.cpdf_api=e.cpdf,t.resolve()}),function(){t.reject()}),t.promise()}baseUris(){var t=e.Deferred();return this.cloudBaseUris().done(this.proxy(function(){this.filesBaseUris().done(this.proxy(function(){t.resolve()}))})),t.promise()}connect(){var t=e.Deferred();return this.settings.auth_code?(this.baseUris().then(this.proxy(function(){if(this.settings.auth_code){var s={grant_type:"authorization_code",code:this.settings.auth_code,client_id:this.settings.ims_client_id,client_secret:this.settings.ims_client_secret};e.ajax({url:this.settings.ims_host+"ims/token/v1",type:"POST",data:s,contentType:"application/x-www-form-urlencoded;charset=UTF-8"}).then(this.proxy(function(s){var i=(new Date).getTime(),r=/@adobe(test)?\.com$/i.test(s.email);this.settings.auth_code=null,r?(this.settings.auth_token="Bearer "+s.access_token,this.settings.refresh_token=s.refresh_token,this.settings.token_expiry=i+s.expires_in,this.settings.refresh_time=i+s.expires_in/2,this.settings.displayName=s.displayName,t.resolve(),e.consoleLog("got auth token")):(alert("PDF Helper Extension is available to Adobe Employees only"),import("../common/analytics.js").then(({analytics:e})=>{e.event(e.e.EXTENSION_FORCE_UNINSTALL),chrome.management.uninstallSelf()}))}),this.proxy(function(){this.noToken(t)}))}else this.noToken(t)}),this.proxy(function(){this.noToken(t)})),t.promise()):(t.reject(),t.promise())}refreshToken(t){var s,i=(new Date).getTime(),r=e.Deferred();return this.settings.refresh_token?!t&&i<this.settings.refresh_time?r.resolve():i>this.settings.token_expiry?r.reject():(s={grant_type:"refresh_token",refresh_token:this.settings.refresh_token,client_id:this.settings.ims_client_id,client_secret:this.settings.ims_client_secret},e.ajax({url:this.settings.ims_host+"ims/token/v1",type:"POST",data:s,contentType:"application/x-www-form-urlencoded; charset=UTF-8"}).then(this.proxy(function(t){var s=(new Date).getTime();this.settings.auth_token="Bearer "+t.access_token,this.settings.refresh_token=t.refresh_token,this.settings.token_expiry=s+t.expires_in,this.settings.refresh_time=s+t.expires_in/2,r.resolve(),e.consoleLog("refresh token result"),e.consoleLogDir(t)}),this.proxy(function(){this.noToken(r)}))):r.reject(),r.promise()}ajaxReady(t){let s=e.Deferred();return this.settings.auth_token?this.refreshToken(t).then(this.proxy(function(){s.resolve()}),this.proxy(function(){this.noToken(s)})):this.connect().then(this.proxy(function(){this.settings.files_root?s.resolve():e.ajax({url:this.settings.files_api+"root",type:"GET",headers:this.GET_headers()}).then(this.proxy(function(e){s.resolve(),this.settings.files_root=e.id}),this.proxy(function(){this.noToken(s)}))}),this.proxy(function(){this.noToken(s)})),s.promise()}sso_url(t){return e.ajax({url:this.settings.cloud_api+"session/sso_uri?path="+t,type:"GET",headers:this.GET_headers()})}authorize(e){return this.settings.auth_code=e,this.settings.auth_token=null,delete this.settings.refresh_token,delete this.settings.token_expiry,delete this.settings.refresh_time,this.ajaxReady()}clearAuth(){this.settings.auth_token&&(e.ajax({url:this.settings.cloud_api+"session",type:"DELETE",headers:this.$POST_headers}),delete this.settings.auth_token,delete this.settings.refresh_token,delete this.settings.token_expiry,delete this.settings.refresh_time,delete this.settings.displayName)}LOG(t,s){return e.Deferred().resolve()}registerUninstallUrl({locale:t,experimentCodes:s}={}){const n=i.getItem("appLocale"),o=i.getItem("installSource");if(!["development","normal","sideload"].includes(o))return;const a=new URL(this.getUninstallUrl()),l=n||t||i.getItem("viewer-locale")||e.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));a.searchParams.append("locale",l),a.searchParams.append("theme",i.getItem("theme")||"auto"),a.searchParams.append("callingApp",chrome.runtime.id),a.searchParams.append("extVer",chrome.runtime.getManifest().version),a.searchParams.append("is",o);const h="true"===i.getItem("IsRunningInEdge")?"edge":"chrome";a.searchParams.append("br",h);let c=-1;if(i.getItem("extUserState"))c=0;else{const e=i.getItem("viewerStorage");if(e){c=+(0===(parseInt(e.usage,10)||0))}}a.searchParams.append("nu",c);[["os","osInfo"],["bv","browserVersion"],["iv","installVersion"],["it","installTimestamp"],["auid","anonUserUUID"],["pv","pdfViewer"]].forEach(([e,t])=>{((e,t)=>{t&&a.searchParams.append(e,t)})(e,i.getItem(t))});const g=s||r();g&&g.length>0&&a.searchParams.append("acEx",JSON.stringify(g.sort())),chrome.runtime.setUninstallURL(a.href)}}a||(a=new l,e.ajaxError(function(e,t,s,i){401===t.status&&a.clearAuth()}));export const common=a;