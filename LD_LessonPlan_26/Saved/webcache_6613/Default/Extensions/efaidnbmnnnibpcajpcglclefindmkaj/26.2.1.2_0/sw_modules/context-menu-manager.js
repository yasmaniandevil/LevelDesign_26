/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{communicate as e}from"./communicate.js";import{util as t}from"./util.js";import{analytics as n}from"../common/analytics.js";import{SETTINGS as o}from"./settings.js";import{dcLocalStorage as a}from"../common/local-storage.js";import{floodgate as r}from"./floodgate.js";import{sendPingEventHandler as i}from"../common/util.js";import{loggingApi as s}from"../common/loggingApi.js";import{launchExpress as c}from"./express.js";import{toggleExpressTouchpoints as d}from"./express/express-context-menu.js";import{toggleAddWebpageToProjectContextMenu as m,handleAddWebpageToProjectContextMenu as l,ensureAndExtractWebpageHTML as u,isAddWebpageToProjectEnabled as p}from"./add-webpage-to-project.js";import{ADD_WEBPAGE_TO_PROJECT_CONTEXT_MENU_TP_CTX as g,ADD_WEBPAGE_TO_NEW_PDF_SPACE_CONTEXT_MENU as E,ADD_WEBPAGE_TO_EXISTING_PDF_SPACE_CONTEXT_MENU as f,NEW_RCM_LABEL_FLAG as x}from"../common/constant.js";import{CACHE_PURGE_SCHEME as P,EXPRESS as C,STORAGE_KEYS as I}from"./constant.js";import{common as M}from"./common.js";import{registerRequestId as T}from"./request-validator.js";const b=()=>e.getModule("acro-web2pdf"),w=()=>e.getModule("acro-gstate"),N=["http://*/*","https://*/*"];function _(e){let n,o=e;return t&&t.isChromeOnlyMessage(o)&&t.isEdge()&&(o+="Edge"),n=t&&t.getTranslation?t.getTranslation(o):chrome.i18n.getMessage(o),n}function v(e){return(e.title||_("web2pdfUntitledFileName")).replace(/[<>?:|*"/'&.]/g,"")}function h(e,n){if(!e&&!n)return!1;try{const t=e.pageUrl||n.url,o=new URL(t);if(o.protocol&&["http:","https:"].includes(o.protocol))return!0}catch(e){t.consoleError(e)}return!1}async function A(e,t){const n=e.map(async e=>{try{await chrome.contextMenus.update(e,t)}catch(t){s.error({message:`Failed to update context menu item: ${e}`,error:t?.message})}});await Promise.all(n)}async function U(e,t,n){try{o.IS_READER||n||await A(["convertPageContextMenu","appendPageContextMenu"],{visible:!0})}catch(e){s.error({message:"Failed to configure context menu structure",error:e?.message})}}function R(e){return new Promise(t=>{try{const n=chrome.contextMenus.create(e,()=>{chrome.runtime.lastError&&s.error({message:`Error creating menu item: ${e.id}`,error:chrome.runtime.lastError.message}),t(n)})}catch(n){s.error({message:`Exception creating menu item: ${e.id}`,error:n?.message}),t(null)}})}function D(n){const i=0===n||1===n&&!1===e.NMHConnStatus||n===o.READER_VER||n===o.ERP_READER_VER;chrome.contextMenus.removeAll(async()=>{try{const e=await p(),n=await r.hasFlag(x,P.NO_CALL)&&e;let s;if(n?s=await R({id:"adobeAcrobatParentMenu",title:t.getTranslation("adobeAcrobatParentMenuTitle"),contexts:["page"],documentUrlPatterns:N,visible:!0}):await R({id:"addWebpageToProject",title:t.getTranslation("addWebpageToProjectContextMenuTitle"),contexts:["page"],documentUrlPatterns:N,visible:!1}),await R({id:"addWebpageToNewPdfSpaceContextMenu",parentId:n&&s?s:void 0,title:t.getTranslation("addWebpageToNewPdfSpaceContextMenu"),contexts:["page"],documentUrlPatterns:N,visible:!1}),await R({id:"addWebpageToExistingPdfSpaceContextMenu",parentId:n&&s?s:void 0,title:t.getTranslation("addWebpageToExistingPdfSpaceContextMenu"),contexts:["page"],documentUrlPatterns:N,visible:!1}),await R({id:"separatorForPdfSpaceMenu",parentId:n&&s?s:void 0,type:"separator",contexts:["page"],documentUrlPatterns:N,visible:!1}),!o.IS_READER&&!i){const e={contexts:["page"],documentUrlPatterns:N,visible:!1};await R({id:"convertPageContextMenu",parentId:n?s:void 0,title:_("web2pdfConvertPageContextMenu"),...e}),await R({id:"appendPageContextMenu",parentId:n?s:void 0,title:_("web2pdfAppendPageContextMenu"),...e})}await U(0,0,i),d(a.getItem("express-touch-points")),m({parentMenuId:n?s:void 0,useNewContextMenuLabel:n})}catch(e){s.error({message:"Failed to create context menus",error:e?.message,stack:e?.stack})}})}async function O(e,t,n){try{const e=function(e,t){const n=a.getItem("appLocale")||chrome.i18n.getMessage("@@ui_locale"),o=chrome.runtime.id,r=`req_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;T(r,t);const i=M.getWelcomePdfUrlHost(),s={tabId:e.id,title:e.title,locale:n,extensionId:o,requestId:r},c=JSON.stringify(s),d=btoa(c),m=new URL(`${i}/link/spaces/create-new-space`);return m.searchParams.set("context",t),m.searchParams.set("payload",d),m.searchParams.set("isNew","1"),m.toString()}(t,n);u(t.id),chrome.tabs.create({url:e,active:!0}),s.info({message:"Direct create new PDF Space initiated",tabId:t.id})}catch(e){s.error({message:"Error in direct create new PDF Space",error:e?.message})}}function S(e,t){i(),"convertPageContextMenu"===e.menuItemId?function(e,t){h(e,t)&&(n.event(n.e.CONTEXT_MENU_CONVERT_PAGE),b().handleConversionRequest({tabId:t.id,caller:w().web2pdfCaller.MENU,action:w().web2pdfAction.CONVERT,context:w().web2pdfContext.PAGE,url:e.pageUrl||t.url,domtitle:v(t)}))}(e,t):"appendPageContextMenu"===e.menuItemId?function(e,t){h(e,t)&&(n.event(n.e.CONTEXT_MENU_APPEND_PAGE),b().handleConversionRequest({tabId:t.id,caller:w().web2pdfCaller.MENU,action:w().web2pdfAction.APPEND,context:w().web2pdfContext.PAGE,url:e.pageUrl||t.url,domtitle:v(t)}))}(e,t):"convertLinkTargetToPDFContextMenu"===e.menuItemId?function(e,t){h(e,t)&&(n.event(n.e.CONTEXT_MENU_CONVERT_LINK),b().handleConversionRequest({tabId:t.id,caller:w().web2pdfCaller.MENU,action:w().web2pdfAction.CONVERT,context:w().web2pdfContext.LINK,url:e.linkUrl,domtitle:v(t)}))}(e,t):"appendLinkTargetToExistingPDFContextMenu"===e.menuItemId?function(e,t){h(e,t)&&(n.event(n.e.CONTEXT_MENU_APPEND_LINK),b().handleConversionRequest({tabId:t.id,caller:w().web2pdfCaller.MENU,action:w().web2pdfAction.APPEND,context:w().web2pdfContext.LINK,url:e.linkUrl,domtitle:v(t)}))}(e,t):Object.values(C.VERBS).includes(e.menuItemId.replace("ContextMenu",""))||"expressMenu"===e.menuItemId?function(e,t){if(!h(e,t))return;const o=new URL(t.url).hostname;let r;r="expressMenu"===e.menuItemId?"editImage":e?.menuItemId?.replace("ContextMenu",""),n.event(n.e.CONTEXT_MENU_EXPRESS_VERB,{domain:o,TARGET:e?.linkUrl?"Link":"Image",VERB:r},{frequency:"always"}),a.setItem(C.CONTEXT_MENU_INTERACTION_DONE,"true");const i={...e,intent:r,touchpoint:"ContextMenu"};c(i,t)}(e,t):"addWebpageToProject"===e.menuItemId?l(e,t,g):"addWebpageToNewPdfSpaceContextMenu"===e.menuItemId?async function(e,t,o){await a.init();const r=a.getItem(I.KW_FTE_COMPLETED);n.event(n.e.CONTEXT_MENU_ADD_WEB_PAGE_TO_NEW_PDF_SPACE,{fteCompleted:r,context:o}),r?await O(0,t,o):l(e,t,o)}(e,t,E):"addWebpageToExistingPdfSpaceContextMenu"===e.menuItemId&&function(e,t,o){n.event(n.e.CONTEXT_MENU_ADD_WEB_PAGE_TO_EXISTING_PDF_SPACE,{context:o}),l(e,t,o)}(e,t,f)}export{D as createContextMenu,S as contextMenuOnClickHandler,A as updateContextMenuItems,U as configureContextMenuStructure};