/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e}from"./common/local-storage.js";import{hydrateWithStorage as o}from"./sw_modules/hydrate.js";import{communicate as s}from"./sw_modules/communicate.js";import{tempUrlBufferClean as t}from"./sw_modules/temp-url-buffer-cleanup.js";import{onMessageListener as r}from"./sw_modules/common.js";import{externalClients as n}from"./sw_modules/externalClients.js";import{feat as a}from"./sw_modules/feat.js";import{session as d}from"./sw_modules/session.js";import{acroweb2pdf as i}from"./sw_modules/acro-web2pdf.js";import{userSubscriptionAlarmHandler as m}from"./sw_modules/user-subscription.js";import{whatsNewAlarmHandler as c,onWhatsNewTabRemoved as l,checkAndOpenWhatsNewPage as p}from"./sw_modules/whats-new-handler.js";import{startQAWithWebpage as u}from"./sw_modules/ch-context-menu.js";import{openPreferences as h}from"./common/navigation-helper.js";import"./sw_modules/acro-gstate.js";import{authProvider as f}from"./sw_modules/auth-provider.js";import{initSiteVisitAnalytics as w}from"./sw_modules/site-visit-analytics.js";import{startup as b,registerActions as g,onWelcomeTabRemoved as _,contextMenuOnClickHandler as L,updateAnalyticsOptInAdmin as I,refocusLocalFteWindow as y,onLocalFileClosed as x,onLocalFteWindowClosed as S,onDownloadChanged as j}from"./sw_modules/ch-context-menu.js";import{processRequest as v,honorRequest as A,onTabsUpdated as C,onTabActivated as T,logWebpageDomain as D,handlePrefetchValidation as R,detectAndStorePrefetch as E,cleanupPrefetchForTab as k,onWindowFocusChanged as P}from"./sw_modules/viewer-module.js";import{indexedDBScript as M}from"./common/indexDB.js";import{offscreenActions as B}from"./sw_modules/offscreen-actions.js";import{analytics as O}from"./common/analytics.js";import{expressModalTabCloseListener as U}from"./sw_modules/express.js";import{pdfRenderingTabCloseListener as F}from"./common/pdf-rendering-tracking.js";import{sidepanelState as N}from"./sw_modules/SidepanelState.js";import{loggingApi as q}from"./common/loggingApi.js";import H from"./sw_modules/ExplicitBlocklist.js";import{removeCoiTab as G,trackCoiHeaders as V,clearOptionPageSource as W}from"./common/util.js";import{storageAnalyzer as Y}from"./sw_modules/storage-analyzer.js";const z=["http","https","ftp","file","blob","data","filesystem","drive"];try{const B=chrome.runtime.getURL("/");chrome.runtime.onConnect.addListener(o=>{const[s,t,r]=o.name?.split("_")??[];"sidepanel"===s&&(o.onMessage.addListener(()=>{}),chrome.tabs.sendMessage(parseInt(t),{action:"sidepanel_opened"}),N.setIsOpen(parseInt(t),!0),o.onDisconnect.addListener(async()=>{chrome.tabs.sendMessage(parseInt(t),{action:"sidepanel_closed",initTimeStamp:r});const o=N.getLoadState(parseInt(t));N.setIsOpen(parseInt(t),!1),N.setLoadState(parseInt(t),N.LOAD_STATE.NOT_LOADED);const s=Date.now(),{version:n}=chrome.runtime.getManifest();await e.init(),q.info({message:"DC Acrobat Extn: Sidepanel closed",timestamp:s,duration:Math.round((s-r)/100)/10,durationInMs:s-r,adobeInternal:"true"===e.getItem("adobeInternal"),extensionVersion:n}),o===N.LOAD_STATE.FULLY_LOADED?O.event("DCBrowserExt:SidePanel:Closed:FullyLoaded"):o===N.LOAD_STATE.CDN_READY?O.event("DCBrowserExt:SidePanel:Closed:CdnReady"):O.event("DCBrowserExt:SidePanel:Closed:CdnNotReady")}))}),chrome.management.getSelf(o(b)),chrome.runtime.onInstalled.addListener(o(g)),w(),chrome.cookies?.onChanged?.addListener(e=>{const{name:o,domain:s}=e?.cookie||{};s?.includes("services.adobe.com")&&("ims_sid"===o?f.resetSignInStatusCooldown():"gds"===o&&e?.removed&&["explicit","expired"].includes(e?.cause)&&chrome.runtime.sendMessage({content_op:"removeAnonGenAIProvisionResponse"}))}),chrome.runtime.onStartup.addListener(o(()=>{e.removeItem("loadedTabsInfo"),p("browserStartup")})),chrome.contextMenus.onClicked.addListener(o(L)),chrome.runtime.onMessageExternal.addListener(o(a,n)),chrome.action.onUserSettingsChanged?.addListener(o(async o=>{const s=e.getItem("pinToolbarSettingsWindowId");if(s&&o.isOnToolbar)try{await chrome.windows.remove(s)}catch(e){}})),chrome.webRequest.onHeadersReceived.addListener(e=>{o(e=>{R(e)||(v(e,!1),D(e),V(e))})(e)},{urls:["http://*/*","https://*/*"],types:["main_frame","sub_frame"]},["responseHeaders"]),chrome.webRequest.onBeforeRequest.addListener(e=>{o(v)(e,!0)},{urls:["file://*/*.pdf","file://*/*.PDF"],types:["main_frame","sub_frame"]}),chrome.webRequest.onBeforeSendHeaders.addListener(e=>{o(E)(e)},{urls:["http://*/*","https://*/*"],types:["main_frame"]},["requestHeaders"]),chrome.webRequest.onBeforeRequest.addListener(o(A),{urls:z.map(e=>B+e+"*"),types:["main_frame"]}),chrome.webNavigation.onBeforeNavigate.addListener(o(s.handlerTabs),{frameType:"outermost_frame"}),chrome.runtime.onMessage.addListener((...t)=>{const[n,a,d]=t;switch(n?.type){case"getWindowType":a?.tab?.windowId?chrome.windows.get(a.tab.windowId).then(e=>{const o="popup"===e.type,s="app"===e.type;d({isPopup:o,isApp:s})}):d({isPopup:!1,isApp:!1});break;case"open_side_panel":u(n,a.tab||n.tab);break;case"open_options_page":h({preferenceTabId:n.preferenceTabId,controlId:n.controlId,accordionId:n.accordionId,sectionClassNames:n.highlightSection});break;case"send_to_sidepanel":chrome.runtime.sendMessage({...n,tabId:a.tab?.id});break;case"get_sidepanel_state":d({isOpen:N.getIsOpen(a.tab?.id)});break;case"sidepanel_load_state":N.setLoadState(n.tabId,N.LOAD_STATE[n.state]);break;case"get_explicit_blocklist":"true"===e.getItem("enableGenAIFab")?H.getExplicitBlocklist().then(e=>d(e)).catch(()=>d([])):d([])}return o(r,s.proxy(s.handler))(...t),!0}),chrome.tabs.onRemoved.addListener(o(s.proxy(s.close),d.proxy(d.onSessionTabRemoved),_,(...o)=>{e.getItem("LocalFileAccessTouchpointsFromViewer")||M.deleteDataFromIndexedDB(...o)},x,s.proxy(s.getCurrentTabInfoAndUpdateLoadedTabs),U,F,G,e=>N.clear(e),k,f.clearImsConsciousTab,W,l)),chrome.tabs.onUpdated.addListener(o(C)),chrome.storage.managed.onChanged.addListener(o(I)),chrome.extension.isAllowedFileSchemeAccess(o(s.proxy(s.setIsAllowedLocalFileAccess))),chrome.tabs.onActivated.addListener(async(...e)=>{o(T,s.proxy(s.active),y,f.recheckSignInStatus)(...e)}),chrome.tabs.onReplaced.addListener(o(s.proxy(s.tabReplace))),chrome.tabs.onMoved.addListener(o(s.proxy(s.getCurrentTabInfoAndUpdateLoadedTabs))),i.setNcPort(chrome.runtime.connectNative("com.adobe.acrobat.chrome_webcapture")),i.ncPort.onMessage.addListener(i.proxy(i.nativeMessageCallback)),i.ncPort.onDisconnect.addListener(i.proxy(i.nativeOnDisconnect)),chrome.alarms.onAlarm.addListener(o(e=>{m(e),c(e)})),chrome.alarms.onAlarm.addListener(t.deleteTempURLBufferEntries),chrome.windows.onRemoved.addListener(o(S)),chrome.downloads.onChanged.addListener(o(j)),chrome.downloads.onCreated.addListener(e=>{(e?.finalUrl&&new URL(e?.finalUrl)?.searchParams?.has("acrobatPromotionSource")||e?.url&&new URL(e?.url)?.searchParams?.get("acrobatPromotionSource"))&&(chrome.downloads.cancel(e?.id),O.event("DCBrowserExt:PromotionSource:Download:Cancel"))}),chrome.windows.onFocusChanged.addListener(o(P))}catch(e){console.log(e)}